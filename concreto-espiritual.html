<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Concreto Espiritual — Diagnóstico</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:560px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:84px;resize:vertical;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}

    .barWrap{display:grid;gap:10px;margin-top:10px;}
    .barItem{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:10px;background:rgba(0,0,0,.10);}
    .barTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;}
    .barTitle{font-weight:950;font-size:13px;line-height:1.25;}
    .barNum{font-weight:950;font-size:13px;color:rgba(255,255,255,.92);}
    .barBg{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px;border:1px solid rgba(255,255,255,.10);}
    .barFill{height:100%;width:0%;border-radius:999px;background:rgba(94,234,212,.85);}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .big{font-weight:950;font-size:18px;}
    .bigNum{font-weight:950;font-size:34px;letter-spacing:.3px;line-height:1;}
    .stateGood{color:#34d399;}
    .stateWarn{color:#fcd34d;}
    .stateBad{color:#fda4af;}

    .qBlock{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;background:rgba(0,0,0,.10);margin-top:10px;}
    .qHead{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .qHead b{font-size:13px;}
    .qHelp{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35;}
    .qOpts{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px;}
    @media(min-width:740px){.qOpts{grid-template-columns:repeat(5, 1fr);}}
    .opt{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:rgba(255,255,255,.90);
      display:flex;flex-direction:column;gap:6px;
      min-height:60px;
    }
    .opt small{color:var(--muted);font-size:11px;line-height:1.2}
    .opt input{display:none}
    .opt.sel{border-color:rgba(94,234,212,.75);box-shadow:0 0 0 2px rgba(94,234,212,.15) inset;}
    .hr{height:1px;background:var(--line);margin:10px 0;}
    .twoCol{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:740px){.twoCol{grid-template-columns:1fr 1fr;}}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Concreto Espiritual</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill">Diagnóstico didáctico (sin servidor)</span>
      <span class="pill" id="qCount">Preguntas: —</span>
      <span class="pill" id="ansCount">Respondidas: —</span>
      <span class="pill" id="bandPill">Calidad: —</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- IZQ: RESULTADOS -->
    <div class="card">
      <div class="row">
        <div>
          <b>Resultado</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            Puntaje global ponderado + puntajes por componente (materiales).
          </div>
        </div>
        <span class="pill" id="liveState">Estado: —</span>
      </div>

      <div class="mini">
        <div class="row">
          <div>
            <div class="muted">Puntaje global</div>
            <div class="bigNum" id="overallScore">—</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Calidad</div>
            <div class="big" id="overallBand">—</div>
            <div class="muted" id="overallSummary" style="font-size:12px;margin-top:4px;max-width:260px;">—</div>
          </div>
        </div>
      </div>

      <div class="mini">
        <h3>Materiales (por componente)</h3>
        <div class="barWrap" id="bars"></div>
      </div>

      <div class="twoCol">
        <div class="mini">
          <h3>Hallazgos</h3>
          <div class="muted" style="font-size:12px;margin-top:-2px">Déficits y posibles excesos por desbalance.</div>
          <ul id="findings"></ul>
        </div>

        <div class="mini">
          <h3>Enfoque (siguiente ajuste)</h3>
          <ul id="focus"></ul>
        </div>
      </div>

      <div class="mini">
        <h3>Verso fundamento</h3>
        <div class="muted" id="verse"></div>
      </div>

      <div class="mini">
        <h3>Reglas rápidas</h3>
        <ul id="rules"></ul>
      </div>

      <div class="btns">
        <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
        <button class="ghost" id="btnPdf" disabled>Descargar PDF premium</button>
        <button class="ghost" id="btnTeachPdf" disabled>PDF Enseñanza (Libro)</button>
        <button class="ghost" id="btnReset">Borrar todo</button>
      </div>
    </div>

    <!-- DER: FORM + PREGUNTAS -->
    <div class="card">
      <div class="row">
        <div>
          <b>Formulario</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            Responde según práctica real (últimas 2–4 semanas).
          </div>
        </div>
        <span class="pill">Autoevaluación</span>
      </div>

      <div class="fieldgrid">
        <div>
          <label>Hogar / Familia</label>
          <input id="home" placeholder="Ej: Hogar Abraham y Sara">
        </div>
        <div>
          <label>Acompañante (opcional)</label>
          <input id="mentor" placeholder="Ej: Pastor / Consejero">
        </div>
        <div>
          <label>Fecha</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Observaciones</label>
          <textarea id="notes" placeholder="Contexto, acuerdos, tensiones actuales…"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div id="questions"></div>

      <div class="btns">
        <button class="primary" id="btnCalc">Calcular diagnóstico</button>
        <button class="ghost" id="btnClear">Limpiar respuestas</button>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
const JSON_PATH = "concreto-espiritual.json";
const STORAGE_KEY = "concreto_espiritual_v1";

let DATA = null;

const state = {
  header: { home:"", mentor:"", date:"", notes:"" },
  answers: {} // questionId -> value (1-5)
};

// ===== Helpers =====
const $ = id => document.getElementById(id);

function save(){
  state.header.home = $("home").value || "";
  state.header.mentor = $("mentor").value || "";
  state.header.date = $("date").value || "";
  state.header.notes = $("notes").value || "";
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const p = JSON.parse(raw);
    state.header = p.header || state.header;
    state.answers = p.answers || {};
  }catch(e){}
}

function setDate(){
  if($("date").value) return;
  const d = new Date();
  $("date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function okPdfLib(){
  return !!(window.jspdf && window.jspdf.jsPDF) &&
    !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
}

function safeName(name){
  return (name||"hogar")
    .toLowerCase().replace(/\s+/g,"_")
    .replace(/[^a-z0-9_\-]/g,"")
    .slice(0,60);
}

function requireComplete(){
  const answered = Object.keys(state.answers).length;
  if(answered < DATA.questions.length){
    alert("Responde todas las preguntas antes de exportar PDF.");
    return false;
  }
  return true;
}

function renderRules(){
  const rules = $("rules");
  rules.innerHTML = "";
  (DATA.texts.rules || []).forEach(r=>{
    const li = document.createElement("li");
    li.textContent = r;
    rules.appendChild(li);
  });
}

// ===== Render preguntas =====
function renderQuestions(){
  const wrap = $("questions");
  wrap.innerHTML = "";
  DATA.questions.forEach(q=>{
    const block = document.createElement("div");
    block.className = "qBlock";
    block.innerHTML = `
      <div class="qHead">
        <b>${q.text}</b>
        <span class="tag">${q.component}</span>
      </div>
      <div class="qHelp">${q.help || ""}</div>
      <div class="qOpts">
        ${DATA.scale.labels.map(l=>`
          <label class="opt ${state.answers[q.id]==l.value?"sel":""}">
            <input type="radio" name="${q.id}" value="${l.value}">
            <b>${l.value}</b>
            <small>${l.label}</small>
          </label>
        `).join("")}
      </div>
    `;
    wrap.appendChild(block);

    block.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        state.answers[q.id] = Number(inp.value);
        save();
        renderQuestions();
        updateCounts();
      });
    });
  });
}

// ===== Cálculo =====
function calc(){
  const compScores = {};
  DATA.components.forEach(c=> compScores[c.key] = []);

  DATA.questions.forEach(q=>{
    const v = state.answers[q.id];
    if(v) compScores[q.component].push(v);
  });

  const compResult = {};
  let total = 0;

  DATA.components.forEach(c=>{
    const arr = compScores[c.key];
    const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const pct = Math.round((avg / DATA.scale.max) * 100);
    compResult[c.key] = { pct, avg };
    total += pct * c.weight;
  });

  const overall = Math.round(total);
  return { overall, compResult };
}

// ===== Band =====
function bandFor(score){
  return DATA.bands.find(b=> score>=b.min && score<=b.max) || DATA.bands[DATA.bands.length-1];
}

function updateCounts(){
  $("qCount").textContent = `Preguntas: ${DATA.questions.length}`;
  $("ansCount").textContent = `Respondidas: ${Object.keys(state.answers).length}/${DATA.questions.length}`;
}

// ===== Render resultados =====
function renderResult(){
  updateCounts();

  const answered = Object.keys(state.answers).length;

  if(answered < DATA.questions.length){
    $("liveState").textContent = "Estado: incompleto";
    $("btnTxt").disabled = true;
    $("btnPdf").disabled = true;
    $("btnTeachPdf").disabled = true;
    return;
  }

  const { overall, compResult } = calc();
  const band = bandFor(overall);

  $("overallScore").textContent = overall;
  $("overallBand").textContent = band.label;
  $("overallSummary").textContent = band.summary;
  $("bandPill").textContent = `Calidad: ${band.label}`;
  $("liveState").textContent = "Estado: evaluado";

  // Bars
  const bars = $("bars");
  bars.innerHTML = "";
  DATA.components.forEach(c=>{
    const r = compResult[c.key];
    const div = document.createElement("div");
    div.className = "barItem";
    div.innerHTML = `
      <div class="barTop">
        <div class="barTitle">${c.label}</div>
        <div class="barNum">${r.pct}%</div>
      </div>
      <div class="barBg">
        <div class="barFill" style="width:${r.pct}%;background:${band.badgeColor}"></div>
      </div>
      <div class="muted" style="font-size:12px;margin-top:6px">${c.summary}</div>
    `;
    bars.appendChild(div);
  });

  // Findings
  const f = $("findings");
  f.innerHTML = "";
  const lows = [];
  const highs = [];

  Object.entries(compResult).forEach(([k,v])=>{
    if(v.pct < 60) lows.push(k);
    if(v.pct > 90) highs.push(k);
  });

  if(lows.length===0 && highs.length===0){
    f.innerHTML = "<li>Sin desbalances críticos detectados.</li>";
  } else {
    lows.forEach(l=> f.innerHTML += `<li>Déficit en <b>${l}</b></li>`);
    highs.forEach(h=> f.innerHTML += `<li>Posible exceso en <b>${h}</b></li>`);
  }

  // Focus
  const fo = $("focus");
  fo.innerHTML = "";
  band.focus.forEach(x=> fo.innerHTML += `<li>${x}</li>`);

  // Verse
  $("verse").textContent = `${DATA.verses.foundation.quote} (${DATA.verses.foundation.reference})`;

  // Rules
  renderRules();

  // Enable buttons
  $("btnTxt").disabled = false;
  $("btnPdf").disabled = !okPdfLib();
  $("btnTeachPdf").disabled = !okPdfLib();

  // PDF warn
  $("pdfWarn").style.display = okPdfLib() ? "none" : "block";
}

// ===== TXT =====
function downloadTXT(){
  const { overall, compResult } = calc();
  const band = bandFor(overall);

  let out = [];
  out.push("CONCRETO ESPIRITUAL — DIAGNÓSTICO");
  out.push("");
  out.push(`Hogar: ${$("home").value}`);
  out.push(`Fecha: ${$("date").value}`);
  out.push("");
  out.push(`PUNTAJE GLOBAL: ${overall}`);
  out.push(`CALIDAD: ${band.label}`);
  out.push(band.summary);
  out.push("");
  out.push("COMPONENTES:");
  DATA.components.forEach(c=>{
    out.push(`- ${c.label}: ${compResult[c.key].pct}%`);
  });
  out.push("");
  out.push("ENFOQUE 7 DÍAS:");
  band.focus.forEach(x=> out.push("• "+x));

  const blob = new Blob([out.join("\n")], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "concreto_espiritual.txt";
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===== PDF premium =====
function downloadPDFPremium(){
  if(!okPdfLib()){
    $("pdfWarn").style.display="block";
    alert("No se pudo cargar jsPDF/AutoTable. Revisa internet/CDN.");
    return;
  }
  if(!requireComplete()) return;

  const { overall, compResult } = calc();
  const band = bandFor(overall);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"letter"});

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 44;

  // Header
  doc.setFillColor(22,33,58);
  doc.rect(0,0,W,90,"F");
  doc.setTextColor(255,255,255);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("CONCRETO ESPIRITUAL — PDF PREMIUM", M, 52);

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);
  doc.setTextColor(210,230,255);
  doc.text("Puntaje global + Componentes + Hallazgos + Plan 7 días", M, 72);

  // Datos
  doc.setTextColor(22,33,58);
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text("Datos", M, 130);
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(`Hogar: ${$("home").value || "(no especificado)"}`, M, 152);
  doc.text(`Acompañante: ${$("mentor").value || "(no especificado)"}`, M, 170);
  doc.text(`Fecha: ${$("date").value || "(no especificada)"}`, M, 188);

  // Resultado
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text("Resultado", M, 224);

  doc.setFont("helvetica","bold"); doc.setFontSize(28);
  doc.setTextColor(16,185,129);
  doc.text(String(overall), M, 256);

  doc.setTextColor(22,33,58);
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.text(`Calidad: ${band.label}`, M+70, 256);

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.setTextColor(70,90,110);
  doc.text(doc.splitTextToSize(band.summary || "", W-M*2), M, 282);

  // Verso
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.setTextColor(22,33,58);
  doc.text("Verso fundamento", M, 330);
  doc.setFont("times","italic"); doc.setFontSize(11);
  doc.setTextColor(20,60,70);
  doc.text(doc.splitTextToSize(DATA.verses.foundation.quote, W-M*2), M, 354);
  doc.setFont("helvetica","normal"); doc.setFontSize(9);
  doc.setTextColor(90,102,130);
  doc.text(`(${DATA.verses.foundation.reference})`, M, 388);

  // Page 2: tabla componentes
  doc.addPage();
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(22,33,58);
  doc.text("Materiales (por componente)", M, 60);
  doc.setDrawColor(230); doc.line(M, 70, W-M, 70);

  doc.autoTable({
    startY: 92,
    head: [["Componente", "Puntaje (%)", "Peso", "Resumen"]],
    body: DATA.components.map(c=>[
      c.label,
      `${compResult[c.key].pct}%`,
      `${Math.round(c.weight*100)}%`,
      c.summary
    ]),
    theme:"grid",
    styles:{font:"helvetica", fontSize:10, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
    headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
    margin:{left:M, right:M}
  });

  // Page 3: hallazgos + plan
  doc.addPage();
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(22,33,58);
  doc.text("Hallazgos + Plan 7 días", M, 60);
  doc.setDrawColor(230); doc.line(M, 70, W-M, 70);

  const lows = [];
  const highs = [];
  Object.entries(compResult).forEach(([k,v])=>{
    if(v.pct < 60) lows.push(k);
    if(v.pct > 90) highs.push(k);
  });

  doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(22,33,58);
  doc.text("Hallazgos", M, 98);

  doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(22,33,58);
  const lines = [];
  if(lows.length===0 && highs.length===0) lines.push("• Sin desbalances críticos detectados.");
  lows.forEach(k=> lines.push(`• Déficit: ${k}`));
  highs.forEach(k=> lines.push(`• Posible exceso: ${k}`));
  doc.text(doc.splitTextToSize(lines.join("\n"), W-M*2), M, 120);

  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text("Enfoque (7 días)", M, 210);
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(doc.splitTextToSize((band.focus||[]).map(x=>"• "+x).join("\n"), W-M*2), M, 232);

  const planRows = (DATA.planTemplates.plan7||[]).map(d=>[
    `Día ${d.day}`,
    d.title,
    (d.items||[]).join(" • ")
  ]);

  doc.autoTable({
    startY: 320,
    head: [["Día", "Enfoque", "Acciones"]],
    body: planRows,
    theme:"grid",
    styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
    headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
    columnStyles:{0:{cellWidth:70},1:{cellWidth:170},2:{cellWidth:W-M*2-70-170}},
    margin:{left:M, right:M}
  });

  // Footer
  const pages = doc.getNumberOfPages();
  for(let i=1;i<=pages;i++){
    doc.setPage(i);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(90,102,130);
    doc.text("Concreto Espiritual — Diagnóstico de Materiales del Hogar", M, H-18);
    doc.text(`Página ${i} de ${pages}`, W-M, H-18, {align:"right"});
  }

  doc.save(`${safeName($("home").value)}_concreto_premium.pdf`);
}

// ===== PDF Enseñanza =====
function downloadTeachingPDF(){
  if(!okPdfLib()){
    $("pdfWarn").style.display="block";
    alert("No se pudo cargar jsPDF/AutoTable. Revisa internet/CDN.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"letter"});

  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 44;

  const INK = [22,33,58];
  const MUTED = [90,102,130];

  const T = DATA.teachingPdf;

  // Portada
  doc.setFillColor(22,33,58);
  doc.rect(0,0,W,110,"F");
  doc.setTextColor(255,255,255);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(T.title, M, 56);

  doc.setFont("helvetica","normal");
  doc.setFontSize(11.5);
  doc.setTextColor(210,230,255);
  doc.text(doc.splitTextToSize(T.subtitle, W-M*2), M, 84);

  // Marco
  doc.setFillColor(255,255,255);
  doc.roundedRect(M, 140, W-M*2, 190, 12, 12, "F");
  doc.setTextColor(...INK);
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text("Marco (como el libro)", M+14, 166);

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text((T.frame||[]).map(x=>"• "+x).join("\n"), M+14, 190);

  // Cómo usar
  doc.addPage();
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.setTextColor(...INK);
  doc.text("Cómo usar la app", M, 60);
  doc.setDrawColor(230); doc.line(M, 70, W-M, 70);

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(doc.splitTextToSize((T.howToUse||[]).map(x=>"• "+x).join("\n"), W-M*2), M, 98);

  // Tabla componentes
  doc.addPage();
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.setTextColor(...INK);
  doc.text("Componentes (mapa del concreto)", M, 60);
  doc.setDrawColor(230); doc.line(M, 70, W-M, 70);

  doc.autoTable({
    startY: 92,
    head: [["Elemento", "Peso", "Descripción"]],
    body: DATA.components.map(c=>[c.label, `${Math.round(c.weight*100)}%`, c.summary]),
    theme:"grid",
    styles:{font:"helvetica", fontSize:10, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
    headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
    margin:{left:M, right:M}
  });

  // Cierre
  doc.addPage();
  doc.setFont("helvetica","bold"); doc.setFontSize(14);
  doc.setTextColor(...INK);
  doc.text("Cierre", M, 60);
  doc.setDrawColor(230); doc.line(M, 70, W-M, 70);

  doc.setFillColor(245,247,255);
  doc.roundedRect(M, 92, W-M*2, 190, 12, 12, "F");
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.setTextColor(...INK);
  doc.text("Cierre (modelo)", M+14, 118);

  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(doc.splitTextToSize((T.closing||[]).map(x=>"• "+x).join("\n"), W-M*2-28), M+14, 144);

  // Footer
  const pages = doc.getNumberOfPages();
  for(let i=1;i<=pages;i++){
    doc.setPage(i);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(...MUTED);
    doc.text("Enseñanza — Concreto Espiritual (Diagnóstico de Materiales)", M, H-18);
    doc.text(`Página ${i} de ${pages}`, W-M, H-18, {align:"right"});
  }

  doc.save(`${safeName($("home").value)}_ensenanza_concreto.pdf`);
}

// ===== Reset =====
function resetAll(){
  if(!confirm("¿Borrar todo el diagnóstico?")) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// ===== Init =====
async function init(){
  const res = await fetch(JSON_PATH);
  DATA = await res.json();

  $("t").textContent = DATA.meta.title;
  $("d").textContent = DATA.meta.description;

  load();
  $("home").value = state.header.home;
  $("mentor").value = state.header.mentor;
  $("date").value = state.header.date;
  $("notes").value = state.header.notes;
  setDate();

  renderQuestions();
  updateCounts();
  renderRules();

  // aviso si PDF libs no cargan
  $("pdfWarn").style.display = okPdfLib() ? "none" : "block";
}

$("btnCalc").addEventListener("click", renderResult);
$("btnClear").addEventListener("click", resetAll);

$("btnTxt").addEventListener("click", ()=>{
  // TXT solo si está completo
  if(Object.keys(state.answers).length < DATA.questions.length){
    alert("Responde todas las preguntas antes de exportar TXT.");
    return;
  }
  downloadTXT();
});

// ✅ PDFs funcionando
$("btnPdf").addEventListener("click", downloadPDFPremium);
$("btnTeachPdf").addEventListener("click", downloadTeachingPDF);

$("btnReset").addEventListener("click", resetAll);

["home","mentor","date","notes"].forEach(id=>{
  $(id).addEventListener("input", save);
});

init();
</script>
</body>
</html>