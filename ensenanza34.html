<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auditoría del Hogar — Sistema Estructural</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --accent:#5eead4; --line:rgba(255,255,255,.10);
      --danger:#fb7185;
      --green:rgba(94,234,212,.18); --yellow:rgba(250,204,21,.14);
      --orange:rgba(251,146,60,.14); --red:rgba(251,113,133,.14);
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 1050px; margin: 0 auto; padding: 24px; }
    .hero{ background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08)); border:1px solid var(--line); border-radius:18px; padding:18px; }
    h1{ margin:0 0 6px; font-size:28px; }
    .sub{ margin:0; color:var(--muted); line-height:1.4; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); font-size:12px; margin-right:8px; }
    .card{ margin-top:16px; background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px; }
    .sec-head{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .sec-head h2{ margin:0; font-size:18px; }
    .sec-sub{ color:var(--muted); font-size:13px; margin-top:4px; }
    .q{ padding:12px 0; border-top:1px solid var(--line); }
    .q:first-of-type{ border-top:none; }
    .q label{ display:block; font-weight:650; }
    .opts{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .opt{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); cursor:pointer; user-select:none; }
    .actions{ margin-top: 16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{ border:0; border-radius:14px; padding:12px 14px; font-weight:800; cursor:pointer; }
    .primary{ background:var(--accent); color:#071018; }
    .ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18); }
    .muted{ color:var(--muted); }
    .result{ margin-top:16px; border:1px solid var(--line); border-radius:18px; padding:16px; background:rgba(255,255,255,.04); display:none; }
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; letter-spacing:.4px; border:1px solid rgba(255,255,255,.12); }
    .b-green{ background:var(--green); color:var(--accent); border-color:rgba(94,234,212,.35); }
    .b-yellow{ background:var(--yellow); color:#fde68a; border-color:rgba(250,204,21,.30); }
    .b-orange{ background:var(--orange); color:#fdba74; border-color:rgba(251,146,60,.30); }
    .b-red{ background:var(--red); color:var(--danger); border-color:rgba(251,113,133,.30); }
    blockquote{ margin:10px 0; padding:10px 12px; border-left:3px solid rgba(94,234,212,.45); background:rgba(94,234,212,.06); border-radius:10px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:980px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .mini{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(255,255,255,.03); }
    .mini h4{ margin:0 0 6px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.45; }
    .error{ color:var(--danger); }
    .fieldgrid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px; }
    @media(min-width:800px){ .fieldgrid{ grid-template-columns: 1fr 1fr; } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-weight:700; font-size:13px; }
    .field input, .field textarea{
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
    }
    .field textarea{ min-height: 90px; resize: vertical; }
    .toggleRow{ margin-top:10px; display:flex; align-items:center; gap:10px; }
    .toggleRow input{ transform: scale(1.2); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="title">Auditoría del Hogar — Sistema Estructural</h1>
      <p class="sub" id="desc"></p>
      <div style="margin-top:10px;">
        <span class="pill" id="scalePill"></span>
        <span class="pill" id="maxPill"></span>
      </div>
    </div>

    <div class="card">
      <div class="sec-head">
        <div>
          <h2>Datos de auditoría</h2>
          <div class="sec-sub">Se incluyen en el informe descargable. No se envían a ningún servidor.</div>
        </div>
        <span class="pill">Cabecera</span>
      </div>

      <div class="fieldgrid">
        <div class="field">
          <label for="patientName">Nombre del paciente</label>
          <input id="patientName" type="text" placeholder="Ej: Juan y María Pérez" />
        </div>

        <div class="field">
          <label for="auditorName">Nombre del auditor</label>
          <input id="auditorName" type="text" placeholder="Ej: Pastor / Consejero" />
        </div>

        <div class="field">
          <label for="auditDate">Fecha (editable)</label>
          <input id="auditDate" type="date" />
        </div>

        <div class="field">
          <label for="freeNotes">Observaciones libres</label>
          <textarea id="freeNotes" placeholder="Contexto, motivo, acuerdos, etc."></textarea>
        </div>
      </div>

      <div class="toggleRow">
        <input type="checkbox" id="includeDetails" checked />
        <label for="includeDetails" class="small">Incluir respuestas por pregunta al final del informe</label>
      </div>
    </div>

    <div id="form"></div>

    <div class="actions">
      <button class="primary" id="btnResult">Ver resultado</button>
      <button class="ghost" id="btnDownload" disabled>Descargar evaluación</button>
      <button class="ghost" id="btnReset">Reiniciar</button>
      <span class="muted" id="liveScore">Puntaje actual: 0</span>
    </div>

    <div id="result" class="result"></div>
  </div>

<script>
  const JSON_PATH = "ensenanza34.json";

  let DATA = null;
  const state = {};
  let lastReportText = "";

  const formEl = document.getElementById("form");
  const resultEl = document.getElementById("result");
  const liveScoreEl = document.getElementById("liveScore");
  const btnDownload = document.getElementById("btnDownload");

  const patientNameEl = document.getElementById("patientName");
  const auditorNameEl = document.getElementById("auditorName");
  const auditDateEl = document.getElementById("auditDate");
  const freeNotesEl = document.getElementById("freeNotes");
  const includeDetailsEl = document.getElementById("includeDetails");

  function setDefaultDateOnlyIfEmpty(){
    if (auditDateEl.value) return;
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    auditDateEl.value = `${yyyy}-${mm}-${dd}`;
  }

  function maxOptionValue(){
    return Math.max(...DATA.scale.options.map(o => Number(o.value)));
  }

  function totalQuestions(){
    return DATA.sections.reduce((acc, sec) => acc + sec.questions.length, 0);
  }

  function totalMaxScore(){
    return totalQuestions() * maxOptionValue();
  }

  function totalScore(){
    let sum = 0;
    DATA.sections.forEach(sec=>{
      sec.questions.forEach(q=>{
        sum += (state[q.id] ?? 0);
      });
    });
    return sum;
  }

  function sectionScore(sec){
    return sec.questions.reduce((acc, q)=> acc + (state[q.id] ?? 0), 0);
  }

  function badgeClass(label){
    const s = (label||"").toLowerCase();
    if(s.includes("aline")) return "b-green";
    if(s.includes("ajus")) return "b-yellow";
    if(s.includes("ries")) return "b-orange";
    return "b-red";
  }

  function updateLiveScore(){
    liveScoreEl.textContent = `Puntaje actual: ${totalScore()}`;
  }

  // Bandas por porcentaje para que funcione con cualquier max real
  function bandSection(score, secMax){
    const pct = secMax === 0 ? 0 : (score / secMax) * 100;
    if (pct <= 26.6667) return DATA.rubrics.sectionBands.find(b=>b.key==="alineado");
    if (pct <= 60) return DATA.rubrics.sectionBands.find(b=>b.key==="ajuste");
    return DATA.rubrics.sectionBands.find(b=>b.key==="riesgo");
  }

  function bandGlobal(score, max){
    const pct = max === 0 ? 0 : (score / max) * 100;
    if (pct <= 22.2222) return DATA.rubrics.globalBands.find(b=>b.key==="g_alineado");
    if (pct <= 44.4444) return DATA.rubrics.globalBands.find(b=>b.key==="g_ajuste");
    if (pct <= 70.3704) return DATA.rubrics.globalBands.find(b=>b.key==="g_riesgo");
    return DATA.rubrics.globalBands.find(b=>b.key==="g_critico");
  }

  function manualForSection(sectionId){
    if(!DATA.pastoralManual || !DATA.pastoralManual.sections) return null;
    return DATA.pastoralManual.sections.find(s => s.id === sectionId) || null;
  }

  function renderHeader(){
    document.getElementById("title").textContent = DATA.meta.title || "Auditoría del Hogar";
    document.getElementById("desc").textContent = DATA.meta.description || "";
    const scaleText = DATA.scale.options.map(o => `${o.value} ${o.label}`).join(" · ");
    document.getElementById("scalePill").textContent = `Escala: ${scaleText}`;
    document.getElementById("maxPill").textContent = `Total máx: ${totalMaxScore()}`;
  }

  function renderForm(){
    formEl.innerHTML = "";

    DATA.sections.forEach(sec=>{
      const card = document.createElement("div");
      card.className = "card";

      const subtitle = sec.subtitle || "";
      const focus = sec.diagnosticFocus || "";
      const secMax = sec.questions.length * maxOptionValue();

      const head = document.createElement("div");
      head.className = "sec-head";
      head.innerHTML = `
        <div>
          <h2>${sec.title || "Sección"}</h2>
          ${subtitle ? `<div class="sec-sub">${subtitle}</div>` : ""}
          ${focus ? `<div class="sec-sub"><b>Enfoque:</b> ${focus}</div>` : ""}
        </div>
        <span class="pill">Máx sección: ${secMax}</span>
      `;
      card.appendChild(head);

      sec.questions.forEach((q, idx)=>{
        const qDiv = document.createElement("div");
        qDiv.className = "q";

        const optionsHTML = DATA.scale.options.map(opt => `
          <label class="opt">
            <input type="radio" name="${q.id}" value="${opt.value}">
            <span>${opt.label} (${opt.value})</span>
          </label>
        `).join("");

        qDiv.innerHTML = `
          <label>${idx+1}. ${q.text || ""}</label>
          <div class="opts" role="radiogroup" aria-label="${q.text || ""}">
            ${optionsHTML}
          </div>
        `;
        card.appendChild(qDiv);

        qDiv.querySelectorAll(`input[name="${q.id}"]`).forEach(inp=>{
          inp.addEventListener("change", e=>{
            state[q.id] = Number(e.target.value);
            updateLiveScore();
          });
        });
      });

      formEl.appendChild(card);
    });
  }

  function reportText(globalScore, globalBand, sectionsBreakdown, includeDetails){
    const max = totalMaxScore();
    const lines = [];

    lines.push("EVALUACIÓN — AUDITORÍA DEL HOGAR (SISTEMA ESTRUCTURAL)");
    lines.push("");
    lines.push("DATOS");
    lines.push(`Paciente: ${patientNameEl.value.trim() || "(no especificado)"}`);
    lines.push(`Auditor: ${auditorNameEl.value.trim() || "(no especificado)"}`);
    lines.push(`Fecha: ${auditDateEl.value || "(no especificada)"}`);
    lines.push("Observaciones:");
    lines.push(freeNotesEl.value.trim() || "(sin observaciones)");
    lines.push("");

    lines.push("RESULTADO GLOBAL");
    lines.push(`Puntaje: ${globalScore} / ${max}`);
    lines.push(`Diagnóstico: ${globalBand.label}`);
    lines.push(`Resumen: ${globalBand.summary}`);
    lines.push(`${globalBand.verse.quote} (${globalBand.verse.reference})`);
    lines.push("Acciones sugeridas:");
    globalBand.actions.forEach(a => lines.push("• " + a));
    lines.push("");

    lines.push("DIAGNÓSTICO POR SECCIONES (INDEPENDIENTE)");
    lines.push("--------------------------------------------------");
    sectionsBreakdown.forEach(sb=>{
      lines.push(`${sb.title} — ${sb.score}/${sb.max} — ${sb.band.label}`);
      if(sb.focus) lines.push(`Enfoque: ${sb.focus}`);
      lines.push(`Resumen: ${sb.band.summary}`);
      lines.push(`${sb.band.verse.quote} (${sb.band.verse.reference})`);
      lines.push("Recomendaciones:");
      sb.band.recommendation.forEach(r => lines.push("• " + r));
      if(sb.manual){
        lines.push("");
        lines.push("Mini-enseñanza pastoral (sección):");
        lines.push(sb.manual.miniTeaching.title);
        sb.manual.miniTeaching.text.forEach(t => lines.push("- " + t));
        lines.push(`${sb.manual.miniTeaching.verse.quote} (${sb.manual.miniTeaching.verse.reference})`);
        lines.push("Claves:");
        sb.manual.miniTeaching.keys.forEach(k => lines.push("• " + k));
        lines.push("Plan 1 semana:");
        sb.manual.miniTeaching.oneWeekPlan.forEach(p => lines.push("• " + p));
      }
      lines.push("");
    });

    if(includeDetails){
      lines.push("RESPUESTAS POR PREGUNTA");
      lines.push("--------------------------------------------------");
      DATA.sections.forEach(sec=>{
        lines.push((sec.title || "Sección").toUpperCase());
        sec.questions.forEach((q, i)=>{
          const val = (state[q.id] ?? 0);
          const opt = DATA.scale.options.find(o=>Number(o.value)===val);
          const lab = opt ? opt.label : "Sin respuesta";
          lines.push(`${i+1}. ${q.text}`);
          lines.push(`   Respuesta: ${lab} (${val})`);
        });
        lines.push("");
      });
    }

    lines.push("NOTA PASTORAL");
    lines.push("Este resultado no juzga personas; describe el sistema. El objetivo es orientar proceso, no imponer culpa.");
    lines.push("");

    return lines.join("\n");
  }

  function showResult(){
    const gScore = totalScore();
    const gMax = totalMaxScore();
    const gBand = bandGlobal(gScore, gMax);
    const globalBadge = badgeClass(gBand.label);

    const sectionsBreakdown = DATA.sections.map(sec=>{
      const sScore = sectionScore(sec);
      const sMax = sec.questions.length * maxOptionValue();
      const sBand = bandSection(sScore, sMax);
      const manual = manualForSection(sec.id);
      return {
        id: sec.id,
        title: sec.title || "Sección",
        focus: sec.diagnosticFocus || "",
        score: sScore,
        max: sMax,
        band: sBand,
        manual: manual
      };
    });

    // Ordenar: sección más crítica primero (mayor score %)
    sectionsBreakdown.sort((a,b)=>{
      const ap = a.max ? a.score/a.max : 0;
      const bp = b.max ? b.score/b.max : 0;
      return bp - ap;
    });

    const sectionCards = sectionsBreakdown.map(sb => {
      const mt = sb.manual?.miniTeaching;
      return `
        <div class="mini">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <h4>${sb.title}</h4>
            <span class="badge ${badgeClass(sb.band.label)}">${sb.band.label}</span>
          </div>
          <div class="small"><b>Puntaje:</b> ${sb.score}/${sb.max}</div>
          ${sb.focus ? `<div class="small"><b>Enfoque:</b> ${sb.focus}</div>` : ""}
          <div class="small" style="margin-top:6px;"><b>Resumen:</b> ${sb.band.summary}</div>
          <blockquote>${sb.band.verse.quote}<br><span class="muted">(${sb.band.verse.reference})</span></blockquote>
          <div class="small"><b>Recomendaciones:</b>
            <ul style="margin:6px 0 0 18px; padding:0;">
              ${sb.band.recommendation.map(r => `<li>${r}</li>`).join("")}
            </ul>
          </div>

          ${mt ? `
          <div class="small" style="margin-top:10px;">
            <b>Mini-enseñanza pastoral:</b><br>
            <span style="color:var(--text); font-weight:800;">${mt.title}</span>
            <ul style="margin:6px 0 0 18px; padding:0;">
              ${mt.text.map(t => `<li>${t}</li>`).join("")}
            </ul>
            <blockquote>${mt.verse.quote}<br><span class="muted">(${mt.verse.reference})</span></blockquote>
            <div class="small"><b>Claves:</b>
              <ul style="margin:6px 0 0 18px; padding:0;">
                ${mt.keys.map(k => `<li>${k}</li>`).join("")}
              </ul>
            </div>
            <div class="small" style="margin-top:6px;"><b>Plan 1 semana:</b>
              <ul style="margin:6px 0 0 18px; padding:0;">
                ${mt.oneWeekPlan.map(p => `<li>${p}</li>`).join("")}
              </ul>
            </div>
          </div>
          ` : ""}
        </div>
      `;
    }).join("");

    resultEl.style.display = "block";
    resultEl.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
        <div>
          <span class="badge ${globalBadge}">${gBand.label}</span>
          <div class="muted" style="margin-top:6px;">Puntaje total: <b>${gScore}</b> / ${gMax}</div>
          <div class="muted" style="margin-top:4px;">${gBand.summary}</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <h3 style="margin:0 0 8px;">Enseñanza global</h3>
        <blockquote>${gBand.verse.quote}<br><span class="muted">(${gBand.verse.reference})</span></blockquote>
        <div class="small"><b>Acciones sugeridas:</b>
          <ul style="margin:6px 0 0 18px; padding:0;">
            ${gBand.actions.map(a => `<li>${a}</li>`).join("")}
          </ul>
        </div>
      </div>

      <h3 style="margin-top:18px;">Diagnóstico por secciones (más crítico primero)</h3>
      <div class="grid">${sectionCards}</div>
    `;

    lastReportText = reportText(gScore, gBand, sectionsBreakdown, includeDetailsEl.checked);
    btnDownload.disabled = false;
    resultEl.scrollIntoView({behavior:"smooth"});
  }

  function downloadReport(){
    if(!lastReportText) return;
    const blob = new Blob([lastReportText], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "evaluacion_hogar.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll(){
    Object.keys(state).forEach(k => delete state[k]);
    document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
    updateLiveScore();
    resultEl.style.display = "none";
    resultEl.innerHTML = "";
    btnDownload.disabled = true;
    lastReportText = "";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  async function init(){
    try{
      const res = await fetch(JSON_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("No se pudo cargar el JSON: " + res.status);
      DATA = await res.json();
      renderHeader();
      setDefaultDateOnlyIfEmpty();
      renderForm();
      updateLiveScore();
    }catch(err){
      formEl.innerHTML = `<div class="card"><div class="error"><b>Error:</b> ${err.message}</div><div class="small">Asegúrate de que <b>${JSON_PATH}</b> esté en la misma carpeta del HTML.</div></div>`;
    }
  }

  document.getElementById("btnResult").addEventListener("click", showResult);
  document.getElementById("btnReset").addEventListener("click", resetAll);
  document.getElementById("btnDownload").addEventListener("click", downloadReport);

  init();
</script>
</body>
</html>