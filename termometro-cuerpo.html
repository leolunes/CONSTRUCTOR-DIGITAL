<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Term√≥metro del Cuerpo ‚Äî Sanidad integral</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1150px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:520px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .muted{color:var(--muted);}
    .sec{border-top:1px solid var(--line);padding-top:10px;margin-top:10px;}
    .sec:first-child{border-top:none;padding-top:0;margin-top:0;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, textarea{
      width:100%;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .opts{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .opt{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:8px 10px;cursor:pointer;user-select:none;}
    .opt input{width:auto}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .result{display:none;margin-top:12px;border-radius:18px;border:1px solid var(--line);padding:14px;background:rgba(255,255,255,.04);}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.4px;}
    .bG{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.35);}
    .bY{background:rgba(245,158,11,.18);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
    .bO{background:rgba(249,115,22,.18);color:#fdba74;border:1px solid rgba(249,115,22,.35);}
    .bR{background:rgba(244,63,94,.18);color:#fda4af;border:1px solid rgba(244,63,94,.35);}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .dangerNote{
      margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(244,63,94,.35);
      background:rgba(244,63,94,.10);color:#fda4af;font-size:13px;line-height:1.35;
    }
    .toggleRow{margin-top:10px;display:flex;gap:10px;align-items:center;}
    .toggleRow input{transform:scale(1.1)}
    .small{font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="t">Term√≥metro del Cuerpo ‚Äî Sanidad integral</h1>
      <p class="sub" id="d"></p>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <span class="pill" id="pMax"></span>
        <span class="pill">Niveles: 0‚Äì3 (Reposo ‚Üí Alerta)</span>
        <span class="pill" id="liveGlobal">Global: ‚Äî</span>
      </div>

      <div id="disclaimer" class="dangerNote" style="display:none;"></div>
      <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
    </div>

    <div class="grid">
      <!-- IZQ: VISUAL -->
      <div class="card">
        <div class="row">
          <div>
            <b>Mapa corporal + term√≥metro</b>
            <div class="muted small" style="margin-top:4px;">
              El cuerpo puede reflejar cargas internas. Esto es una lectura pastoral, no un diagn√≥stico m√©dico.
            </div>
          </div>
          <span class="pill" id="liveScore">Puntaje: 0</span>
        </div>

        <div class="svgBox" style="margin-top:10px;">
          <svg id="viz" viewBox="0 0 520 360" width="100%" height="auto" aria-label="Mapa corporal con term√≥metro">
            <!-- Fondo -->
            <rect x="0" y="0" width="520" height="360" fill="rgba(255,255,255,.02)"></rect>

            <!-- Term√≥metro -->
            <g transform="translate(48,34)">
              <rect x="0" y="0" width="56" height="270" rx="18" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"></rect>

              <!-- columna term√≥metro -->
              <rect x="22" y="18" width="12" height="206" rx="8" fill="rgba(255,255,255,.08)"></rect>

              <!-- nivel term√≥metro (se ajusta por JS) -->
              <rect id="thermoFill" x="22" y="224" width="12" height="0" rx="8" fill="#10b981"></rect>

              <!-- bulbo -->
              <circle cx="28" cy="248" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.16)"></circle>
              <circle id="thermoBulb" cx="28" cy="248" r="14" fill="#10b981"></circle>

              <text x="28" y="300" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">TERM√ìMETRO</text>
              <text id="thermoLabel" x="28" y="316" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.65)">‚Äî</text>
            </g>

            <!-- Silueta simple -->
            <g transform="translate(180,22)">
              <!-- cabeza -->
              <circle cx="80" cy="48" r="28" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"></circle>

              <!-- tronco -->
              <rect x="44" y="78" width="72" height="130" rx="26" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"></rect>

              <!-- piernas -->
              <rect x="50" y="208" width="26" height="96" rx="12" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"></rect>
              <rect x="84" y="208" width="26" height="96" rx="12" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.16)"></rect>

              <!-- brazos -->
              <rect x="18" y="92" width="26" height="86" rx="12" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.14)"></rect>
              <rect x="116" y="92" width="26" height="86" rx="12" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.14)"></rect>

              <!-- ZONAS (se colorean por secci√≥n) -->
              <rect id="Z1" x="58" y="30" width="44" height="36" rx="14" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="52" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.9)">1</text>

              <rect id="Z2" x="56" y="90" width="48" height="34" rx="12" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="112" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.9)">2</text>

              <rect id="Z3" x="46" y="128" width="68" height="34" rx="12" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="150" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.9)">3</text>

              <rect id="Z4" x="56" y="166" width="48" height="36" rx="12" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="190" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.9)">4</text>

              <rect id="Z5" x="62" y="106" width="36" height="20" rx="10" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="121" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.9)">5</text>

              <rect id="Z6" x="56" y="230" width="48" height="44" rx="14" fill="#64748b" opacity="0.90"></rect>
              <text x="80" y="257" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.9)">6</text>

              <text x="80" y="332" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">Zonas 1‚Äì6 (por secciones)</text>
            </g>
          </svg>

          <div class="legend">
            <div class="k"><span class="dot" style="background:var(--g)"></span>Cuerpo en reposo</div>
            <div class="k"><span class="dot" style="background:var(--y)"></span>Tensi√≥n leve</div>
            <div class="k"><span class="dot" style="background:var(--o)"></span>Desgaste sostenido</div>
            <div class="k"><span class="dot" style="background:var(--r)"></span>Alerta corporal</div>
          </div>
        </div>

        <div class="result" id="resBox"></div>
      </div>

      <!-- DER: FORM -->
      <div class="card">
        <div class="row">
          <div>
            <b>Datos de sesi√≥n</b>
            <div class="muted small" style="margin-top:4px;">Se incluye en el informe. No se env√≠a a servidor.</div>
          </div>
          <span class="pill">Cabecera</span>
        </div>

        <div class="fieldgrid" style="margin-top:10px;">
          <div>
            <label>Nombre del participante</label>
            <input id="patient" placeholder="Ej: Juan P√©rez">
          </div>
          <div>
            <label>Mentor / facilitador</label>
            <input id="auditor" placeholder="Ej: Mentor / Pastor">
          </div>
          <div>
            <label>Fecha (editable)</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, s√≠ntomas referidos, etc."></textarea>
          </div>
        </div>

        <div class="toggleRow">
          <input id="details" type="checkbox" checked>
          <div class="muted small">Incluir detalle por secci√≥n en el PDF</div>
        </div>

        <div class="sec" id="secForm"></div>

        <div class="btns">
          <button class="primary" id="btnResult">Ver resultado</button>
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
          <button class="ghost" id="btnReset">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    "use strict";

    const JSON_PATH = "termometro-cuerpo.json";
    const LOGO_PATH = "logo.png";

    let DATA = null;
    let logoDataUrl = null;
    const scores = {}; // sectionId -> 0..3
    let last = null;

    const secForm = document.getElementById("secForm");
    const resBox = document.getElementById("resBox");
    const pdfWarn = document.getElementById("pdfWarn");
    const disclaimerBox = document.getElementById("disclaimer");

    const patientEl = document.getElementById("patient");
    const auditorEl = document.getElementById("auditor");
    const dateEl = document.getElementById("date");
    const notesEl = document.getElementById("notes");
    const detailsEl = document.getElementById("details");

    const liveScore = document.getElementById("liveScore");
    const liveGlobal = document.getElementById("liveGlobal");
    const btnTxt = document.getElementById("btnTxt");
    const btnPdf = document.getElementById("btnPdf");

    const thermoFill = document.getElementById("thermoFill");
    const thermoBulb = document.getElementById("thermoBulb");
    const thermoLabel = document.getElementById("thermoLabel");

    // Secci√≥n -> zona del cuerpo (Z1..Z6)
    const ZONE_MAP = {
      descanso_sueno: "Z1",
      ansiedad: "Z2",
      tension_corporal: "Z3",
      ritmos: "Z4",
      carga_emocional: "Z5",
      practicas_reposo: "Z6"
    };

    function setDefaultDateIfEmpty(){
      if(dateEl.value) return;
      const d = new Date();
      dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    function okPdfLib(){
      return !!(window.jspdf && window.jspdf.jsPDF) && !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
    }

    function levelByValue(v){
      return DATA.levels.find(x => Number(x.value) === Number(v)) || DATA.levels[0];
    }

    function totalScore(){
      return DATA.sections.reduce((acc,s) => acc + (scores[s.id] ?? 0), 0);
    }

    function globalBand(sum){
      const b = DATA.globalBands.find(x => sum >= x.min && sum <= x.max);
      return b || DATA.globalBands[0];
    }

    function badgeClassForBandKey(key){
      if(key === "g_reposo") return "bG";
      if(key === "g_ajuste") return "bY";
      if(key === "g_desgaste") return "bO";
      return "bR";
    }

    function updateBodyZones(){
      DATA.sections.forEach(sec => {
        const zoneId = ZONE_MAP[sec.id];
        if(!zoneId) return;
        const el = document.getElementById(zoneId);
        if(!el) return;
        const v = scores[sec.id] ?? 0;
        el.setAttribute("fill", levelByValue(v).color);
      });
    }

    function updateThermometer(){
      // Usamos el band global para "temperatura" visual (0..3)
      const sum = totalScore();
      const band = globalBand(sum);

      // Convertir band a nivel aproximado (0..3)
      let level = 0;
      if(band.key === "g_ajuste") level = 1;
      else if(band.key === "g_desgaste") level = 2;
      else if(band.key === "g_alerta") level = 3;

      const col = levelByValue(level).color;

      // Term√≥metro: altura m√°xima 206px (de y=18 a y=224)
      const maxH = 206;
      const h = Math.round((level / 3) * maxH);
      const y = 224 - h;

      thermoFill.setAttribute("y", String(y));
      thermoFill.setAttribute("height", String(h));
      thermoFill.setAttribute("fill", col);
      thermoBulb.setAttribute("fill", col);

      thermoLabel.textContent = (band.label || "‚Äî");
    }

    function updateLive(){
      const sum = totalScore();
      liveScore.textContent = `Puntaje: ${sum}`;
      const g = globalBand(sum);
      liveGlobal.textContent = `Global: ${g.label}`;
      updateBodyZones();
      updateThermometer();
    }

    function renderForm(){
      secForm.innerHTML = `
        <div class="muted small" style="margin-bottom:10px;">
          Selecciona el nivel por secci√≥n. 0=Cuerpo en reposo, 1=Tensi√≥n leve, 2=Desgaste sostenido, 3=Alerta corporal.
        </div>
      `;

      DATA.sections.forEach((sec, idx) => {
        scores[sec.id] = 0;

        const div = document.createElement("div");
        div.className = "sec";
        div.innerHTML = `
          <div class="row">
            <div>
              <div style="font-weight:900">${sec.title}</div>
              <div class="muted small" style="margin-top:4px">${sec.diagnosticFocus || ""}</div>
              <div class="muted small" style="margin-top:4px">Zona: <b>${idx+1}</b></div>
            </div>
            <span class="pill" id="pill_${sec.id}">${DATA.levels[0].label}</span>
          </div>

          <div class="opts" role="radiogroup" aria-label="${sec.title}">
            ${DATA.levels.map(l => `
              <label class="opt">
                <input type="radio" name="${sec.id}" value="${l.value}" ${l.value===0 ? "checked" : ""}>
                <span>${l.label} (${l.value})</span>
              </label>
            `).join("")}
          </div>

          <div class="muted small" style="margin-top:10px;">
            <b>üìñ</b> ${sec.verse.quote} <span class="muted">(${sec.verse.reference})</span>
          </div>
        `;

        div.querySelectorAll(`input[name="${sec.id}"]`).forEach(inp => {
          inp.addEventListener("change", (e) => {
            const v = Number(e.target.value);
            scores[sec.id] = v;

            const lev = levelByValue(v);
            const pill = document.getElementById(`pill_${sec.id}`);
            if(pill) pill.textContent = lev.label;

            updateLive();
          });
        });

        secForm.appendChild(div);
      });

      updateLive();
    }

    function buildPayload(){
      const header = {
        patient: patientEl.value.trim() || "(no especificado)",
        auditor: auditorEl.value.trim() || "(no especificado)",
        date: dateEl.value || "(no especificada)",
        notes: notesEl.value.trim() || ""
      };

      const sum = totalScore();
      const g = globalBand(sum);

      const sections = DATA.sections.map(sec => {
        const v = scores[sec.id] ?? 0;
        const level = levelByValue(v);
        return {
          id: sec.id,
          title: sec.title,
          levelValue: v,
          levelKey: level.key,
          levelLabel: level.label,
          color: level.color,
          verse: sec.verse,
          focus: sec.diagnosticFocus || "",
          miniTeaching: sec.miniTeaching || [],
          actions: sec.actions || []
        };
      });

      // peor arriba
      sections.sort((a,b) => b.levelValue - a.levelValue);

      const top = sections.slice(0,3);

      const plan7 = [
        { day: 1, title: `Escucha corporal + presencia (${top[0]?.title || "Secci√≥n"})`, items: [
          "Pausa 5 min: respirar y notar tensi√≥n.",
          `Leer y orar: ${top[0]?.verse?.quote || ""} (${top[0]?.verse?.reference || ""})`,
          "Nombrar 1 carga que el cuerpo est√° sosteniendo."
        ].filter(Boolean)},
        { day: 2, title: `Ajuste simple: ${top[0]?.title || "Secci√≥n"}`, items: [
          ...(top[0]?.actions?.slice(0,2) || []),
          "Cerrar el d√≠a con gratitud (3 cosas)."
        ]},
        { day: 3, title: `Ajuste simple: ${top[1]?.title || top[0]?.title || "Secci√≥n"}`, items: [
          ...(top[1]?.actions?.slice(0,2) || []),
          "Reducir una urgencia artificial (pantalla/agenda)."
        ]},
        { day: 4, title: `Ajuste simple: ${top[2]?.title || top[0]?.title || "Secci√≥n"}`, items: [
          ...(top[2]?.actions?.slice(0,2) || []),
          "Pausa 90 segundos antes de reaccionar (2 veces)."
        ]},
        { day: 5, title: "Ritmo de reposo (pr√°ctica protegida)", items: [
          "Definir 1 bloque de reposo real (30‚Äì60 min).",
          "Protegerlo sin culpa.",
          "Oraci√≥n breve: entrega de cargas."
        ]},
        { day: 6, title: "Revisi√≥n de se√±ales", items: [
          "¬øQu√© zona del cuerpo se sinti√≥ m√°s cargada hoy?",
          "¬øQu√© pensamiento/ emoci√≥n estuvo asociado?",
          "Elegir 1 microajuste para ma√±ana."
        ]},
        { day: 7, title: "Cierre y continuidad", items: [
          "Revisar puntaje: ¬øsubi√≥ o baj√≥?",
          "Elegir 1 h√°bito que se sostendr√° por 4 semanas.",
          "Si hay alerta sostenida: buscar acompa√±amiento."
        ]}
      ];

      return {
        meta: DATA.meta,
        header,
        global: { sum, band: g },
        sections,
        includeDetails: detailsEl.checked,
        plan7
      };
    }

    function showResult(){
      last = buildPayload();
      const b = last.global.band;
      const badge = badgeClassForBandKey(b.key);

      resBox.style.display = "block";
      resBox.innerHTML = `
        <div class="row">
          <div>
            <span class="badge ${badge}">${b.label}</span>
            <div class="muted" style="margin-top:6px;font-size:13px;">
              Puntaje global: <b>${last.global.sum}</b> / ${DATA.sections.length * 3}
            </div>
            <div class="muted" style="margin-top:4px;font-size:13px;">${b.summary}</div>
          </div>
        </div>

        <div style="margin-top:10px;border-left:3px solid rgba(94,234,212,.45);background:rgba(94,234,212,.06);padding:10px 12px;border-radius:12px;">
          <div style="font-style:italic;">${b.verse.quote}</div>
          <div class="muted" style="margin-top:6px;">(${b.verse.reference})</div>
        </div>

        <div class="dangerNote" style="margin-top:10px;">
          <b>Nota:</b> ${DATA.meta.disclaimer || "Herramienta pastoral. No reemplaza atenci√≥n profesional."}
        </div>
      `;

      btnTxt.disabled = false;
      const ok = okPdfLib();
      btnPdf.disabled = !ok;
      pdfWarn.style.display = ok ? "none" : "block";
    }

    function downloadTXT(){
      if(!last) return;

      const L = [];
      L.push((last.meta.title || "").toUpperCase());
      L.push("");
      L.push("DISCLAIMER");
      L.push(last.meta.disclaimer || "(sin disclaimer)");
      L.push("");
      L.push("DATOS");
      L.push(`Participante: ${last.header.patient}`);
      L.push(`Mentor/Facilitador: ${last.header.auditor}`);
      L.push(`Fecha: ${last.header.date}`);
      L.push("Observaciones:");
      L.push(last.header.notes || "(sin observaciones)");
      L.push("");
      L.push("RESULTADO GLOBAL");
      L.push(`Puntaje: ${last.global.sum}/${DATA.sections.length * 3}`);
      L.push(`Diagn√≥stico: ${last.global.band.label}`);
      L.push(last.global.band.summary);
      L.push(`${last.global.band.verse.quote} (${last.global.band.verse.reference})`);
      L.push("");
      L.push("SECCIONES (peor ‚Üí mejor)");
      L.push("--------------------------------------------------");

      last.sections.forEach(s => {
        L.push(`${s.title} ‚Äî ${s.levelLabel} (${s.levelValue})`);
        L.push(`Enfoque: ${s.focus}`);
        L.push(`Biblia: ${s.verse.quote} (${s.verse.reference})`);
        if(last.includeDetails){
          if(s.miniTeaching?.length){
            L.push("Mini-ense√±anza:");
            s.miniTeaching.forEach(x => L.push("‚Ä¢ " + x));
          }
          if(s.actions?.length){
            L.push("Acciones sugeridas:");
            s.actions.forEach(x => L.push("‚Ä¢ " + x));
          }
        }
        L.push("");
      });

      L.push("PLAN SEMANAL 7 D√çAS");
      L.push("--------------------------------------------------");
      last.plan7.forEach(d => {
        L.push(`D√≠a ${d.day}: ${d.title}`);
        d.items.forEach(i => L.push("‚Ä¢ " + i));
        L.push("");
      });

      const blob = new Blob([L.join("\n")], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "termometro_cuerpo.txt";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function loadLogo(){
      try{
        const res = await fetch(LOGO_PATH, { cache:"no-store" });
        if(!res.ok) return null;
        const blob = await res.blob();
        return await new Promise((resolve) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => resolve(null);
          fr.readAsDataURL(blob);
        });
      }catch(_e){
        return null;
      }
    }

    function levelColorRGB(label){
      const s = (label || "").toLowerCase();
      if(s.includes("reposo")) return [16,185,129];
      if(s.includes("tensi√≥n") || s.includes("tension") || s.includes("leve")) return [245,158,11];
      if(s.includes("desgaste")) return [249,115,22];
      return [244,63,94];
    }

    function safeName(name){
      return (name || "termometro_cuerpo")
        .toLowerCase()
        .replace(/\s+/g,"_")
        .replace(/[^a-z0-9_\-]/g,"")
        .slice(0,60);
    }

    async function downloadPDF(){
      if(!last) return;
      if(!okPdfLib()){
        pdfWarn.style.display = "block";
        return;
      }

      if(logoDataUrl === null){
        logoDataUrl = await loadLogo();
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"letter" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();
      const M = 44;

      const COLORS = { ink:[22,33,58], muted:[90,102,130] };

      function addLogo(x,y,w,h){
        if(!logoDataUrl) return;
        try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(_e){}
      }

      function header(){
        addLogo(M, 16, 34, 34);
        doc.setFont("helvetica","bold");
        doc.setFontSize(12);
        doc.setTextColor(...COLORS.ink);
        doc.text("Term√≥metro del Cuerpo ‚Äî Informe", W/2, 36, {align:"center"});
        doc.setDrawColor(230);
        doc.line(M, 52, W-M, 52);
        return 74;
      }

      function footer(){
        const n = doc.getNumberOfPages();
        for(let i=1;i<=n;i++){
          doc.setPage(i);
          doc.setFont("helvetica","normal");
          doc.setFontSize(9);
          doc.setTextColor(...COLORS.muted);
          doc.text("Herramienta pastoral ‚Äî no reemplaza atenci√≥n profesional", M, H-18);
          doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
        }
      }

      // PORTADA
      doc.setFillColor(22,33,58);
      doc.rect(0,0,W,96,"F");
      addLogo(W - M - 56, 18, 56, 56);

      doc.setFont("helvetica","bold");
      doc.setFontSize(22);
      doc.setTextColor(255,255,255);
      doc.text("TERM√ìMETRO DEL CUERPO", M, 50);

      doc.setFont("helvetica","normal");
      doc.setFontSize(12);
      doc.setTextColor(210,230,255);
      doc.text("Sanidad integral (lectura pastoral)", M, 72);

      doc.setFillColor(245,247,255);
      doc.roundedRect(M, 120, W-M*2, 130, 12, 12, "F");
      doc.setTextColor(...COLORS.ink);
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.text("Datos", M+14, 145);

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(`Participante: ${last.header.patient}`, M+14, 172);
      doc.text(`Mentor/Facilitador: ${last.header.auditor}`, M+14, 192);
      doc.text(`Fecha: ${last.header.date}`, M+14, 212);

      // DISCLAIMER
      doc.setFillColor(255,239,240);
      doc.roundedRect(M, 270, W-M*2, 64, 10, 10, "F");
      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      doc.setTextColor(120,20,30);
      doc.text("DISCLAIMER", M+12, 292);
      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.text(doc.splitTextToSize(DATA.meta.disclaimer || "", W-M*2-24), M+12, 310);

      // GLOBAL
      const band = last.global.band;
      const c = levelColorRGB(band.label);

      doc.setFillColor(255,255,255);
      doc.roundedRect(M, 352, W-M*2, 165, 12, 12, "F");

      const badgeText = (band.label || "").toUpperCase();
      doc.setFont("helvetica","bold");
      doc.setFontSize(10);
      const pad = 18;
      const maxW = 300;
      const bw = Math.min(maxW, doc.getTextWidth(badgeText) + pad*2);
      const bh = 26;

      doc.setFillColor(...c);
      doc.roundedRect(M+14, 372, bw, bh, 12, 12, "F");
      doc.setTextColor(255,255,255);
      doc.text(badgeText, M+14 + bw/2, 390, {align:"center"});

      doc.setTextColor(...COLORS.ink);
      doc.setFontSize(12);
      doc.text(`Puntaje global: ${last.global.sum}/${DATA.sections.length * 3}`, M+14, 420);

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(doc.splitTextToSize(band.summary, W-M*2-28), M+14, 442);

      doc.setFillColor(240,253,250);
      doc.roundedRect(M, 520, W-M*2, 58, 10, 10, "F");
      doc.setFont("times","italic");
      doc.setFontSize(11);
      doc.setTextColor(20,60,70);
      doc.text(doc.splitTextToSize(band.verse.quote, W-M*2-20), M+10, 540);
      doc.setFont("helvetica","normal");
      doc.setFontSize(9);
      doc.setTextColor(70,90,110);
      doc.text(`(${band.verse.reference})`, M+10, 566);

      // TABLA SECCIONES
      doc.addPage();
      let y = header();

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...COLORS.ink);
      doc.text("Diagn√≥stico por secciones", M, y);
      y += 12;
      doc.setDrawColor(230);
      doc.line(M, y, W-M, y);
      y += 12;

      const rows = last.sections.slice().reverse().map(s => [
        s.title,
        s.levelLabel,
        String(s.levelValue),
        `${s.verse.quote} (${s.verse.reference})`
      ]);

      doc.autoTable({
        startY: y,
        head: [["Secci√≥n", "Estado", "Nivel", "Porci√≥n b√≠blica"]],
        body: rows,
        theme: "grid",
        styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
        headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
        didParseCell: function(data){
          if(data.section==="body" && data.column.index===1){
            const v = data.cell.raw || "";
            const cc = levelColorRGB(v);
            data.cell.styles.fillColor = cc;
            data.cell.styles.textColor = [255,255,255];
            data.cell.styles.fontStyle = "bold";
          }
        },
        margin: {left:M, right:M}
      });

      // DETALLE (si se activa)
      doc.addPage();
      y = header();

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...COLORS.ink);
      doc.text("Gu√≠a pastoral por secciones", M, y);
      y += 12;
      doc.setDrawColor(230);
      doc.line(M, y, W-M, y);
      y += 12;

      const dRows = last.sections.slice().reverse().map(s => [
        s.title,
        s.levelLabel,
        (last.includeDetails && s.miniTeaching?.length) ? ("‚Ä¢ " + s.miniTeaching.join(" ‚Ä¢ ")) : "(sin detalle)",
        (last.includeDetails && s.actions?.length) ? ("‚Ä¢ " + s.actions.join(" ‚Ä¢ ")) : "(sin acciones)"
      ]);

      doc.autoTable({
        startY: y,
        head: [["Secci√≥n", "Estado", "Mini-ense√±anza", "Acciones"]],
        body: dRows,
        theme: "grid",
        styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
        headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
        didParseCell: function(data){
          if(data.section==="body" && data.column.index===1){
            const v = data.cell.raw || "";
            const cc = levelColorRGB(v);
            data.cell.styles.fillColor = cc;
            data.cell.styles.textColor = [255,255,255];
            data.cell.styles.fontStyle = "bold";
          }
        },
        columnStyles: {
          0:{cellWidth:150},
          1:{cellWidth:90},
          2:{cellWidth:(W - M*2 - 150 - 90)/2},
          3:{cellWidth:(W - M*2 - 150 - 90)/2}
        },
        margin: {left:M, right:M}
      });

      // PLAN 7 D√çAS
      doc.addPage();
      y = header();

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...COLORS.ink);
      doc.text("Plan semanal (7 d√≠as)", M, y);
      y += 12;
      doc.setDrawColor(230);
      doc.line(M, y, W-M, y);
      y += 12;

      const planRows = last.plan7.map(d => [
        `D√≠a ${d.day}`,
        d.title,
        d.items.join(" ‚Ä¢ ")
      ]);

      doc.autoTable({
        startY: y,
        head: [["D√≠a", "Enfoque", "Acciones"]],
        body: planRows,
        theme: "grid",
        styles: {font:"helvetica",fontSize:9.5,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
        headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
        columnStyles: { 0:{cellWidth:70}, 1:{cellWidth:190}, 2:{cellWidth:(W - M*2 - 70 - 190)} },
        margin: {left:M, right:M}
      });

      // OBSERVACIONES
      doc.addPage();
      y = header();

      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...COLORS.ink);
      doc.text("Observaciones", M, y);
      y += 12;
      doc.setDrawColor(230);
      doc.line(M, y, W-M, y);
      y += 14;

      doc.setFillColor(255,255,255);
      doc.roundedRect(M, y, W-M*2, 420, 12, 12, "F");
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.setTextColor(...COLORS.ink);
      const notes = last.header.notes || "(sin observaciones)";
      doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, y+26);

      footer();

      const name = safeName(last.header.patient || "termometro_cuerpo");
      doc.save(`${name}_termometro_cuerpo.pdf`);
    }

    function resetAll(){
      DATA.sections.forEach(s => scores[s.id] = 0);
      document.querySelectorAll('input[type="radio"]').forEach(i => {
        i.checked = (i.value === "0");
      });
      document.querySelectorAll('[id^="pill_"]').forEach(p => p.textContent = DATA.levels[0].label);

      updateLive();
      resBox.style.display = "none";
      resBox.innerHTML = "";
      btnTxt.disabled = true;
      btnPdf.disabled = true;
      last = null;
      window.scrollTo({top:0, behavior:"smooth"});
    }

    async function init(){
      try{
        const res = await fetch(JSON_PATH, {cache:"no-store"});
        if(!res.ok) throw new Error("No se pudo cargar el JSON: " + res.status);
        DATA = await res.json();

        document.getElementById("t").textContent = DATA.meta.title || "Term√≥metro del Cuerpo";
        document.getElementById("d").textContent = DATA.meta.description || "";
        document.getElementById("pMax").textContent = `Total m√°x: ${DATA.sections.length * 3}`;

        if(DATA.meta && DATA.meta.disclaimer){
          disclaimerBox.style.display = "block";
          disclaimerBox.textContent = DATA.meta.disclaimer;
        }

        setDefaultDateIfEmpty();
        renderForm();

        pdfWarn.style.display = okPdfLib() ? "none" : "block";
      }catch(e){
        secForm.innerHTML = `
          <div style="color:#fda4af"><b>Error:</b> ${e.message}</div>
          <div class="muted" style="margin-top:6px">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta.</div>
        `;
      }
    }

    document.getElementById("btnResult").addEventListener("click", showResult);
    document.getElementById("btnTxt").addEventListener("click", downloadTXT);
    document.getElementById("btnPdf").addEventListener("click", downloadPDF);
    document.getElementById("btnReset").addEventListener("click", resetAll);

    init();
  </script>
</body>
</html>