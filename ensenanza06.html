<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La viga: la mujer como alma del sistema ‚Äî Test</title>

  <!-- jsPDF + autoTable (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e8eefc;
      --muted:#aab7d6;
      --line:#22304e;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --bad:#fb7185;
      --good:#34d399;
      --orange:#fb923c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.22), transparent 60%),
                  radial-gradient(1200px 700px at 85% 0%, rgba(167,243,208,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 60px}
    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:18px 18px;border:1px solid var(--line);background:rgba(17,26,46,.72);
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(8px);
      position:sticky;top:0;z-index:30;
    }
    .titleBlock{display:flex;gap:14px;align-items:center;min-width:280px}
    .logo{
      width:44px;height:44px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);padding:6px;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .live{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(15,23,42,.7);
      font-size:12.5px;
    }
    .pill b{font-family:var(--mono);font-size:12.5px}
    .pill .dot{width:9px;height:9px;border-radius:999px;background:var(--accent)}
    .pill.good .dot{background:var(--good)}
    .pill.warn .dot{background:var(--warn)}
    .pill.risk .dot{background:var(--orange)}
    .pill.bad .dot{background:var(--bad)}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      margin-top:16px;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(17,26,46,.75);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .fields{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
    }
    @media(max-width:700px){.fields{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="text"], input[type="date"], textarea{
      width:100%;
      background:rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px
    }
    button{
      appearance:none;border:0;cursor:pointer;
      padding:10px 12px;border-radius:14px;
      background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.12));
      color:var(--text);
      border:1px solid rgba(125,211,252,.35);
      font-weight:600;
    }
    button.secondary{
      background:rgba(15,23,42,.7);
      border:1px solid rgba(255,255,255,.14);
      font-weight:600;
    }
    button.danger{
      background:linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.12));
      border:1px solid rgba(251,113,133,.38);
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .smallNote{color:var(--muted);font-size:12px;margin-top:8px}
    .toggle{
      display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12.5px;
      margin-left:auto;
    }
    .toggle input{transform: translateY(1px)}
    .section{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      background:rgba(17,26,46,.62);
      box-shadow:var(--shadow);
    }
    .sectionHead{
      padding:14px 14px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background:rgba(15,23,42,.65);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sectionHead h3{margin:0;font-size:14px}
    .sectionHead .metaLine{color:var(--muted);font-size:12.5px;margin-top:4px}
    .sectionBody{padding:10px 14px 14px}
    .q{
      padding:12px 0;border-bottom:1px dashed rgba(255,255,255,.12);
    }
    .q:last-child{border-bottom:0}
    .q .qText{font-size:13.5px;margin-bottom:8px}
    .scaleRow{
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .opt{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;background:rgba(15,23,42,.55);
      font-size:12.5px;color:var(--text);
      user-select:none;
    }
    .opt input{margin:0}
    .opt:hover{border-color: rgba(125,211,252,.35)}
    .results{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.62);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .resultsHead{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:14px;border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(17,26,46,.75);
    }
    .resultsHead h2{margin:0;font-size:15px}
    .resBody{padding:14px}
    .bandBox{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.35);
    }
    .bandTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;
      padding:7px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,23,42,.65);
      font-size:12.5px;font-weight:700;
    }
    .tag.good{border-color: rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
    .tag.warn{border-color: rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
    .tag.risk{border-color: rgba(251,146,60,.38);background:rgba(251,146,60,.12)}
    .tag.bad{border-color: rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .verse{
      margin-top:10px;color:var(--muted);font-size:12.5px;
      border-left:3px solid rgba(125,211,252,.35);
      padding-left:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:12.5px;
    }
    th,td{
      text-align:left;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.10);
      vertical-align:top;
    }
    th{color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}
    .plan{
      margin-top:14px;
      display:grid;grid-template-columns:1fr;gap:10px;
    }
    .day{
      padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.30);
    }
    .day b{font-family:var(--mono);font-size:12.5px}
    .err{
      margin-top:14px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(251,113,133,.38);
      background:rgba(251,113,133,.10);
      color:var(--text);
    }
    .footerNote{margin-top:18px;color:var(--muted);font-size:12px}

    /* P√≥rtico */
    .porticoWrap{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .porticoTop{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;
    }
    .porticoSvgBox{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.30);
      border-radius:16px;
      padding:10px;
      overflow:auto;
    }
    .legendRow{
      display:flex;gap:8px;flex-wrap:wrap;
      color:var(--muted);font-size:12.5px;
    }
    .lg{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.55);
    }
  </style>
</head>
<body>
  <div class="wrap">

    <header>
      <div class="titleBlock">
        <img class="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <div>
          <h1>[La viga: la mujer como alma del sistema]</h1>
          <div class="sub">Auditor√≠a diagn√≥stica basada en el cap√≠tulo 6: ‚ÄúLa viga‚Äù</div>
        </div>
      </div>
      <div class="live">
        <div id="liveScorePill" class="pill"><span class="dot"></span><span>Puntaje:</span> <b id="liveScore">0</b><span class="muted">/</span><b id="liveMax">0</b></div>
        <div id="livePercentPill" class="pill"><span class="dot"></span><span>Progreso:</span> <b id="liveAnswered">0</b><span class="muted">/</span><b id="liveTotalQ">0</b></div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Datos del informe</h2>
        <div class="fields">
          <div>
            <label for="patientName">Nombre del paciente</label>
            <input id="patientName" type="text" placeholder="Ej: Mar√≠a P√©rez" />
          </div>
          <div>
            <label for="auditorName">Nombre del auditor</label>
            <input id="auditorName" type="text" placeholder="Ej: Pastora / Mentora / Auditor" />
          </div>
          <div>
            <label for="dateField">Fecha</label>
            <input id="dateField" type="date" />
          </div>
          <div>
            <label for="includeDetails">Detalle por pregunta (para TXT/PDF)</label>
            <div class="toggle" style="margin-left:0">
              <input id="includeDetails" type="checkbox" />
              <span>Incluir detalles</span>
            </div>
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="notes">Observaciones libres</label>
          <textarea id="notes" placeholder="Notas del auditor, contexto, acuerdos, etc."></textarea>
        </div>

        <div class="controls">
          <button id="btnResults">Ver resultado</button>
          <button id="btnTxt" class="secondary">Descargar TXT</button>
          <button id="btnPdf" class="secondary">Descargar PDF bonito</button>
          <button id="btnPng" class="secondary">Descargar Imagen (PNG)</button>
          <button id="btnReset" class="danger">Reiniciar</button>
          <div class="toggle">
            <input id="autoScroll" type="checkbox" checked />
            <span>Auto-bajar a resultados</span>
          </div>
        </div>
        <div class="smallNote">Escala 0‚Äì5 (radio buttons). No se permiten n√∫meros escritos manualmente.</div>
        <div id="loadError" class="err" style="display:none"></div>
      </div>

      <div class="card">
        <h2>Gu√≠a r√°pida de lectura</h2>
        <div class="bandBox">
          <div class="muted" style="font-size:12.5px">
            Este test detecta <b>sensibilidad como dise√±o</b>, <b>percepci√≥n y distribuci√≥n</b>, <b>horizontalidad relacional</b>,
            <b>apoyo del Esp√≠ritu Santo</b>, <b>sobrecarga/fisuras</b>, <b>riesgo de cargar como columna</b> y <b>transferencia correcta</b>.
            <br><br>
            Incluye <b>Diagrama del p√≥rtico</b> (Comuni√≥n, Congregaci√≥n, Intersecci√≥n) para visualizar el estado estructural del hogar.
          </div>
        </div>
        <div class="footerNote">
          Archivos requeridos: <span class="muted">ensenanza06.json</span>, <span class="muted">ensenanza06.html</span> y <span class="muted">logo.png</span> en la misma carpeta.
        </div>
      </div>
    </div>

    <div id="testRoot"></div>

    <div id="resultsRoot" class="results" style="display:none">
      <div class="resultsHead">
        <h2>Resultados</h2>
        <div class="pill"><span class="dot"></span><span>Total:</span> <b id="resTotal">0</b><span class="muted">/</span><b id="resMax">0</b> <span class="muted">¬∑</span> <b id="resPct">0%</b></div>
      </div>
      <div class="resBody">
        <div id="globalBox" class="bandBox"></div>

        <!-- Diagrama del p√≥rtico -->
        <div style="margin-top:12px">
          <h2 style="margin:0 0 10px;font-size:14px">Diagrama del p√≥rtico</h2>
          <div class="bandBox">
            <div class="porticoTop">
              <div class="muted" style="font-size:12.5px">
                Visual estructural (Cimiento/Comuni√≥n, Uni√≥n/Congregaci√≥n, Apoyo m√≥vil/Intersecci√≥n) calculado desde el test.
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <div id="pillComunion" class="pill"><span class="dot"></span><span>Comuni√≥n:</span> <b id="pctComunion">0%</b></div>
                <div id="pillCongregacion" class="pill"><span class="dot"></span><span>Congregaci√≥n:</span> <b id="pctCongregacion">0%</b></div>
                <div id="pillInterseccion" class="pill"><span class="dot"></span><span>Intersecci√≥n:</span> <b id="pctInterseccion">0%</b></div>
              </div>
            </div>

            <div class="porticoWrap">
              <div class="porticoSvgBox">
                <div id="porticoSvgMount"></div>
              </div>

              <div class="legendRow">
                <span class="lg">üü¢ Alineado</span>
                <span class="lg">üü° En ajuste</span>
                <span class="lg">üü† En riesgo</span>
                <span class="lg">üî¥ Cr√≠tico</span>
              </div>

              <div class="smallNote">El bot√≥n ‚ÄúDescargar Imagen (PNG)‚Äù exporta este diagrama con t√≠tulo y fecha dentro de la imagen.</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h2 style="margin:0 0 10px;font-size:14px">Resultados por secci√≥n</h2>
          <div style="overflow:auto">
            <table id="sectionTable">
              <thead>
                <tr>
                  <th>Secci√≥n</th>
                  <th>Diagn√≥stico</th>
                  <th>Puntaje</th>
                  <th>%</th>
                  <th>Enfoque</th>
                  <th>Verso</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:14px">
          <h2 style="margin:0 0 10px;font-size:14px">Enfoque pastoral por secciones</h2>
          <div id="pastoralBlocks"></div>
        </div>

        <div style="margin-top:14px">
          <h2 style="margin:0 0 10px;font-size:14px">Plan semanal autom√°tico (7 d√≠as)</h2>
          <div class="muted" style="font-size:12.5px;margin-bottom:8px">
            Basado en las secciones con mayor tensi√≥n (menor %). Se prioriza restauraci√≥n con pasos peque√±os y sostenibles.
          </div>
          <div id="weeklyPlan" class="plan"></div>
        </div>

        <div class="footerNote">Tip: descarga el PDF para una lectura ordenada con portada, tablas, diagrama, plan y enfoque pastoral.</div>
      </div>
    </div>

  </div>

<script>
(() => {
  const JSON_PATH = './ensenanza06.json';
  const TITLE = '[La viga: la mujer como alma del sistema]';

  // Umbrales por porcentaje (0..1) para diagn√≥sticos texto
  const GLOBAL_THRESHOLDS = [
    { min: 0.85, band: 'Alineado' },
    { min: 0.65, band: 'Ajuste' },
    { min: 0.40, band: 'Riesgo' },
    { min: 0.00, band: 'Cr√≠tico' }
  ];
  const SECTION_THRESHOLDS = [
    { min: 0.75, band: 'Alineado' },
    { min: 0.50, band: 'Ajuste' },
    { min: 0.00, band: 'Riesgo' }
  ];

  // Bandas del P√≥rtico (0..100)
  const PORTICO_BANDS = [
    { min: 75, label: 'Alineado', key: 'good', emoji:'üü¢' },
    { min: 55, label: 'En ajuste', key: 'warn', emoji:'üü°' },
    { min: 35, label: 'En riesgo', key: 'risk', emoji:'üü†' },
    { min: 0,  label: 'Cr√≠tico',  key: 'bad',  emoji:'üî¥' }
  ];

  const el = (id) => document.getElementById(id);

  const state = {
    data: null,
    answers: new Map(), // key: qid, value: number
    totalQuestions: 0,
    maxPerQuestion: 5,
    maxTotal: 0,
    lastPorticoPNG: null // cache dataURL
  };

  // Defaults
  try {
    const today = new Date();
    const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
    el('dateField').value = iso;
  } catch {}

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function fmtPct(p){ return `${Math.round(p*100)}%`; }
  function safeText(s){ return (s ?? '').toString(); }

  function getScaleOptions(){
    const opts = state.data?.scale?.options || [];
    const nums = opts.map(o => Number(o.value)).filter(v => Number.isFinite(v));
    const max = nums.length ? Math.max(...nums) : 5;
    state.maxPerQuestion = max;
    return opts;
  }

  function computeTotals(){
    let total = 0;
    let answered = 0;
    for (const [, val] of state.answers.entries()){
      if (Number.isFinite(val)){
        total += val;
        answered += 1;
      }
    }
    return { total, answered };
  }

  function pickBand(pct, thresholds, kind){
    const p = clamp(pct, 0, 1);
    const chosen = thresholds.find(t => p >= t.min) || thresholds[thresholds.length - 1];
    const label = chosen.band;

    if (kind === 'global'){
      const bandObj = (state.data.rubrics.globalBands || []).find(b => b.label === label);
      return bandObj || (state.data.rubrics.globalBands || [])[0] || { label, summary:'', verse:{quote:'',reference:''} };
    } else {
      const bandObj = (state.data.rubrics.sectionBands || []).find(b => b.label === label);
      return bandObj || (state.data.rubrics.sectionBands || [])[0] || { label, summary:'', verse:{quote:'',reference:''} };
    }
  }

  function computeBySection(){
    const sections = state.data.sections || [];
    const by = [];
    for (const s of sections){
      let score = 0;
      let answered = 0;
      const qCount = (s.questions || []).length;
      for (const q of (s.questions || [])){
        const v = state.answers.get(q.id);
        if (Number.isFinite(v)){
          score += v;
          answered += 1;
        }
      }
      const max = qCount * state.maxPerQuestion;
      const pct = max > 0 ? (score / max) : 0;
      const band = pickBand(pct, SECTION_THRESHOLDS, 'section');
      by.push({ section: s, score, max, pct, answered, qCount, band });
    }
    by.sort((a,b) => a.pct - b.pct); // tension first
    return by;
  }

  function bandClass(label){
    const l = (label || '').toLowerCase();
    if (l.includes('aline')) return 'good';
    if (l.includes('ajust')) return 'warn';
    if (l.includes('riesg')) return 'bad';
    if (l.includes('cr√≠t') || l.includes('crit')) return 'bad';
    return '';
  }

  function porticoBandFromPct100(p){
    const v = clamp(Math.round(p), 0, 100);
    const chosen = PORTICO_BANDS.find(b => v >= b.min) || PORTICO_BANDS[PORTICO_BANDS.length - 1];
    return chosen;
  }

  function colorForPorticoKey(key){
    if (key === 'good') return '#34d399';
    if (key === 'warn') return '#fbbf24';
    if (key === 'risk') return '#fb923c';
    return '#fb7185';
  }

  function renderTest(){
    const root = el('testRoot');
    root.innerHTML = '';

    const data = state.data;
    const scale = getScaleOptions();
    const sections = data.sections || [];

    // counts
    let totalQ = 0;
    for (const s of sections) totalQ += (s.questions || []).length;
    state.totalQuestions = totalQ;
    state.maxTotal = totalQ * state.maxPerQuestion;

    el('liveMax').textContent = state.maxTotal;
    el('liveTotalQ').textContent = totalQ;

    for (const s of sections){
      const sec = document.createElement('div');
      sec.className = 'section';
      sec.dataset.sectionId = s.id;

      const head = document.createElement('div');
      head.className = 'sectionHead';

      const left = document.createElement('div');
      const h = document.createElement('h3');
      h.textContent = s.title;
      const meta = document.createElement('div');
      meta.className = 'metaLine';
      meta.textContent = `${safeText(s.subtitle)} ¬∑ Enfoque: ${safeText(s.diagnosticFocus)}`;
      left.appendChild(h);
      left.appendChild(meta);

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '10px';
      right.style.alignItems = 'center';
      right.style.flexWrap = 'wrap';
      right.innerHTML = `
        <div class="pill"><span class="dot"></span><span>Secci√≥n:</span> <b id="secScore_${s.id}">0</b><span class="muted">/</span><b id="secMax_${s.id}">0</b></div>
      `;

      head.appendChild(left);
      head.appendChild(right);

      const body = document.createElement('div');
      body.className = 'sectionBody';

      for (const q of (s.questions || [])){
        const qWrap = document.createElement('div');
        qWrap.className = 'q';

        const qText = document.createElement('div');
        qText.className = 'qText';
        qText.textContent = q.text;

        const row = document.createElement('div');
        row.className = 'scaleRow';

        for (const opt of scale){
          const id = `${q.id}_v${opt.value}`;
          const lab = document.createElement('label');
          lab.className = 'opt';
          lab.setAttribute('for', id);

          const inp = document.createElement('input');
          inp.type = 'radio';
          inp.name = q.id;
          inp.id = id;
          inp.value = String(opt.value);
          inp.addEventListener('change', () => {
            state.answers.set(q.id, Number(inp.value));
            state.lastPorticoPNG = null; // invalidate cache
            updateLive();
          });

          const span = document.createElement('span');
          span.textContent = `${opt.label}`;

          lab.appendChild(inp);
          lab.appendChild(span);
          row.appendChild(lab);
        }

        qWrap.appendChild(qText);
        qWrap.appendChild(row);
        body.appendChild(qWrap);
      }

      sec.appendChild(head);
      sec.appendChild(body);
      root.appendChild(sec);

      const secMax = (s.questions || []).length * state.maxPerQuestion;
      const maxEl = el(`secMax_${s.id}`);
      if (maxEl) maxEl.textContent = secMax;
    }

    updateLive();
  }

  function computePorticoAxes(){
    const by = computeBySection(); // sorted low->high
    const axisAgg = {
      comunion: { score:0, max:0 },
      congregacion: { score:0, max:0 },
      interseccion: { score:0, max:0 }
    };
    for (const it of by){
      const axis = it.section.porticoAxis || 'comunion';
      if (!axisAgg[axis]) continue;
      axisAgg[axis].score += it.score;
      axisAgg[axis].max += it.max;
    }
    const toPct100 = (obj) => obj.max > 0 ? (obj.score / obj.max) * 100 : 0;

    const comunionPct = toPct100(axisAgg.comunion);
    const congregacionPct = toPct100(axisAgg.congregacion);
    const interseccionPct = toPct100(axisAgg.interseccion);

    return {
      comunion: { pct: comunionPct, band: porticoBandFromPct100(comunionPct) },
      congregacion: { pct: congregacionPct, band: porticoBandFromPct100(congregacionPct) },
      interseccion: { pct: interseccionPct, band: porticoBandFromPct100(interseccionPct) }
    };
  }

  function updatePorticoUI(){
    const axes = computePorticoAxes();

    const setPill = (pillId, pctId, axis) => {
      const pill = el(pillId);
      const pctEl = el(pctId);
      if (!pill || !pctEl) return;
      pctEl.textContent = `${Math.round(axes[axis].pct)}%`;
      pill.classList.remove('good','warn','risk','bad');
      pill.classList.add(axes[axis].band.key);
    };

    setPill('pillComunion', 'pctComunion', 'comunion');
    setPill('pillCongregacion', 'pctCongregacion', 'congregacion');
    setPill('pillInterseccion', 'pctInterseccion', 'interseccion');

    renderPorticoSVG(); // render fresh
  }

  function updateLive(){
    const { total, answered } = computeTotals();

    el('liveScore').textContent = total;
    el('liveAnswered').textContent = answered;

    const pct = state.maxTotal ? total / state.maxTotal : 0;
    const pill = el('liveScorePill');
    pill.classList.remove('good','warn','bad','risk');
    const label = pickBand(pct, GLOBAL_THRESHOLDS, 'global').label || '';
    const cls = bandClass(label);
    if (cls) pill.classList.add(cls);

    const pill2 = el('livePercentPill');
    pill2.classList.remove('good','warn','bad','risk');
    if (answered === state.totalQuestions && state.totalQuestions > 0) pill2.classList.add('good');
    else if (answered > 0) pill2.classList.add('warn');

    const bySection = computeBySection().reduce((acc, it) => { acc[it.section.id] = it; return acc; }, {});
    for (const s of (state.data.sections || [])){
      const it = bySection[s.id];
      const scoreEl = el(`secScore_${s.id}`);
      if (scoreEl) scoreEl.textContent = it ? it.score : 0;
    }

    // If results open, refresh portico module too
    if (el('resultsRoot').style.display !== 'none'){
      updatePorticoUI();
    }
  }

  function buildGlobalBox(globalBand, pct){
    const cls = bandClass(globalBand.label);
    const tagClass = cls ? `tag ${cls}` : 'tag';
    const verse = globalBand.verse || { quote:'', reference:'' };

    return `
      <div class="bandTop">
        <span class="${tagClass}">Diagn√≥stico global: ${safeText(globalBand.label)}</span>
        <span class="pill"><span class="dot"></span><span>Porcentaje:</span> <b>${fmtPct(pct)}</b></span>
      </div>
      <div style="margin-top:10px;color:var(--text);font-size:13px">${safeText(globalBand.summary)}</div>
      <div class="verse">üìñ ‚Äú${safeText(verse.quote)}‚Äù <span class="muted">(${safeText(verse.reference)})</span></div>
    `;
  }

  function getMiniTeachingForSection(sectionId){
    const list = state.data?.pastoralManual?.sections || [];
    return list.find(x => x.id === sectionId)?.miniTeaching || null;
  }

  function buildWeeklyPlanFromSections(bySectionSortedLow){
    const priority = bySectionSortedLow.slice(0, 3);
    const pools = priority.map(it => {
      const mini = getMiniTeachingForSection(it.section.id);
      return { title: it.section.title, actions: (mini?.oneWeekPlan || []).slice() };
    }).filter(p => p.actions.length);

    const days = [];
    for (let i=0;i<7;i++){
      const picks = [];
      for (let j=0;j<pools.length;j++){
        const pool = pools[(i + j) % pools.length];
        const act = pool.actions[i % pool.actions.length];
        if (act) picks.push({ sec: pool.title, act });
        if (picks.length >= 2) break;
      }
      if (!picks.length){
        picks.push({ sec: 'Alineaci√≥n general', act: 'Ora: ‚ÄúEsp√≠ritu Santo, sost√©n mi alma; ens√©√±ame a percibir sin cargar y a transferir sin temor.‚Äù' });
      }
      days.push(picks);
    }
    return days;
  }

  // -------------------------
  // DIAGRAMA DEL P√ìRTICO (SVG)
  // -------------------------
  function buildPorticoSVGMarkup(){
    const axes = computePorticoAxes();
    const patient = safeText(el('patientName').value).trim();
    const date = safeText(el('dateField').value).trim();

    const comm = axes.comunion;
    const cong = axes.congregacion;
    const inter = axes.interseccion;

    const cComm = colorForPorticoKey(comm.band.key);
    const cCong = colorForPorticoKey(cong.band.key);
    const cInter = colorForPorticoKey(inter.band.key);

    // Visual settings
    const W = 860, H = 420;
    const pad = 26;

    // Geometry (p√≥rtico)
    const baseY = 320;
    const baseX1 = 140, baseX2 = 760;
    const colX = 220;
    const colYTop = 150;
    const beamY = colYTop;
    const beamX2 = 720;

    // Nodes
    const n1x = colX, n1y = baseY - 10;        // COMUNI√ìN above base
    const n2x = colX, n2y = beamY;             // CONGREGACI√ìN at joint
    const n3x = beamX2, n3y = beamY;           // INTERSECCI√ìN at right end

    const titleLine = `Diagrama del p√≥rtico ‚Äî ${patient ? patient : 'Paciente'} ‚Äî ${date || 'Fecha'}`;

    const labelBand = (a) => `${a.band.emoji} ${a.band.label} (${Math.round(a.pct)}%)`;

    return `
<svg id="porticoSvg" xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <defs>
    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="rgba(0,0,0,0.45)"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect x="0" y="0" width="${W}" height="${H}" rx="22" fill="#0b1220"/>
  <rect x="${pad}" y="${pad}" width="${W - pad*2}" height="${H - pad*2}" rx="18" fill="#0f172a" stroke="rgba(255,255,255,0.10)"/>

  <!-- Top text: CARGAS -->
  <text x="${W/2}" y="70" fill="rgba(232,238,252,0.88)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="18" font-weight="700" text-anchor="middle">
    CARGAS (vivas + muertas)
  </text>
  <text x="${W/2}" y="94" fill="rgba(170,183,214,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    (decorativo) ‚Üò‚Üò‚Üò hacia la viga
  </text>

  <!-- Decorative arrows -->
  <path d="M 530 112 C 560 128, 590 140, 620 150" fill="none" stroke="rgba(125,211,252,0.35)" stroke-width="6" stroke-linecap="round"/>
  <path d="M 540 126 C 570 142, 600 152, 630 160" fill="none" stroke="rgba(167,243,208,0.22)" stroke-width="6" stroke-linecap="round"/>

  <!-- Base (CIMIENTO) -->
  <path d="M ${baseX1} ${baseY} L ${baseX2} ${baseY}" stroke="${cComm}" stroke-width="18" stroke-linecap="round" filter="url(#softShadow)"/>
  <text x="${(baseX1+baseX2)/2}" y="${baseY+36}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    CIMIENTO
  </text>

  <!-- Column (VAR√ìN) - colored by CONGREGACI√ìN -->
  <path d="M ${colX} ${baseY} L ${colX} ${colYTop}" stroke="${cCong}" stroke-width="18" stroke-linecap="round" filter="url(#softShadow)"/>
  <text x="${colX-50}" y="${(baseY+colYTop)/2}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle" transform="rotate(-90 ${colX-50} ${(baseY+colYTop)/2})">
    COLUMNA (VAR√ìN)
  </text>

  <!-- Beam (MUJER) - colored by INTERSECCI√ìN -->
  <path d="M ${colX} ${beamY} L ${beamX2} ${beamY}" stroke="${cInter}" stroke-width="18" stroke-linecap="round" filter="url(#softShadow)"/>
  <text x="${(colX+beamX2)/2}" y="${beamY-24}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    VIGA (MUJER)
  </text>

  <!-- Nodes -->
  <circle cx="${n1x}" cy="${n1y}" r="16" fill="#0b1220" stroke="${cComm}" stroke-width="10"/>
  <circle cx="${n2x}" cy="${n2y}" r="16" fill="#0b1220" stroke="${cCong}" stroke-width="10"/>
  <circle cx="${n3x}" cy="${n3y}" r="16" fill="#0b1220" stroke="${cInter}" stroke-width="10"/>

  <text x="${n1x}" y="${n1y+44}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    COMUNI√ìN
  </text>
  <text x="${n2x+10}" y="${n2y-26}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="start">
    CONGREGACI√ìN
  </text>
  <text x="${n3x}" y="${n3y-26}" fill="rgba(232,238,252,0.9)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    INTERSECCI√ìN / APOYO M√ìVIL
  </text>

  <!-- Axis status badges -->
  <g>
    <rect x="60" y="265" rx="12" ry="12" width="250
" height="92" fill="rgba(17,26,46,0.70)" stroke="rgba(255,255,255,0.10)"/>
    <text x="78" y="292" fill="rgba(232,238,252,0.92)" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace" font-size="12">
      COMUNI√ìN: ${labelBand(comm)}
    </text>
    <text x="78" y="316" fill="rgba(232,238,252,0.92)" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace" font-size="12">
      CONGREGACI√ìN: ${labelBand(cong)}
    </text>
    <text x="78" y="340" fill="rgba(232,238,252,0.92)" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace" font-size="12">
      INTERSECCI√ìN: ${labelBand(inter)}
    </text>
  </g>

  <!-- Footer title/date inside image -->
  <text x="${W/2}" y="${H-22}" fill="rgba(170,183,214,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="12" text-anchor="middle">
    ${safeText(titleLine)}
  </text>
</svg>
    `.trim();
  }

  function renderPorticoSVG(){
    const mount = el('porticoSvgMount');
    if (!mount) return;
    mount.innerHTML = buildPorticoSVGMarkup();
  }

  async function svgToPngDataUrl(svgEl){
    const svgText = new XMLSerializer().serializeToString(svgEl);
    const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.decoding = 'async';

    // Try anonymous (works for same-origin)
    img.crossOrigin = 'anonymous';

    await new Promise((resolve, reject) => {
      img.onload = () => resolve();
      img.onerror = (e) => reject(e);
      img.src = url;
    });

    const canvas = document.createElement('canvas');
    const w = svgEl.viewBox.baseVal.width || svgEl.width.baseVal.value || 860;
    const h = svgEl.viewBox.baseVal.height || svgEl.height.baseVal.value || 420;
    canvas.width = Math.round(w);
    canvas.height = Math.round(h);

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    URL.revokeObjectURL(url);
    return canvas.toDataURL('image/png');
  }

  async function getPorticoPNG(){
    if (state.lastPorticoPNG) return state.lastPorticoPNG;
    const svg = document.getElementById('porticoSvg');
    if (!svg) throw new Error('No se encontr√≥ el SVG del p√≥rtico.');
    const dataUrl = await svgToPngDataUrl(svg);
    state.lastPorticoPNG = dataUrl;
    return dataUrl;
  }

  async function downloadPorticoPNG(){
    try{
      // ensure rendered
      renderPorticoSVG();
      const dataUrl = await getPorticoPNG();
      const a = document.createElement('a');
      const date = safeText(el('dateField').value).trim() || 'fecha';
      a.href = dataUrl;
      a.download = `portico_${date}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(err){
      alert('No se pudo exportar el PNG del p√≥rtico. ' + (err?.message || err));
    }
  }

  // -------------------------
  // RESULTADOS + REPORTES
  // -------------------------
  function renderResults(){
    const { total } = computeTotals();
    const max = state.maxTotal || 1;
    const pct = total / max;

    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');

    el('resTotal').textContent = total;
    el('resMax').textContent = max;
    el('resPct').textContent = fmtPct(pct);

    el('globalBox').innerHTML = buildGlobalBox(globalBand, pct);

    // Section table + pastoral blocks
    const tbody = el('sectionTable').querySelector('tbody');
    tbody.innerHTML = '';

    const bySectionRaw = computeBySection(); // sorted low->high
    const bySectionOriginalOrder = (state.data.sections || []).map(s => bySectionRaw.find(x => x.section.id === s.id)).filter(Boolean);

    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const secVerse = s.sectionVerse || { quote:'', reference:'' };

      const tr = document.createElement('tr');
      const focus = safeText(s.diagnosticFocus);
      const diag = it.band?.label || '‚Äî';
      const diagSummary = it.band?.summary || '';
      const diagCell = `<b>${safeText(diag)}</b><div class="muted" style="margin-top:4px">${safeText(diagSummary)}</div>`;

      tr.innerHTML = `
        <td><b>${safeText(s.title)}</b><div class="muted" style="margin-top:4px">${safeText(s.subtitle)}</div></td>
        <td>${diagCell}</td>
        <td><span style="font-family:var(--mono)">${it.score}</span> / <span class="muted">${it.max}</span></td>
        <td><b>${fmtPct(it.pct)}</b></td>
        <td class="muted">${focus}</td>
        <td class="muted">‚Äú${safeText(secVerse.quote)}‚Äù (${safeText(secVerse.reference)})</td>
      `;
      tbody.appendChild(tr);
    }

    // Pastoral blocks (all sections)
    const pastoralRoot = el('pastoralBlocks');
    pastoralRoot.innerHTML = '';
    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const mini = getMiniTeachingForSection(s.id);
      const cls = bandClass(it.band?.label || '');

      const block = document.createElement('div');
      block.className = 'bandBox';
      block.style.marginBottom = '10px';

      const tagClass = cls ? `tag ${cls}` : 'tag';
      if (!mini){
        block.innerHTML = `
          <div class="bandTop">
            <span class="${tagClass}">${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')}</span>
            <span class="pill"><span class="dot"></span><span>${fmtPct(it.pct)}</span></span>
          </div>
          <div class="muted" style="margin-top:10px">No se encontr√≥ mini-ense√±anza para esta secci√≥n.</div>
        `;
      } else {
        const bullets = (mini.text || []).map(x => `<li>${safeText(x)}</li>`).join('');
        const v = mini.verse || { quote:'', reference:'' };
        block.innerHTML = `
          <div class="bandTop">
            <span class="${tagClass}">${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')}</span>
            <span class="pill"><span class="dot"></span><span>Puntaje:</span> <b>${it.score}</b><span class="muted">/</span><b>${it.max}</b> <span class="muted">¬∑</span> <b>${fmtPct(it.pct)}</b></span>
          </div>
          <div style="margin-top:10px"><b>${safeText(mini.title)}</b></div>
          <ul style="margin:8px 0 0 18px;color:var(--text);font-size:13px">${bullets}</ul>
          <div class="verse">üìñ ‚Äú${safeText(v.quote)}‚Äù <span class="muted">(${safeText(v.reference)})</span></div>
        `;
      }

      pastoralRoot.appendChild(block);
    }

    // Weekly plan (7 days)
    const planRoot = el('weeklyPlan');
    planRoot.innerHTML = '';
    const days = buildWeeklyPlanFromSections(bySectionRaw);
    for (let d=0; d<7; d++){
      const div = document.createElement('div');
      div.className = 'day';
      const items = days[d].map(x => `<li><span class="muted">(${safeText(x.sec)})</span> ${safeText(x.act)}</li>`).join('');
      div.innerHTML = `<b>D√≠a ${d+1}</b><ul style="margin:8px 0 0 18px;font-size:13px">${items}</ul>`;
      planRoot.appendChild(div);
    }

    // Portico UI
    updatePorticoUI();

    el('resultsRoot').style.display = 'block';
    if (el('autoScroll').checked){
      el('resultsRoot').scrollIntoView({ behavior:'smooth', block:'start' });
    }
  }

  function buildTXT(){
    const data = state.data;
    const patient = safeText(el('patientName').value).trim();
    const auditor = safeText(el('auditorName').value).trim();
    const date = safeText(el('dateField').value).trim();
    const notes = safeText(el('notes').value).trim();
    const includeDetails = el('includeDetails').checked;

    const { total } = computeTotals();
    const pct = state.maxTotal ? total / state.maxTotal : 0;
    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');
    const globalVerse = globalBand.verse || { quote:'', reference:'' };

    const bySection = computeBySection();
    const ordered = (data.sections || []).map(s => bySection.find(x => x.section.id === s.id)).filter(Boolean);

    const days = buildWeeklyPlanFromSections(bySection);

    const axes = computePorticoAxes();
    const axisLine = (id, label) => {
      const a = axes[id];
      return `${label}: ${Math.round(a.pct)}% ‚Äî ${a.band.emoji} ${a.band.label}`;
    };

    let out = '';
    out += `${TITLE}\n`;
    out += `${'='.repeat(TITLE.length)}\n\n`;
    out += `Paciente: ${patient || '(sin especificar)'}\n`;
    out += `Auditor:  ${auditor || '(sin especificar)'}\n`;
    out += `Fecha:    ${date || '(sin especificar)'}\n\n`;
    out += `Observaciones:\n${notes ? notes : '(sin observaciones)'}\n\n`;

    out += `DIAGN√ìSTICO GLOBAL\n`;
    out += `- Puntaje: ${total}/${state.maxTotal} (${fmtPct(pct)})\n`;
    out += `- Nivel: ${safeText(globalBand.label)}\n`;
    out += `- Resumen: ${safeText(globalBand.summary)}\n`;
    out += `- Verso: ‚Äú${safeText(globalVerse.quote)}‚Äù (${safeText(globalVerse.reference)})\n\n`;

    out += `DIAGRAMA DEL P√ìRTICO (indicadores)\n`;
    out += `- ${axisLine('comunion', 'Comuni√≥n')}\n`;
    out += `- ${axisLine('congregacion', 'Congregaci√≥n')}\n`;
    out += `- ${axisLine('interseccion', 'Intersecci√≥n')}\n\n`;

    out += `RESULTADOS POR SECCI√ìN\n`;
    out += `----------------------\n`;
    for (const it of ordered){
      const s = it.section;
      const diag = it.band?.label || '‚Äî';
      const secVerse = s.sectionVerse || { quote:'', reference:'' };
      out += `‚Ä¢ ${safeText(s.title)}\n`;
      out += `  - Puntaje: ${it.score}/${it.max} (${fmtPct(it.pct)})\n`;
      out += `  - Diagn√≥stico: ${safeText(diag)}\n`;
      out += `  - Enfoque: ${safeText(s.diagnosticFocus)}\n`;
      out += `  - Verso: ‚Äú${safeText(secVerse.quote)}‚Äù (${safeText(secVerse.reference)})\n\n`;
    }

    out += `ENFOQUE PASTORAL POR SECCIONES\n`;
    out += `------------------------------\n`;
    for (const it of ordered){
      const s = it.section;
      const mini = getMiniTeachingForSection(s.id);
      out += `‚Ä¢ ${safeText(s.title)}\n`;
      if (!mini){
        out += `  (sin mini-ense√±anza)\n\n`;
        continue;
      }
      out += `  ${safeText(mini.title)}\n`;
      for (const b of (mini.text || [])){
        out += `  - ${safeText(b)}\n`;
      }
      const v = mini.verse || { quote:'', reference:'' };
      out += `  Verso: ‚Äú${safeText(v.quote)}‚Äù (${safeText(v.reference)})\n\n`;
    }

    out += `PLAN SEMANAL (7 D√çAS)\n`;
    out += `---------------------\n`;
    for (let i=0;i<7;i++){
      out += `D√≠a ${i+1}:\n`;
      for (const item of days[i]){
        out += `  - (${safeText(item.sec)}) ${safeText(item.act)}\n`;
      }
      out += `\n`;
    }

    if (includeDetails){
      out += `DETALLE DE RESPUESTAS\n`;
      out += `---------------------\n`;
      for (const s of (data.sections || [])){
        out += `\n[${safeText(s.title)}]\n`;
        for (const q of (s.questions || [])){
          const v = state.answers.get(q.id);
          const val = Number.isFinite(v) ? v : null;
          out += `- ${safeText(q.text)} => ${val === null ? '(sin responder)' : val}\n`;
        }
      }
      out += `\n`;
    }

    return out;
  }

  function downloadTXT(){
    const txt = buildTXT();
    const blob = new Blob([txt], { type:'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = safeText(el('dateField').value).trim() || 'fecha';
    a.href = url;
    a.download = `ensenanza06_${date}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------------
  // PDF BONITO (jsPDF + autoTable)
  // -------------------------
  async function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const margin = 42;

    const patient = safeText(el('patientName').value).trim();
    const auditor = safeText(el('auditorName').value).trim();
    const date = safeText(el('dateField').value).trim();
    const notes = safeText(el('notes').value).trim();
    const includeDetails = el('includeDetails').checked;

    const { total } = computeTotals();
    const max = state.maxTotal || 1;
    const pct = total / max;
    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');
    const globalVerse = globalBand.verse || { quote:'', reference:'' };

    const bySection = computeBySection();
    const ordered = (state.data.sections || []).map(s => bySection.find(x => x.section.id === s.id)).filter(Boolean);

    // Prepare portico image
    updatePorticoUI();
    let porticoPng = null;
    try { porticoPng = await getPorticoPNG(); } catch { porticoPng = null; }

    // Load logo (optional)
    const loadImageToDataUrl = (src) => new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        c.getContext('2d').drawImage(img, 0, 0);
        resolve(c.toDataURL('image/png'));
      };
      img.onerror = () => resolve(null);
      img.src = src;
    });

    const logoData = await loadImageToDataUrl('logo.png');

    // Helper: header logo small
    const drawHeader = () => {
      if (logoData){
        doc.addImage(logoData, 'PNG', margin, 18, 26, 26);
      }
      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.setTextColor(170,183,214);
      doc.text('Auditor√≠a ‚Äî La viga', margin + 34, 36);
      doc.setDrawColor(34,48,78);
      doc.setLineWidth(1);
      doc.line(margin, 52, W - margin, 52);
    };

    // Helper: pill auto-fit
    const drawPill = (x, y, text, bgRGB, textRGB) => {
      doc.setFont('helvetica','bold');
      doc.setFontSize(12);
      const paddingX = 10, paddingY = 8;
      const maxW = W - margin - x;
      let t = text;
      while (doc.getTextWidth(t) + paddingX*2 > maxW && t.length > 10){
        t = t.slice(0, -1);
      }
      const w = doc.getTextWidth(t) + paddingX*2;
      const h = 24;
      doc.setFillColor(...bgRGB);
      doc.setDrawColor(255,255,255);
      doc.setLineWidth(0.5);
      doc.roundedRect(x, y, w, h, 12, 12, 'F');
      doc.setTextColor(...textRGB);
      doc.text(t, x + paddingX, y + 16);
      doc.setTextColor(232,238,252);
    };

    // ----- COVER -----
    doc.setFillColor(11,18,32);
    doc.rect(0,0,W,H,'F');

    // Title
    doc.setFont('helvetica','bold');
    doc.setFontSize(22);
    doc.setTextColor(232,238,252);
    doc.text(TITLE, margin, 92);

    // Logo
    if (logoData){
      doc.addImage(logoData, 'PNG', W - margin - 56, 70, 56, 56);
    }

    // Meta
    doc.setFont('helvetica','normal');
    doc.setFontSize(12);
    doc.setTextColor(170,183,214);
    doc.text(`Paciente: ${patient || '‚Äî'}`, margin, 126);
    doc.text(`Auditor: ${auditor || '‚Äî'}`, margin, 146);
    doc.text(`Fecha: ${date || '‚Äî'}`, margin, 166);

    // Global pill
    const gb = safeText(globalBand.label);
    const pillText = `Diagn√≥stico global: ${gb} ¬∑ ${Math.round(pct*100)}%`;
    // pick colors
    let bg = [15,23,42], fg = [232,238,252];
    const bc = bandClass(gb);
    if (bc === 'good') bg = [52,211,153];
    else if (bc === 'warn') bg = [251,191,36];
    else if (bc === 'bad') bg = [251,113,133];
    drawPill(margin, 188, pillText, bg, [11,18,32]);

    // Verse global
    doc.setTextColor(232,238,252);
    doc.setFont('helvetica','italic');
    doc.setFontSize(12);
    const verseLine = `‚Äú${safeText(globalVerse.quote)}‚Äù (${safeText(globalVerse.reference)})`;
    doc.text(verseLine, margin, 226, { maxWidth: W - margin*2 });

    // Portico image centered
    if (porticoPng){
      const imgW = W - margin*2;
      const imgH = imgW * (420/860); // same ratio
      const y = 260;
      doc.addImage(porticoPng, 'PNG', margin, y, imgW, imgH);
    }

    // Next page
    doc.addPage();
    drawHeader();

    // ----- TABLE by section -----
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Tabla de resultados por secci√≥n', margin, 84);

    const tableBody = ordered.map(it => {
      const s = it.section;
      const diag = it.band?.label || '‚Äî';
      return [
        safeText(s.title),
        safeText(diag),
        `${it.score}/${it.max}`,
        `${Math.round(it.pct*100)}%`,
        safeText(s.porticoAxis || '')
      ];
    });

    doc.autoTable({
      startY: 100,
      head: [['Secci√≥n','Diagn√≥stico','Puntaje','%','Eje p√≥rtico']],
      body: tableBody,
      styles: { font:'helvetica', fontSize:10, textColor:[232,238,252], fillColor:[15,23,42], lineColor:[34,48,78], lineWidth:0.5 },
      headStyles: { fillColor:[17,26,46], textColor:[170,183,214] },
      alternateRowStyles: { fillColor:[13,20,36] },
      margin: { left: margin, right: margin }
    });

    // Portico mini (optional) + Plan
    let yAfter = doc.lastAutoTable.finalY + 18;

    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Plan semanal (7 d√≠as)', margin, yAfter);
    yAfter += 12;

    const days = buildWeeklyPlanFromSections(bySection);
    const planRows = [];
    for (let i=0;i<7;i++){
      const actions = days[i].map(x => `(${safeText(x.sec)}) ${safeText(x.act)}`).join('\n');
      planRows.push([`D√≠a ${i+1}`, actions]);
    }

    doc.autoTable({
      startY: yAfter + 8,
      head: [['D√≠a','Acciones (1‚Äì2)']],
      body: planRows,
      styles: { font:'helvetica', fontSize:10, textColor:[232,238,252], fillColor:[15,23,42], lineColor:[34,48,78], lineWidth:0.5, cellPadding:6 },
      headStyles: { fillColor:[17,26,46], textColor:[170,183,214] },
      alternateRowStyles: { fillColor:[13,20,36] },
      margin: { left: margin, right: margin }
    });

    // ----- Pastoral sections -----
    doc.addPage();
    drawHeader();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Enfoque pastoral por secciones', margin, 84);

    let y = 104;
    doc.setFont('helvetica','normal');
    doc.setFontSize(11);
    doc.setTextColor(232,238,252);

    const pageBottom = H - margin;

    for (const it of ordered){
      const s = it.section;
      const mini = getMiniTeachingForSection(s.id);
      const title = `${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')} (${Math.round(it.pct*100)}%)`;
      const secVerse = (mini?.verse) || s.sectionVerse || { quote:'', reference:'' };

      const ensureSpace = (needed) => {
        if (y + needed > pageBottom){
          doc.addPage();
          drawHeader();
          y = 78;
        }
      };

      ensureSpace(90);
      doc.setFont('helvetica','bold');
      doc.text(title, margin, y);
      y += 16;

      if (!mini){
        doc.setFont('helvetica','normal');
        doc.setTextColor(170,183,214);
        doc.text('(sin mini-ense√±anza)', margin, y);
        doc.setTextColor(232,238,252);
        y += 16;
        continue;
      }

      doc.setFont('helvetica','normal');
      doc.setTextColor(232,238,252);
      doc.text(safeText(mini.title), margin, y);
      y += 14;

      const bullets = (mini.text || []).map(t => `‚Ä¢ ${safeText(t)}`);
      for (const b of bullets){
        ensureSpace(18);
        doc.setTextColor(232,238,252);
        doc.text(b, margin, y, { maxWidth: W - margin*2 });
        y += 14;
      }

      ensureSpace(34);
      doc.setFont('helvetica','italic');
      doc.setTextColor(170,183,214);
      doc.text(`‚Äú${safeText(secVerse.quote)}‚Äù (${safeText(secVerse.reference)})`, margin, y, { maxWidth: W - margin*2 });
      doc.setFont('helvetica','normal');
      y += 22;

      // divider
      doc.setDrawColor(34,48,78);
      doc.setLineWidth(1);
      doc.line(margin, y, W - margin, y);
      y += 16;
    }

    // ----- Observations + Portico -----
    doc.addPage();
    drawHeader();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Observaciones', margin, 84);

    doc.setFont('helvetica','normal');
    doc.setFontSize(11);
    doc.setTextColor(232,238,252);
    const obs = notes ? notes : '(sin observaciones)';
    doc.text(obs, margin, 106, { maxWidth: W - margin*2 });

    // Portico again (smaller)
    if (porticoPng){
      const imgW2 = W - margin*2;
      const imgH2 = imgW2 * (420/860);
      const y2 = 220;
      doc.addImage(porticoPng, 'PNG', margin, y2, imgW2, imgH2);
    }

    // ----- Details (optional) -----
    if (includeDetails){
      doc.addPage();
      drawHeader();
      doc.setFont('helvetica','bold');
      doc.setFontSize(14);
      doc.setTextColor(232,238,252);
      doc.text('Detalle por pregunta', margin, 84);

      const detailRows = [];
      for (const s of (state.data.sections || [])){
        for (const q of (s.questions || [])){
          const v = state.answers.get(q.id);
          detailRows.push([
            safeText(s.title),
            safeText(q.text),
            Number.isFinite(v) ? String(v) : '‚Äî'
          ]);
        }
      }

      doc.autoTable({
        startY: 100,
        head: [['Secci√≥n','Pregunta','Valor']],
        body: detailRows,
        styles: { font:'helvetica', fontSize:9, textColor:[232,238,252], fillColor:[15,23,42], lineColor:[34,48,78], lineWidth:0.5, cellPadding:5 },
        headStyles: { fillColor:[17,26,46], textColor:[170,183,214] },
        alternateRowStyles: { fillColor:[13,20,36] },
        margin: { left: margin, right: margin }
      });
    }

    const fileDate = date || 'fecha';
    doc.save(`ensenanza06_${fileDate}.pdf`);
  }

  // -------------------------
  // LOAD JSON + EVENTS
  // -------------------------
  async function loadJSON(){
    try{
      const res = await fetch(JSON_PATH, { cache:'no-store' });
      if (!res.ok) throw new Error(`No se pudo cargar ${JSON_PATH} (HTTP ${res.status}).`);
      const data = await res.json();
      state.data = data;

      // Ensure required structures exist
      if (!data.sections || !Array.isArray(data.sections)) throw new Error('JSON inv√°lido: falta "sections".');
      if (!data.scale?.options) throw new Error('JSON inv√°lido: falta "scale.options".');
      if (!data.rubrics?.globalBands || !data.rubrics?.sectionBands) throw new Error('JSON inv√°lido: falta "rubrics".');

      renderTest();
    }catch(err){
      const box = el('loadError');
      box.style.display = 'block';
      box.textContent = 'Error cargando ensenanza06.json: ' + (err?.message || err);
      console.error(err);
    }
  }

  function resetAll(){
    // clear answers
    state.answers.clear();
    state.lastPorticoPNG = null;

    // clear radios
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);

    // hide results
    el('resultsRoot').style.display = 'none';

    updateLive();
  }

  // Buttons
  el('btnResults').addEventListener('click', () => {
    renderResults();
  });

  el('btnTxt').addEventListener('click', () => {
    downloadTXT();
  });

  el('btnPdf').addEventListener('click', async () => {
    try{
      // If user never opened results, still compute and render diagram
      if (el('resultsRoot').style.display === 'none'){
        renderResults();
      }
      await downloadPDF();
    }catch(err){
      alert('No se pudo generar el PDF. ' + (err?.message || err));
      console.error(err);
    }
  });

  el('btnPng').addEventListener('click', async () => {
    // Ensure results shown (so SVG exists)
    if (el('resultsRoot').style.display === 'none'){
      renderResults();
    }
    await downloadPorticoPNG();
  });

  el('btnReset').addEventListener('click', () => {
    if (confirm('¬øReiniciar el test y borrar respuestas?')) resetAll();
  });

  // Load
  loadJSON();

})();
</script>

</body>
</html>
