<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title></title>

  <!-- Allowed CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1722;
      --panel2:#0b1320;
      --text:#e6eefc;
      --muted:#a6b3c7;
      --line:#1d2a3a;
      --focus:#6aa6ff;
      --good:#34d399;
      --warn:#fbbf24;
      --risk:#fb7185;
      --crit:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(900px 600px at 18% -10%, rgba(106,166,255,.16), transparent 55%),
                  radial-gradient(800px 520px at 96% 0%, rgba(52,211,153,.10), transparent 45%),
                  radial-gradient(900px 700px at 60% 110%, rgba(251,191,36,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:28px 16px 64px;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .mark{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,166,255,.22), rgba(52,211,153,.12));
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .mark:before{
      content:"";
      position:absolute;inset:-20%;
      background: radial-gradient(circle at 30% 30%, rgba(106,166,255,.35), transparent 50%),
                  radial-gradient(circle at 70% 60%, rgba(52,211,153,.28), transparent 55%),
                  radial-gradient(circle at 40% 90%, rgba(251,191,36,.18), transparent 55%);
      filter: blur(2px);
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width:64ch;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.09);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16);}
    .btn:active{transform: translateY(0px);}
    .btn.secondary{
      background: rgba(255,255,255,.03);
      box-shadow: none;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.25);
      background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.06));
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr; }
      .toolbar{justify-content:flex-start;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.07);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card .head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .card h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .muted{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }
    .band{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border
:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      width:100%;
      justify-content:space-between;
    }
    .band strong{font-weight:650; color:var(--text);}
    .band.aligned{border-color: rgba(52,211,153,.25); background: linear-gradient(180deg, rgba(52,211,153,.14), rgba(52,211,153,.05));}
    .band.adjust{border-color: rgba(251,191,36,.25); background: linear-gradient(180deg, rgba(251,191,36,.14), rgba(251,191,36,.05));}
    .band.risk{border-color: rgba(251,113,133,.25); background: linear-gradient(180deg, rgba(251,113,133,.14), rgba(251,113,133,.05));}
    .band.critical{border-color: rgba(239,68,68,.25); background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.06));}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .kpi{
      flex:1 1 180px;
      min-width:180px;
      padding:12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.18);
    }
    .kpi .label{color:var(--muted); font-size:12px;}
    .kpi .value{font-size:22px; margin-top:6px; font-weight:750; letter-spacing:.2px;}
    .kpi .hint{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35;}

    .divider{height:1px; background: rgba(255,255,255,.07); margin:12px 0;}

    .sections{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    details.sec{
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.16);
      border-radius: var(--radius2);
      overflow:hidden;
    }
    details.sec[open]{
      background: rgba(0,0,0,.20);
      border-color: rgba(255,255,255,.10);
    }
    summary.secSum{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      user-select:none;
    }
    summary.secSum::-webkit-details-marker{display:none}
    .secLeft{display:flex; gap:12px; align-items:flex-start;}
    .secIdx{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      font-family: var(--mono);
      color: var(--muted);
      font-size:12px;
      flex:0 0 auto;
    }
    .secTitles .t{margin:0; font-size:13px; font-weight:700;}
    .secTitles .s{margin-top:3px; color:var(--muted); font-size:12px; line-height:1.35;}
    .secRight{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .miniScore{
      font-family: var(--mono);
      color: var(--muted);
      font-size:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding:6px 10px;
      white-space:nowrap;
    }
    .secBody{
      padding: 0 12px 12px;
    }
    .secMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-size:12px;
      max-width: 100%;
    }
    .tag .k{opacity:.8}
    .tag .v{color: var(--text); font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .qList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .q{
      padding:12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.02);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .q .qt{
      flex: 1 1 auto;
      min-width: 0;
    }
    .q .qt .qId{
      font-family: var(--mono);
      font-size:11px;
      color: var(--muted);
      margin-bottom:6px;
    }
    .q .qt .qText{
      font-size:13px;
      line-height:1.4;
      color: var(--text);
    }

    .scale{
      flex: 0 0 auto;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .dot{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      display:grid; place-items:center;
      font-family: var(--mono);
      font-size:12px;
      cursor:pointer;
      transition: transform .10s ease, border-color .12s ease, background .12s ease, color .12s ease;
      user-select:none;
    }
    .dot:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18);}
    .dot.active{
      color: var(--text);
      border-color: rgba(106,166,255,.35);
      background: rgba(106,166,255,.14);
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.16);
    }
    .table th, .table td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align:top;
    }
    .table th{color: var(--muted); font-weight:650; background: rgba(255,255,255,.02);}
    .table tr:last-child td{border-bottom:none}
    .mono{font-family: var(--mono);}

    .svgWrap{
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.14);
      padding:12px;
      overflow:hidden;
      position:relative;
    }
    .svgTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    .sw{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      font-size:12px;
      color: var(--muted);
    }
    .sw i{
      width:10px;height:10px;border-radius:999px; display:inline-block;
      background: currentColor;
    }
    .sw.live{color: var(--good);}
    .sw.dead{color: var(--crit);}
    .sw.seis{color: #9aa6b2;}

    svg#portico{
      width:100%;
      height:auto;
      display:block;
    }
    .node{cursor:pointer}
    .part{cursor:pointer}
    .loadArrow{cursor:pointer}
    .hoverGlow{filter: drop-shadow(0 0 14px rgba(106,166,255,.22));}

    .tooltip{
      position:absolute;
      pointer-events:none;
      z-index:20;
      background: rgba(10,14,20,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
      max-width: 320px;
      box-shadow: var(--shadow);
      transform: translate(10px, 10px);
      opacity:0;
      transition: opacity .10s ease;
    }
    .tooltip .t{font-size:12px; font-weight:750; margin-bottom:4px;}
    .tooltip .b{font-size:12px; color: var(--muted); line-height:1.35;}
    .tooltip.show{opacity:1;}

    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      width: min(920px, 100%);
      max-height: min(86vh, 920px);
      overflow:auto;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{margin:0; font-size:14px; letter-spacing:.2px;}
    .modalBody{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .modalBody{grid-template-columns:1fr;}
    }
    .box{
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.16);
      padding:12px;
    }
    .box h3{margin:0 0 8px; font-size:13px;}
    .box p{margin:0; color: var(--muted); font-size:12px; line-height:1.5;}
    .list{
      margin:8px 0 0;
      padding:0 0 0 16px;
      color: var(--muted);
      font-size:12px;
      line-height:1.55;
    }

    .ghost{
      opacity:.0;
      height:0;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1 id="appTitle"></h1>
          <div class="sub" id="appSubtitle"></div>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn secondary" id="btnSave" type="button">
          <span id="lblSave"></span>
          <span aria-hidden="true">üíæ</span>
        </button>
        <button class="btn secondary" id="btnReset" type="button">
          <span id="lblReset"></span>
          <span aria-hidden="true">‚Ü∫</span>
        </button>
        <button class="btn" id="btnPdf" type="button">
          <span id="lblPdf"></span>
          <span aria-hidden="true">üìÑ</span>
        </button>
        <button class="btn" id="btnPng" type="button">
          <span id="lblPng"></span>
          <span aria-hidden="true">üñºÔ∏è</span>
        </button>
        <button class="btn" id="btnTxt" type="button">
          <span id="lblTxt"></span>
          <span aria-hidden="true">üßæ</span>
        </button>
        <button class="btn danger" id="btnClearAll" type="button">
          <span id="lblClear"></span>
          <span aria-hidden="true">üóëÔ∏è</span>
        </button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div>
            <h2 id="hdrAssessment"></h2>
            <div class="muted" id="hdrAssessmentSub"></div>
          </div>
          <div class="pill" id="pillGlobal"></div>
        </div>

        <div class="row" id="kpis">
          <div class="kpi">
            <div class="label" id="kpiGlobalLabel"></div>
            <div class="value mono" id="kpiGlobalValue">‚Äî</div>
            <div class="hint" id="kpiGlobalHint"></div>
          </div>
          <div class="kpi">
            <div class="label" id="kpiAxisLabel"></div>
            <div class="value mono" id="kpiAxisValue">‚Äî</div>
            <div class="hint" id="kpiAxisHint"></div>
          </div>
          <div class="kpi">
            <div class="label" id="kpiSectionsLabel"></div>
            <div class="value mono" id="kpiSectionsValue">‚Äî</div>
            <div class="hint" id="kpiSectionsHint"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="globalBand" class="band aligned">
          <strong id="bandTitle"></strong>
          <span class="mono" id="bandScore"></span>
        </div>

        <div class="divider"></div>

        <div class="sections" id="sections"></div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <h2 id="hdrPortico"></h2>
            <div class="muted" id="hdrPorticoSub"></div>
          </div>
          <div class="pill" id="pillBeforeAfter"></div>
        </div>

        <div class="svgWrap" id="svgWrap">
          <div class="svgTop">
            <div class="pill" id="pillAxis"></div>
            <div class="legend">
              <span class="sw live"><i></i><span id="lblLive"></span></span>
              <span class="sw dead"><i></i><span id="lblDead"></span></span>
              <span class="sw seis"><i></i><span id="lblSeis"></span></span>
            </div>
          </div>

          <div class="tooltip" id="tooltip">
            <div class="t" id="ttTitle"></div>
            <div class="b" id="ttBody"></div>
          </div>

          <!-- REAL SVG P√≥rtico -->
          <svg id="portico" viewBox="0 0 900 560" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="">
            <defs>
              <linearGradient id="gPanel" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.06)"/>
                <stop offset="1" stop-color="rgba(255,255,255,.02)"/>
              </linearGradient>
              <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor"/>
              </marker>
            </defs>

            <!-- Frame background -->
            <rect x="18" y="18" width="864" height="524" rx="22" fill="url(#gPanel)" stroke="rgba(255,255,255,.08)"/>

            <!-- Ground line -->
            <path d="M 80 460 H 820" stroke="rgba(255,255,255,.08)" stroke-width="2"/>

            <!-- CIMIENTO -->
            <g class="part" data-part="cimiento">
              <rect x="130" y="420" width="640" height="70" rx="18" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
              <path d="M 150 450 H 750" stroke="rgba(255,255,255,.08)" stroke-width="2" stroke-dasharray="6 8"/>
              <circle class="node" data-node="nudo-izq-cimiento" cx="220" cy="455" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
              <circle class="node" data-node="nudo-der-cimiento" cx="680" cy="455" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
            </g>

            <!-- COLUMNA -->
            <g class="part" data-part="columna">
              <rect x="220" y="180" width="56" height="240" rx="14" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.11)" stroke-width="2"/>
              <circle class="node" data-node="nudo-columna-base" cx="248" cy="420" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
              <circle class="node" data-node="nudo-columna-cabeza" cx="248" cy="180" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
            </g>

            <!-- VIGA -->
            <g class="part" data-part="viga">
              <rect x="248" y="150" width="470" height="56" rx="14" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.11)" stroke-width="2"/>
              <circle class="node" data-node="nudo-viga-izq" cx="248" cy="178" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
              <circle class="node" data-node="nudo-viga-der" cx="718" cy="178" r="7" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.18)"/>
            </g>

            <!-- Apoyo m√≥vil (representado como rodillo) -->
            <g class="part" data-part="apoyo">
              <path d="M 705 206 L 731 206 L 718 228 Z" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
              <circle cx="710" cy="235" r="8" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
              <circle cx="726" cy="235" r="8" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            </g>

            <!-- Flechas de carga -->
            <g class="loadArrow live" data-load="viva" style="color: var(--good);">
              <path d="M 360 105 V 142" stroke="currentColor" stroke-width="4" marker-end="url(#arrow)"/>
              <path d="M 520 105 V 142" stroke="currentColor" stroke-width="4" marker-end="url(#arrow)"/>
            </g>
            <g class="loadArrow dead" data-load="muerta" style="color: var(--crit);">
              <path d="M 440 105 V 142" stroke="currentColor" stroke-width="4" marker-end="url(#arrow)"/>
            </g>
            <g class="loadArrow seis" data-load="sismica" style="color: #9aa6b2;">
              <path d="M 140 360 H 205" stroke="currentColor" stroke-width="4" marker-end="url(#arrow)"/>
              <path d="M 140 340 H 205" stroke="currentColor" stroke-width="4" marker-end="url(#arrow)"/>
            </g>

            <!-- Etiquetas (vac√≠as; se llenan desde JSON para cumplir regla de texto) -->
            <g font-family="var(--sans)" font-size="13" fill="rgba(230,238,252,.90)">
              <text id="svgLabelCimiento" x="160" y="445"></text>
              <text id="svgLabelColumna" x="220" y="168"></text>
              <text id="svgLabelViga" x="248" y="140"></text>
              <text id="svgLabelApoyo" x="660" y="260"></text>
            </g>
          </svg>
        </div>

        <div class="divider"></div>

        <div class="box">
          <h3 id="hdrSteps"></h3>
          <div class="muted" id="stepsIntro"></div>
          <ol class="list" id="steps"></ol>
        </div>

        <div class="divider"></div>

        <div class="box">
          <h3 id="hdrAxes"></h3>
          <table class="table" id="axesTable" aria-label="">
            <thead>
              <tr>
                <th id="thAxis"></th>
                <th id="thScore"></th>
                <th id="thBand"></th>
              </tr>
            </thead>
            <tbody id="axesBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h3 class="modalTitle" id="modalTitle"></h3>
          <div class="muted" id="modalSub"></div>
        </div>
        <button class="btn secondary" id="btnCloseModal" type="button">
          <span id="lblClose"></span>
          <span aria-hidden="true">‚úï</span>
        </button>
      </div>

      <div class="modalBody">
        <div class="box">
          <h3 id="hdrTeaching"></h3>
          <p id="modalTeaching"></p>
          <div class="divider"></div>
          <h3 id="hdrVerse"></h3>
          <p id="modalVerse"></p>
        </div>
        <div class="box">
          <h3 id="hdrActions"></h3>
          <ul class="list" id="modalActions"></ul>
          <div class="divider"></div>
          <div class="muted" id="modalNote"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const JSON_PATH = "viga-mujer.json";
      const LS_KEY = "audit:viga-mujer";

      const $ = (id)=>document.getElementById(id);
      const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
      const fmt1 = (n)=> (Math.round(n*10)/10).toFixed(1);
      const safeText = (v)=> (v==null ? "" : String(v));

      let data = null;
      let state = { answers: {} }; // qid -> 0..5 (null => unanswered)
      let lastSaved = null;

      const ui = {
        title: $("appTitle"),
        subtitle: $("appSubtitle"),
        labels: {
          save: $("lblSave"),
          reset: $("lblReset"),
          pdf: $("lblPdf"),
          png: $("lblPng"),
          txt: $("lblTxt"),
          clear: $("lblClear"),
          close: $("lblClose"),
          live: $("lblLive"),
          dead: $("lblDead"),
          seis: $("lblSeis"),
        },
        headers: {
          assessment: $("hdrAssessment"),
          assessmentSub: $("hdrAssessmentSub"),
          portico: $("hdrPortico"),
          porticoSub: $("hdrPorticoSub"),
          steps: $("hdrSteps"),
          stepsIntro: $("stepsIntro"),
          axes: $("hdrAxes"),
          teaching: $("hdrTeaching"),
          verse: $("hdrVerse"),
          actions: $("hdrActions"),
        },
        pills: {
          global: $("pillGlobal"),
          axis: $("pillAxis"),
          beforeAfter: $("pillBeforeAfter"),
        },
        kpis: {
          gLabel: $("kpiGlobalLabel"),
          gValue: $("kpiGlobalValue"),
          gHint: $("kpiGlobalHint"),
          aLabel: $("kpiAxisLabel"),
          aValue: $("kpiAxisValue"),
          aHint: $("kpiAxisHint"),
          sLabel: $("kpiSectionsLabel"),
          sValue: $("kpiSectionsValue"),
          sHint: $("kpiSectionsHint"),
        },
        band: {
          el: $("globalBand"),
          title: $("bandTitle"),
          score: $("bandScore"),
        },
        sections: $("sections"),
        axes: {
          table: $("axesTable"),
          body: $("axesBody"),
          thAxis: $("thAxis"),
          thScore: $("thScore"),
          thBand: $("thBand"),
        },
        tooltip: {
          box: $("tooltip"),
          t: $("ttTitle"),
          b: $("ttBody"),
        },
        svg: {
          wrap: $("svgWrap"),
          root: $("portico"),
          labelC: $("svgLabelCimiento"),
          labelCol: $("svgLabelColumna"),
          labelV: $("svgLabelViga"),
          labelA: $("svgLabelApoyo"),
        },
        steps: $("steps"),
        modal: {
          back: $("modalBackdrop"),
          title: $("modalTitle"),
          sub: $("modalSub"),
          teaching: $("modalTeaching"),
          verse: $("modalVerse"),
          actions: $("modalActions"),
          note: $("modalNote"),
        },
        btns: {
          save: $("btnSave"),
          reset: $("btnReset"),
          pdf: $("btnPdf"),
          png: $("btnPng"),
          txt: $("btnTxt"),
          clear: $("btnClearAll"),
          closeModal: $("btnCloseModal"),
        },
      };

      function bandForScore(avg){
        // 0..5 where 5 is best alignment.
        const b = data?.rubrics?.globalBands || [];
        // Expect bands with min/max inclusive; pick match. Fallback thresholds.
        for(const band of b){
          if(typeof band?.min==="number" && typeof band?.max==="number"){
            if(avg>=band.min && avg<=band.max) return band;
          }
        }
        // fallback
        if(avg>=4.2) return {key:"aligned", label:"", css:"aligned"};
        if(avg>=3.2) return {key:"adjust", label:"", css:"adjust"};
        if(avg>=2.0) return {key:"risk", label:"", css:"risk"};
        return {key:"critical", label:"", css:"critical"};
      }

      function sectionBandForScore(avg){
        const b = data?.rubrics?.sectionBands || [];
        for(const band of b){
          if(typeof band?.min==="number" && typeof band?.max==="number"){
            if(avg>=band.min && avg<=band.max) return band;
          }
        }
        return bandForScore(avg);
      }

      function getUi(path, fallback=""){
        // meta.ui.* is optional; avoid visible fixed text if absent
        const parts = path.split(".");
        let cur = data?.meta?.ui;
        for(const p of parts){
          if(!cur || typeof cur!=="object") return fallback;
          cur = cur[p];
        }
        return safeText(cur ?? fallback);
      }

      function loadLocal(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return null;
          return JSON.parse(raw);
        }catch(e){ return null; }
      }

      function saveLocal(payload){
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      }

      function clearLocal(){
        localStorage.removeItem(LS_KEY);
      }

      function hydrateFromSaved(saved){
        if(!saved) return;
        if(saved.answers && typeof saved.answers==="object"){
          state.answers = saved.answers;
        }
      }

      function compute(){
        const sections = data.sections || [];
        const axes = (data.porticoModel && data.porticoModel.axes) ? data.porticoModel.axes : [];
        const qMax = (data.scale && data.scale.options ? Math.max(...data.scale.options.map(o=>o.value)) : 5) || 5;

        // Per section
        const sectionScores = sections.map(sec=>{
          const qs = sec.questions || [];
          let sum=0, cnt=0;
          for(const q of qs){
            const v = state.answers[q.id];
            if(v==null || v==="") continue;
            sum += Number(v);
            cnt += 1;
          }
          const avg = cnt ? sum/cnt : 0;
          const pct = (avg / qMax) * 100;
          return { id: sec.id, title: sec.title, avg, pct, cnt, total: qs.length, porticoAxis: sec.porticoAxis };
        });

        // Per axis (aggregate across sections that map to axis)
        const axisScores = axes.map(ax=>{
          const rel = sectionScores.filter(s=>s.porticoAxis===ax.id);
          let sum=0, cnt=0, totalQ=0;
          for(const s of rel){
            const sec = sections.find(x=>x.id===s.id);
            const qs = sec?.questions || [];
            totalQ += qs.length;
            // Weighted by answered questions in section
            if(s.cnt){
              sum += s.avg * s.cnt;
              cnt += s.cnt;
            }
          }
          const avg = cnt ? sum/cnt : 0;
          const pct = (avg / qMax) * 100;
          return { id: ax.id, title: ax.title, avg, pct, answered: cnt, totalQ };
        });

        // Global (all answered questions)
        let gSum=0, gCnt=0, gTotal=0;
        for(const sec of sections){
          for(const q of (sec.questions||[])){
            gTotal++;
            const v = state.answers[q.id];
            if(v==null || v==="") continue;
            gSum += Number(v);
            gCnt++;
          }
        }
        const gAvg = gCnt ? gSum/gCnt : 0;
        const gPct = (gAvg / qMax) * 100;

        return { sectionScores, axisScores, global: { avg: gAvg, pct: gPct, answered: gCnt, totalQ: gTotal } };
      }

      function renderTop(){
        document.title = safeText(data?.meta?.title || "");
        ui.title.textContent = safeText(data?.meta?.title || "");
        ui.subtitle.textContent = safeText(data?.meta?.subtitle || "");

        ui.labels.save.textContent = getUi("buttons.save", "");
        ui.labels.reset.textContent = getUi("buttons.reset", "");
        ui.labels.pdf.textContent = getUi("buttons.pdf", "");
        ui.labels.png.textContent = getUi("buttons.png", "");
        ui.labels.txt.textContent = getUi("buttons.txt", "");
        ui.labels.clear.textContent = getUi("buttons.clear", "");
        ui.labels.close.textContent = getUi("buttons.close", "");

        ui.headers.assessment.textContent = getUi("headers.assessment", "");
        ui.headers.assessmentSub.textContent = safeText(data?.meta?.description || "");

        ui.headers.portico.textContent = getUi("headers.portico", "");
        ui.headers.porticoSub.textContent = getUi("headers.porticoSub", "");

        ui.headers.steps.textContent = getUi("headers.steps", "");
        ui.headers.stepsIntro.textContent = getUi("headers.stepsIntro", "");

        ui.headers.axes.textContent = getUi("headers.axes", "");

        ui.headers.teaching.textContent = getUi("headers.teaching", "");
        ui.headers.verse.textContent = getUi("headers.verse", "");
        ui.headers.actions.textContent = getUi("headers.actions", "");

        ui.kpis.gLabel.textContent = getUi("kpis.globalLabel", "");
        ui.kpis.gHint.textContent = getUi("kpis.globalHint", "");
        ui.kpis.aLabel.textContent = getUi("kpis.axisLabel", "");
        ui.kpis.aHint.textContent = getUi("kpis.axisHint", "");
        ui.kpis.sLabel.textContent = getUi("kpis.sectionsLabel", "");
        ui.kpis.sHint.textContent = getUi("kpis.sectionsHint", "");

        ui.axes.thAxis.textContent = getUi("tables.axis", "");
        ui.axes.thScore.textContent = getUi("tables.score", "");
        ui.axes.thBand.textContent = getUi("tables.band", "");
        ui.axes.table.setAttribute("aria-label", getUi("tables.axisAria", ""));

        ui.svg.root.setAttribute("aria-label", getUi("svg.aria", ""));
        ui.modal.back.setAttribute("aria-label", getUi("modal.aria", ""));

        ui.labels.live.textContent = getUi("legend.live", "");
        ui.labels.dead.textContent = getUi("legend.dead", "");
        ui.labels.seis.textContent = getUi("legend.seismic", "");

        ui.svg.labelC.textContent = getUi("svg.labels.cimiento", "");
        ui.svg.labelCol.textContent = getUi("svg.labels.columna", "");
        ui.svg.labelV.textContent = getUi("svg.labels.viga", "");
        ui.svg.labelA.textContent = getUi("svg.labels.apoyo", "");
      }

      function makeDots(qid, current){
        const opts = (data.scale && data.scale.options) ? data.scale.options : [
          {value:0,label:"0"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"},{value:5,label:"5"}
        ];
        const wrap = document.createElement("div");
        wrap.className = "scale";
        for(const o of opts){
          const b = document.createElement("button");
          b.type="button";
          b.className = "dot" + (Number(current)===Number(o.value) ? " active" : "");
          b.textContent = safeText(o.value);
          b.addEventListener("click", ()=>{
            state.answers[qid] = Number(o.value);
            renderAll();
          });
          wrap.appendChild(b);
        }
        return wrap;
      }

      function renderSections(computed){
        ui.sections.innerHTML = "";
        const sections = data.sections || [];
        const secScoreMap = new Map(computed.sectionScores.map(s=>[s.id,s]));

        let idx = 0;
        for(const sec of sections){
          idx++;
          const det = document.createElement("details");
          det.className = "sec";
          det.dataset.sec = sec.id;

          const sum = document.createElement("summary");
          sum.className = "secSum";

          const left = document.createElement("div");
          left.className = "secLeft";

          const boxIdx = document.createElement("div");
          boxIdx.className = "secIdx";
          boxIdx.textContent = String(idx);

          const titles = document.createElement("div");
          titles.className = "secTitles";
          const t = document.createElement("div");
          t.className = "t";
          t.textContent = safeText(sec.title || "");
          const s = document.createElement("div");
          s.className = "s";
          s.textContent = safeText(sec.subtitle || "");
          titles.appendChild(t);
          titles.appendChild(s);

          left.appendChild(boxIdx);
          left.appendChild(titles);

          const right = document.createElement("div");
          right.className = "secRight";

          const score = secScoreMap.get(sec.id) || {avg:0,cnt:0,total:(sec.questions||[]).length};
          const band = sectionBandForScore(score.avg);

          const mini = document.createElement("div");
          mini.className = "miniScore";
          mini.textContent = `${fmt1(score.avg)} / 5  ¬∑  ${score.cnt}/${score.total}`;

          const miniBand = document.createElement("div");
          miniBand.className = "miniScore";
          miniBand.textContent = safeText(band?.label || "");

          right.appendChild(mini);
          right.appendChild(miniBand);

          sum.appendChild(left);
          sum.appendChild(right);

          const body = document.createElement("div");
          body.className = "secBody";

          const meta = document.createElement("div");
          meta.className = "secMeta";

          const tag1 = document.createElement("div");
          tag1.className = "tag";
          tag1.innerHTML = `<span class="k">${safeText(getUi("labels.diagnosticFocus",""))}</span><span class="v">${safeText(sec.diagnosticFocus||"")}</span>`;

          const tag2 = document.createElement("div");
          tag2.className = "tag";
          tag2.innerHTML = `<span class="k">${safeText(getUi("labels.porticoAxis",""))}</span><span class="v">${safeText(axisTitle(sec.porticoAxis))}</span>`;

          const tag3 = document.createElement("div");
          tag3.className = "tag";
          tag3.innerHTML = `<span class="k">${safeText(getUi("labels.sectionVerse",""))}</span><span class="v">${safeText(sec.sectionVerse||"")}</span>`;

          meta.appendChild(tag1);
          meta.appendChild(tag2);
          meta.appendChild(tag3);

          const qList = document.createElement("div");
          qList.className = "qList";

          for(const q of (sec.questions||[])){
            const qRow = document.createElement("div");
            qRow.className = "q";

            const qt = document.createElement("div");
            qt.className = "qt";

            const qId = document.createElement("div");
            qId.className = "qId";
            qId.textContent = safeText(q.id);

            const qText = document.createElement("div");
            qText.className = "qText";
            qText.textContent = safeText(q.text);

            qt.appendChild(qId);
            qt.appendChild(qText);

            const dots = makeDots(q.id, state.answers[q.id]);

            qRow.appendChild(qt);
            qRow.appendChild(dots);
            qList.appendChild(qRow);
          }

          body.appendChild(meta);
          body.appendChild(qList);

          det.appendChild(sum);
          det.appendChild(body);

          // Click open modal from summary right side via double click
          sum.addEventListener("dblclick", (e)=>{
            e.preventDefault();
            openModalForSection(sec.id);
          });

          ui.sections.appendChild(det);
        }
      }

      function axisTitle(axisId){
        const ax = (data.porticoModel?.axes || []).find(a=>a.id===axisId);
        return ax ? safeText(ax.title) : safeText(axisId||"");
      }

      function renderAxesTable(computed){
        ui.axes.body.innerHTML = "";
        for(const ax of computed.axisScores){
          const tr = document.createElement("tr");
          const tdA = document.createElement("td");
          tdA.textContent = safeText(ax.title || ax.id);
          const tdS = document.createElement("td");
          tdS.className = "mono";
          tdS.textContent = `${fmt1(ax.avg)} / 5  ¬∑  ${ax.answered}/${ax.totalQ}`;
          const band = bandForScore(ax.avg);
          const tdB = document.createElement("td");
          tdB.textContent = safeText(band?.label || "");
          tr.appendChild(tdA);
          tr.appendChild(tdS);
          tr.appendChild(tdB);
          ui.axes.body.appendChild(tr);
        }
      }

      function renderGlobal(computed){
        const g = computed.global;

        ui.kpis.gValue.textContent = `${fmt1(g.avg)} / 5`;
        ui.kpis.aValue.textContent = computed.axisScores.length ? `${fmt1(avgOf(computed.axisScores.map(a=>a.avg)))} / 5` : `‚Äî`;
        ui.kpis.sValue.textContent = computed.sectionScores.length ? `${fmt1(avgOf(computed.sectionScores.map(s=>s.avg)))} / 5` : `‚Äî`;

        const band = bandForScore(g.avg);
        ui.band.el.className = `band ${band.css || band.key || "aligned"}`;
        ui.band.title.textContent = safeText(band.label || "");
        ui.band.score.textContent = `${fmt1(g.avg)} / 5  ¬∑  ${g.answered}/${g.totalQ}`;

        ui.pills.global.textContent = safeText(getUi("pills.global","")) || safeText(band.label || "");
        ui.pills.axis.textContent = safeText(getUi("pills.axis",""));
      }

      function avgOf(arr){
        if(!arr.length) return 0;
        let s=0; for(const n of arr) s += Number(n)||0;
        return s/arr.length;
      }

      function renderBeforeAfter(computed){
        const current = computed.global.avg;
        const prev = lastSaved?.computed?.global?.avg;

        const label = safeText(getUi("pills.beforeAfter",""));
        if(prev==null){
          ui.pills.beforeAfter.textContent = label ? label : "";
          return;
        }
        const delta = current - prev;
        const sign = delta>0 ? "+" : "";
        ui.pills.beforeAfter.textContent = `${label ? (label+" ") : ""}${fmt1(prev)} ‚Üí ${fmt1(current)} (${sign}${fmt1(delta)})`;
      }

      function buildSteps(){
        ui.steps.innerHTML = "";
        // Derive steps purely from JSON content; prefer meta.ui.steps[] or fallback to axes + flow model
        const steps = data?.meta?.ui?.steps;
        const list = Array.isArray(steps) && steps.length ? steps : deriveStepsFromModel();
        for(const s of list){
          const li = document.createElement("li");
          li.textContent = safeText(s);
          ui.steps.appendChild(li);
        }
      }

      function deriveStepsFromModel(){
        const sections = data.sections || [];
        const axes = data.porticoModel?.axes || [];
        const byAxis = new Map();
        for(const a of axes) byAxis.set(a.id, []);
        for(const sec of sections){
          if(!byAxis.has(sec.porticoAxis)) byAxis.set(sec.porticoAxis, []);
          byAxis.get(sec.porticoAxis).push(sec);
        }
        const out = [];
        // Use axis order to generate a guided reading path
        for(const ax of axes){
          const secs = byAxis.get(ax.id) || [];
          const line = safeText(ax.title || ax.id) + (secs.length ? ": " + secs.map(s=>safeText(s.title)).filter(Boolean).join(" ¬∑ ") : "");
          out.push(line);
        }
        return out.filter(Boolean);
      }

      function hookSvg(){
        const svg = ui.svg.root;
        const wrap = ui.svg.wrap;

        function showTooltip(x,y,title,body){
          ui.tooltip.t.textContent = safeText(title);
          ui.tooltip.b.textContent = safeText(body);
          ui.tooltip.box.style.left = x + "px";
          ui.tooltip.box.style.top = y + "px";
          ui.tooltip.box.classList.add("show");
        }
        function hideTooltip(){
          ui.tooltip.box.classList.remove("show");
        }

        function tipForTarget(t){
          const part = t.closest("[data-part]");
          const node = t.closest("[data-node]");
          const load = t.closest("[data-load]");

          if(load){
            const k = load.getAttribute("data-load");
            const title = getUi(`svg.tooltips.loads.${k}.title`, "");
            const body  = getUi(`svg.tooltips.loads.${k}.body`, "");
            return {title, body, clickKey: `load:${k}`};
          }
          if(node){
            const k = node.getAttribute("data-node");
            const title = getUi(`svg.tooltips.nodes.${k}.title`, "");
            const body  = getUi(`svg.tooltips.nodes.${k}.body`, "");
            return {title, body, clickKey: `node:${k}`};
          }
          if(part){
            const k = part.getAttribute("data-part");
            const title = getUi(`svg.tooltips.parts.${k}.title`, "");
            const body  = getUi(`svg.tooltips.parts.${k}.body`, "");
            return {title, body, clickKey: `part:${k}`};
          }
          return null;
        }

        svg.addEventListener("mousemove", (e)=>{
          const tip = tipForTarget(e.target);
          if(!tip){ hideTooltip(); return; }
          const r = wrap.getBoundingClientRect();
          showTooltip(e.clientX - r.left, e.clientY - r.top, tip.title, tip.body);
        });
        svg.addEventListener("mouseleave", hideTooltip);

        svg.addEventListener("click", (e)=>{
          const tip = tipForTarget(e.target);
          if(!tip) return;

          // If click corresponds to a known section mapping, open that section
          const map = data?.meta?.ui?.svgClickMap || {};
          const secId = map[tip.clickKey];
          if(secId){
            openModalForSection(secId);
            // auto-open details
            const det = document.querySelector(`details.sec[data-sec="${CSS.escape(secId)}"]`);
            if(det) det.open = true;
            return;
          }

          // else open a generic modal from ui text (still JSON-sourced)
          openModalGeneric(tip.title, tip.body, getUi("modal.genericNote",""), []);
        });
      }

      function openModalForSection(secId){
        const sec = (data.sections||[]).find(s=>s.id===secId);
        const man = (data.pastoralManual?.sections||[]).find(s=>s.id===secId);

        const title = safeText(sec?.title || "");
        const sub = safeText(sec?.diagnosticFocus || "");

        const teaching = safeText(man?.teaching || man?.summary || "");
        const verse = safeText(sec?.sectionVerse || man?.verse || "");
        const actions = Array.isArray(man?.actions) ? man.actions : (Array.isArray(man?.steps) ? man.steps : []);

        openModalGeneric(title, teaching, verse, actions, sub);
      }

      function openModalGeneric(title, teaching, verse, actions, sub=""){
        ui.modal.title.textContent = safeText(title);
        ui.modal.sub.textContent = safeText(sub);
        ui.modal.teaching.textContent = safeText(teaching);
        ui.modal.verse.textContent = safeText(verse);
        ui.modal.actions.innerHTML = "";
        for(const a of actions){
          const li = document.createElement("li");
          li.textContent = safeText(a);
          ui.modal.actions.appendChild(li);
        }
        ui.modal.note.textContent = safeText(getUi("modal.note",""));
        ui.modal.back.classList.add("show");
      }

      function closeModal(){
        ui.modal.back.classList.remove("show");
      }

      function hookModal(){
        ui.btns.closeModal.addEventListener("click", closeModal);
        ui.modal.back.addEventListener("click", (e)=>{
          if(e.target === ui.modal.back) closeModal();
        });
        window.addEventListener("keydown", (e)=>{
          if(e.key==="Escape") closeModal();
        });
      }

      function exportTxt(computed){
        const lines = [];
        const meta = data.meta || {};
        lines.push(safeText(meta.title||""));
        lines.push(safeText(meta.subtitle||""));
        lines.push("");

        const g = computed.global;
        lines.push(`${safeText(getUi("exports.globalLine",""))}`.trim());
        lines.push(`GLOBAL: ${fmt1(g.avg)} / 5  (${g.answered}/${g.totalQ})`);
        lines.push("");

        lines.push("AXES:");
        for(const ax of computed.axisScores){
          lines.push(`- ${safeText(ax.title||ax.id)}: ${fmt1(ax.avg)} / 5  (${ax.answered}/${ax.totalQ})`);
        }
        lines.push("");

        lines.push("SECCIONES:");
        for(const s of computed.sectionScores){
          lines.push(`- ${safeText(s.title||s.id)}: ${fmt1(s.avg)} / 5  (${s.cnt}/${s.total})`);
        }
        lines.push("");

        lines.push("RESPUESTAS:");
        for(const sec of (data.sections||[])){
          lines.push(`\n[${safeText(sec.title)}]`);
          for(const q of (sec.questions||[])){
            const v = state.answers[q.id];
            const vv = (v==null || v==="") ? "-" : String(v);
            lines.push(`${safeText(q.id)}\t${vv}\t${safeText(q.text)}`);
          }
        }

        const blob = new Blob([lines.join("\n")], {type:"text/plain;charset=utf-8"});
        downloadBlob(blob, (data.meta?.id || "auditoria") + ".txt");
      }

      function exportPdf(computed){
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF) return;

        const doc = new jsPDF({ unit:"pt", format:"a4" });
        const margin = 42;
        let y = margin;

        const title = safeText(data?.meta?.title||"");
        const subtitle = safeText(data?.meta?.subtitle||"");
        const desc = safeText(data?.meta?.description||"");

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(title, margin, y);
        y += 18;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        if(subtitle){
          doc.text(subtitle, margin, y);
          y += 14;
        }
        if(desc){
          doc.setTextColor(120);
          doc.text(doc.splitTextToSize(desc, 520), margin, y);
          doc.setTextColor(0);
          y += 28;
        } else {
          y += 10;
        }

        const g = computed.global;
        doc.setFont("helvetica","bold");
        doc.setFontSize(11);
        doc.text(`GLOBAL: ${fmt1(g.avg)} / 5  (${g.answered}/${g.totalQ})`, margin, y);
        y += 10;

        const band = bandForScore(g.avg);
        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text(`${safeText(getUi("exports.bandLabel",""))} ${safeText(band.label||"")}`, margin, y);
        y += 16;

        // Axes table
        doc.setFont("helvetica","bold");
        doc.text(safeText(getUi("exports.axesTitle","")) || "AXES", margin, y);
        y += 8;

        doc.autoTable({
          startY: y,
          head: [[safeText(getUi("tables.axis",""))||"Eje", safeText(getUi("tables.score",""))||"Puntaje", safeText(getUi("tables.band",""))||"Banda"]],
          body: computed.axisScores.map(ax=>{
            const b = bandForScore(ax.avg);
            return [safeText(ax.title||ax.id), `${fmt1(ax.avg)} / 5  ¬∑  ${ax.answered}/${ax.totalQ}`, safeText(b.label||"")];
          }),
          theme: "grid",
          styles: { fontSize: 9 },
          headStyles: { fillColor: [20,25,35] },
          margin: { left: margin, right: margin },
        });

        y = doc.lastAutoTable.finalY + 14;

        // Sections table
        doc.setFont("helvetica","bold");
        doc.text(safeText(getUi("exports.sectionsTitle","")) || "SECCIONES", margin, y);
        y += 8;

        doc.autoTable({
          startY: y,
          head: [[safeText(getUi("exports.sectionCol",""))||"Secci√≥n", safeText(getUi("tables.score",""))||"Puntaje", safeText(getUi("tables.band",""))||"Banda"]],
          body: computed.sectionScores.map(s=>{
            const b = sectionBandForScore(s.avg);
            return [safeText(s.title||s.id), `${fmt1(s.avg)} / 5  ¬∑  ${s.cnt}/${s.total}`, safeText(b.label||"")];
          }),
          theme: "grid",
          styles: { fontSize: 9 },
          headStyles: { fillColor: [20,25,35] },
          margin: { left: margin, right: margin },
        });

        // Portico SVG snapshot as image (best-effort)
        try{
          const svgData = serializeSvgToDataUrl(ui.svg.root);
          const img = new Image();
          img.onload = function(){
            const pageW = doc.internal.pageSize.getWidth();
            const usableW = pageW - margin*2;
            const ratio = img.width ? (usableW / img.width) : 1;
            const h = img.height * ratio;
            doc.addPage();
            doc.setFont("helvetica","bold");
            doc.setFontSize(11);
            doc.text(safeText(getUi("exports.porticoTitle","")) || "", margin, margin);
            doc.addImage(img, "PNG", margin, margin+14, usableW, h);
            doc.save((data.meta?.id || "auditoria") + ".pdf");
          };
          img.onerror = function(){
            doc.save((data.meta?.id || "auditoria") + ".pdf");
          };
          img.src = svgData;
          return;
        }catch(e){/* ignore */}

        doc.save((data.meta?.id || "auditoria") + ".pdf");
      }

      function exportPng(){
        const url = serializeSvgToDataUrl(ui.svg.root);
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          canvas.toBlob((blob)=>{
            if(blob) downloadBlob(blob, (data.meta?.id || "portico") + ".png");
          }, "image/png");
        };
        img.src = url;
      }

      function serializeSvgToDataUrl(svgEl){
        const clone = svgEl.cloneNode(true);
        // inline computed styles for markers/currentColor (best-effort)
        const cssVars = getComputedStyle(document.documentElement);
        // Ensure currentColor resolves in markers
        clone.querySelectorAll("[style]").forEach(()=>{});

        const s = new XMLSerializer().serializeToString(clone);
        const encoded = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(s);
        // Convert to PNG via canvas by drawing this SVG data URL
        // For direct PNG downloads we create PNG later; for PDF addImage we need PNG, so we‚Äôll render through canvas.
        // However, jsPDF addImage needs image data; we return SVG URL and convert to PNG with canvas when needed.
        // Here we create PNG data URL by rendering to canvas immediately (sync not possible); so return SVG URL for callers.
        return encoded;
      }

      function downloadBlob(blob, filename){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{
          URL.revokeObjectURL(a.href);
          a.remove();
        }, 0);
      }

      function hookButtons(){
        ui.btns.save.addEventListener("click", ()=>{
          const computed = compute();
          const payload = {
            savedAt: new Date().toISOString(),
            answers: state.answers,
            computed
          };
          saveLocal(payload);
          lastSaved = payload;
          renderAll();
        });

        ui.btns.reset.addEventListener("click", ()=>{
          // reset to last saved (if exists), else clear
          const saved = loadLocal();
          state.answers = {};
          if(saved?.answers) state.answers = saved.answers;
          renderAll();
        });

        ui.btns.clear.addEventListener("click", ()=>{
          clearLocal();
          lastSaved = null;
          state.answers = {};
          renderAll();
        });

        ui.btns.txt.addEventListener("click", ()=>{
          exportTxt(compute());
        });

        ui.btns.pdf.addEventListener("click", ()=>{
          exportPdf(compute());
        });

        ui.btns.png.addEventListener("click", ()=>{
          exportPng();
        });
      }

      function renderAll(){
        const computed = compute();
        renderGlobal(computed);
        renderBeforeAfter(computed);
        renderSections(computed);
        renderAxesTable(computed);
      }

      async function init(){
        const res = await fetch(JSON_PATH, {cache:"no-store"});
        data = await res.json();

        // load last saved
        lastSaved = loadLocal();
        hydrateFromSaved(lastSaved);

        renderTop();
        buildSteps();
        hookSvg();
        hookModal();
        hookButtons();

        renderAll();

        // Default pill axis label from JSON
        ui.pills.axis.textContent = safeText(getUi("pills.axis",""));
      }

      init().catch((e)=>{
        // Avoid visible fixed error text; keep silent in UI.
        console.error(e);
      });
    })();
  </script>
</body>
</html>
