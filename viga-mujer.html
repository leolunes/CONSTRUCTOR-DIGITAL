<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üî¥La viga: la mujer como alma del sistema</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --text:#e8eef7;
      --muted:#a7b3c4;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --accent:#7dd3fc;
      --ok:#22c55e;
      --warn:#f59e0b;
      --risk:#ef4444;
      --crit:#fb7185;
      --gray:#94a3b8;
      --chip:#111a25;
      --focus:rgba(125,211,252,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 700px at 20% 0%, rgba(125,211,252,.08), transparent 55%),
                 radial-gradient(1100px 700px at 80% 10%, rgba(34,197,94,.06), transparent 60%),
                 var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      letter-spacing:.2px;
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px 48px}
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
      padding:14px 14px;border:1px solid var(--border);border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky;top:10px;backdrop-filter: blur(8px); z-index:50;
    }
    .titleBlock{min-width:260px;flex:1}
    h1{margin:0;font-size:18px;font-weight:800;line-height:1.2}
    .desc{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;min-width:260px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{
      display:flex;flex-direction:column;gap:6px;
      background:rgba(255,255,255,.02);
      border:1px solid var(--border);
      border-radius:14px;padding:10px 10px;min-width:160px;
    }
    .field label{font-size:11px;color:var(--muted)}
    .field input{
      width:100%;background:transparent;border:none;outline:none;color:var(--text);
      font-size:13px;
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-size:12px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      transition:transform .06s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(125,211,252,.35)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{border-color:rgba(125,211,252,.45);background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(255,255,255,.02))}
    .btn.danger{border-color:rgba(239,68,68,.45);background:linear-gradient(180deg, rgba(239,68,68,.14), rgba(255,255,255,.02))}
    .btn.ghost{background:transparent;box-shadow:none}
    .toggle{
      display:flex;align-items:center;gap:8px;
      padding:10px 10px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.02);
      font-size:12px;font-weight:700;color:var(--text);
    }
    .toggle input{accent-color: var(--accent)}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(0,0,0,.12);
    }
    .cardHeader h2{margin:0;font-size:13px;font-weight:900;letter-spacing:.3px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.02);font-size:11px;color:var(--muted);font-weight:700;
      white-space:nowrap;
    }
    .cardBody{padding:14px}
    .statLine{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .bigPct{font-size:34px;font-weight:1000;letter-spacing:-.7px}
    .bandPill{
      padding:7px 10px;border-radius:999px;font-size:11px;font-weight:900;border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .bandPill.ok{border-color:rgba(34,197,94,.35); color: #b7f7c9}
    .bandPill.warn{border-color:rgba(245,158,11,.35); color:#fde68a}
    .bandPill.risk{border-color:rgba(239,68,68,.35); color:#fecaca}
    .bandPill.crit{border-color:rgba(251,113,133,.35); color:#fecdd3}
    .summary{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.45}
    .verse{
      margin-top:12px;padding:10px 12px;border-radius:16px;border:1px dashed rgba(125,211,252,.25);
      background:rgba(125,211,252,.06);
      color:var(--text);
      font-size:12px;line-height:1.35;
    }
    .verse .ref{color:var(--muted);font-weight:800;margin-top:6px;font-size:11px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{color:var(--muted);font-size:11px;text-align:left;font-weight:900;letter-spacing:.4px}
    td{font-size:12px}
    .tblWrap{overflow:auto;border:1px solid var(--border);border-radius:16px}
    .tblWrap table{min-width:620px}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 8px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.02);font-size:11px;font-weight:900;
    }
    .tag.ok{border-color:rgba(34,197,94,.35); color:#b7f7c9}
    .tag.warn{border-color:rgba(245,158,11,.35); color:#fde68a}
    .tag.risk{border-color:rgba(239,68,68,.35); color:#fecaca}
    .tag.crit{border-color:rgba(251,113,133,.35); color:#fecdd3}
    .tag.gray{border-color:rgba(148,163,184,.25); color:#e2e8f0}
    .sections{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .sectionCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.012));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .sectionHead{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.10);
    }
    .sectionHead .left{min-width:240px;flex:1}
    .sectionHead .t{font-size:13px;font-weight:1000;margin:0}
    .sectionHead .st{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}
    .sectionHead .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:180px}
    .miniLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .kpi{font-size:12px;font-weight:1000}
    .sectionBody{padding:14px}
    .qgrid{display:grid;grid-template-columns: 1fr 140px;gap:10px;align-items:center}
    @media (max-width: 720px){
      .qgrid{grid-template-columns:1fr}
    }
    .qitem{
      padding:10px 12px;border:1px solid var(--border);border-radius:16px;
      background:rgba(255,255,255,.02);
      display:grid;grid-template-columns: 1fr 130px;gap:10px;align-items:center;
    }
    @media (max-width: 720px){
      .qitem{grid-template-columns:1fr}
    }
    .qtext{font-size:12px;line-height:1.35}
    .qctrl{
      display:flex;align-items:center;justify-content:flex-end;gap:8px;
    }
    select{
      width:120px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      outline:none;
      font-weight:900;
      font-size:12px;
    }
    .help{
      margin-top:12px;
      padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
    }
    .helpTitle{font-size:12px;font-weight:1000;margin:0}
    .helpText{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.45}
    .help ul{margin:8px 0 0 18px;color:var(--muted);font-size:12px;line-height:1.45}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .obs{
      width:100%;min-height:110px;resize:vertical;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:16px;
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:12px;
      line-height:1.4;
    }
    .tooltip{
      position:fixed;z-index:9999;
      pointer-events:none;
      padding:10px 10px;border-radius:14px;border:1px solid var(--border);
      background:rgba(7,10,15,.95);
      box-shadow:var(--shadow);
      max-width:320px;
      transform: translate(10px,10px);
      opacity:0; transition:opacity .08s ease;
      font-size:12px;line-height:1.35;
    }
    .tooltip .tt{font-weight:1000}
    .tooltip .tm{margin-top:6px;color:var(--muted)}
    .tooltip .tv{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:#e2e8f0}
    .tooltip .tr{margin-top:6px;color:var(--muted);font-size:11px;font-weight:900}
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.62);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:2000;
    }
    .modal{
      width:min(920px, 100%);
      border:1px solid var(--border);
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(0,0,0,.18);
    }
    .modalHead .mh{font-weight:1000;font-size:13px;margin:0}
    .modalBody{padding:14px}
    .closeX{font-size:12px}
    .kgrid{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width: 820px){.kgrid{grid-template-columns:1fr}}
    .list{
      margin:10px 0 0 18px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .hint{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:16px;border:1px dashed rgba(148,163,184,.25);
      background:rgba(148,163,184,.06); color:var(--muted);
      font-size:12px;line-height:1.4;
    }
    .footRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px
    }
    .small{font-size:11px;color:var(--muted);font-weight:700}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .sr{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <h1 id="title"></h1>
        <div class="desc" id="desc"></div>
      </div>

      <div class="controls">
        <div class="row">
          <div class="field">
            <label for="patient">Paciente</label>
            <input id="patient" type="text" autocomplete="off" />
          </div>
          <div class="field">
            <label for="auditor">Auditor</label>
            <input id="auditor" type="text" autocomplete="off" />
          </div>
          <div class="field">
            <label for="date">Fecha</label>
            <input id="date" type="date" />
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnExportPDF">Exportar PDF</button>
          <button class="btn" id="btnExportPNG">Exportar PNG</button>
          <button class="btn" id="btnExportTXT">Exportar TXT</button>
          <button class="btn" id="btnSaveBefore">Guardar ANTES</button>
          <button class="btn" id="btnSaveAfter">Guardar DESPU√âS</button>
          <button class="btn danger" id="btnReset">Reset</button>
          <label class="toggle" title="">
            <input id="toggleGuide" type="checkbox" />
            <span id="toggleGuideLabel"></span>
          </label>
          <label class="toggle" title="">
            <input id="toggleDetailPDF" type="checkbox" />
            <span id="toggleDetailPDFLabel"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <h2 id="globalCardTitle"></h2>
          <span class="chip" id="globalChip"></span>
        </div>
        <div class="cardBody">
          <div class="statLine">
            <div class="bigPct" id="globalPct">‚Äî</div>
            <div class="bandPill" id="globalBandPill">‚Äî</div>
          </div>
          <div class="summary" id="globalSummary"></div>
          <div class="verse" id="globalVerse">
            <div id="globalVerseQ"></div>
            <div class="ref" id="globalVerseR"></div>
          </div>

          <div class="divider"></div>

          <div class="cardHeader" style="padding:10px 0 0;border:0;background:transparent">
            <h2 id="porticoTitle"></h2>
            <span class="chip" id="porticoChip"></span>
          </div>

          <div style="margin-top:10px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:rgba(0,0,0,.12)">
            <div id="porticoWrap" style="position:relative;padding:12px">
              <svg id="porticoSVG" width="100%" viewBox="0 0 520 340" role="img" aria-label="">
                <defs>
                  <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="2.6" result="blur"/>
                    <feMerge>
                      <feMergeNode in="blur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                  <marker id="arrowHead" viewBox="0 0 10 10" refX="8.5" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
                    <path d="M 0 0 L 10 5 L 0 10 z" fill="currentColor"></path>
                  </marker>
                </defs>

                <!-- Base background grid lines -->
                <g opacity="0.12">
                  <path d="M40 300 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 260 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 220 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 180 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 140 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 100 H500" stroke="white" stroke-width="1"/>
                  <path d="M40 60 H500" stroke="white" stroke-width="1"/>
                </g>

                <!-- Cimiento (horizontal inferior) -->
                <path id="elCimiento" d="M70 285 H460" stroke="white" stroke-opacity="0.55" stroke-width="14" stroke-linecap="round"/>
                <!-- Columna (vertical izquierda) -->
                <path id="elColumna" d="M110 285 V70" stroke="white" stroke-opacity="0.55" stroke-width="14" stroke-linecap="round"/>
                <!-- Viga (horizontal superior) -->
                <path id="elViga" d="M110 90 H430" stroke="white" stroke-opacity="0.55" stroke-width="14" stroke-linecap="round"/>

                <!-- Nudos -->
                <g filter="url(#glow)">
                  <circle id="nodoBase" cx="110" cy="285" r="12" fill="rgba(255,255,255,.75)" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
                  <circle id="nodoArriba" cx="110" cy="90" r="12" fill="rgba(255,255,255,.75)" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
                  <circle id="nodoExtremo" cx="430" cy="90" r="12" fill="rgba(255,255,255,.75)" stroke="rgba(255,255,255,.25)" stroke-width="2"/>
                </g>

                <!-- Flechas de carga: viva (verde), muerta (roja), s√≠smica (gris) -->
                <g id="flechas" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <g id="cargaViva" style="color: var(--ok)">
                    <path d="M260 60 V85" stroke="currentColor" marker-end="url(#arrowHead)"/>
                    <path d="M320 60 V85" stroke="currentColor" marker-end="url(#arrowHead)"/>
                  </g>
                  <g id="cargaMuerta" style="color: var(--risk)">
                    <path d="M200 58 V85" stroke="currentColor" marker-end="url(#arrowHead)"/>
                  </g>
                  <g id="cargaSismica" style="color: var(--gray)">
                    <path d="M80 210 H110" stroke="currentColor" marker-end="url(#arrowHead)"/>
                    <path d="M80 170 H110" stroke="currentColor" marker-end="url(#arrowHead)"/>
                  </g>
                </g>

                <!-- Hit areas for interaction -->
                <g opacity="0" cursor="pointer">
                  <rect id="hitComunion" x="78" y="70" width="64" height="220" rx="18"></rect>
                  <rect id="hitCongregacion" x="110" y="62" width="330" height="56" rx="18"></rect>
                  <rect id="hitInterseccion" x="78" y="258" width="100" height="64" rx="18"></rect>
                </g>

                <!-- Labels (non-doctrinal; text comes from JSON via JS) -->
                <g font-size="12" font-weight="900" fill="rgba(255,255,255,.85)">
                  <text id="lblComunion" x="22" y="155" transform="rotate(-90 22 155)"></text>
                  <text id="lblCongregacion" x="220" y="36"></text>
                  <text id="lblInterseccion" x="160" y="314"></text>
                </g>
              </svg>
            </div>
          </div>

          <div class="divider"></div>

          <div class="cardHeader" style="padding:10px 0 0;border:0;background:transparent">
            <h2 id="axesTableTitle"></h2>
            <span class="chip" id="axesChip"></span>
          </div>
          <div class="tblWrap" style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th id="thAxis"></th>
                  <th id="thScore"></th>
                  <th id="thBand"></th>
                  <th id="thKeyVerse"></th>
                </tr>
              </thead>
              <tbody id="axesTbody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="cardHeader" style="padding:10px 0 0;border:0;background:transparent">
            <h2 id="obsTitle"></h2>
            <span class="chip" id="obsChip"></span>
          </div>
          <textarea class="obs" id="observations"></textarea>

          <div class="footRow">
            <div class="small mono" id="storageHint"></div>
            <div class="small" id="versionHint"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h2 id="sectionsTitle"></h2>
          <span class="chip" id="sectionsChip"></span>
        </div>
        <div class="cardBody">
          <div class="tblWrap">
            <table>
              <thead>
                <tr>
                  <th id="thSection"></th>
                  <th id="thAxisSmall"></th>
                  <th id="thSectionScore"></th>
                  <th id="thSectionBand"></th>
                </tr>
              </thead>
              <tbody id="sectionsTbody"></tbody>
            </table>
          </div>

          <div class="sections" id="sectionsCards"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div style="display:flex;flex-direction:column;gap:6px">
          <div class="mh" id="modalTitle"></div>
          <div class="small" id="modalSub"></div>
        </div>
        <button class="btn ghost closeX" id="modalClose">Cerrar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // ‚úÖ AUTO-VALIDACI√ìN REQUERIDA
    const JSON_PATH = './üî¥viga-mujer.json';
    const TITLE = 'üî¥La viga: la mujer como alma del sistema';

    const LS_KEY = 'pastoral_audit_viga_mujer_v1';
    const LS_BEFORE_KEY = 'pastoral_audit_viga_mujer_before';
    const LS_AFTER_KEY  = 'pastoral_audit_viga_mujer_after';

    const state = {
      data: null,
      answers: {}, // qid -> value 0..5
      meta: {
        patient: '',
        auditor: '',
        date: '',
        observations: '',
        guideMode: false,
        detailPDF: false
      }
    };

    const $ = (id) => document.getElementById(id);

    const ui = {
      title: $('title'),
      desc: $('desc'),
      patient: $('patient'),
      auditor: $('auditor'),
      date: $('date'),
      observations: $('observations'),
      toggleGuide: $('toggleGuide'),
      toggleGuideLabel: $('toggleGuideLabel'),
      toggleDetailPDF: $('toggleDetailPDF'),
      toggleDetailPDFLabel: $('toggleDetailPDFLabel'),

      btnExportPDF: $('btnExportPDF'),
      btnExportPNG: $('btnExportPNG'),
      btnExportTXT: $('btnExportTXT'),
      btnSaveBefore: $('btnSaveBefore'),
      btnSaveAfter: $('btnSaveAfter'),
      btnReset: $('btnReset'),

      globalPct: $('globalPct'),
      globalBandPill: $('globalBandPill'),
      globalSummary: $('globalSummary'),
      globalVerseQ: $('globalVerseQ'),
      globalVerseR: $('globalVerseR'),
      globalChip: $('globalChip'),

      axesTbody: $('axesTbody'),
      sectionsTbody: $('sectionsTbody'),
      sectionsCards: $('sectionsCards'),

      tooltip: $('tooltip'),
      modalBackdrop: $('modalBackdrop'),
      modalClose: $('modalClose'),
      modalTitle: $('modalTitle'),
      modalSub: $('modalSub'),
      modalBody: $('modalBody'),

      // portico labels + hits
      lblComunion: $('lblComunion'),
      lblCongregacion: $('lblCongregacion'),
      lblInterseccion: $('lblInterseccion'),
      hitComunion: $('hitComunion'),
      hitCongregacion: $('hitCongregacion'),
      hitInterseccion: $('hitInterseccion'),

      // titles that should not be doctrinal; only UI
      globalCardTitle: $('globalCardTitle'),
      porticoTitle: $('porticoTitle'),
      axesTableTitle: $('axesTableTitle'),
      obsTitle: $('obsTitle'),
      sectionsTitle: $('sectionsTitle'),

      thAxis: $('thAxis'),
      thScore: $('thScore'),
      thBand: $('thBand'),
      thKeyVerse: $('thKeyVerse'),
      thSection: $('thSection'),
      thAxisSmall: $('thAxisSmall'),
      thSectionScore: $('thSectionScore'),
      thSectionBand: $('thSectionBand'),

      porticoChip: $('porticoChip'),
      axesChip: $('axesChip'),
      obsChip: $('obsChip'),
      sectionsChip: $('sectionsChip'),

      storageHint: $('storageHint'),
      versionHint: $('versionHint')
    };

    function todayISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function safeText(s){ return (s ?? '').toString(); }

    function bandClassFromLabel(label){
      const l = (label||'').toLowerCase();
      if(l.includes('aline')) return 'ok';
      if(l.includes('ajust')) return 'warn';
      if(l.includes('ries')) return 'risk';
      if(l.includes('cr√≠t') || l.includes('crit')) return 'crit';
      return 'gray';
    }

    function axisBandByPct(pct){
      if(pct >= 75) return { key:'Alineado', t:'Alineado' };
      if(pct >= 55) return { key:'En ajuste', t:'En ajuste' };
      if(pct >= 35) return { key:'En riesgo', t:'En riesgo' };
      return { key:'Cr√≠tico', t:'Cr√≠tico' };
    }

    function sectionBandByPct(pct){
      if(pct >= 75) return { key:'Alineado', t:'Alineado' };
      if(pct >= 55) return { key:'Ajuste', t:'Ajuste' };
      return { key:'Riesgo', t:'Riesgo' };
    }

    function globalBandByPct(pct){
      // 4 bandas
      if(pct >= 75) return { key:'Alineado', t:'Alineado' };
      if(pct >= 55) return { key:'Ajuste', t:'Ajuste' };
      if(pct >= 35) return { key:'Riesgo', t:'Riesgo' };
      return { key:'Cr√≠tico', t:'Cr√≠tico' };
    }

    function pctFromRaw(raw, maxRaw){
      if(maxRaw <= 0) return 0;
      const v = (raw / maxRaw) * 100;
      return Math.max(0, Math.min(100, v));
    }

    function getScaleLabel(value){
      const opt = (state.data?.scale?.options || []).find(o => o.value === value);
      return opt ? opt.label : String(value);
    }

    function ensureAllAnswers(){
      for(const sec of state.data.sections){
        for(const q of sec.questions){
          const key = q.id;
          if(!(key in state.answers)) state.answers[key] = 0;
        }
      }
    }

    function computeSection(sec){
      const qs = sec.questions;
      const raw = qs.reduce((sum,q)=>sum+(Number(state.answers[q.id] ?? 0)),0);
      const max = qs.length * 5;
      const pct = pctFromRaw(raw, max);
      const band = sectionBandByPct(pct);
      const bandDef = (state.data.rubrics.sectionBands || []).find(b=>b.label === band.t) || null;
      return { raw, max, pct, band, bandDef };
    }

    function computeAxis(axisId){
      const secs = state.data.sections.filter(s=>s.porticoAxis===axisId);
      const raw = secs.reduce((sum,s)=>sum+computeSection(s).raw,0);
      const max = secs.reduce((sum,s)=>sum+(s.questions.length*5),0);
      const pct = pctFromRaw(raw, max);
      const band = axisBandByPct(pct);
      const axisDef = state.data.porticoModel.axes.find(a=>a.id===axisId);
      const bandDef = axisDef?.bands?.find(b=>b.label.toLowerCase().includes(band.key.toLowerCase().split(' ')[1]||band.key.toLowerCase()) || b.label===band.t || b.label===band.key) || null;
      // fallback: match by ranges for canonical
      let best = bandDef;
      if(!best && axisDef?.bands?.length){
        const pick = (pct>=75)?axisDef.bands.find(b=>b.range==="75-100")
                  : (pct>=55)?axisDef.bands.find(b=>b.range==="55-74")
                  : (pct>=35)?axisDef.bands.find(b=>b.range==="35-54")
                  : axisDef.bands.find(b=>b.range==="0-34");
        best = pick || axisDef.bands[0];
      }
      return { raw, max, pct, band, bandDef: best, axisDef, secs };
    }

    function computeGlobal(){
      const secs = state.data.sections;
      const raw = secs.reduce((sum,s)=>sum+computeSection(s).raw,0);
      const max = secs.reduce((sum,s)=>sum+(s.questions.length*5),0);
      const pct = pctFromRaw(raw, max);
      const band = globalBandByPct(pct);
      const bandDef = (state.data.rubrics.globalBands || []).find(b=>b.label===band.t) || null;
      return { raw, max, pct, band, bandDef };
    }

    function renderStaticUIStrings(){
      // UI headings (no doctrina)
      ui.globalCardTitle.textContent = 'Diagn√≥stico global';
      ui.porticoTitle.textContent = 'P√≥rtico diagn√≥stico';
      ui.axesTableTitle.textContent = 'Tabla de ejes';
      ui.obsTitle.textContent = 'Observaciones';
      ui.sectionsTitle.textContent = 'Secciones';

      ui.thAxis.textContent = 'Eje';
      ui.thScore.textContent = 'Puntaje';
      ui.thBand.textContent = 'Banda';
      ui.thKeyVerse.textContent = 'Verso';

      ui.thSection.textContent = 'Secci√≥n';
      ui.thAxisSmall.textContent = 'Eje';
      ui.thSectionScore.textContent = 'Puntaje';
      ui.thSectionBand.textContent = 'Banda';

      ui.toggleGuideLabel.textContent = 'Modo gu√≠a';
      ui.toggleDetailPDFLabel.textContent = 'Detalle por pregunta en PDF';

      ui.globalChip.textContent = '0‚Äì5 ‚Ä¢ 8 preguntas x secci√≥n ‚Ä¢ sin backend';
      ui.porticoChip.textContent = 'Hover: tooltip ‚Ä¢ Click: modal';
      ui.axesChip.textContent = '3 ejes ‚Ä¢ % por eje';
      ui.obsChip.textContent = 'Incluido en exportaciones';
      ui.sectionsChip.textContent = '8 secciones ‚Ä¢ 64 preguntas';

      ui.versionHint.textContent = 'v1 ‚Ä¢ GitHub Pages';
    }

    function renderHeader(){
      ui.title.textContent = safeText(state.data.meta.title || TITLE);
      ui.desc.textContent = safeText(state.data.meta.description || '');
      document.title = safeText(state.data.meta.title || TITLE);

      // Portico labels come from JSON axes labels
      const ax = Object.fromEntries(state.data.porticoModel.axes.map(a=>[a.id,a]));
      ui.lblComunion.textContent = safeText(ax.comunion?.label || 'Comuni√≥n');
      ui.lblCongregacion.textContent = safeText(ax.congregacion?.label || 'Congregaci√≥n');
      ui.lblInterseccion.textContent = safeText(ax.interseccion?.label || 'Intersecci√≥n');

      // aria-label for svg
      $('porticoSVG').setAttribute('aria-label', safeText(state.data.meta.title || TITLE));
    }

    function renderAxesTable(){
      ui.axesTbody.innerHTML = '';
      const axes = state.data.porticoModel.axes;

      for(const a of axes){
        const r = computeAxis(a.id);
        const bandLabel = r.band.t;
        const cls = bandClassFromLabel(bandLabel);
        const tr = document.createElement('tr');

        const tdA = document.createElement('td');
        tdA.innerHTML = `<div style="font-weight:1000">${escapeHTML(a.label)}</div><div class="muted" style="margin-top:4px">${escapeHTML(a.description)}</div>`;
        const tdS = document.createElement('td');
        tdS.innerHTML = `<div class="mono" style="font-weight:1000">${Math.round(r.pct)}%</div><div class="muted">${r.raw}/${r.max}</div>`;
        const tdB = document.createElement('td');
        tdB.innerHTML = `<span class="tag ${cls}">${escapeHTML(bandLabel)}</span>`;
        const tdV = document.createElement('td');
        const vq = r.bandDef?.verse?.quote || '';
        const vr = r.bandDef?.verse?.reference || '';
        tdV.innerHTML = `<div>${escapeHTML(vq)}</div><div class="muted" style="margin-top:6px;font-weight:900;font-size:11px">${escapeHTML(vr)}</div>`;

        tr.appendChild(tdA); tr.appendChild(tdS); tr.appendChild(tdB); tr.appendChild(tdV);
        ui.axesTbody.appendChild(tr);
      }
    }

    function renderSectionsTable(){
      ui.sectionsTbody.innerHTML = '';
      for(const sec of state.data.sections){
        const r = computeSection(sec);
        const cls = bandClassFromLabel(r.band.t);
        const tr = document.createElement('tr');

        const tdS = document.createElement('td');
        tdS.innerHTML = `<div style="font-weight:1000">${escapeHTML(sec.title)}</div><div class="muted" style="margin-top:4px">${escapeHTML(sec.subtitle)}</div>`;
        const tdA = document.createElement('td');
        tdA.innerHTML = `<span class="tag gray">${escapeHTML(sec.porticoAxis)}</span>`;
        const tdP = document.createElement('td');
        tdP.innerHTML = `<div class="mono" style="font-weight:1000">${Math.round(r.pct)}%</div><div class="muted">${r.raw}/${r.max}</div>`;
        const tdB = document.createElement('td');
        tdB.innerHTML = `<span class="tag ${cls}">${escapeHTML(r.band.t)}</span>`;

        tr.appendChild(tdS); tr.appendChild(tdA); tr.appendChild(tdP); tr.appendChild(tdB);
        ui.sectionsTbody.appendChild(tr);
      }
    }

    function renderSectionsCards(){
      ui.sectionsCards.innerHTML = '';
      const manualById = Object.fromEntries(state.data.pastoralManual.sections.map(s=>[s.id,s]));

      for(const sec of state.data.sections){
        const r = computeSection(sec);
        const cls = bandClassFromLabel(r.band.t);

        const card = document.createElement('div');
        card.className = 'sectionCard';
        card.setAttribute('data-sec', sec.id);

        const head = document.createElement('div');
        head.className = 'sectionHead';

        const left = document.createElement('div');
        left.className = 'left';
        left.innerHTML = `
          <div class="t">${escapeHTML(sec.title)}</div>
          <div class="st">${escapeHTML(sec.subtitle)}</div>
        `;

        const right = document
.createElement('div');
        right.className = 'right';
        right.innerHTML = `
          <div class="miniLine">
            <span class="kpi mono">${Math.round(r.pct)}%</span>
            <span class="tag ${cls}">${escapeHTML(r.band.t)}</span>
          </div>
          <div class="miniLine">
            <span class="tag gray">${escapeHTML(sec.porticoAxis)}</span>
            <span class="muted mono">${r.raw}/${r.max}</span>
          </div>
        `;

        head.appendChild(left);
        head.appendChild(right);

        const body = document.createElement('div');
        body.className = 'sectionBody';

        const verseQ = sec.sectionVerse?.quote || '';
        const verseR = sec.sectionVerse?.reference || '';

        const manual = manualById[sec.id]?.miniTeaching || null;

        const guideBlock = document.createElement('div');
        guideBlock.className = 'help';
        guideBlock.style.display = state.meta.guideMode ? 'block' : 'none';
        guideBlock.innerHTML = `
          <div class="helpTitle">${escapeHTML(manual?.title || '')}</div>
          <div class="helpText">${escapeHTML(sec.diagnosticFocus || '')}</div>
          ${manual?.text?.length ? `<ul>${manual.text.map(t=>`<li>${escapeHTML(t)}</li>`).join('')}</ul>` : ''}
          ${manual?.verse?.quote ? `
            <div class="verse" style="margin-top:10px">
              <div>${escapeHTML(manual.verse.quote)}</div>
              <div class="ref">${escapeHTML(manual.verse.reference || '')}</div>
            </div>
          ` : ''}
          ${manual?.oneWeekPlan?.length ? `
            <div class="divider"></div>
            <div class="helpTitle">${escapeHTML('Plan de 7 d√≠as')}</div>
            <ul>${manual.oneWeekPlan.map(d=>`<li>${escapeHTML(d)}</li>`).join('')}</ul>
          ` : ''}
        `;

        const sectionVerseBlock = document.createElement('div');
        sectionVerseBlock.className = 'verse';
        sectionVerseBlock.innerHTML = `
          <div>${escapeHTML(verseQ)}</div>
          <div class="ref">${escapeHTML(verseR)}</div>
        `;

        const qWrap = document.createElement('div');
        qWrap.className = 'qgrid';

        for(const q of sec.questions){
          const qItem = document.createElement('div');
          qItem.className = 'qitem';
          qItem.setAttribute('data-qid', q.id);
          qItem.innerHTML = `
            <div class="qtext">
              <div style="font-weight:900">${escapeHTML(q.id)}</div>
              <div style="margin-top:6px">${escapeHTML(q.text)}</div>
            </div>
            <div class="qctrl">
              <select aria-label="${escapeHTML(q.id)}"></select>
            </div>
          `;

          const sel = qItem.querySelector('select');
          for(const opt of state.data.scale.options){
            const o = document.createElement('option');
            o.value = String(opt.value);
            o.textContent = opt.label;
            sel.appendChild(o);
          }
          sel.value = String(state.answers[q.id] ?? 0);
          sel.addEventListener('change', () => {
            state.answers[q.id] = Number(sel.value);
            persist();
            renderAll();
          });

          qWrap.appendChild(qItem);
        }

        body.appendChild(sectionVerseBlock);
        body.appendChild(guideBlock);
        body.appendChild(document.createElement('div')).className = 'divider';
        body.appendChild(qWrap);

        card.appendChild(head);
        card.appendChild(body);
        ui.sectionsCards.appendChild(card);
      }
    }

    function renderGlobal(){
      const g = computeGlobal();
      ui.globalPct.textContent = `${Math.round(g.pct)}%`;

      const cls = bandClassFromLabel(g.band.t);
      ui.globalBandPill.className = `bandPill ${cls}`;
      ui.globalBandPill.textContent = g.band.t;

      ui.globalSummary.textContent = safeText(g.bandDef?.summary || '');
      ui.globalVerseQ.textContent = safeText(g.bandDef?.verse?.quote || '');
      ui.globalVerseR.textContent = safeText(g.bandDef?.verse?.reference || '');
    }

    function renderStorageHints(){
      const hasMain = !!localStorage.getItem(LS_KEY);
      const hasB = !!localStorage.getItem(LS_BEFORE_KEY);
      const hasA = !!localStorage.getItem(LS_AFTER_KEY);
      const parts = [];
      parts.push(hasMain ? 'Auto-guardado: s√≠' : 'Auto-guardado: no');
      parts.push(hasB ? 'ANTES: s√≠' : 'ANTES: no');
      parts.push(hasA ? 'DESPU√âS: s√≠' : 'DESPU√âS: no');
      ui.storageHint.textContent = parts.join(' ‚Ä¢ ');
    }

    function renderAll(){
      if(!state.data) return;
      renderHeader();
      renderGlobal();
      renderAxesTable();
      renderSectionsTable();
      renderSectionsCards();
      renderStorageHints();
    }

    function escapeHTML(str){
      return safeText(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function persist(){
      const payload = {
        answers: state.answers,
        meta: state.meta
      };
      try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); }catch(_){}
    }

    function hydrate(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === 'object'){
          if(obj.answers && typeof obj.answers === 'object') state.answers = obj.answers;
          if(obj.meta && typeof obj.meta === 'object'){
            state.meta = { ...state.meta, ...obj.meta };
          }
        }
      }catch(_){}
    }

    function setMetaInputs(){
      ui.patient.value = state.meta.patient || '';
      ui.auditor.value = state.meta.auditor || '';
      ui.date.value = state.meta.date || '';
      ui.observations.value = state.meta.observations || '';
      ui.toggleGuide.checked = !!state.meta.guideMode;
      ui.toggleDetailPDF.checked = !!state.meta.detailPDF;
    }

    function bindMetaInputs(){
      ui.patient.addEventListener('input', ()=>{ state.meta.patient = ui.patient.value; persist(); renderStorageHints(); });
      ui.auditor.addEventListener('input', ()=>{ state.meta.auditor = ui.auditor.value; persist(); renderStorageHints(); });
      ui.date.addEventListener('change', ()=>{ state.meta.date = ui.date.value; persist(); renderStorageHints(); });
      ui.observations.addEventListener('input', ()=>{ state.meta.observations = ui.observations.value; persist(); renderStorageHints(); });

      ui.toggleGuide.addEventListener('change', ()=>{
        state.meta.guideMode = !!ui.toggleGuide.checked;
        persist();
        renderAll();
      });

      ui.toggleDetailPDF.addEventListener('change', ()=>{
        state.meta.detailPDF = !!ui.toggleDetailPDF.checked;
        persist();
        renderAll();
      });
    }

    function saveSnapshot(key){
      const snap = {
        savedAt: new Date().toISOString(),
        dataTitle: safeText(state.data?.meta?.title || TITLE),
        meta: { ...state.meta },
        answers: { ...state.answers }
      };
      try{ localStorage.setItem(key, JSON.stringify(snap)); }catch(_){}
      renderStorageHints();
    }

    function resetAll(){
      state.answers = {};
      state.meta = {
        patient: '',
        auditor: '',
        date: todayISO(),
        observations: '',
        guideMode: false,
        detailPDF: false
      };
      try{
        localStorage.removeItem(LS_KEY);
      }catch(_){}
      ensureAllAnswers();
      setMetaInputs();
      persist();
      renderAll();
    }

    // ----------------------
    // Tooltip + Modal (P√≥rtico)
    // ----------------------
    function showTooltip(x,y, html){
      ui.tooltip.innerHTML = html;
      ui.tooltip.style.left = `${x}px`;
      ui.tooltip.style.top = `${y}px`;
      ui.tooltip.style.opacity = '1';
    }
    function hideTooltip(){
      ui.tooltip.style.opacity = '0';
    }

    function axisTooltipHTML(axisId){
      const r = computeAxis(axisId);
      const a = r.axisDef;
      const bandLabel = r.band.t;
      const vq = r.bandDef?.verse?.quote || '';
      const vr = r.bandDef?.verse?.reference || '';
      return `
        <div class="tt">${escapeHTML(a.label)} ‚Ä¢ <span class="mono">${Math.round(r.pct)}%</span></div>
        <div class="tm">${escapeHTML(a.description)}</div>
        <div class="tv">${escapeHTML(r.bandDef?.summary || '')}</div>
        <div class="tr">${escapeHTML(bandLabel)} ‚Ä¢ ${escapeHTML(vr)}</div>
        <div class="tm" style="margin-top:8px">${escapeHTML(vq)}</div>
      `;
    }

    function openModalForAxis(axisId){
      const r = computeAxis(axisId);
      const a = r.axisDef;
      const bandLabel = r.band.t;
      const cls = bandClassFromLabel(bandLabel);

      ui.modalTitle.textContent = safeText(a.label);
      ui.modalSub.textContent = `${Math.round(r.pct)}% ‚Ä¢ ${bandLabel}`;
      ui.modalBody.innerHTML = `
        <div class="kgrid">
          <div class="card" style="box-shadow:none">
            <div class="cardHeader"><h2>${escapeHTML('Enfoque')}</h2><span class="chip">${escapeHTML(a.id)}</span></div>
            <div class="cardBody">
              <div class="summary">${escapeHTML(a.description)}</div>
              <div class="divider"></div>
              <div class="bandPill ${cls}" style="display:inline-flex">${escapeHTML(bandLabel)}</div>
              <div class="summary" style="margin-top:10px">${escapeHTML(r.bandDef?.summary || '')}</div>
              <div class="verse">
                <div>${escapeHTML(r.bandDef?.verse?.quote || '')}</div>
                <div class="ref">${escapeHTML(r.bandDef?.verse?.reference || '')}</div>
              </div>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="cardHeader"><h2>${escapeHTML('Acciones sugeridas')}</h2><span class="chip">${escapeHTML('Gu√≠a')}</span></div>
            <div class="cardBody">
              <div class="hint">
                <div style="font-weight:1000">‚Ä¢</div>
                <div>${escapeHTML('Use las secciones asociadas a este eje para priorizar conversaci√≥n, oraci√≥n y acuerdos pr√°cticos.')}</div>
              </div>
              <div class="divider"></div>
              <div style="font-weight:1000;font-size:12px">${escapeHTML('Secciones del eje')}</div>
              <ul class="list">
                ${r.secs.map(s=>{
                  const sr = computeSection(s);
                  return `<li><span style="font-weight:900">${escapeHTML(s.title)}</span> ‚Äî <span class="mono">${Math.round(sr.pct)}%</span></li>`;
                }).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;

      ui.modalBackdrop.style.display = 'flex';
      ui.modalBackdrop.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      ui.modalBackdrop.style.display = 'none';
      ui.modalBackdrop.setAttribute('aria-hidden','true');
      ui.modalBody.innerHTML = '';
    }

    function bindPorticoInteractions(){
      const hitMap = [
        { el: ui.hitComunion, id: 'comunion' },
        { el: ui.hitCongregacion, id: 'congregacion' },
        { el: ui.hitInterseccion, id: 'interseccion' }
      ];

      for(const item of hitMap){
        item.el.addEventListener('mousemove', (e)=>{
          showTooltip(e.clientX, e.clientY, axisTooltipHTML(item.id));
        });
        item.el.addEventListener('mouseleave', ()=> hideTooltip());
        item.el.addEventListener('click', ()=> openModalForAxis(item.id));
      }

      ui.modalBackdrop.addEventListener('click', (e)=>{
        if(e.target === ui.modalBackdrop) closeModal();
      });
      ui.modalClose.addEventListener('click', closeModal);
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeModal();
      });
    }

    // ----------------------
    // Export helpers
    // ----------------------
    function getHeaderMeta(){
      const t = safeText(state.data?.meta?.title || TITLE);
      const p = safeText(state.meta.patient || '');
      const a = safeText(state.meta.auditor || '');
      const d = safeText(state.meta.date || '');
      return { t, p, a, d };
    }

    function downloadBlob(filename, blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function svgToPngDataUrl(svgEl, width=1200){
      const clone = svgEl.cloneNode(true);
      clone.setAttribute('xmlns','http://www.w3.org/2000/svg');

      // Inline CSS vars by converting to computed styles where needed (simple approach: keep as-is)
      const svgStr = new XMLSerializer().serializeToString(clone);
      const svg64 = btoa(unescape(encodeURIComponent(svgStr)));
      const imgSrc = `data:image/svg+xml;base64,${svg64}`;

      const img = new Image();
      img.decoding = 'async';
      img.src = imgSrc;

      await new Promise((res, rej)=>{
        img.onload = ()=>res();
        img.onerror = (e)=>rej(e);
      });

      const aspect = img.height / img.width;
      const h = Math.round(width * aspect);

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      // background
      ctx.fillStyle = '#0b0f14';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.drawImage(img, 0, 0, width, h);
      return canvas.toDataURL('image/png');
    }

    async function exportPNG(){
      const svgEl = $('porticoSVG');
      const pngUrl = await svgToPngDataUrl(svgEl, 1600);

      const { t, p, a, d } = getHeaderMeta();

      // add footer using canvas
      const img = new Image();
      img.src = pngUrl;
      await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });

      const footerH = 110;
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height + footerH;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = '#0b0f14';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0);

      ctx.fillStyle = 'rgba(255,255,255,.9)';
      ctx.font = '700 28px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(t, 36, img.height + 42);

      ctx.fillStyle = 'rgba(255,255,255,.75)';
      ctx.font = '600 18px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const line = `Paciente: ${p || '‚Äî'}   ‚Ä¢   Auditor: ${a || '‚Äî'}   ‚Ä¢   Fecha: ${d || '‚Äî'}`;
      ctx.fillText(line, 36, img.height + 78);

      const out = canvas.toDataURL('image/png');
      const b = await (await fetch(out)).blob();
      downloadBlob(`portico_${slugify(t)}.png`, b);
    }

    function buildTXT(){
      const { t, p, a, d } = getHeaderMeta();
      const g = computeGlobal();

      const lines = [];
      lines.push(t);
      lines.push(`Paciente: ${p || '‚Äî'}`);
      lines.push(`Auditor: ${a || '‚Äî'}`);
      lines.push(`Fecha: ${d || '‚Äî'}`);
      lines.push('');
      lines.push(`Diagn√≥stico global: ${Math.round(g.pct)}% ‚Ä¢ ${g.band.t}`);
      lines.push(safeText(g.bandDef?.summary || ''));
      lines.push(`Verso: ${safeText(g.bandDef?.verse?.quote || '')} (${safeText(g.bandDef?.verse?.reference || '')})`);
      lines.push('');
      lines.push('Ejes:');
      for(const ax of state.data.porticoModel.axes){
        const r = computeAxis(ax.id);
        lines.push(`- ${ax.label}: ${Math.round(r.pct)}% ‚Ä¢ ${r.band.t}`);
        lines.push(`  ${safeText(r.bandDef?.summary || '')}`);
        lines.push(`  ${safeText(r.bandDef?.verse?.quote || '')} (${safeText(r.bandDef?.verse?.reference || '')})`);
      }
      lines.push('');
      lines.push('Secciones:');
      const manualById = Object.fromEntries(state.data.pastoralManual.sections.map(s=>[s.id,s]));
      for(const sec of state.data.sections){
        const r = computeSection(sec);
        const man = manualById[sec.id]?.miniTeaching || null;
        lines.push(`- ${sec.title} [${sec.porticoAxis}] : ${Math.round(r.pct)}% ‚Ä¢ ${r.band.t}`);
        lines.push(`  ${safeText(sec.subtitle || '')}`);
        lines.push(`  Enfoque: ${safeText(sec.diagnosticFocus || '')}`);
        lines.push(`  Verso: ${safeText(sec.sectionVerse?.quote || '')} (${safeText(sec.sectionVerse?.reference || '')})`);
        if(man?.title){
          lines.push(`  Mini-ense√±anza: ${safeText(man.title)}`);
          for(const t of (man.text || [])) lines.push(`   ‚Ä¢ ${safeText(t)}`);
        }
        if(man?.oneWeekPlan?.length){
          lines.push('  Plan 7 d√≠as:');
          for(const d of man.oneWeekPlan) lines.push(`   ‚Ä¢ ${safeText(d)}`);
        }
      }

      lines.push('');
      lines.push('Observaciones:');
      lines.push(safeText(state.meta.observations || '‚Äî'));
      lines.push('');

      return lines.join('\n');
    }

    function exportTXT(){
      const txt = buildTXT();
      const blob = new Blob([txt], { type:'text/plain;charset=utf-8' });
      downloadBlob(`auditoria_${slugify(safeText(state.data?.meta?.title||TITLE))}.txt`, blob);
    }

    function slugify(s){
      return safeText(s)
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'_')
        .replace(/^_+|_+$/g,'');
    }

    function pdfAddTable(doc, startY, cols, rows, colWidths){
      const left = 36;
      let y = startY;
      const lineH = 16;

      doc.setFontSize(10);
      doc.setTextColor(230,238,247);

      // header
      doc.setFont(undefined,'bold');
      let x = left;
      for(let i=0;i<cols.length;i++){
        doc.text(cols[i], x, y);
        x += colWidths[i];
      }
      y += 10;
      doc.setDrawColor(255,255,255);
      doc.setLineWidth(0.2);
      doc.line(left, y, left + colWidths.reduce((a,b)=>a+b,0), y);
      y += 10;

      // rows
      doc.setFont(undefined,'normal');
      for(const r of rows){
        x = left;
        const maxLines = r.reduce((m,cell,i)=>{
          const w = colWidths[i] - 6;
          const lines = doc.splitTextToSize(String(cell), w);
          return Math.max(m, lines.length);
        }, 1);

        for(let i=0;i<r.length;i++){
          const w = colWidths[i] - 6;
          const lines = doc.splitTextToSize(String(r[i]), w);
          doc.text(lines, x, y);
          x += colWidths[i];
        }
        y += (maxLines * lineH);
        if(y > 770){
          doc.addPage();
          y = 48;
        }
      }
      return y;
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const { t, p, a, d } = getHeaderMeta();
      const g = computeGlobal();

      const marginX = 36;
      let y = 44;

      // Header
      doc.setTextColor(232,238,247);
      doc.setFontSize(16);
      doc.setFont(undefined,'bold');
      doc.text(t, marginX, y);
      y += 18;

      doc.setFontSize(10);
      doc.setFont(undefined,'normal');
      doc.setTextColor(167,179,196);
      doc.text(`Paciente: ${p || '‚Äî'}   ‚Ä¢   Auditor: ${a || '‚Äî'}   ‚Ä¢   Fecha: ${d || '‚Äî'}`, marginX, y);
      y += 18;

      // Diagn√≥stico global
      doc.setTextColor(232,238,247);
      doc.setFont(undefined,'bold');
      doc.setFontSize(12);
      doc.text(`Diagn√≥stico global: ${Math.round(g.pct)}% ‚Ä¢ ${g.band.t}`, marginX, y);
      y += 14;

      doc.setFont(undefined,'normal');
      doc.setTextColor(167,179,196);
      const sumLines = doc.splitTextToSize(safeText(g.bandDef?.summary || ''), 520);
      doc.text(sumLines, marginX, y);
      y += (sumLines.length * 14) + 6;

      doc.setTextColor(232,238,247);
      doc.setFontSize(10);
      const vLine = `${safeText(g.bandDef?.verse?.quote || '')} (${safeText(g.bandDef?.verse?.reference || '')})`;
      doc.text(doc.splitTextToSize(vLine, 520), marginX, y);
      y += 18;

      // P√≥rtico image
      const svgEl = $('porticoSVG');
      const pngUrl = await svgToPngDataUrl(svgEl, 1000);

      // Fit in page
      const imgW = 520;
      const imgH = 340;
      doc.addImage(pngUrl, 'PNG', marginX, y, imgW, imgH);
      y += imgH + 16;

      // Tabla de ejes
      doc.setFont(undefined,'bold');
      doc.setTextColor(232,238,247);
      doc.setFontSize(12);
      doc.text('Tabla de ejes', marginX, y);
      y += 18;

      const axesRows = state.data.porticoModel.axes.map(ax=>{
        const r = computeAxis(ax.id);
        const vq = safeText(r.bandDef?.verse?.quote || '');
        const vr = safeText(r.bandDef?.verse?.reference || '');
        return [
          ax.label,
          `${Math.round(r.pct)}% (${r.raw}/${r.max})`,
          r.band.t,
          `${vq} (${vr})`
        ];
      });
      y = pdfAddTable(doc, y, ['Eje','Puntaje','Banda','Verso'], axesRows, [110,120,80,210]);
      y += 14;

      // Tabla de secciones
      doc.setFont(undefined,'bold');
      doc.setTextColor(232,238,247);
      doc.setFontSize(12);
      doc.text('Tabla de secciones', marginX, y);
      y += 18;

      const secRows = state.data.sections.map(sec=>{
        const r = computeSection(sec);
        return [
          sec.title,
          sec.porticoAxis,
          `${Math.round(r.pct)}% (${r.raw}/${r.max})`,
          r.band.t
        ];
      });
      y = pdfAddTable(doc, y, ['Secci√≥n','Eje','Puntaje','Banda'], secRows, [220,90,120,90]);
      y += 14;

      // Enfoque pastoral por secci√≥n + Plan semanal autom√°tico
      const manualById = Object.fromEntries(state.data.pastoralManual.sections.map(s=>[s.id,s]));
      doc.addPage();
      y = 44;

      doc.setFont(undefined,'bold');
      doc.setTextColor(232,238,247);
      doc.setFontSize(14);
      doc.text('Enfoque pastoral por secci√≥n', marginX, y);
      y += 18;

      doc.setFontSize(10);
      doc.setFont(undefined,'normal');
      doc.setTextColor(167,179,196);

      for(const sec of state.data.sections){
        const r = computeSection(sec);
        const man = manualById[sec.id]?.miniTeaching || null;

        doc.setTextColor(232,238,247);
        doc.setFont(undefined,'bold');
        doc.text(`${sec.title} ‚Äî ${Math.round(r.pct)}% ‚Ä¢ ${r.band.t}`, marginX, y);
        y += 14;

        doc.setFont(undefined,'normal');
        doc.setTextColor(167,179,196);

        const focus = `Enfoque: ${safeText(sec.diagnosticFocus || '')}`;
        const focusLines = doc.splitTextToSize(focus, 520);
        doc.text(focusLines, marginX, y);
        y += (focusLines.length * 14) + 2;

        const verseLine = `${safeText(sec.sectionVerse?.quote || '')} (${safeText(sec.sectionVerse?.reference || '')})`;
        const verseLines = doc.splitTextToSize(verseLine, 520);
        doc.text(verseLines, marginX, y);
        y += (verseLines.length * 14) + 6;

        if(man?.title){
          doc.setTextColor(232,238,247);
          doc.setFont(undefined,'bold');
          doc.text(safeText(man.title), marginX, y);
          y += 14;

          doc.setFont(undefined,'normal');
          doc.setTextColor(167,179,196);
          for(const tline of (man.text || [])){
            const tl = doc.splitTextToSize(`‚Ä¢ ${safeText(tline)}`, 520);
            doc.text(tl, marginX, y);
            y += (tl.length * 14);
          }
          y += 6;
        }

        if(man?.oneWeekPlan?.length){
          doc.setTextColor(232,238,247);
          doc.setFont(undefined,'bold');
          doc.text('Plan de 7 d√≠as', marginX, y);
          y += 14;

          doc.setFont(undefined,'normal');
          doc.setTextColor(167,179,196);
          for(const dline of man.oneWeekPlan){
            const dl = doc.splitTextToSize(`‚Ä¢ ${safeText(dline)}`, 520);
            doc.text(dl, marginX, y);
            y += (dl.length * 14);
          }
          y += 10;
        }

        if(state.meta.detailPDF){
          doc.setTextColor(232,238,247);
          doc.setFont(undefined,'bold');
          doc.text('Detalle por pregunta', marginX, y);
          y += 14;

          doc.setFont(undefined,'normal');
          doc.setTextColor(167,179,196);
          for(const q of sec.questions){
            const val = Number(state.answers[q.id] ?? 0);
            const line = `${q.id} (${val}/5): ${safeText(q.text)} ‚Äî ${safeText(getScaleLabel(val))}`;
            const qLines = doc.splitTextToSize(line, 520);
            doc.text(qLines, marginX, y);
            y += (qLines.length * 14);
            if(y > 770){ doc.addPage(); y = 44; }
          }
          y += 10;
        }

        if(y > 770){ doc.addPage(); y = 44; }
      }

      // Observaciones
      doc.addPage();
      y = 44;
      doc.setTextColor(232,238,247);
      doc.setFont(undefined,'bold');
      doc.setFontSize(14);
      doc.text('Observaciones', marginX, y);
      y += 18;

      doc.setFontSize(10);
      doc.setFont(undefined,'normal');
      doc.setTextColor(167,179,196);
      const obs = safeText(state.meta.observations || '‚Äî');
      doc.text(doc.splitTextToSize(obs, 520), marginX, y);

      doc.save(`auditoria_${slugify(t)}.pdf`);
    }

    // ----------------------
    // Buttons
    // ----------------------
    function bindButtons(){
      ui.btnExportPNG.addEventListener('click', async ()=>{
        ui.btnExportPNG.disabled = true;
        try{ await exportPNG(); } finally { ui.btnExportPNG.disabled = false; }
      });

      ui.btnExportTXT.addEventListener('click', ()=> exportTXT());

      ui.btnExportPDF.addEventListener('click', async ()=>{
        ui.btnExportPDF.disabled = true;
        try{ await exportPDF(); } finally { ui.btnExportPDF.disabled = false; }
      });

      ui.btnSaveBefore.addEventListener('click', ()=> saveSnapshot(LS_BEFORE_KEY));
      ui.btnSaveAfter.addEventListener('click', ()=> saveSnapshot(LS_AFTER_KEY));

      ui.btnReset.addEventListener('click', ()=>{
        const ok = confirm('¬øResetear respuestas y meta?');
        if(ok) resetAll();
      });
    }

    // ----------------------
    // Load JSON + init
    // ----------------------
    async function loadJSON(){
      const res = await fetch(JSON_PATH, { cache:'no-store' });
      if(!res.ok) throw new Error(`No se pudo cargar JSON: ${res.status}`);
      return await res.json();
    }

    async function init(){
      renderStaticUIStrings();

      try{
        state.data = await loadJSON();
      }catch(err){
        ui.title.textContent = TITLE;
        ui.desc.textContent = 'No se pudo cargar el archivo JSON. Verifique la ruta y el nombre.';
        console.error(err);
        return;
      }

      hydrate();

      // defaults
      if(!state.meta.date) state.meta.date = todayISO();

      ensureAllAnswers();
      setMetaInputs();
      bindMetaInputs();
      bindButtons();
      bindPorticoInteractions();

      // initial render
      renderAll();
      persist();
    }

    init();
  </script>
</body>
</html>


