<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La viga: la mujer como alma del sistema ‚Äî Auditor√≠a Diagn√≥stica Pastoral</title>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --card:#111b26;
      --muted:#8aa0b5;
      --text:#e7f0fb;
      --line:#223246;
      --line2:#1a2839;
      --accent:#6fb1ff;

      --good:#3ddc97;
      --warn:#ffd166;
      --risk:#ff9f1c;
      --crit:#ff4d6d;

      --pill:#162536;
      --pillOn:#223a55;
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(111,177,255,.18), transparent 55%),
                  radial-gradient(900px 540px at 90% 0%, rgba(61,220,151,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    a{color:inherit}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:22px 16px 60px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:14px 14px 6px;
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(17,27,38,.92), rgba(15,22,32,.92));
      border:1px solid var(--line2);
      box-shadow:var(--shadow);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:280px;
    }
    .logo{
      width:46px;height:46px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(111,177,255,.35), rgba(61,220,151,.25));
      border:1px solid rgba(111,177,255,.22);
      display:grid;place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .logo svg{opacity:.95}
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .title .sub{
      margin-top:3px;
      font-size:12px;
      color:var(--muted);
    }
    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button{
      appearance:none;
      border:none;
      background:var(--pill);
      color:var(--text);
      border:1px solid rgba(138,160,181,.18);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      font-weight:650;
      letter-spacing:.15px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }
    button:hover{background:var(--pillOn); border-color: rgba(111,177,255,.22)}
    button:active{transform: translateY(1px)}
    button.primary{
      background: linear-gradient(135deg, rgba(111,177,255,.25), rgba(111,177,255,.08));
      border-color: rgba(111,177,255,.35);
    }
    button.danger{
      background: linear-gradient(135deg, rgba(255,77,109,.20), rgba(255,77,109,.06));
      border-color: rgba(255,77,109,.32);
    }
    button:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .85fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(17,27,38,.95), rgba(15,22,32,.95));
      border:1px solid var(--line2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line2);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .cardHead h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:rgba(231,240,251,.95);
    }
    .cardHead .hint{
      font-size:12px;
      color:var(--muted);
      max-width:560px;
    }
    .cardBody{padding:14px}
    .pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(22,37,54,.75);
      border:1px solid rgba(138,160,181,.18);
      color:rgba(231,240,251,.92);
      font-size:12px;
    }
    .pill b{font-weight:800}
    .muted{color:var(--muted)}
    .sec{
      padding:12px;
      border-radius:16px;
      background: rgba(10,14,20,.35);
      border:1px solid rgba(34,50,70,.65);
      margin-bottom:12px;
    }
    .secTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .secTop h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .secTop .metaLine{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .verse{
      margin-top:10px;
      font-size:12px;
      color:rgba(231,240,251,.88);
      padding:10px 10px;
      border-radius:14px;
      background: rgba(17,27,38,.55);
      border:1px dashed rgba(138,160,181,.22);
    }
    .q{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(34,50,70,.75);
      background: rgba(15,22,32,.55);
    }
    .q .qText{font-size:13px; font-weight:650}
    .q .qObs{font-size:12px; color:var(--muted); margin-top:6px}
    .scaleRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .scorePill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      height:34px;
      border-radius:12px;
      background: rgba(22,37,54,.75);
      border:1px solid rgba(138,160,181,.18);
      cursor:pointer;
      user-select:none;
      font-weight:850;
      transition: background .2s ease, border-color .2s ease, transform .08s ease;
    }
    .scorePill:hover{background: rgba(34,58,85,.65); border-color: rgba(111,177,255,.22)}
    .scorePill:active{transform: translateY(1px)}
    .scorePill.on{
      background: linear-gradient(135deg, rgba(111,177,255,.30), rgba(61,220,151,.12));
      border-color: rgba(111,177,255,.40);
    }
    .mini{
      font-size:12px;
      color:var(--muted);
    }

    /* Results */
    .resultBanner{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(34,50,70,.75);
      background: rgba(15,22,32,.65);
      margin-bottom:12px;
    }
    .badge{
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(22,37,54,.75);
    }
    .badge.good{border-color: rgba(61,220,151,.35); background: rgba(61,220,151,.12)}
    .badge.warn{border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10)}
    .badge.risk{border-color: rgba(255,159,28,.35); background: rgba(255,159,28,.10)}
    .badge.crit{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.10)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(34,50,70,.75);
      background: rgba(15,22,32,.55);
    }
    th, td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(34,50,70,.75);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:rgba(231,240,251,.92);
      font-weight:900;
      background: rgba(17,27,38,.55);
    }
    tr:last-child td{border-bottom:none}
    .rightCol{
      display:grid;
      gap:14px;
      align-content:start;
    }

    /* Portico */
    .porticoWrap{
      position:relative;
      border-radius:var(--radius);
      overflow:hidden;
      border:1px solid var(--line2);
      background: radial-gradient(900px 420px at 25% 0%, rgba(111,177,255,.12), transparent 55%),
                  radial-gradient(720px 360px at 80% 20%, rgba(61,220,151,.10), transparent 58%),
                  rgba(10,14,20,.55);
      box-shadow:var(--shadow);
    }
    .porticoTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:12px 12px 8px;
      border-bottom:1px solid rgba(34,50,70,.65);
      background: rgba(15,22,32,.55);
    }
    .porticoTop .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .porticoTop .t{
      font-weight:950;
      letter-spacing:.2px;
      font-size:13px;
    }
    .porticoTop .d{
      font-size:12px;
      color:var(--muted);
      max-width:620px;
    }
    .porticoTop .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .tooltip{
      position:absolute;
      pointer-events:none;
      opacity:0;
      transform: translateY(-6px);
      transition: opacity .12s ease, transform .12s ease;
      background: rgba(10,14,20,.92);
      border:1px solid rgba(138,160,181,.22);
      color:rgba(231,240,251,.96);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      max-width:260px;
      box-shadow: 0 18px 32px rgba(0,0,0,.38);
      z-index:10;
      line-height:1.25;
    }
    .tooltip.on{opacity:1; transform: translateY(0)}
    .tooltip .small{color:var(--muted); font-size:11px; margin-top:4px}

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modalBackdrop.on{display:flex}
    .modal{
      width:min(760px, 96vw);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(17,27,38,.96), rgba(15,22,32,.96));
      border:1px solid rgba(34,50,70,.85);
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(34,50,70,.75);
    }
    .modalHead .h{
      font-weight:950;
      letter-spacing:.2px;
      font-size:14px;
      margin:0;
    }
    .modalBody{padding:14px}
    .modalBody .k{font-size:12px; color:var(--muted); margin-top:8px}
    .modalBody .teaching{
      margin-top:8px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(34,50,70,.75);
      background: rgba(10,14,20,.35);
      font-size:13px;
    }
    .modalBody ul{margin:10px 0 0 18px; padding:0}
    .modalBody li{margin:6px 0; color:rgba(231,240,251,.92); font-size:13px}
    .modalClose{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(138,160,181,.18);
      background: rgba(22,37,54,.65);
      cursor:pointer;
      font-weight:900;
    }

    /* SVG status classes */
    .axis-good{stroke: var(--good)}
    .axis-warn{stroke: var(--warn)}
    .axis-risk{stroke: var(--risk)}
    .axis-crit{stroke: var(--crit)}

    .pulseSoft{animation: pulseSoft 2.6s ease-in-out infinite}
    @keyframes pulseSoft{
      0%,100%{opacity:1}
      50%{opacity:.72}
    }
    .microVibe{animation: microVibe 2.3s ease-in-out infinite}
    @keyframes microVibe{
      0%,100%{transform: translateX(0)}
      25%{transform: translateX(2px)}
      50%{transform: translateX(0)}
      75%{transform: translateX(-2px)}
    }
    .dashAnim{
      stroke-dasharray: 18 14;
      animation: dashMove 2.8s linear infinite;
    }
    @keyframes dashMove{
      from{stroke-dashoffset:0}
      to{stroke-dashoffset:-64}
    }

    .nodeCircle{
      fill: rgba(15,22,32,.95);
      stroke: rgba(231,240,251,.22);
      stroke-width: 3;
    }
    .nodeRing{
      fill:none;
      stroke-width: 10;
      opacity:0;
      filter: blur(0.2px);
    }
    .nodeRing.on{opacity:.22}
    .nodeLabel{
      font-size:14px;
      font-weight:900;
      fill: rgba(231,240,251,.92);
      letter-spacing:.4px;
    }
    .structLabel{
      font-size:14px;
      font-weight:950;
      fill: rgba(231,240,251,.90);
      letter-spacing:.9px;
    }
    .structSubLabel{
      font-size:12px;
      font-weight:800;
      fill: rgba(138,160,181,.90);
      letter-spacing:.35px;
    }
    .ghostPrev{
      opacity:.35;
      stroke: rgba(231,240,251,.55);
      stroke-dasharray: 10 12;
      stroke-linecap: round;
    }
    .deltaRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .delta{
      font-size:12px;
      color:rgba(231,240,251,.92);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(34,50,70,.75);
      background: rgba(15,22,32,.55);
    }
    .delta b{font-weight:950}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="14" cy="14" r="12.2" stroke="rgba(231,240,251,.85)" stroke-width="2"/>
            <path d="M14 7.2V20.8" stroke="rgba(231,240,251,.92)" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M8.2 14H19.8" stroke="rgba(231,240,251,.92)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1 id="appTitle">La viga: la mujer como alma del sistema</h1>
          <div class="sub" id="appSub">Auditor√≠a diagn√≥stica pastoral ‚Ä¢ sin backend ‚Ä¢ escala 0‚Äì5</div>
        </div>
      </div>

      <div class="topActions">
        <button id="btnShowResult" class="primary" disabled>Ver resultado</button>
        <button id="btnDownloadTxt" disabled>Descargar TXT</button>
        <button id="btnDownloadPdf" disabled>Descargar PDF bonito</button>
        <button id="btnDownloadPng" disabled>Descargar Imagen PNG</button>
        <button id="btnReset" class="danger">Reiniciar</button>
      </div>
    </header>

    <div class="grid">
      <div class="card" id="cardTest">
        <div class="cardHead">
          <div>
            <h2 id="testHeading">Test</h2>
            <div class="hint" id="testHint">Responde con honestidad pastoral. No diagnostica personas: diagnostica flujo, cargas y alineaci√≥n.</div>
          </div>
          <div class="pills" id="metaPills"></div>
        </div>
        <div class="cardBody" id="sectionsRoot">
          <div class="muted" id="loadingState">Cargando contenido‚Ä¶</div>
        </div>
      </div>

      <div class="rightCol">
        <div class="porticoWrap">
          <div class="porticoTop">
            <div class="left">
              <div class="t">Diagrama del p√≥rtico (diagn√≥stico)</div>
              <div class="d" id="porticoDesc">Cimiento (Comuni√≥n), Columna (Congregaci√≥n), Viga (Intersecci√≥n). Pasa el cursor o toca para ver estados; haz click para abrir mini-ense√±anza.</div>
            </div>
            <div class="btns">
              <button id="btnGuided">Expl√≠came este diagrama</button>
            </div>
          </div>

          <div style="position:relative; padding:10px;">
            <div class="tooltip" id="tooltip"></div>

            <!-- SVG 860√ó420 ‚Äî geometr√≠a fija: L estructural -->
            <svg id="porticoSvg" width="860" height="420" viewBox="0 0 860 420" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="P√≥rtico diagn√≥stico en L">
              <defs>
                <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L10,5 L0,10 Z" fill="currentColor"></path>
                </marker>
              </defs>

              <!-- CARGAS (coordenadas fijas) -->
              <!-- Carga Viva (verde) -->
              <g id="loadLive" data-kind="load">
                <line x1="740" y1="50" x2="740" y2="108" stroke="var(--good)" stroke-width="6" stroke-linecap="round" style="color:var(--good)" marker-end="url(#arrowHead)"/>
                <text x="712" y="42" class="structSubLabel">CARGA VIVA</text>
              </g>
              <!-- Carga Muerta (roja) -->
              <g id="loadDead" data-kind="load">
                <line x1="780" y1="50" x2="780" y2="108" stroke="var(--crit)" stroke-width="6" stroke-linecap="round" style="color:var(--crit)" marker-end="url(#arrowHead)"/>
                <text x="742" y="42" class="structSubLabel">CARGA MUERTA</text>
              </g>
              <!-- Carga S√≠smica (horizontal) -->
              <g id="loadSeismic" data-kind="load">
                <line x1="810" y1="300" x2="728" y2="300" stroke="rgba(231,240,251,.75)" stroke-width="6" stroke-linecap="round" style="color:rgba(231,240,251,.75)" marker-end="url(#arrowHead)"/>
                <text x="736" y="292" class="structSubLabel">CARGA S√çSMICA</text>
              </g>

              <!-- P√ìRTICO PREVIO (para Antes/Despu√©s) -->
              <g id="prevOverlay" opacity="0"></g>

              <!-- P√ìRTICO ACTUAL (L estructural) -->
              <!-- Cimiento -->
              <path id="elCimiento" data-kind="element" data-axis="comunion"
                    d="M140 330 L720 330"
                    stroke="rgba(231,240,251,.60)" stroke-width="22" stroke-linecap="round" fill="none"/>
              <!-- Columna -->
              <path id="elColumna" data-kind="element" data-axis="congregacion"
                    d="M200 330 L200 110"
                    stroke="rgba(231,240,251,.60)" stroke-width="22" stroke-linecap="round" fill="none"/>
              <!-- Viga -->
              <path id="elViga" data-kind="element" data-axis="interseccion"
                    d="M200 110 L720 110"
                    stroke="rgba(231,240,251,.60)" stroke-width="22" stroke-linecap="round" fill="none"/>

              <!-- Etiquetas estructurales (reglas: solo un text para CIMIENTO y solo un text para COMUNI√ìN) -->
              <text x="140" y="368" class="structLabel">CIMIENTO</text>

              <!-- Nudos -->
              <!-- Halo/ring + nodo principal -->
              <g id="nodeComunion" data-kind="node" data-axis="comunion" style="cursor:pointer">
                <circle id="haloComunion" class="nodeRing" cx="200" cy="330" r="22" stroke="var(--accent)"></circle>
                <circle class="nodeCircle" cx="200" cy="330" r="14"></circle>
                <text x="200" y="386" text-anchor="middle" class="nodeLabel">COMUNI√ìN</text>
              </g>

              <g id="nodeCongregacion" data-kind="node" data-axis="congregacion" style="cursor:pointer">
                <circle id="haloCongregacion" class="nodeRing" cx="200" cy="110" r="22" stroke="var(--accent)"></circle>
                <circle class="nodeCircle" cx="200" cy="110" r="14"></circle>
                <text x="200" y="86" text-anchor="middle" class="nodeLabel">CONGREGACI√ìN</text>
              </g>

              <g id="nodeInterseccion" data-kind="node" data-axis="interseccion" style="cursor:pointer">
                <circle id="haloInterseccion" class="nodeRing" cx="720" cy="110" r="22" stroke="var(--accent)"></circle>
                <circle class="nodeCircle" cx="720" cy="110" r="14"></circle>
                <text x="720" y="86" text-anchor="middle" class="nodeLabel">INTERSECCI√ìN</text>
              </g>

              <!-- Sub-etiquetas discretas -->
              <text x="248" y="325" class="structSubLabel">BASE / CRISTO</text>
              <text x="218" y="170" class="structSubLabel">COLUMNA / VAR√ìN</text>
              <text x="420" y="100" class="structSubLabel">VIGA / MUJER</text>
            </svg>
          </div>
        </div>

        <div class="card" id="cardResults">
          <div class="cardHead">
            <div>
              <h2>Resultados</h2>
              <div class="hint" id="resultHint">Aparecer√°n cuando completes el test y presiones ‚ÄúVer resultado‚Äù.</div>
            </div>
            <div class="pills" id="resultPills"></div>
          </div>
          <div class="cardBody" id="resultsRoot">
            <div class="muted">Completa el test para ver diagn√≥stico global, ejes, tensiones y plan de enfoque.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal contextual -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div>
          <div class="h" id="modalTitle">Panel</div>
          <div class="k" id="modalSubtitle"></div>
        </div>
        <div class="modalClose" id="modalClose">Cerrar</div>
      </div>
      <div class="modalBody">
        <div class="verse" id="modalVerse"></div>
        <div class="teaching" id="modalTeaching"></div>
        <div class="k">Acciones pr√°cticas sugeridas</div>
        <ul id="modalActions"></ul>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const JSON_PATH = "./viga-mujer.json";
    const STORAGE_KEY_LAST = "viga-mujer:lastResult";
    const STORAGE_KEY_PREV = "viga-mujer:prevResult";

    // =========================
    // STATE
    // =========================
    let DATA = null;
    let ANSWERS = {}; // questionId -> score (0..5)
    let LAST_RESULT = null;
    let GUIDED = { on:false, step:0, timer:null };

    // =========================
    // DOM
    // =========================
    const appTitle = document.getElementById("appTitle");
    const appSub = document.getElementById("appSub");
    const metaPills = document.getElementById("metaPills");
    const sectionsRoot = document.getElementById("sectionsRoot");
    const loadingState = document.getElementById("loadingState");

    const btnShowResult = document.getElementById("btnShowResult");
    const btnDownloadTxt = document.getElementById("btnDownloadTxt");
    const btnDownloadPdf = document.getElementById("btnDownloadPdf");
    const btnDownloadPng = document.getElementById("btnDownloadPng");
    const btnReset = document.getElementById("btnReset");
    const btnGuided = document.getElementById("btnGuided");

    const resultsRoot = document.getElementById("resultsRoot");
    const resultPills = document.getElementById("resultPills");
    const resultHint = document.getElementById("resultHint");

    const tooltip = document.getElementById("tooltip");
    const porticoSvg = document.getElementById("porticoSvg");

    const elCimiento = document.getElementById("elCimiento");
    const elColumna = document.getElementById("elColumna");
    const elViga = document.getElementById("elViga");

    const nodeComunion = document.getElementById("nodeComunion");
    const nodeCongregacion = document.getElementById("nodeCongregacion");
    const nodeInterseccion = document.getElementById("nodeInterseccion");

    const haloComunion = document.getElementById("haloComunion");
    const haloCongregacion = document.getElementById("haloCongregacion");
    const haloInterseccion = document.getElementById("haloInterseccion");

    const prevOverlay = document.getElementById("prevOverlay");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalClose = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalVerse = document.getElementById("modalVerse");
    const modalTeaching = document.getElementById("modalTeaching");
    const modalActions = document.getElementById("modalActions");

    // =========================
    // HELPERS
    // =========================
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function nowISO(){ return new Date().toISOString().slice(0,10); }
    function fmtDateLong(){
      const d = new Date();
      const opts = {year:"numeric", month:"long", day:"2-digit"};
      return d.toLocaleDateString("es-ES", opts);
    }
    function safeText(s){ return (s ?? "").toString(); }
    function avg(arr){
      if(!arr.length) return 0;
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }
    function percentFromAvg(a){ return Math.round((clamp(a,0,5)/5)*100); }
    function bandByPercent(pct){
      const bands = DATA?.rubrics?.globalBands || [];
      for(const b of bands){
        if(pct >= b.minPercent && pct <= b.maxPercent) return b;
      }
      return bands[bands.length-1] || {key:"critical", label:"üî¥ Cr√≠tico"};
    }
    function bandByAvg(a){
      const bands = DATA?.rubrics?.sectionBands || [];
      for(const b of bands){
        if(a >= b.minAvg && a <= b.maxAvg) return b;
      }
      return bands[bands.length-1] || {key:"critical", label:"üî¥ Cr√≠tico"};
    }
    function badgeClass(key){
      if(key==="aligned") return "good";
      if(key==="adjust") return "warn";
      if(key==="risk") return "risk";
      return "crit";
    }
    function axisColorKey(key){
      if(key==="comunion") return "--good";
      if(key==="congregacion") return "--warn";
      return "--risk";
    }
    function getAxisInfo(axisKey){
      return DATA?.porticoModel?.axes?.[axisKey] || null;
    }
    function getManualForSection(sectionId){
      return (DATA?.pastoralManual || []).find(m => m.sectionId === sectionId) || null;
    }
    function getManualForAxis(axisKey){
      const sections = (DATA?.sections || []).filter(s => s.axis === axisKey);
      const first = sections.sort((a,b)=>a.order-b.order)[0];
      if(!first) return null;
      return getManualForSection(first.id);
    }
    function downloadBlob(name, content, mime){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }

    // =========================
    // LOAD DATA
    // =========================
    async function init(){
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      DATA = await res.json();

      // minimal validations (silent)
      if(!DATA?.sections?.length) throw new Error("JSON inv√°lido: no sections");
      if((DATA.pastoralManual||[]).length !== (DATA.sections||[]).length) throw new Error("JSON inv√°lido: pastoralManual no coincide 1:1");

      appTitle.textContent = safeText(DATA.meta?.title || "Auditor√≠a");
      appSub.textContent = `${safeText(DATA.meta?.chapterRef || "")} ‚Ä¢ escala ${DATA.scale?.min ?? 0}‚Äì${DATA.scale?.max ?? 5} ‚Ä¢ ${safeText(DATA.meta?.fileName || "")}`;

      renderMeta();
      renderSections();
      hydratePrevOverlayFromStorage();
      wirePorticoInteractivity();
      wireButtons();

      loadingState?.remove?.();
      updateButtonsState();
      updatePorticoVisual(null);
    }

    function renderMeta(){
      metaPills.innerHTML = "";
      const pills = [
        {k:"Archivo", v: DATA.meta?.fileName},
        {k:"Versi√≥n", v: DATA.meta?.version},
        {k:"Fecha", v: DATA.meta?.createdAt},
        {k:"Cap√≠tulo", v: DATA.meta?.chapterRef}
      ];
      for(const p of pills){
        const el = document.createElement("div");
        el.className = "pill";
        el.innerHTML = `<span class="muted">${safeText(p.k)}:</span> <b>${safeText(p.v)}</b>`;
        metaPills.appendChild(el);
      }
    }

    function renderSections(){
      sectionsRoot.innerHTML = "";
      const sections = (DATA.sections || []).slice().sort((a,b)=>a.order-b.order);

      for(const sec of sections){
        const block = document.createElement("div");
        block.className = "sec";
        block.id = `sec_${sec.id}`;

        const axisInfo = getAxisInfo(sec.axis);
        const top = document.createElement("div");
        top.className = "secTop";
        top.innerHTML = `
          <div>
            <h3>${sec.order}. ${safeText(sec.title)}</h3>
            <div class="metaLine">Eje: <b>${safeText(axisInfo?.label || sec.axis)}</b> ‚Ä¢ Elemento: <b>${safeText(axisInfo?.element || "")}</b></div>
          </div>
          <div class="pill"><span class="muted">Estado:</span> <b id="band_${sec.id}">‚Äî</b></div>
        `;

        const intro = document.createElement("div");
        intro.className = "mini";
        intro.textContent = safeText(sec.intro || "");

        const verse = document.createElement("div");
        verse.className = "verse";
        verse.textContent = safeText(sec.verse || "");

        block.appendChild(top);
        block.appendChild(intro);
        block.appendChild(verse);

        for(const q of (sec.questions||[])){
          const qEl = document.createElement("div");
          qEl.className = "q";
          qEl.id = `q_${q.id}`;

          const text = document.createElement("div");
          text.className = "qText";
          text.textContent = safeText(q.text);

          const obs = document.createElement("div");
          obs.className = "qObs";
          obs.textContent = safeText(q.observable);

          const row = document.createElement("div");
          row.className = "scaleRow";
          row.setAttribute("role","group");
          row.setAttribute("aria-label", `Puntaje para ${q.id}`);

          for(let v=DATA.scale.min; v<=DATA.scale.max; v++){
            const p = document.createElement("div");
            p.className = "scorePill";
            p.textContent = v;
            p.dataset.qid = q.id;
            p.dataset.val = String(v);
            p.tabIndex = 0;
            p.addEventListener("click", ()=> setAnswer(q.id, v));
            p.addEventListener("keydown", (e)=>{
              if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setAnswer(q.id, v); }
            });
            row.appendChild(p);
          }

          qEl.appendChild(text);
          qEl.appendChild(obs);
          qEl.appendChild(row);

          block.appendChild(qEl);
        }

        sectionsRoot.appendChild(block);
      }
    }

    function setAnswer(qid, val){
      ANSWERS[qid] = clamp(val, 0, 5);
      const qWrap = document.getElementById(`q_${qid}`);
      if(qWrap){
        qWrap.querySelectorAll(".scorePill").forEach(el=>{
          el.classList.toggle("on", Number(el.dataset.val) === ANSWERS[qid]);
        });
      }
      updateSectionBadgesLive();
      updateButtonsState();
    }

    function updateSectionBadgesLive(){
      const sections = (DATA.sections || []).slice().sort((a,b)=>a.order-b.order);
      for(const sec of sections){
        const qids = (sec.questions||[]).map(q=>q.id);
        const scores = qids.map(id => (id in ANSWERS) ? ANSWERS[id] : null).filter(v=>v!==null);
        const el = document.getElementById(`band_${sec.id}`);
        if(!el) continue;
        if(scores.length === 0){
          el.textContent = "‚Äî";
          continue;
        }
        const a = avg(scores);
        const b = bandByAvg(a);
        el.textContent = `${b.label} (${a.toFixed(2)})`;
      }
    }

    function updateButtonsState(){
      const totalQuestions = (DATA.sections||[]).reduce((n,s)=>n + (s.questions||[]).length, 0);
      const answered = Object.keys(ANSWERS).length;
      const complete = answered === totalQuestions;

      btnShowResult.disabled = !complete;
      const hasResult = !!LAST_RESULT;
      btnDownloadTxt.disabled = !hasResult;
      btnDownloadPdf.disabled = !hasResult;
      btnDownloadPng.disabled = !hasResult;
    }

    // =========================
    // SCORING & RESULTS
    // =========================
    function computeResults(){
      const sections = (DATA.sections||[]).slice().sort((a,b)=>a.order-b.order);

      const sectionResults = sections.map(sec=>{
        const scores = (sec.questions||[]).map(q => ANSWERS[q.id] ?? null);
        const filled = scores.filter(v=>v!==null);
        const a = avg(filled);
        const pct = percentFromAvg(a);
        const band = bandByAvg(a);
        return {
          id: sec.id,
          order: sec.order,
          title: sec.title,
          axis: sec.axis,
          verse: sec.verse,
          avg: Number(a.toFixed(3)),
          percent: pct,
          bandKey: band.key,
          bandLabel: band.label,
          bandSignal: band.signal
        };
      });

      const byAxis = {comunion:[], congregacion:[], interseccion:[]};
      sectionResults.forEach(r => byAxis[r.axis]?.push(r.avg));

      const axisAverages = {};
      const axisPercents = {};
      const axisBands = {};
      for(const k of Object.keys(byAxis)){
        const a = avg(byAxis[k]);
        axisAverages[k] = Number(a.toFixed(3));
        axisPercents[k] = percentFromAvg(a);
        axisBands[k] = bandByPercent(axisPercents[k]);
      }

      const globalAvg = avg(Object.values(axisAverages));
      const globalPercent = percentFromAvg(globalAvg);
      const globalBand = bandByPercent(globalPercent);

      // top needs: lowest 3 sections
      const needs = sectionResults.slice().sort((a,b)=>a.avg-b.avg).slice(0,3).map(s=>{
        const manual = getManualForSection(s.id);
        return {
          sectionId: s.id,
          title: s.title,
          axis: s.axis,
          bandLabel: s.bandLabel,
          avg: s.avg,
          percent: s.percent,
          actions: (manual?.actions || []).slice(0,2),
          keyVerse: manual?.keyVerse || s.verse || ""
        };
      });

      return {
        meta:{
          fileName: DATA.meta?.fileName,
          title: DATA.meta?.title,
          createdAt: nowISO(),
          createdAtLong: fmtDateLong()
        },
        totals:{
          globalAvg: Number(globalAvg.toFixed(3)),
          globalPercent,
          globalBandKey: globalBand.key,
          globalBandLabel: globalBand.label,
          globalSummary: globalBand.summary,
          pastoralTone: globalBand.pastoralTone
        },
        axes:{
          comunion:{avg: axisAverages.comunion, percent: axisPercents.comunion, bandKey: axisBands.comunion.key, bandLabel: axisBands.comunion.label},
          congregacion:{avg: axisAverages.congregacion, percent: axisPercents.congregacion, bandKey: axisBands.congregacion.key, bandLabel: axisBands.congregacion.label},
          interseccion:{avg: axisAverages.interseccion, percent: axisPercents.interseccion, bandKey: axisBands.interseccion.key, bandLabel: axisBands.interseccion.label}
        },
        sections: sectionResults,
        needs
      };
    }

    function renderResults(result){
      resultPills.innerHTML = "";
      resultsRoot.innerHTML = "";

      const gb = bandByPercent(result.totals.globalPercent);
      resultHint.textContent = gb.summary || "";

      const banner = document.createElement("div");
      banner.className = "resultBanner";
      banner.innerHTML = `
        <div>
          <div style="font-weight:950; font-size:14px; letter-spacing:.2px;">Diagn√≥stico global: <span class="badge ${badgeClass(gb.key)}">${gb.label}</span></div>
          <div class="muted" style="margin-top:6px; font-size:12px;">${safeText(gb.summary)} ‚Ä¢ Enfoque: <b>${safeText(gb.pastoralTone)}</b></div>
          <div class="muted" style="margin-top:4px; font-size:12px;">Fecha: <b>${safeText(result.meta.createdAtLong)}</b></div>
        </div>
        <div class="pill"><span class="muted">Global:</span> <b>${result.totals.globalPercent}%</b></div>
      `;
      resultsRoot.appendChild(banner);

      // Pills axes
      const axPills = [
        {k:"Comuni√≥n (Cimiento)", v:`${result.axes.comunion.percent}%`, cls: badgeClass(result.axes.comunion.bandKey)},
        {k:"Congregaci√≥n (Columna)", v:`${result.axes.congregacion.percent}%`, cls: badgeClass(result.axes.congregacion.bandKey)},
        {k:"Intersecci√≥n (Viga)", v:`${result.axes.interseccion.percent}%`, cls: badgeClass(result.axes.interseccion.bandKey)}
      ];
      for(const p of axPills){
        const el = document.createElement("div");
        el.className = `badge ${p.cls}`;
        el.textContent = `${p.k}: ${p.v}`;
        resultPills.appendChild(el);
      }

      // Axis table
      const axisTable = document.createElement("table");
      axisTable.innerHTML = `
        <thead>
          <tr>
            <th>Eje</th>
            <th>Elemento</th>
            <th>Estado</th>
            <th>Promedio</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>Comuni√≥n</b></td>
            <td>Cimiento</td>
            <td>${safeText(result.axes.comunion.bandLabel)}</td>
            <td>${result.axes.comunion.avg.toFixed(2)}</td>
            <td><b>${result.axes.comunion.percent}%</b></td>
          </tr>
          <tr>
            <td><b>Congregaci√≥n</b></td>
            <td>Columna</td>
            <td>${safeText(result.axes.congregacion.bandLabel)}</td>
            <td>${result.axes.congregacion.avg.toFixed(2)}</td>
            <td><b>${result.axes.congregacion.percent}%</b></td>
          </tr>
          <tr>
            <td><b>Intersecci√≥n</b></td>
            <td>Viga</td>
            <td>${safeText(result.axes.interseccion.bandLabel)}</td>
            <td>${result.axes.interseccion.avg.toFixed(2)}</td>
            <td><b>${result.axes.interseccion.percent}%</b></td>
          </tr>
        </tbody>
      `;
      resultsRoot.appendChild(axisTable);

      // Section table
      const secTable = document.createElement("table");
      const rows = result.sections.map(s=>`
        <tr>
          <td><b>${s.order}. ${safeText(s.title)}</b><div class="muted" style="margin-top:4px">${safeText(getAxisInfo(s.axis)?.label || s.axis)}</div></td>
          <td>${safeText(s.bandLabel)}<div class="muted" style="margin-top:4px">${safeText(s.bandSignal)}</div></td>
          <td>${s.avg.toFixed(2)}</td>
          <td><b>${s.percent}%</b></td>
        </tr>
      `).join("");

      secTable.innerHTML = `
        <thead>
          <tr>
            <th>Secci√≥n</th>
            <th>Se√±al</th>
            <th>Prom.</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      `;
      resultsRoot.appendChild(document.createElement("div")).style.height="10px";
      resultsRoot.appendChild(secTable);

      // Plan
      const plan = document.createElement("div");
      plan.className = "sec";
      plan.innerHTML = `<div style="font-weight:950; letter-spacing:.2px; font-size:14px;">Plan de enfoque (3 √°reas de presi√≥n)</div>
                        <div class="muted" style="margin-top:6px; font-size:12px;">Prioriza aliviar carga y restaurar flujo: percibir ‚Üí expresar ‚Üí transferir ‚Üí reposar.</div>`;
      for(const n of result.needs){
        const ax = getAxisInfo(n.axis);
        const box = document.createElement("div");
        box.className = "q";
        box.innerHTML = `
          <div class="qText">${safeText(n.title)} <span class="muted">(${safeText(ax?.element || "")})</span></div>
          <div class="qObs">Estado: <b>${safeText(n.bandLabel)}</b> ‚Ä¢ ${n.percent}%</div>
          <div class="verse" style="margin-top:10px;">${safeText(n.keyVerse)}</div>
          <div class="mini" style="margin-top:8px; font-weight:850; color:rgba(231,240,251,.92)">Acciones sugeridas</div>
          <div class="mini" style="margin-top:6px;">
            ‚Ä¢ ${safeText(n.actions?.[0] || "‚Äî")}<br/>
            ‚Ä¢ ${safeText(n.actions?.[1] || "‚Äî")}
          </div>
        `;
        plan.appendChild(box);
      }
      resultsRoot.appendChild(document.createElement("div")).style.height="10px";
      resultsRoot.appendChild(plan);

      // Before/After deltas (if previous exists)
      const prev = loadPrevResult();
      if(prev){
        const deltas = {
          comunion: result.axes.comunion.percent - prev.axes.comunion.percent,
          congregacion: result.axes.congregacion.percent - prev.axes.congregacion.percent,
          interseccion: result.axes.interseccion.percent - prev.axes.interseccion.percent
        };
        const deltaWrap = document.createElement("div");
        deltaWrap.className = "deltaRow";
        deltaWrap.innerHTML = `
          <div class="delta"><b>Antes/Despu√©s</b> (medici√≥n previa detectada)</div>
          <div class="delta">Comuni√≥n: <b>${fmtDelta(deltas.comunion)}</b></div>
          <div class="delta">Congregaci√≥n: <b>${fmtDelta(deltas.congregacion)}</b></div>
          <div class="delta">Intersecci√≥n: <b>${fmtDelta(deltas.interseccion)}</b></div>
        `;
        resultsRoot.insertBefore(deltaWrap, resultsRoot.children[1] || null);
      }
    }

    function fmtDelta(n){
      const s = (n>0?"+":"") + n.toString() + "%";
      return s;
    }

    // =========================
    // P√ìRTICO: VISUALS + INTERACTIVITY
    // =========================
    function clearAxisClasses(el){
      el.classList.remove("axis-good","axis-warn","axis-risk","axis-crit","pulseSoft","microVibe","dashAnim");
    }

    // ‚úÖ FIX: faltaba el par√©ntesis y la llave de la funci√≥n
    function applyAxisStyle(el, band){
      if(!el || !band) return;
      clearAxisClasses(el);

      // Color band
      if(band.key==="aligned") el.classList.add("axis-good");
      else if(band.key==="adjust") el.classList.add("axis-warn");
      else if(band.key==="risk") el.classList.add("axis-risk");
      else el.classList.add("axis-crit");

      // Animation rules (sutil)
      if(band.key==="adjust") el.classList.add("pulseSoft");
      if(band.key==="risk") el.classList.add("microVibe");
      if(band.key==="critical") el.classList.add("dashAnim");
    }

    function updatePorticoVisual(result){
      // If no result yet: reset strokes and halos, keep overlays hidden if no prev
      if(!result){
        [elCimiento, elColumna, elViga].forEach(el=>{
          clearAxisClasses(el);
          el.setAttribute("stroke","rgba(231,240,251,.60)");
        });
        [haloComunion, haloCongregacion, haloInterseccion].forEach(h=>{
          h.classList.remove("on");
          h.setAttribute("stroke","var(--accent)");
        });
        prevOverlay.setAttribute("opacity","0");
        return;
      }

      const ax = result.axes;
      const bCom = bandByPercent(ax.comunion.percent);
      const bCon = bandByPercent(ax.congregacion.percent);
      const bInt = bandByPercent(ax.interseccion.percent);

      applyAxisStyle(elCimiento, bCom);
      applyAxisStyle(elColumna, bCon);
      applyAxisStyle(elViga, bInt);

      // Node tension halos (difference > 20%)
      const p = {
        comunion: ax.comunion.percent,
        congregacion: ax.congregacion.percent,
        interseccion: ax.interseccion.percent
      };
      const keys = Object.keys(p);
      let maxK = keys[0], minK = keys[0];
      for(const k of keys){
        if(p[k] > p[maxK]) maxK = k;
        if(p[k] < p[minK]) minK = k;
      }
      const diff = Math.abs(p[maxK] - p[minK]);
      const dominant = maxK;
      const domVar = axisColorKey(dominant);

      // reset halos
      const haloMap = {
        comunion: haloComunion,
        congregacion: haloCongregacion,
        interseccion: haloInterseccion
      };
      for(const k of keys){
        haloMap[k].classList.remove("on");
        haloMap[k].setAttribute("stroke","var(--accent)");
      }

      if(diff > 20){
        for(const k of keys){
          haloMap[k].classList.add("on");
          haloMap[k].setAttribute("stroke", `var(${domVar})`);
        }
      }

      // Previous overlay
      renderPrevOverlayIfAny(result);
    }

    function axisTooltip(axisKey, kind){
      const r = LAST_RESULT;
      const info = getAxisInfo(axisKey);
      const pct = r ? r.axes?.[axisKey]?.percent : null;
      const band = r ? bandByPercent(pct) : null;

      if(kind === "element"){
        if(axisKey==="comunion"){
          return {
            line1: `Cimiento / Comuni√≥n ‚Äî ${pct ?? "‚Äî"}%`,
            line2: band ? band.summary : safeText(info?.diagnosticFocus || "")
          };
        }
        if(axisKey==="congregacion"){
          const risk = band ? (band.key==="risk"||band.key==="critical" ? "Riesgo detectado" : "Sin riesgo cr√≠tico") : "‚Äî";
          return {
            line1: `Columna / Congregaci√≥n ‚Äî ${pct ?? "‚Äî"}%`,
            line2: `Alineaci√≥n del var√≥n ‚Ä¢ ${risk}`
          };
        }
        // interseccion
        return {
          line1: `Viga / Intersecci√≥n ‚Äî ${pct ?? "‚Äî"}%`,
          line2: band ? "Sobrecarga y presi√≥n visible" : safeText(info?.diagnosticFocus || "")
        };
      }

      // node
      const templates = info?.shortDiagnosisTemplates || [];
      let diag = safeText(info?.diagnosticFocus || "");
      if(band){
        if(band.key==="aligned") diag = templates[0] || diag;
        else if(band.key==="adjust") diag = templates[1] || diag;
        else diag = templates[2] || diag;
      }
      return {
        line1: `${safeText(info?.nodeLabel || info?.label || axisKey)} ‚Äî ${pct ?? "‚Äî"}%`,
        line2: diag
      };
    }

    function showTooltipAt(clientX, clientY, html){
      const pad = 14;
      tooltip.innerHTML = html;
      tooltip.classList.add("on");

      const rect = tooltip.getBoundingClientRect();
      let x = clientX + 12;
      let y = clientY + 12;

      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if(x + rect.width + pad > vw) x = clientX - rect.width - 12;
      if(y + rect.height + pad > vh) y = clientY - rect.height - 12;

      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    function hideTooltip(){
      tooltip.classList.remove("on");
    }

    function openModalForAxis(axisKey, sourceLabel){
      const info = getAxisInfo(axisKey);
      const manual = getManualForAxis(axisKey);

      modalTitle.textContent = `${safeText(info?.element || "Panel")} ‚Äî ${safeText(info?.label || axisKey)}`;
      modalSubtitle.textContent = safeText(sourceLabel || info?.diagnosticFocus || "");
      modalVerse.textContent = safeText(manual?.keyVerse || info?.keyVerse || "");
      modalTeaching.textContent = safeText(manual?.miniTeaching || info?.diagnosticFocus || "");

      modalActions.innerHTML = "";
      const acts = (manual?.actions || []).slice(0,2);
      for(const a of acts){
        const li = document.createElement("li");
        li.textContent = safeText(a);
        modalActions.appendChild(li);
      }
      if(acts.length === 0){
        const li = document.createElement("li");
        li.textContent = "Practiquen una conversaci√≥n breve de transferencia hoy: percibir ‚Üí expresar ‚Üí transferir ‚Üí reposar.";
        modalActions.appendChild(li);
      }

      modalBackdrop.classList.add("on");
      modalBackdrop.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      modalBackdrop.classList.remove("on");
      modalBackdrop.setAttribute("aria-hidden","true");
    }

    function wirePorticoInteractivity(){
      const targets = [
        {el: elCimiento, kind:"element", axis:"comunion"},
        {el: elColumna, kind:"element", axis:"congregacion"},
        {el: elViga, kind:"element", axis:"interseccion"},
        {el: nodeComunion, kind:"node", axis:"comunion"},
        {el: nodeCongregacion, kind:"node", axis:"congregacion"},
        {el: nodeInterseccion, kind:"node", axis:"interseccion"}
      ];

      for(const t of targets){
        t.el.style.cursor = "pointer";

        const onMove = (e)=>{
          if(GUIDED.on) return;
          if(!LAST_RESULT){
            showTooltipAt(e.clientX, e.clientY, `<div><b>${safeText(getAxisInfo(t.axis)?.element || "")}</b></div><div class="small">Completa el test para ver el estado.</div>`);
            return;
          }
          const tip = axisTooltip(t.axis, t.kind);
          showTooltipAt(e.clientX, e.clientY, `<div><b>${safeText(tip.line1)}</b></div><div class="small">${safeText(tip.line2)}</div>`);
        };

        const onEnter = (e)=> onMove(e);
        const onLeave = ()=> { if(!GUIDED.on) hideTooltip(); };

        t.el.addEventListener("pointerenter", onEnter);
        t.el.addEventListener("pointermove", onMove);
        t.el.addEventListener("pointerleave", onLeave);

        // Tap support
        t.el.addEventListener("pointerdown", (e)=>{
          if(GUIDED.on) return;
          if(e.pointerType === "touch"){
            onMove(e);
            setTimeout(()=> hideTooltip(), 1400);
          }
        }, {passive:true});

        // Click -> contextual panel
        t.el.addEventListener("click", ()=>{
          if(!LAST_RESULT){
            openModalForAxis(t.axis, "Completa el test para habilitar diagn√≥stico por eje.");
            return;
          }
          const label = (t.kind==="element")
            ? `Estado actual: ${LAST_RESULT.axes?.[t.axis]?.percent ?? "‚Äî"}% ‚Ä¢ ${safeText(bandByPercent(LAST_RESULT.axes?.[t.axis]?.percent ?? 0).label)}`
            : `Diagn√≥stico del nudo: ${safeText(axisTooltip(t.axis, "node").line2)}`;

          openModalForAxis(t.axis, label);
        });
      }
    }

    // =========================
    // GUIDED MODE
    // =========================
    function stopGuided(){
      GUIDED.on = false;
      GUIDED.step = 0;
      if(GUIDED.timer) clearTimeout(GUIDED.timer);
      GUIDED.timer = null;
      btnGuided.textContent = "Expl√≠came este diagrama";
      hideTooltip();
      // remove temporary emphasis
      [elCimiento, elColumna, elViga].forEach(el=> el.style.filter = "");
      [nodeComunion, nodeCongregacion, nodeInterseccion].forEach(el=> el.style.filter = "");
    }

    function runGuidedStep(step){
      const steps = [
        {
          el: elCimiento,
          title: "1/4 ‚Äî Cimiento",
          text: "Aqu√≠ se diagnostica la base: descanso y dependencia de Cristo. Si el cimiento est√° bajo, todo se vuelve presi√≥n."
        },
        {
          el: elColumna,
          title: "2/4 ‚Äî Columna",
          text: "Aqu√≠ se ve la alineaci√≥n del var√≥n: presencia, cobertura y recepci√≥n de transferencia. Si la columna reacciona tarde, la viga se sobrecarga."
        },
        {
          el: elViga,
          title: "3/4 ‚Äî Viga",
          text: "Aqu√≠ se ve el clima del hogar: sensibilidad canalizada, convivencia y distribuci√≥n del peso. Si acumula, aparecen fisuras emocionales."
        },
        {
          el: nodeInterseccion,
          title: "4/4 ‚Äî Cargas",
          text: "Las flechas representan presiones. El objetivo no es negar cargas, sino transferir y sostener con orden: viga ‚Üí columna ‚Üí cimiento."
        }
      ];

      const s = steps[step];
      if(!s){ stopGuided(); return; }

      // emphasis
      [elCimiento, elColumna, elViga].forEach(el=> el.style.filter = "");
      [nodeComunion, nodeCongregacion, nodeInterseccion].forEach(el=> el.style.filter = "");
      s.el.style.filter = "drop-shadow(0 0 10px rgba(111,177,255,.35))";

      const host = porticoSvg.getBoundingClientRect();
      const cx = Math.round(host.left + host.width*0.5);
      const cy = Math.round(host.top + 18);

      showTooltipAt(cx, cy, `<div><b>${safeText(s.title)}</b></div><div class="small">${safeText(s.text)}</div>`);
      tooltip.style.left = `${Math.round(host.left + 16)}px`;
      tooltip.style.top = `${Math.round(host.top + 16)}px`;

      GUIDED.timer = setTimeout(()=>{
        GUIDED.step += 1;
        runGuidedStep(GUIDED.step);
      }, 2800);
    }

    function startGuided(){
      if(GUIDED.on) return;
      GUIDED.on = true;
      GUIDED.step = 0;
      btnGuided.textContent = "Detener lectura guiada";
      runGuidedStep(0);
    }

    // =========================
    // STORAGE (Before/After)
    // =========================
    function saveLastResult(result){
      localStorage.setItem(STORAGE_KEY_LAST, JSON.stringify(result));
    }
    function loadLastResult(){
      try{
        const s = localStorage.getItem(STORAGE_KEY_LAST);
        return s ? JSON.parse(s) : null;
      }catch(_){ return null; }
    }
    function savePrevResult(result){
      localStorage.setItem(STORAGE_KEY_PREV, JSON.stringify(result));
    }
    function loadPrevResult(){
      try{
        const s = localStorage.getItem(STORAGE_KEY_PREV);
        return s ? JSON.parse(s) : null;
      }catch(_){ return null; }
    }
    function hydratePrevOverlayFromStorage(){
      const prev = loadPrevResult();
      if(prev){
        prevOverlay.setAttribute("opacity","0");
      }
    }

    function renderPrevOverlayIfAny(currentResult){
      const prev = loadPrevResult();
      if(!prev){
        prevOverlay.innerHTML = "";
        prevOverlay.setAttribute("opacity","0");
        return;
      }

      const pc = prev.axes?.comunion?.percent ?? 0;
      const pg = prev.axes?.congregacion?.percent ?? 0;
      const pi = prev.axes?.interseccion?.percent ?? 0;

      const bCom = bandByPercent(pc);
      const bCon = bandByPercent(pg);
      const bInt = bandByPercent(pi);

      const colorClass = (key)=>{
        if(key==="aligned") return "axis-good";
        if(key==="adjust") return "axis-warn";
        if(key==="risk") return "axis-risk";
        return "axis-crit";
      };

      prevOverlay.innerHTML = `
        <path d="M140 330 L720 330" class="ghostPrev ${colorClass(bCom.key)}" stroke-width="14" fill="none"/>
        <path d="M200 330 L200 110" class="ghostPrev ${colorClass(bCon.key)}" stroke-width="14" fill="none"/>
        <path d="M200 110 L720 110" class="ghostPrev ${colorClass(bInt.key)}" stroke-width="14" fill="none"/>
      `;
      prevOverlay.setAttribute("opacity","1");
    }

    // =========================
    // EXPORTS
    // =========================
    function buildTxt(result){
      const lines = [];
      lines.push(`${safeText(result.meta.title)} ‚Äî Auditor√≠a Diagn√≥stica Pastoral`);
      lines.push(`Fecha: ${safeText(result.meta.createdAtLong)} (${safeText(result.meta.createdAt)})`);
      lines.push("");
      lines.push(`Diagn√≥stico global: ${safeText(result.totals.globalBandLabel)} ‚Äî ${result.totals.globalPercent}%`);
      lines.push(`${safeText(result.totals.globalSummary)} (Enfoque: ${safeText(result.totals.pastoralTone)})`);
      lines.push("");
      lines.push("Ejes:");
      lines.push(`- Comuni√≥n / Cimiento: ${result.axes.comunion.percent}% (prom. ${result.axes.comunion.avg.toFixed(2)}) ${safeText(result.axes.comunion.bandLabel)}`);
      lines.push(`- Congregaci√≥n / Columna: ${result.axes.congregacion.percent}% (prom. ${result.axes.congregacion.avg.toFixed(2)}) ${safeText(result.axes.congregacion.bandLabel)}`);
      lines.push(`- Intersecci√≥n / Viga: ${result.axes.interseccion.percent}% (prom. ${result.axes.interseccion.avg.toFixed(2)}) ${safeText(result.axes.interseccion.bandLabel)}`);
      lines.push("");
      lines.push("Secciones:");
      for(const s of result.sections){
        lines.push(`- ${s.order}. ${safeText(s.title)} [${safeText(getAxisInfo(s.axis)?.label || s.axis)}]: ${s.percent}% (prom. ${s.avg.toFixed(2)}) ${safeText(s.bandLabel)}`);
      }
      lines.push("");
      lines.push("Plan de enfoque (3 √°reas de presi√≥n):");
      for(const n of result.needs){
        lines.push(`‚Ä¢ ${safeText(n.title)} ‚Äî ${n.percent}% ${safeText(n.bandLabel)}`);
        if(n.keyVerse) lines.push(`  ${safeText(n.keyVerse)}`);
        if(n.actions?.[0]) lines.push(`  - ${safeText(n.actions[0])}`);
        if(n.actions?.[1]) lines.push(`  - ${safeText(n.actions[1])}`);
      }
      return lines.join("\n");
    }

    function svgToDataUrl(svgString){
      const encoded = encodeURIComponent(svgString)
        .replace(/%0A/g, "")
        .replace(/%20/g, " ")
        .replace(/%3D/g, "=")
        .replace(/%3A/g, ":")
        .replace(/%2F/g, "/")
        .replace(/%22/g, "'");
      return `data:image/svg+xml;charset=utf-8,${encoded}`;
    }

    function buildExportSvg(includeTitleDate){
      const svg = porticoSvg.cloneNode(true);

      const prevG = svg.querySelector("#prevOverlay");
      if(prevG && prevOverlay){
        prevG.innerHTML = prevOverlay.innerHTML;
        prevG.setAttribute("opacity", prevOverlay.getAttribute("opacity") || "0");
      }

      if(includeTitleDate){
        const t1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t1.setAttribute("x", "18");
        t1.setAttribute("y", "28");
        t1.setAttribute("fill", "rgba(231,240,251,.92)");
        t1.setAttribute("font-size", "16");
        t1.setAttribute("font-weight", "900");
        t1.textContent = safeText(DATA?.meta?.title || "Auditor√≠a");

        const t2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t2.setAttribute("x", "18");
        t2.setAttribute("y", "48");
        t2.setAttribute("fill", "rgba(138,160,181,.92)");
        t2.setAttribute("font-size", "12");
        t2.setAttribute("font-weight", "800");
        t2.textContent = `Fecha: ${fmtDateLong()}`;

        svg.insertBefore(t2, svg.firstChild);
        svg.insertBefore(t1, svg.firstChild);
      }

      const bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      bg.setAttribute("x","0"); bg.setAttribute("y","0");
      bg.setAttribute("width","860"); bg.setAttribute("height","420");
      bg.setAttribute("fill", "#0b0f14");
      svg.insertBefore(bg, svg.firstChild);

      const serializer = new XMLSerializer();
      const str = serializer.serializeToString(svg);
      return str;
    }

    async function getPorticoPngDataUrl(includeTitleDate){
      const svgStr = buildExportSvg(includeTitleDate);
      const url = svgToDataUrl(svgStr);

      const canvas = document.createElement("canvas");
      canvas.width = 860;
      canvas.height = 420;
      const ctx = canvas.getContext("2d");

      await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0, 0); resolve(); };
        img.onerror = reject;
        img.src = url;
      });

      return canvas.toDataURL("image/png");
    }

    async function exportPng(){
      const pngUrl = await getPorticoPngDataUrl(true);
      const a = document.createElement("a");
      a.href = pngUrl;
      a.download = `${safeText(DATA?.meta?.fileName || "portico")}-${nowISO()}.png`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=> a.remove(), 200);
    }

    function exportTxt(){
      const txt = buildTxt(LAST_RESULT);
      downloadBlob(`${safeText(DATA?.meta?.fileName || "auditoria")}-${nowISO()}.txt`, txt, "text/plain;charset=utf-8");
    }

    async function exportPdf(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});

      const W = doc.internal.pageSize.getWidth();
      const margin = 44;

      doc.setFillColor(15,22,32);
      doc.rect(0,0,W,doc.internal.pageSize.getHeight(),"F");

      doc.setDrawColor(231,240,251);
      doc.setLineWidth(2);
      doc.circle(margin+20, margin+20, 16, "S");
      doc.line(margin+20, margin+10, margin+20, margin+30);
      doc.line(margin+10, margin+20, margin+30, margin+20);

      doc.setTextColor(231,240,251);
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text(safeText(DATA?.meta?.title || "Auditor√≠a Diagn√≥stica Pastoral"), margin, margin+70);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(138,160,181);
      doc.text(`${safeText(DATA?.meta?.chapterRef || "")} ‚Ä¢ ${safeText(DATA?.meta?.fileName || "")}`, margin, margin+90);
      doc.text(`Fecha: ${safeText(LAST_RESULT?.meta?.createdAtLong || fmtDateLong())}`, margin, margin+105);

      const gb = bandByPercent(LAST_RESULT.totals.globalPercent);
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(231,240,251);
      doc.text(`Diagn√≥stico global: ${safeText(gb.label)} ‚Äî ${LAST_RESULT.totals.globalPercent}%`, margin, margin+132);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(138,160,181);
      doc.text(doc.splitTextToSize(safeText(gb.summary || ""), W - margin*2), margin, margin+150);

      const png = await getPorticoPngDataUrl(true);
      const imgW = W - margin*2;
      const imgH = Math.round(imgW * (420/860));
      doc.addImage(png, "PNG", margin, margin+190, imgW, imgH);

      doc.addPage();
      doc.setTextColor(231,240,251);
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text("Resumen por ejes", margin, margin);

      doc.setFontSize(10);
      doc.setFont("helvetica","normal");
      doc.setTextColor(138,160,181);
      doc.text("Diagnostica alineaci√≥n, cargas y transferencia por eje.", margin, margin+16);

      doc.autoTable({
        startY: margin+28,
        head: [["Eje","Elemento","Estado","Prom.","%"]],
        body: [
          ["Comuni√≥n","Cimiento", safeText(LAST_RESULT.axes.comunion.bandLabel), LAST_RESULT.axes.comunion.avg.toFixed(2), `${LAST_RESULT.axes.comunion.percent}%`],
          ["Congregaci√≥n","Columna", safeText(LAST_RESULT.axes.congregacion.bandLabel), LAST_RESULT.axes.congregacion.avg.toFixed(2), `${LAST_RESULT.axes.congregacion.percent}%`],
          ["Intersecci√≥n","Viga", safeText(LAST_RESULT.axes.interseccion.bandLabel), LAST_RESULT.axes.interseccion.avg.toFixed(2), `${LAST_RESULT.axes.interseccion.percent}%`]
        ],
        theme: "grid",
        styles: {font:"helvetica", fontSize:9, textColor: [231,240,251], lineColor:[34,50,70], fillColor:[15,22,32]},
        headStyles: {fillColor:[17,27,38], textColor:[231,240,251]},
        alternateRowStyles: {fillColor:[13,19,28]},
        margin: {left: margin, right: margin}
      });

      doc.addPage();
      doc.setTextColor(231,240,251);
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.text("Plan de enfoque (3 √°reas de presi√≥n)", margin, margin);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(138,160,181);
      doc.text("Prioriza aliviar carga y restaurar flujo: percibir ‚Üí expresar ‚Üí transferir ‚Üí reposar.", margin, margin+16);

      const planBody = LAST_RESULT.needs.map(n=>{
        const ax = getAxisInfo(n.axis);
        const acts = (n.actions||[]).slice(0,2).join(" | ");
        return [
          safeText(n.title),
          safeText(ax?.element || ""),
          `${n.percent}%`,
          safeText(n.keyVerse || ""),
          acts
        ];
      });

      doc.autoTable({
        startY: margin+28,
        head: [["√Årea","Elemento","%","Verso clave","Acciones"]],
        body: planBody,
        theme: "grid",
        styles: {font:"helvetica", fontSize:8, textColor: [231,240,251], lineColor:[34,50,70], fillColor:[15,22,32], cellPadding:6},
        headStyles: {fillColor:[17,27,38], textColor:[231,240,251]},
        alternateRowStyles: {fillColor:[13,19,28]},
        margin: {left: margin, right: margin},
        columnStyles: {
          0: {cellWidth: 160},
          1: {cellWidth: 70},
          2: {cellWidth: 40},
          3: {cellWidth: 170},
          4: {cellWidth: 110}
        }
      });

      doc.save(`${safeText(DATA?.meta?.fileName || "auditoria")}-${nowISO()}.pdf`);
    }

    // =========================
    // BUTTONS / EVENTS
    // =========================
    function wireButtons(){
      btnShowResult.addEventListener("click", ()=>{
        const r = computeResults();

        const existingLast = loadLastResult();
        if(existingLast) savePrevResult(existingLast);

        LAST_RESULT = r;
        saveLastResult(r);

        renderResults(r);
        updatePorticoVisual(r);
        updateButtonsState();
      });

      btnDownloadTxt.addEventListener("click", ()=> exportTxt());
      btnDownloadPng.addEventListener("click", ()=> exportPng());
      btnDownloadPdf.addEventListener("click", ()=> exportPdf());

      btnReset.addEventListener("click", ()=>{
        stopGuided();
        ANSWERS = {};
        LAST_RESULT = null;

        document.querySelectorAll(".scorePill.on").forEach(el=> el.classList.remove("on"));
        document.querySelectorAll('[id^="band_"]').forEach(el=> el.textContent="‚Äî");

        resultsRoot.innerHTML = `<div class="muted">Completa el test para ver diagn√≥stico global, ejes, tensiones y plan de enfoque.</div>`;
        resultPills.innerHTML = "";
        resultHint.textContent = "Aparecer√°n cuando completes el test y presiones ‚ÄúVer resultado‚Äù.";

        updatePorticoVisual(null);
        updateButtonsState();
        hideTooltip();
      });

      btnGuided.addEventListener("click", ()=>{
        if(GUIDED.on) stopGuided();
        else startGuided();
      });

      modalClose.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (e)=>{
        if(e.target === modalBackdrop) closeModal();
      });

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          if(modalBackdrop.classList.contains("on")) closeModal();
          if(GUIDED.on) stopGuided();
          hideTooltip();
        }
      });

      document.addEventListener("scroll", ()=> { if(!GUIDED.on) hideTooltip(); }, {passive:true});
    }

    // =========================
    // BOOT
    // =========================
    init().catch(err=>{
      sectionsRoot.innerHTML = `<div class="sec"><div class="qText">Error al cargar</div><div class="qObs">${safeText(err?.message || err)}</div></div>`;
    });
  </script>
</body>
</html>