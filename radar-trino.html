<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Radar Trino ‚Äî Gobierno Interior</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1150px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:520px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .sec{border-top:1px solid var(--line);padding-top:10px;margin-top:10px;}
    .sec:first-child{border-top:none;padding-top:0;margin-top:0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .opts{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .opt{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:8px 10px;cursor:pointer;user-select:none;}
    .opt input{width:auto}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .result{display:none;margin-top:12px;border-radius:18px;border:1px solid var(--line);padding:14px;background:rgba(255,255,255,.04);}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.4px;}
    .bG{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.35);}
    .bY{background:rgba(245,158,11,.18);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
    .bO{background:rgba(249,115,22,.18);color:#fdba74;border:1px solid rgba(249,115,22,.35);}
    .bR{background:rgba(244,63,94,.18);color:#fda4af;border:1px solid rgba(244,63,94,.35);}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .toggleRow{margin-top:10px;display:flex;gap:10px;align-items:center;}
    .toggleRow input{transform:scale(1.1)}

    /* ===== MODAL ===== */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); padding:18px; z-index:9999;
    }
    .modalCard{
      width:min(880px, 100%); max-height:min(86vh, 900px); overflow:hidden;
      background:var(--card); border:1px solid var(--line); border-radius:18px;
      box-shadow:0 20px 80px rgba(0,0,0,.45);
    }
    .modalHeader{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
    }
    .modalTitle{font-weight:950; font-size:16px;}
    .modalSub{color:var(--muted); font-size:12.5px; margin-top:4px; line-height:1.3;}
    .modalClose{
      background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--text);
      border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:900;
    }
    .modalBody{
      padding:14px; overflow:auto; max-height:calc(86vh - 120px);
      color:var(--text);
    }
    .modalBody h3{margin:12px 0 6px; font-size:14px;}
    .modalBody p, .modalBody li{color:var(--muted); line-height:1.5; font-size:13px;}
    .modalFooter{
      display:flex; justify-content:flex-end; gap:10px; padding:12px 14px;
      border-top:1px solid var(--line);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="t">Radar Trino ‚Äî Gobierno Interior</h1>
      <p class="sub" id="d"></p>
      <div style="margin-top:10px">
        <span class="pill" id="pMax"></span>
        <span class="pill" id="pHow">Niveles: 0‚Äì3 (Alineado ‚Üí Cr√≠tico)</span>
      </div>
      <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
    </div>

    <div class="grid">
      <!-- IZQ: DIAGRAMA -->
      <div class="card">
        <div class="row">
          <div>
            <b>Diagrama del gobierno interior</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">
              Esp√≠ritu (trono) ‚Üí Alma (int√©rprete) ‚Üí Cuerpo (expresi√≥n). El orden produce reposo.
            </div>
          </div>
          <span class="pill" id="liveGlobal">Global: ‚Äî</span>
        </div>

        <div class="svgBox" style="margin-top:10px;">
          <!-- Trino SVG -->
          <svg id="trino" viewBox="0 0 520 360" width="100%" height="auto" aria-label="Gobierno interior trino">
            <!-- fondo suave -->
            <rect x="0" y="0" width="520" height="360" rx="18" fill="rgba(255,255,255,.02)"></rect>

            <!-- flechas (orden) -->
            <g id="flows" opacity="0.9">
              <line id="flowSA" x1="260" y1="100" x2="260" y2="160" stroke="rgba(255,255,255,.25)" stroke-width="6" stroke-linecap="round"/>
              <polygon points="260,168 248,152 272,152" fill="rgba(255,255,255,.25)"/>

              <line id="flowAC" x1="260" y1="210" x2="260" y2="270" stroke="rgba(255,255,255,.25)" stroke-width="6" stroke-linecap="round"/>
              <polygon points="260,278 248,262 272,262" fill="rgba(255,255,255,.25)"/>
            </g>

            <!-- NODOS PRINCIPALES -->
            <circle id="SPIRIT" cx="260" cy="75" r="58" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)" stroke-width="2"/>
            <text x="260" y="68" text-anchor="middle" font-size="14" fill="rgba(255,255,255,.88)" style="font-weight:900">ESP√çRITU</text>
            <text x="260" y="88" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Trono / Voz / Direcci√≥n</text>

            <circle id="SOUL" cx="260" cy="185" r="58" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)" stroke-width="2"/>
            <text x="260" y="178" text-anchor="middle" font-size="14" fill="rgba(255,255,255,.88)" style="font-weight:900">ALMA</text>
            <text x="260" y="198" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Interpretaci√≥n / Convicci√≥n</text>

            <circle id="BODY" cx="260" cy="295" r="58" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)" stroke-width="2"/>
            <text x="260" y="288" text-anchor="middle" font-size="14" fill="rgba(255,255,255,.88)" style="font-weight:900">CUERPO</text>
            <text x="260" y="308" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Acci√≥n / H√°bitos / Ritmo</text>

            <!-- indicadores laterales -->
            <rect id="ALTAR" x="38" y="36" width="160" height="52" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
            <text x="118" y="58" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.85)" style="font-weight:900">ALTAR / COMUNI√ìN</text>
            <text x="118" y="76" text-anchor="middle" font-size="10" fill="rgba(255,255,255,.65)">Habitar, no visitar</text>

            <rect id="OBEDIENCE" x="322" y="36" width="160" height="52" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
            <text x="402" y="58" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.85)" style="font-weight:900">OBEDIENCIA</text>
            <text x="402" y="76" text-anchor="middle" font-size="10" fill="rgba(255,255,255,.65)">Revelada, no impuesta</text>

            <rect id="GRACE" x="38" y="272" width="160" height="52" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
            <text x="118" y="294" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.85)" style="font-weight:900">GRACIA / HERENCIA</text>
            <text x="118" y="312" text-anchor="middle" font-size="10" fill="rgba(255,255,255,.65)">Hijo, no empleado</text>

            <rect id="REST" x="322" y="272" width="160" height="52" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)"/>
            <text x="402" y="294" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.85)" style="font-weight:900">REPOSO</text>
            <text x="402" y="312" text-anchor="middle" font-size="10" fill="rgba(255,255,255,.65)">Obra terminada</text>

            <!-- pie -->
            <text x="260" y="346" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.65)">
              Si el orden se invierte, el cuerpo paga lo que el alma calla.
            </text>
          </svg>

          <div class="legend">
            <div class="k"><span class="dot" style="background:var(--g)"></span>Alineado</div>
            <div class="k"><span class="dot" style="background:var(--y)"></span>En ajuste</div>
            <div class="k"><span class="dot" style="background:var(--o)"></span>En riesgo</div>
            <div class="k"><span class="dot" style="background:var(--r)"></span>Cr√≠tico</div>
          </div>
        </div>

        <div class="result" id="resBox"></div>
      </div>

      <!-- DER: FORMULARIO -->
      <div class="card">
        <div class="row">
          <div>
            <b>Datos de sesi√≥n</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">Se incluyen en el informe. No se env√≠a a servidor.</div>
          </div>
          <span class="pill">Cabecera</span>
        </div>

        <div class="fieldgrid" style="margin-top:10px;">
          <div>
            <label>Nombre del participante</label>
            <input id="patient" placeholder="Ej: Juan P√©rez">
          </div>
          <div>
            <label>Mentor / Facilitador</label>
            <input id="auditor" placeholder="Ej: Mentor / Pastor">
          </div>
          <div>
            <label>Fecha (editable)</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones libres</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
          </div>
        </div>

        <div class="toggleRow">
          <input id="details" type="checkbox" checked>
          <div class="muted" style="font-size:13px;">Incluir detalle por secci√≥n en el PDF</div>
        </div>

        <div class="sec" id="secForm"></div>

        <div class="btns">
          <button class="primary" id="btnResult">Ver resultado</button>
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
          <button class="ghost" id="btnHelp">Ayuda / Manual</button>
          <button class="ghost" id="btnReset">Reiniciar</button>
          <span class="muted" id="live">Puntaje: 0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL MANUAL -->
  <div id="helpModal" class="modal" aria-hidden="true" role="dialog" aria-label="Manual de uso">
    <div class="modalCard">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="manualTitle">Manual de uso ‚Äî Radar Trino</div>
          <div class="modalSub">Gu√≠a para talleres, mentor√≠as y acompa√±amiento (sin env√≠o a servidor).</div>
        </div>
        <button class="modalClose" id="btnHelpClose" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody" id="manualContent"></div>

      <div class="modalFooter">
        <button class="ghost" id="btnHelpCopy">Copiar manual</button>
        <button class="primary" id="btnHelpOk">Entendido</button>
      </div>
    </div>
  </div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "radar-trino.json";
  const LOGO_PATH = "logo.png";

  let DATA=null;
  let logoDataUrl=null;
  const scores = {}; // sectionId -> levelValue(0..3)
  let last=null;

  const secForm = document.getElementById("secForm");
  const resBox = document.getElementById("resBox");
  const pdfWarn = document.getElementById("pdfWarn");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");
  const detailsEl = document.getElementById("details");

  const liveEl = document.getElementById("live");
  const liveGlobal = document.getElementById("liveGlobal");
  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");

  // ===== MANUAL (fuente √∫nica: modal + PDF + TXT) =====
  const MANUAL = {
    title: "Manual de uso ‚Äî Radar Trino (Gobierno Interior)",
    sections: [
      {
        h: "Prop√≥sito",
        p: [
          "Diagnosticar el orden interno esp√≠ritu‚Äìalma‚Äìcuerpo para acompa√±ar procesos de gobierno interior.",
          "La herramienta revela tensiones: d√≥nde el alma est√° decidiendo sola, d√≥nde el cuerpo est√° pagando y d√≥nde el esp√≠ritu perdi√≥ el trono."
        ]
      },
      {
        h: "C√≥mo usar (paso a paso)",
        li: [
          "Completa la cabecera: participante, mentor y fecha. (Opcional: observaciones).",
          "Selecciona el nivel (0‚Äì3) en cada secci√≥n.",
          "Haz clic en ‚ÄúVer resultado‚Äù para ver diagn√≥stico global.",
          "Descarga TXT (registro r√°pido) o PDF (informe formal).",
          "Aplica el plan de 7 d√≠as y repite el Radar para medir progreso."
        ]
      },
      {
        h: "Interpretaci√≥n de niveles",
        li: [
          "0 Alineado: el Esp√≠ritu gobierna, el alma descansa, el cuerpo responde.",
          "1 En ajuste: hay desalineaci√≥n leve; se corrige con pr√°cticas simples.",
          "2 En riesgo: hay sobrecarga emocional/mental; requiere orden y ritmo.",
          "3 Cr√≠tico: no m√°s presi√≥n: reposo, gracia y acompa√±amiento cercano."
        ]
      },
      {
        h: "Sugerencia para taller/mentor√≠a",
        li: [
          "No uses el Radar para culpar: √∫salo para ordenar.",
          "Trabaja primero el ‚Äòtrono‚Äô (escucha/presencia) antes de exigir conductas.",
          "Cierra con 1‚Äì3 acciones medibles y una oraci√≥n breve."
        ]
      },
      {
        h: "Soluci√≥n r√°pida",
        li: [
          "Si no carga el formulario: confirma que radar-trino.json est√© en la misma carpeta.",
          "Si el PDF est√° deshabilitado: revisa internet (CDN). TXT seguir√° funcionando.",
          "Si el logo no aparece en PDF: confirma logo.png en la carpeta."
        ]
      }
    ]
  };

  function manualToHTML(m){
    const parts = [];
    parts.push(`<h3>${m.title}</h3>`);
    m.sections.forEach(s=>{
      parts.push(`<h3>${s.h}</h3>`);
      if(s.p){ s.p.forEach(x=> parts.push(`<p>${x}</p>`)); }
      if(s.li){
        parts.push("<ul>");
        s.li.forEach(x=> parts.push(`<li>${x}</li>`));
        parts.push("</ul>");
      }
    });
    return parts.join("");
  }

  function manualToPlainText(m){
    const L = [];
    L.push(m.title);
    L.push("");
    m.sections.forEach(s=>{
      L.push(s.h.toUpperCase());
      if(s.p){ s.p.forEach(x=> L.push(x)); }
      if(s.li){ s.li.forEach(x=> L.push("‚Ä¢ "+x)); }
      L.push("");
    });
    return L.join("\n").trim();
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) &&
      !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function levelByValue(v){
    return DATA.levels.find(x=>Number(x.value)===Number(v)) || DATA.levels[0];
  }

  function totalScore(){
    return DATA.sections.reduce((acc,s)=> acc + (scores[s.id] ?? 0), 0);
  }

  function globalBand(sum){
    const b = DATA.globalBands.find(x => sum>=x.min && sum<=x.max);
    return b || DATA.globalBands[0];
  }

  function updateSVG(){
    // si varias secciones apuntan al mismo elemento, gana el peor (max)
    const elementWorst = {};

    DATA.sections.forEach(sec=>{
      const v = scores[sec.id] ?? 0;

      if(sec.element){
        elementWorst[sec.element] = Math.max(elementWorst[sec.element] ?? 0, v);
      }
    });

    const paint = (id, v)=>{
      const el = document.getElementById(id);
      if(!el) return;
      const col = levelByValue(v).color;
      el.setAttribute("fill", col);
      el.setAttribute("stroke", "rgba(255,255,255,.20)");
    };

    // principales
    if(elementWorst.spirit!=null) paint("SPIRIT", elementWorst.spirit);
    if(elementWorst.soul!=null) paint("SOUL", elementWorst.soul);
    if(elementWorst.body!=null) paint("BODY", elementWorst.body);

    // laterales
    if(elementWorst.altar!=null) paint("ALTAR", elementWorst.altar);
    if(elementWorst.obedience!=null) paint("OBEDIENCE", elementWorst.obedience);
    if(elementWorst.grace!=null) paint("GRACE", elementWorst.grace);
    if(elementWorst.rest!=null) paint("REST", elementWorst.rest);

    // flujos (opacidad seg√∫n tensi√≥n: peor => m√°s opaco, como ‚Äúfricci√≥n‚Äù)
    const flowSA = document.getElementById("flowSA");
    const flowAC = document.getElementById("flowAC");
    const a = Math.max(elementWorst.spirit ?? 0, elementWorst.soul ?? 0);
    const b = Math.max(elementWorst.soul ?? 0, elementWorst.body ?? 0);
    if(flowSA) flowSA.setAttribute("stroke", `rgba(255,255,255,${0.18 + (a/3)*0.38})`);
    if(flowAC) flowAC.setAttribute("stroke", `rgba(255,255,255,${0.18 + (b/3)*0.38})`);
  }

  function updateLive(){
    const sum = totalScore();
    liveEl.textContent = `Puntaje: ${sum}`;
    const g = globalBand(sum);
    liveGlobal.textContent = `Global: ${g.label}`;
    updateSVG();
  }

  function renderForm(){
    secForm.innerHTML = `<div class="muted" style="font-size:13px;margin-bottom:10px;">
      Selecciona el nivel por secci√≥n. 0=Alineado, 1=Ajuste, 2=Riesgo, 3=Cr√≠tico.
    </div>`;

    DATA.sections.forEach(sec=>{
      scores[sec.id] = 0;

      const div = document.createElement("div");
      div.className = "sec";
      div.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900">${sec.title}</div>
            <div class="muted" style="font-size:13px;margin-top:4px">${sec.diagnosticFocus || ""}</div>
          </div>
          <span class="pill" id="pill_${sec.id}">Alineado</span>
        </div>
        <div class="opts" role="radiogroup" aria-label="${sec.title}">
          ${DATA.levels.map(l=>`
            <label class="opt">
              <input type="radio" name="${sec.id}" value="${l.value}" ${l.value===0?"checked":""}>
              <span>${l.label} (${l.value})</span>
            </label>
          `).join("")}
        </div>
        <div class="muted" style="font-size:13px;margin-top:10px;">
          <b>üìñ</b> ${sec.verse.quote} <span class="muted">(${sec.verse.reference})</span>
        </div>
      `;

      div.querySelectorAll(`input[name="${sec.id}"]`).forEach(inp=>{
        inp.addEventListener("change", (e)=>{
          const v = Number(e.target.value);
          scores[sec.id] = v;
          const lev = levelByValue(v);
          const pill = document.getElementById(`pill_${sec.id}`);
          if(pill) pill.textContent = lev.label;
          updateLive();
        });
      });

      secForm.appendChild(div);
    });

    updateLive();
  }

  function buildPayload(){
    const header = {
      patient: patientEl.value.trim() || "(no especificado)",
      auditor: auditorEl.value.trim() || "(no especificado)",
      date: dateEl.value || "(no especificada)",
      notes: notesEl.value.trim() || ""
    };

    const sum = totalScore();
    const g = globalBand(sum);

    const sections = DATA.sections.map(sec=>{
      const v = scores[sec.id] ?? 0;
      const level = levelByValue(v);
      return {
        id: sec.id,
        title: sec.title,
        levelValue: v,
        levelKey: level.key,
        levelLabel: level.label,
        color: level.color,
        verse: sec.verse,
        focus: sec.diagnosticFocus || "",
        miniTeaching: sec.miniTeaching || [],
        actions: sec.actions || []
      };
    });

    sections.sort((a,b)=> b.levelValue - a.levelValue);

    const top = sections.slice(0,3);
    const plan7 = [
      { day:1, title:`Restaurar el trono (Esp√≠ritu primero)`, items:[
        `Leer y orar: ${top[0]?.verse?.quote || ""} (${top[0]?.verse?.reference || ""})`,
        "Silencio 5‚Äì10 min: o√≠r antes de actuar.",
        "Escribir 1 instrucci√≥n sencilla que el Esp√≠ritu est√© se√±alando."
      ].filter(Boolean)},
      { day:2, title:`Ajuste dirigido: ${top[0]?.title || "Secci√≥n"}`, items:[
        ...(top[0]?.actions?.slice(0,2) || []),
        "Cierre: oraci√≥n corta de alineaci√≥n (sin promesas grandes)."
      ]},
      { day:3, title:`Ajuste dirigido: ${top[1]?.title || top[0]?.title || "Secci√≥n"}`, items:[
        ...(top[1]?.actions?.slice(0,2) || []),
        "Pr√°ctica: pausa antes de reaccionar (2 veces hoy)."
      ]},
      { day:4, title:`Ajuste dirigido: ${top[2]?.title || top[0]?.title || "Secci√≥n"}`, items:[
        ...(top[2]?.actions?.slice(0,2) || []),
        "Un acuerdo medible: qu√© s√≠ har√© hoy."
      ]},
      { day:5, title:"Gracia y descanso", items:[
        "Detectar 1 esfuerzo por aprobaci√≥n y soltarlo en oraci√≥n.",
        "Hacer una acci√≥n desde identidad (no desde culpa).",
        "Dormir/pausar a tiempo: reposo como obediencia."
      ]},
      { day:6, title:"Cuerpo como altar (ritmo)", items:[
        "Ordenar 1 h√°bito: horarios, alimentaci√≥n, pantalla o movimiento.",
        "Reducir un disparador de ansiedad (noticias/redes/urgencia).",
        "Oraci√≥n breve al iniciar y al cerrar el d√≠a."
      ]},
      { day:7, title:"Revisi√≥n y continuidad", items:[
        "¬øQu√© cambi√≥ esta semana? ¬øQu√© se sostuvo?",
        "Elegir 1 pr√°ctica para 4 semanas.",
        "Repetir el Radar para comparar."
      ]}
    ];

    return {
      meta: DATA.meta,
      header,
      global: { sum, band: g },
      sections,
      includeDetails: detailsEl.checked,
      plan7
    };
  }

  function showResult(){
    last = buildPayload();
    const b = last.global.band;

    const badge =
      b.key==="g_alineado" ? "bG" :
      b.key==="g_ajuste" ? "bY" :
      b.key==="g_riesgo" ? "bO" : "bR";

    resBox.style.display = "block";
    resBox.innerHTML = `
      <div class="row">
        <div>
          <span class="badge ${badge}">${b.label}</span>
          <div class="muted" style="margin-top:6px;font-size:13px;">Puntaje global: <b>${last.global.sum}</b> / ${DATA.sections.length * 3}</div>
          <div class="muted" style="margin-top:4px;font-size:13px;">${b.summary}</div>
        </div>
      </div>
      <div style="margin-top:10px;border-left:3px solid rgba(94,234,212,.45);background:rgba(94,234,212,.06);padding:10px 12px;border-radius:12px;">
        <div style="font-style:italic;">${b.verse.quote}</div>
        <div class="muted" style="margin-top:6px;">(${b.verse.reference})</div>
      </div>
    `;

    btnTxt.disabled = false;

    const ok = okPdfLib();
    btnPdf.disabled = !ok;
    pdfWarn.style.display = ok ? "none" : "block";
  }

  function downloadTXT(){
    if(!last) return;
    const L = [];
    L.push(last.meta.title.toUpperCase());
    L.push("");
    L.push("DATOS");
    L.push(`Participante: ${last.header.patient}`);
    L.push(`Mentor: ${last.header.auditor}`);
    L.push(`Fecha: ${last.header.date}`);
    L.push("Observaciones:");
    L.push(last.header.notes || "(sin observaciones)");
    L.push("");
    L.push("RESULTADO GLOBAL");
    L.push(`Puntaje: ${last.global.sum}/${DATA.sections.length * 3}`);
    L.push(`Diagn√≥stico: ${last.global.band.label}`);
    L.push(last.global.band.summary);
    L.push(`${last.global.band.verse.quote} (${last.global.band.verse.reference})`);
    L.push("");
    L.push("ENFOQUE POR SECCIONES");
    L.push("--------------------------------------------------");
    last.sections.slice().reverse().forEach(s=>{
      L.push(`${s.title} ‚Äî ${s.levelLabel} (${s.levelValue})`);
      L.push(`Enfoque: ${s.focus}`);
      L.push(`Biblia: ${s.verse.quote} (${s.verse.reference})`);
      if(last.includeDetails){
        if(s.miniTeaching?.length){
          L.push("Mini-ense√±anza:");
          s.miniTeaching.forEach(x=> L.push("‚Ä¢ "+x));
        }
        if(s.actions?.length){
          L.push("Acciones sugeridas:");
          s.actions.forEach(x=> L.push("‚Ä¢ "+x));
        }
      }
      L.push("");
    });

    L.push("PLAN SEMANAL 7 D√çAS");
    L.push("--------------------------------------------------");
    last.plan7.forEach(d=>{
      L.push(`D√≠a ${d.day}: ${d.title}`);
      d.items.forEach(i=> L.push("‚Ä¢ "+i));
      L.push("");
    });

    L.push("MANUAL (RESUMEN)");
    L.push("--------------------------------------------------");
    L.push(manualToPlainText(MANUAL));
    L.push("");

    const blob = new Blob([L.join("\n")], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "radar_trino.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise((resolve)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){
      return null;
    }
  }

  function levelColor(label){
    const s = (label||"").toLowerCase();
    if(s.includes("aline")) return [16,185,129];
    if(s.includes("ajus")) return [245,158,11];
    if(s.includes("ries")) return [249,115,22];
    return [244,63,94];
  }

  function safeName(name){
    return (name||"radar_trino")
      .toLowerCase()
      .replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  async function downloadPDF(){
    if(!last) return;
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }

    if(logoDataUrl===null){
      logoDataUrl = await loadLogo();
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"letter" });
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const COLORS = { ink:[22,33,58], muted:[90,102,130], white:[255,255,255] };

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function header(){
      addLogo(M, 16, 34, 34);
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(...COLORS.ink);
      doc.text("Radar Trino ‚Äî Gobierno Interior", W/2, 36, {align:"center"});
      doc.setDrawColor(230);
      doc.line(M, 52, W-M, 52);
      return 74;
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...COLORS.muted);
        doc.text("Gobierno Interior ‚Äî Diagn√≥stico Trino", M, H-18);
        doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // ===== PORTADA =====
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W - M - 56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(22);
    doc.setTextColor(255,255,255);
    doc.text("RADAR TRINO", M, 50);

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Gobierno interior: Esp√≠ritu ‚Üí Alma ‚Üí Cuerpo", M, 72);

    // datos
    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 120, 12, 12, "F");
    doc.setTextColor(...COLORS.ink);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos de sesi√≥n", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Participante: ${last.header.patient}`, M+14, 172);
    doc.text(`Mentor: ${last.header.auditor}`, M+14, 192);
    doc.text(`Fecha: ${last.header.date}`, M+14, 212);

    // tarjeta global
    const band = last.global.band;
    const c = levelColor(band.label);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 260, W-M*2, 185, 12, 12, "F");

    const badgeText = (band.label||"").toUpperCase();
    doc.setFont("helvetica","bold");
    let fs = 10;
    doc.setFontSize(fs);
    const maxW = 260;
    while(doc.getTextWidth(badgeText) > maxW && fs > 8){
      fs -= 1; doc.setFontSize(fs);
    }
    const pad = 18;
    const bw = Math.min(maxW, doc.getTextWidth(badgeText) + pad*2);
    const bh = 26;

    doc.setFillColor(...c);
    doc.roundedRect(M+14, 282, bw, bh, 12, 12, "F");
    doc.setTextColor(255,255,255);
    doc.text(badgeText, M+14 + bw/2, 300, {align:"center"});

    doc.setTextColor(...COLORS.ink);
    doc.setFontSize(12);
    doc.text(`Puntaje global: ${last.global.sum}/${DATA.sections.length * 3}`, M+14, 332);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(doc.splitTextToSize(band.summary, W-M*2-28), M+14, 354);

    // verso global
    doc.setFillColor(240,253,250);
    doc.roundedRect(M, 392, W-M*2, 58, 10, 10, "F");
    doc.setFont("times","italic");
    doc.setFontSize(11);
    doc.setTextColor(20,60,70);
    doc.text(doc.splitTextToSize(band.verse.quote, W-M*2-20), M+10, 412);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(70,90,110);
    doc.text(`(${band.verse.reference})`, M+10, 438);

    // ===== Tabla secciones =====
    doc.addPage();
    let y = header();

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Diagn√≥stico por secciones", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 12;

    const rows = last.sections.slice().reverse().map(s=>[
      s.title,
      s.levelLabel,
      String(s.levelValue),
      `${s.verse.quote} (${s.verse.reference})`
    ]);

    doc.autoTable({
      startY: y,
      head: [["Secci√≥n", "Diagn√≥stico", "Nivel", "Porci√≥n b√≠blica"]],
      body: rows,
      theme: "grid",
      styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      didParseCell: function(data){
        if(data.section==="body" && data.column.index===1){
          const v = data.cell.raw || "";
          const cc = levelColor(v);
          data.cell.styles.fillColor = cc;
          data.cell.styles.textColor = [255,255,255];
          data.cell.styles.fontStyle = "bold";
        }
      },
      margin: {left:M, right:M}
    });

    // ===== Enfoque pastoral =====
    doc.addPage();
    y = header();

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Enfoque por secciones", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 12;

    const pRows = last.sections.slice().reverse().map(s=>[
      s.title,
      s.levelLabel,
      (s.miniTeaching && s.miniTeaching.length) ? ("‚Ä¢ " + s.miniTeaching.join(" ‚Ä¢ ")) : "(sin gu√≠a)",
      (s.actions && s.actions.length) ? ("‚Ä¢ " + s.actions.join(" ‚Ä¢ ")) : "(sin acciones)"
    ]);

    doc.autoTable({
      startY: y,
      head: [["Secci√≥n", "Diagn√≥stico", "Gu√≠a (mini-ense√±anza)", "Acciones sugeridas"]],
      body: pRows,
      theme: "grid",
      styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      didParseCell: function(data){
        if(data.section==="body" && data.column.index===1){
          const v = data.cell.raw || "";
          const cc = levelColor(v);
          data.cell.styles.fillColor = cc;
          data.cell.styles.textColor = [255,255,255];
          data.cell.styles.fontStyle = "bold";
        }
      },
      columnStyles: {
        0:{cellWidth:150},
        1:{cellWidth:90},
        2:{cellWidth: (W - M*2 - 150 - 90)/2},
        3:{cellWidth: (W - M*2 - 150 - 90)/2}
      },
      margin: {left:M, right:M}
    });

    // ===== Plan 7 d√≠as =====
    doc.addPage();
    y = header();

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Plan semanal autom√°tico (7 d√≠as)", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 12;

    const planRows = last.plan7.map(d=>[
      `D√≠a ${d.day}`,
      d.title,
      d.items.join(" ‚Ä¢ ")
    ]);

    doc.autoTable({
      startY: y,
      head: [["D√≠a", "Enfoque", "Acciones"]],
      body: planRows,
      theme: "grid",
      styles: {font:"helvetica",fontSize:9.5,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      columnStyles: { 0:{cellWidth:70}, 1:{cellWidth:190}, 2:{cellWidth: (W - M*2 - 70 - 190)} },
      margin: {left:M, right:M}
    });

    // ===== Observaciones =====
    doc.addPage();
    y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Observaciones del mentor", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 14;

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, y, W-M*2, 420, 12, 12, "F");
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...COLORS.ink);
    const notes = last.header.notes || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, y+26);

    // ===== Manual =====
    doc.addPage();
    y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Manual de uso (resumen)", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 16;

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...COLORS.ink);
    doc.text(doc.splitTextToSize(manualToPlainText(MANUAL), W - M*2), M, y);

    footer();

    const name = safeName(last.header.patient || "radar_trino");
    doc.save(`${name}_radar_trino.pdf`);
  }

  function resetAll(){
    DATA.sections.forEach(s=> scores[s.id]=0);
    document.querySelectorAll('input[type="radio"]').forEach(i=>{
      if(i.value==="0") i.checked=true;
      else i.checked=false;
    });
    document.querySelectorAll('[id^="pill_"]').forEach(p=> p.textContent="Alineado");
    updateLive();
    resBox.style.display="none";
    resBox.innerHTML="";
    btnTxt.disabled=true;
    btnPdf.disabled=true;
    last=null;
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // ===== MODAL =====
  const helpModal = document.getElementById("helpModal");
  const btnHelp = document.getElementById("btnHelp");
  const btnHelpOk = document.getElementById("btnHelpOk");
  const btnHelpClose = document.getElementById("btnHelpClose");
  const btnHelpCopy = document.getElementById("btnHelpCopy");
  const manualContent = document.getElementById("manualContent");

  function openHelp(){
    manualContent.innerHTML = manualToHTML(MANUAL);
    helpModal.style.display = "flex";
    helpModal.setAttribute("aria-hidden","false");
  }
  function closeHelp(){
    helpModal.style.display = "none";
    helpModal.setAttribute("aria-hidden","true");
  }

  btnHelp.addEventListener("click", openHelp);
  btnHelpOk.addEventListener("click", closeHelp);
  btnHelpClose.addEventListener("click", closeHelp);

  helpModal.addEventListener("click", (e)=>{
    if(e.target === helpModal) closeHelp();
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && helpModal.style.display === "flex") closeHelp();
  });

  btnHelpCopy.addEventListener("click", async ()=>{
    try{
      const text = manualToPlainText(MANUAL);
      await navigator.clipboard.writeText(text);
      btnHelpCopy.textContent = "Copiado ‚úì";
      setTimeout(()=> btnHelpCopy.textContent = "Copiar manual", 1200);
    }catch(err){
      alert("No se pudo copiar. Selecciona el texto manualmente.");
    }
  });

  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();
      document.getElementById("t").textContent = DATA.meta.title || "Radar Trino";
      document.getElementById("d").textContent = DATA.meta.description || "";
      document.getElementById("pMax").textContent = `Total m√°x: ${DATA.sections.length * 3}`;

      setDefaultDateIfEmpty();
      renderForm();
      pdfWarn.style.display = okPdfLib() ? "none" : "block";
    }catch(e){
      secForm.innerHTML = `<div style="color:#fda4af"><b>Error:</b> ${e.message}</div>
      <div class="muted" style="margin-top:6px">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta.</div>`;
    }
  }

  document.getElementById("btnResult").addEventListener("click", showResult);
  document.getElementById("btnTxt").addEventListener("click", downloadTXT);
  document.getElementById("btnPdf").addEventListener("click", downloadPDF);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  init();
</script>
</body>
</html>