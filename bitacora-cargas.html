<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bit√°cora de Cargas ‚Äî Hogar</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --good:#10b981; --warn:#f59e0b; --risk:#f97316; --crit:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;margin-right:8px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    label{font-weight:850;font-size:13px;}
    input, select, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:950;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .table{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .score{font-weight:950}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}
    .danger{color:#fda4af;}
    .small{font-size:13px;color:var(--muted);line-height:1.45;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Bit√°cora de Cargas</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill">Registro local (sin servidor)</span>
      <span class="pill" id="pCount">Cargas: 0</span>
      <span class="pill" id="pWeek">Semana: ‚Äî</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- Panel izquierdo -->
    <div class="card">
      <div class="row">
        <b>Registrar carga</b>
        <span class="pill" id="totalLoad">Peso total semana: 0</span>
      </div>

      <div class="fieldgrid">
        <div>
          <label>Paciente / hogar</label>
          <input id="patient" placeholder="Ej: Hogar Abraham y Sara">
        </div>
        <div>
          <label>Auditor</label>
          <input id="auditor" placeholder="Ej: Consejero / Pastor">
        </div>
        <div>
          <label>Fecha (editable)</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Observaciones generales</label>
          <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
        </div>
      </div>

      <div class="mini">
        <h3>Nueva carga</h3>
        <div class="fieldgrid">
          <div style="grid-column:1/-1">
            <label>Nombre corto de la carga</label>
            <input id="loadName" placeholder="Ej: Presi√≥n financiera / Discusi√≥n constante / Falta de altar">
          </div>

          <div>
            <label>Tipo</label>
            <select id="loadType"></select>
          </div>

          <div>
            <label>Direcci√≥n</label>
            <select id="direction"></select>
          </div>

          <div>
            <label>Elemento afectado</label>
            <select id="element"></select>
          </div>

          <div>
            <label>Estado de transferencia</label>
            <select id="transfer"></select>
          </div>

          <div>
            <label>Severidad (1‚Äì5)</label>
            <select id="severity"></select>
          </div>

          <div>
            <label>Frecuencia (1‚Äì5)</label>
            <select id="frequency"></select>
          </div>

          <div style="grid-column:1/-1">
            <label>Detalle / comentario</label>
            <textarea id="detail" placeholder="¬øQu√© lo detona? ¬øQu√© se siente? ¬øQu√© se repite?"></textarea>
          </div>

          <div style="grid-column:1/-1">
            <label>Acci√≥n de transferencia (paso pr√°ctico)</label>
            <input id="action" placeholder="Ej: 15 min de altar juntos / acuerdo de gastos / pedir ayuda">
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnAdd">Agregar carga</button>
          <button class="ghost" id="btnClearForm">Limpiar formulario</button>
        </div>

        <div class="small" style="margin-top:10px">
          ‚úÖ Recomendaci√≥n: registra 3‚Äì7 cargas por semana. No m√°s. Lo dem√°s se vuelve ruido.
        </div>
      </div>

      <div class="btns">
        <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
        <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
        <button class="ghost" id="btnReset">Borrar todo</button>
      </div>
    </div>

    <!-- Panel derecho -->
    <div class="card">
      <div class="row">
        <b>Resumen semanal</b>
        <span class="pill" id="doneHint">Auto-plan 7 d√≠as</span>
      </div>

      <div class="mini" id="summaryBox"></div>

      <div class="mini">
        <h3>Plan semanal autom√°tico (7 d√≠as)</h3>
        <div class="small" id="planHint">Se genera basado en las 2 cargas m√°s pesadas.</div>
        <div id="plan"></div>
      </div>

      <div class="mini">
        <h3>Listado de cargas (semana actual)</h3>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>Carga</th>
                <th>Tipo / Direcci√≥n</th>
                <th>Elemento</th>
                <th>Transferencia</th>
                <th>Peso</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px">Peso = Severidad √ó Frecuencia (m√°x 25).</div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "bitacora-cargas.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "bitacora_cargas_v1";

  let DATA=null;
  let logoDataUrl=null;

  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    loads: [] // {id, weekKey, name, type, direction, element, transfer, severity, frequency, detail, action, createdAt}
  };

  // Elements
  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const pCount = document.getElementById("pCount");
  const pWeek = document.getElementById("pWeek");
  const totalLoadEl = document.getElementById("totalLoad");
  const pdfWarn = document.getElementById("pdfWarn");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");

  const loadNameEl = document.getElementById("loadName");
  const loadTypeEl = document.getElementById("loadType");
  const directionEl = document.getElementById("direction");
  const elementEl = document.getElementById("element");
  const transferEl = document.getElementById("transfer");
  const severityEl = document.getElementById("severity");
  const frequencyEl = document.getElementById("frequency");
  const detailEl = document.getElementById("detail");
  const actionEl = document.getElementById("action");

  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");
  const rowsEl = document.getElementById("rows");
  const summaryBox = document.getElementById("summaryBox");
  const planEl = document.getElementById("plan");

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) && !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function getWeekKey(dateStr){
    // ISO week approximation (suficiente para uso pastoral)
    const d = dateStr ? new Date(dateStr+"T00:00:00") : new Date();
    const day = (d.getDay()+6)%7; // Mon=0
    d.setDate(d.getDate()-day+3);
    const firstThursday = new Date(d.getFullYear(),0,4);
    const diff = d - firstThursday;
    const week = 1 + Math.round(diff / (7*24*3600*1000));
    return `${d.getFullYear()}-W${String(week).padStart(2,"0")}`;
  }

  function nowWeekKey(){
    return getWeekKey(dateEl.value || "");
  }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      state.header = payload.header || state.header;
      state.loads = Array.isArray(payload.loads) ? payload.loads : [];
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  function enumLabel(list, key){
    const item = list.find(x=>x.key===key);
    return item ? item.label : key;
  }

  function setupEnums(){
    // selects
    loadTypeEl.innerHTML = DATA.enums.loadType.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
    directionEl.innerHTML = DATA.enums.direction.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
    elementEl.innerHTML = DATA.enums.element.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
    transferEl.innerHTML = DATA.enums.transferStatus.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");

    const nums = [1,2,3,4,5].map(n=>`<option value="${n}">${n}</option>`).join("");
    severityEl.innerHTML = nums;
    frequencyEl.innerHTML = nums;
  }

  function weight(load){
    return Number(load.severity||1) * Number(load.frequency||1);
  }

  function currentWeekLoads(){
    const wk = nowWeekKey();
    return state.loads.filter(l=> l.weekKey === wk);
  }

  function addLoad(){
    const name = (loadNameEl.value||"").trim();
    if(!name){
      alert("Escribe un nombre corto para la carga.");
      return;
    }
    const wk = nowWeekKey();
    const load = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
      weekKey: wk,
      name,
      type: loadTypeEl.value,
      direction: directionEl.value,
      element: elementEl.value,
      transfer: transferEl.value,
      severity: Number(severityEl.value),
      frequency: Number(frequencyEl.value),
      detail: (detailEl.value||"").trim(),
      action: (actionEl.value||"").trim(),
      createdAt: new Date().toISOString()
    };
    state.loads.unshift(load);
    save();
    clearForm();
    render();
  }

  function clearForm(){
    loadNameEl.value = "";
    detailEl.value = "";
    actionEl.value = "";
    severityEl.value = "3";
    frequencyEl.value = "3";
    loadTypeEl.value = "viva";
    directionEl.value = "vertical";
    elementEl.value = "nudo";
    transferEl.value = "nudo_tenso";
  }

  function deleteLoad(id){
    if(!confirm("¬øEliminar esta carga?")) return;
    state.loads = state.loads.filter(l=> l.id !== id);
    save();
    render();
  }

  function summarize(loads){
    const byType = {};
    const byDir = {};
    const byElem = {};
    let sum = 0;

    loads.forEach(l=>{
      const w = weight(l);
      sum += w;
      byType[l.type] = (byType[l.type]||0) + w;
      byDir[l.direction] = (byDir[l.direction]||0) + w;
      byElem[l.element] = (byElem[l.element]||0) + w;
    });

    const top = [...loads].sort((a,b)=> weight(b)-weight(a)).slice(0,5);

    return { sum, byType, byDir, byElem, top };
  }

  function pickTop2(loads){
    const sorted = [...loads].sort((a,b)=> weight(b)-weight(a));
    return [sorted[0], sorted[1] || sorted[0]].filter(Boolean);
  }

  function buildPlan7(topA, topB){
    const verses = DATA.verses;
    const common = DATA.planTemplates;

    function focusLine(load){
      const w = weight(load);
      return `Enfoque: ${load.name} (Peso ${w}/25) ‚Äî ${enumLabel(DATA.enums.transferStatus, load.transfer)}.`;
    }

    const days = [
      { day:1, title:"Volver al altar (sin culpa)", items:[
        `${verses.transferencia.quote} (${verses.transferencia.reference})`,
        focusLine(topA),
        ...common.altar,
        ...common.transfer
      ]},
      { day:2, title:"Ajuste pr√°ctico (carga #1)", items:[
        focusLine(topA),
        `Paso: ${topA.action || "Definir 1 acci√≥n concreta de transferencia hoy."}`,
        ...common.acuerdo
      ]},
      { day:3, title:"Consolidar transferencia (carga #1)", items:[
        focusLine(topA),
        "Repetir el ajuste del D√≠a 2 (consistencia).",
        "Cerrar el d√≠a con oraci√≥n de entrega al fundamento."
      ]},
      { day:4, title:"Culto del nudo (congregaci√≥n)", items:[
        `${verses.congregacion.quote} (${verses.congregacion.reference})`,
        "15‚Äì25 min: Palabra + oraci√≥n + 1 acuerdo.",
        "Honra mutua: 1 reconocimiento cada uno."
      ]},
      { day:5, title:"Ajuste pr√°ctico (carga #2)", items:[
        focusLine(topB),
        `Paso: ${topB.action || "Definir 1 acci√≥n concreta de transferencia hoy."}`,
        ...common.acuerdo
      ]},
      { day:6, title:"Equilibrio y paz (‚àëFy, ‚àëFx, ‚àëM)", items:[
        `${verses.equilibrio.quote} (${verses.equilibrio.reference})`,
        "Identificar 1 fuerza horizontal y quitar la reacci√≥n impulsiva.",
        "Aplicar pausa + oraci√≥n antes de hablar."
      ]},
      { day:7, title:"Mantenimiento semanal", items:[
        "Revisar: ¬øqu√© baj√≥ tensi√≥n? ¬øqu√© sigue igual?",
        "Elegir 1 h√°bito semanal fijo de mantenimiento.",
        "Registrar 1 nueva carga solo si es necesario (no ruido)."
      ]}
    ];

    return days;
  }

  function renderSummary(loads){
    const s = summarize(loads);
    totalLoadEl.textContent = `Peso total semana: ${s.sum}`;
    pCount.textContent = `Cargas: ${loads.length}`;
    pWeek.textContent = `Semana: ${nowWeekKey()}`;

    function listObj(obj, enumList){
      const entries = Object.entries(obj).sort((a,b)=> b[1]-a[1]);
      if(!entries.length) return "<span class='muted'>(sin datos)</span>";
      return "<ul>" + entries.map(([k,v])=>`<li><span class="tag">${enumLabel(enumList,k)}</span> ‚Äî <b>${v}</b></li>`).join("") + "</ul>";
    }

    summaryBox.innerHTML = `
      <h3>Resumen (por peso)</h3>
      <div class="small">El peso se calcula: <b>Severidad √ó Frecuencia</b> (m√°x 25).</div>
      <div class="fieldgrid" style="margin-top:10px">
        <div class="mini">
          <b>Por tipo</b>
          ${listObj(s.byType, DATA.enums.loadType)}
          <div class="small" style="margin-top:8px">üìñ ${DATA.verses.muerta.quote} (${DATA.verses.muerta.reference})</div>
        </div>
        <div class="mini">
          <b>Por direcci√≥n</b>
          ${listObj(s.byDir, DATA.enums.direction)}
          <div class="small" style="margin-top:8px">üìñ ${DATA.verses.viva.quote} (${DATA.verses.viva.reference})</div>
        </div>
        <div class="mini" style="grid-column:1/-1">
          <b>Por elemento</b>
          ${listObj(s.byElem, DATA.enums.element)}
          <div class="small" style="margin-top:8px">üìñ ${DATA.verses.sismica.quote} (${DATA.verses.sismica.reference})</div>
        </div>
      </div>
      <div class="mini" style="margin-top:10px">
        <b>Top 5 cargas (esta semana)</b>
        ${s.top.length ? ("<ul>" + s.top.map(l=>`<li><b>${l.name}</b> ‚Äî Peso <span class="score">${weight(l)}</span>/25 ¬∑ <span class="tag">${enumLabel(DATA.enums.element,l.element)}</span> ¬∑ <span class="tag">${enumLabel(DATA.enums.transferStatus,l.transfer)}</span></li>`).join("") + "</ul>") : "<div class='muted'>(a√∫n no hay cargas registradas)</div>"}
      </div>
    `;
  }

  function renderRows(loads){
    rowsEl.innerHTML = "";
    loads.sort((a,b)=> weight(b)-weight(a)).forEach(l=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${escapeHtml(l.name)}</b>
          <div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(l.detail||"")}</div>
          <div style="margin-top:6px">
            <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del="${l.id}">Eliminar</button>
          </div>
        </td>
        <td>
          <span class="tag">${escapeHtml(enumLabel(DATA.enums.loadType,l.type))}</span><br>
          <span class="tag" style="margin-top:6px;display:inline-block">${escapeHtml(enumLabel(DATA.enums.direction,l.direction))}</span>
        </td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.element,l.element))}</span></td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.transferStatus,l.transfer))}</span></td>
        <td><span class="score">${weight(l)}</span>/25<br><span class="muted">S:${l.severity} F:${l.frequency}</span></td>
        <td>${escapeHtml(l.action||"‚Äî")}</td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteLoad(btn.getAttribute("data-del")));
    });
  }

  function renderPlan(loads){
    planEl.innerHTML = "";
    if(loads.length < 1){
      planEl.innerHTML = `<div class="muted">Registra al menos 1 carga para generar plan.</div>`;
      return;
    }
    const [a,b] = pickTop2(loads);
    const days = buildPlan7(a,b);

    planEl.innerHTML = days.map(d=>`
      <div class="mini" style="margin-top:10px">
        <b>D√≠a ${d.day}: ${escapeHtml(d.title)}</b>
        <ul>${d.items.map(i=>`<li>${escapeHtml(i)}</li>`).join("")}</ul>
      </div>
    `).join("");
  }

  function render(){
    const loads = currentWeekLoads();
    renderSummary(loads);
    renderRows(loads);
    renderPlan(loads);

    const has = loads.length > 0;
    btnTxt.disabled = !has;
    btnPdf.disabled = !has || !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function buildTxt(){
    const loads = currentWeekLoads().sort((a,b)=> weight(b)-weight(a));
    const s = summarize(loads);
    const [a,b] = pickTop2(loads);
    const plan = loads.length ? buildPlan7(a,b) : [];

    const L=[];
    L.push("BIT√ÅCORA DE CARGAS ‚Äî HOGAR COMO SISTEMA ESTRUCTURAL");
    L.push("");
    L.push(`Paciente: ${patientEl.value || "(no especificado)"}`);
    L.push(`Auditor: ${auditorEl.value || "(no especificado)"}`);
    L.push(`Fecha: ${dateEl.value || "(no especificada)"}`);
    L.push(`Semana: ${nowWeekKey()}`);
    L.push("");
    L.push("Observaciones:");
    L.push(notesEl.value || "(sin observaciones)");
    L.push("");
    L.push(`Peso total semana: ${s.sum}`);
    L.push("");
    L.push("CARGAS (ordenadas por peso)");
    L.push("--------------------------------------------------");
    loads.forEach(l=>{
      L.push(`- ${l.name} ‚Äî Peso ${weight(l)}/25`);
      L.push(`  Tipo: ${enumLabel(DATA.enums.loadType,l.type)} | Direcci√≥n: ${enumLabel(DATA.enums.direction,l.direction)}`);
      L.push(`  Elemento: ${enumLabel(DATA.enums.element,l.element)}`);
      L.push(`  Transferencia: ${enumLabel(DATA.enums.transferStatus,l.transfer)}`);
      if(l.action) L.push(`  Acci√≥n: ${l.action}`);
      if(l.detail) L.push(`  Detalle: ${l.detail}`);
      L.push("");
    });

    L.push("PLAN SEMANAL 7 D√çAS");
    L.push("--------------------------------------------------");
    plan.forEach(d=>{
      L.push(`D√≠a ${d.day}: ${d.title}`);
      d.items.forEach(it=> L.push("‚Ä¢ " + it));
      L.push("");
    });

    return L.join("\n");
  }

  function downloadTxt(){
    const txt = buildTxt();
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bitacora_cargas_semana.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeName(name){
    return (name||"bitacora")
      .toLowerCase().replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  async function downloadPdf(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    const loads = currentWeekLoads().sort((a,b)=> weight(b)-weight(a));
    const s = summarize(loads);
    const [a,b] = pickTop2(loads);
    const plan = loads.length ? buildPlan7(a,b) : [];

    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }
    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Bit√°cora de Cargas ‚Äî Hogar como Sistema Estructural", M, H-18);
        doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // Portada
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(22);
    doc.setTextColor(255,255,255);
    doc.text("BIT√ÅCORA DE CARGAS", M, 52);
    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Muertas ¬∑ Vivas ¬∑ S√≠smicas ‚Äî transferencia y plan semanal", M, 74);

    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 130, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${patientEl.value || "(no especificado)"}`, M+14, 172);
    doc.text(`Auditor: ${auditorEl.value || "(no especificado)"}`, M+14, 192);
    doc.text(`Fecha: ${dateEl.value || "(no especificada)"}`, M+14, 212);
    doc.text(`Semana: ${nowWeekKey()}`, M+14, 232);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 270, W-M*2, 110, 12, 12, "F");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text(`Peso total semana: ${s.sum}`, M+14, 302);
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(...INK);
    doc.text(`Clave: Peso = Severidad √ó Frecuencia (m√°x 25)`, M+14, 324);

    // Tabla cargas
    doc.text("Cargas registradas (semana)", M+14, 410);
    doc.autoTable({
      startY: 420,
      head: [["Carga", "Tipo/Direcci√≥n", "Elemento", "Transferencia", "Peso", "Acci√≥n"]],
      body: loads.map(l=>[
        l.name,
        `${enumLabel(DATA.enums.loadType,l.type)} / ${enumLabel(DATA.enums.direction,l.direction)}`,
        enumLabel(DATA.enums.element,l.element),
        enumLabel(DATA.enums.transferStatus,l.transfer),
        `${weight(l)}/25`,
        l.action || "‚Äî"
      ]),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      margin:{left:M, right:M}
    });

    // Plan semanal
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Plan semanal autom√°tico (7 d√≠as)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.autoTable({
      startY: 90,
      head: [["D√≠a", "Enfoque", "Acciones"]],
      body: plan.map(d=>[
        `D√≠a ${d.day}`,
        d.title,
        d.items.join(" ‚Ä¢ ")
      ]),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.2, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:170},2:{cellWidth:W-M*2-70-170}},
      margin:{left:M, right:M}
    });

    // Observaciones
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Observaciones", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 96, W-M*2, 520, 12, 12, "F");
    doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(...INK);
    const notes = notesEl.value || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, 122);

    footer();

    doc.save(`${safeName(patientEl.value||"hogar")}_bitacora_cargas_${nowWeekKey()}.pdf`);
  }

  function resetAll(){
    if(!confirm("¬øBorrar TODO (bit√°cora completa)?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.header = { patient:"", auditor:"", date:"", notes:"" };
    state.loads = [];
    fillHeaderUI();
    setDefaultDateIfEmpty();
    clearForm();
    save();
    render();
  }

  async function init(){
    const res = await fetch(JSON_PATH, {cache:"no-store"});
    if(!res.ok) throw new Error("No se pudo cargar JSON.");
    DATA = await res.json();

    tEl.textContent = DATA.meta.title;
    dEl.textContent = DATA.meta.description;

    setupEnums();
    setDefaultDateIfEmpty();

    load();
    fillHeaderUI();
    if(!dateEl.value) setDefaultDateIfEmpty();

    clearForm();
    render();

    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  // events
  document.getElementById("btnAdd").addEventListener("click", addLoad);
  document.getElementById("btnClearForm").addEventListener("click", clearForm);
  document.getElementById("btnTxt").addEventListener("click", downloadTxt);
  document.getElementById("btnPdf").addEventListener("click", downloadPdf);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", ()=>{
      save();
      render(); // si cambia fecha -> cambia semana
    });
  });

  init().catch(err=>{
    document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${err.message}<br><span style="color:#a7b4d6">Aseg√∫rate de que ${JSON_PATH} est√© en la misma carpeta.</span></div>`;
  });
</script>
</body>
</html>