<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Deriva ‚Äî Radar del P√≥rtico</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --accent:#5eead4; --line:rgba(255,255,255,.10);
      --danger:#fb7185;
      --g:rgba(16,185,129,.16); --y:rgba(245,158,11,.14);
      --o:rgba(249,115,22,.14); --r:rgba(244,63,94,.14);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;margin-right:8px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:520px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:900;font-size:13px;}
    input, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    .muted{color:var(--muted);}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:950;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(255,255,255,.14);}
    .bG{background:var(--g);color:#6ee7b7;border-color:rgba(16,185,129,.30);}
    .bY{background:var(--y);color:#fcd34d;border-color:rgba(245,158,11,.30);}
    .bO{background:var(--o);color:#fdba74;border-color:rgba(249,115,22,.30);}
    .bR{background:var(--r);color:#fda4af;border-color:rgba(244,63,94,.30);}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    .q{padding:12px 0;border-top:1px solid var(--line);}
    .q:first-of-type{border-top:none;}
    .opts{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;}
    .opt{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);cursor:pointer;user-select:none;}
    .kpi{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;}
    @media(min-width:800px){.kpi{grid-template-columns:1fr 1fr 1fr;}}
    .k{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .k b{font-size:12px;color:var(--muted);}
    .k .v{font-size:20px;font-weight:1000;margin-top:6px;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}
    .resultBox{display:none;}
    canvas{width:100%;height:auto;border-radius:16px;background:rgba(255,255,255,.03);border:1px solid var(--line);}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">‚Äî</h1>
    <p class="sub" id="d">‚Äî</p>
    <div style="margin-top:10px">
      <span class="pill" id="pillMax">‚Äî</span>
      <span class="pill" id="pillBaseVerse">‚Äî</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <b>Datos de auditor√≠a</b>
        <div class="fieldgrid">
          <div>
            <label>Nombre del paciente</label>
            <input id="patient" placeholder="Ej: Juan y Mar√≠a P√©rez">
          </div>
          <div>
            <label>Nombre del auditor</label>
            <input id="auditor" placeholder="Ej: Consejero / Pastor">
          </div>
          <div>
            <label>Fecha (editable)</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones libres</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnCalc">Ver resultado</button>
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
          <b>Radar del P√≥rtico (salud estructural)</b>
          <span class="pill" id="liveScore">‚Äî</span>
        </div>
        <div class="muted" style="margin-top:6px;font-size:13px;">
          Nota: Anclaje/Nudo/Apoyo suben = mejor. Carga/Deriva suben = m√°s tensi√≥n (en radar se invierten para mostrar ‚Äúsalud‚Äù).
        </div>
        <div style="margin-top:10px">
          <canvas id="radar" width="620" height="460"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <b>Simulaci√≥n P‚ÄìŒî (pedag√≥gica)</b>
        <div class="kpi">
          <div class="k"><b>P (carga)</b><div class="v" id="kP">‚Äî</div></div>
          <div class="k"><b>Œî estimada</b><div class="v" id="kD">‚Äî</div></div>
          <div class="k"><b>P_eff</b><div class="v" id="kPe">‚Äî</div></div>
        </div>
        <div class="mini" id="globalBox"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div id="criteriaForm"></div>

      <div class="card resultBox" id="resultsCard" style="margin-top:14px">
        <b>Mini-ense√±anzas por criterio (autom√°tico)</b>
        <div id="teachings"></div>

        <div class="mini" style="margin-top:12px">
          <h3>Plan semanal autom√°tico (7 d√≠as)</h3>
          <div id="plan7"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "simulador-deriva.json";
  const LOGO_PATH = "logo.png";

  let DATA=null;
  let logoDataUrl=null;
  const state = {};
  let last=null; // payload para descargas

  const pdfWarn = document.getElementById("pdfWarn");

  const tEl=document.getElementById("t");
  const dEl=document.getElementById("d");
  const pillMax=document.getElementById("pillMax");
  const pillBaseVerse=document.getElementById("pillBaseVerse");

  const patientEl=document.getElementById("patient");
  const auditorEl=document.getElementById("auditor");
  const dateEl=document.getElementById("date");
  const notesEl=document.getElementById("notes");

  const criteriaForm=document.getElementById("criteriaForm");
  const resultsCard=document.getElementById("resultsCard");
  const teachingsEl=document.getElementById("teachings");
  const plan7El=document.getElementById("plan7");

  const liveScoreEl=document.getElementById("liveScore");

  const kP=document.getElementById("kP");
  const kD=document.getElementById("kD");
  const kPe=document.getElementById("kPe");
  const globalBox=document.getElementById("globalBox");

  const btnTxt=document.getElementById("btnTxt");
  const btnPdf=document.getElementById("btnPdf");

  const radarCanvas=document.getElementById("radar");
  const rctx=radarCanvas.getContext("2d");

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) && !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function clamp(n,min,max){
    n = Number(n);
    if(Number.isNaN(n)) n=min;
    return Math.max(min, Math.min(max, n));
  }

  function safeText(x){ return (x===null || x===undefined) ? "" : String(x); }

  function totalMaxPerCriterion(){ return 5 * 20; } // 5 preguntas x 20
  function findCriterion(id){ return DATA.criteria.find(c=>c.id===id); }

  function criterionScore(c){
    return c.questions.reduce((acc,q)=> acc + (state[q.id] ?? 0), 0);
  }

  function bandForCriterion(c, score){
    // para criterios con 3 bandas (anclaje/nudo/apoyo) y con 4 bandas (carga/deriva)
    const b = c.bands.find(x=> score>=x.min && score<=x.max) || c.bands[c.bands.length-1];
    return b;
  }

  function deltaPctFromDerivaScore(derivaScore){
    return clamp(Math.round(derivaScore * DATA.model.deltaMapFactor), 0, 30);
  }

  function computeK(anclaje, nudo, apoyo){
    const w = DATA.model.kWeights;
    const normA = 1 - (anclaje/100);
    const normN = 1 - (nudo/100);
    const normS = 1 - (apoyo/100);

    let k = DATA.model.kMin + (normA*w.anclaje + normN*w.nudo + normS*w.apoyo) * (DATA.model.kMax - DATA.model.kMin);
    k = clamp(k, DATA.model.kMin, DATA.model.kMax);
    return k;
  }

  function globalBandByAmplificationPct(pct){
    const b = DATA.globalBandsByAmplificationPct.find(x=> pct>=x.minPct && pct<x.maxPct) || DATA.globalBandsByAmplificationPct[DATA.globalBandsByAmplificationPct.length-1];
    return b;
  }

  function badgeClassFromLabel(label){
    const s=(label||"").toLowerCase();
    if(s.includes("estable") || s.includes("aline")) return "badge bG";
    if(s.includes("ajust") || s.includes("normal") || s.includes("moder")) return "badge bY";
    if(s.includes("riesgo") || s.includes("alta") || s.includes("activa")) return "badge bO";
    return "badge bR";
  }

  function renderHeader(){
    tEl.textContent = safeText(DATA.meta.title) || "Simulador de Deriva";
    dEl.textContent = safeText(DATA.meta.description) || "";
    pillMax.textContent = `M√°x por criterio: ${totalMaxPerCriterion()}`;
    const v = DATA.verses.base;
    pillBaseVerse.textContent = `üìñ ${v.quote} (${v.reference})`;
  }

  function renderCriteriaForm(){
    criteriaForm.innerHTML = "";

    DATA.criteria.forEach(c=>{
      const card = document.createElement("div");
      card.className = "card";
      const subtitle = safeText(c.subtitle);
      const focus = safeText(c.diagnosticFocus);

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div>
            <b>${safeText(c.title)}</b>
            ${subtitle ? `<div class="muted" style="margin-top:4px;font-size:13px">${subtitle}</div>` : ""}
            ${focus ? `<div class="muted" style="margin-top:4px;font-size:13px"><b>Enfoque:</b> ${focus}</div>` : ""}
          </div>
          <span class="pill">0‚Äì100</span>
        </div>

        <div class="mini" style="margin-top:10px">
          <div class="muted" style="font-size:13px"><b>Porci√≥n b√≠blica</b></div>
          <div style="margin-top:6px">${safeText(c.sectionVerse.quote)}<br><span class="muted">(${safeText(c.sectionVerse.reference)})</span></div>
        </div>
      `;

      c.questions.forEach((q, idx)=>{
        const qDiv = document.createElement("div");
        qDiv.className = "q";

        const opts = DATA.scale.options.map(opt=>`
          <label class="opt">
            <input type="radio" name="${q.id}" value="${opt.value}">
            <span>${opt.label}</span>
          </label>
        `).join("");

        qDiv.innerHTML = `
          <label>${idx+1}. ${safeText(q.text)}</label>
          <div class="opts" role="radiogroup" aria-label="${safeText(q.text)}">${opts}</div>
        `;

        qDiv.querySelectorAll(`input[name="${q.id}"]`).forEach(inp=>{
          inp.addEventListener("change", (e)=>{
            state[q.id] = Number(e.target.value);
            updateLive();
          });
        });

        card.appendChild(qDiv);
      });

      criteriaForm.appendChild(card);
    });
  }

  function computePayload(){
    const header = {
      patient: patientEl.value.trim() || "(no especificado)",
      auditor: auditorEl.value.trim() || "(no especificado)",
      date: dateEl.value || "(no especificada)",
      notes: notesEl.value.trim() || ""
    };

    // Scores por criterio
    const crit = DATA.criteria.map(c=>{
      const score = criterionScore(c);
      const band = bandForCriterion(c, score);
      return {
        id: c.id,
        title: c.title,
        subtitle: c.subtitle || "",
        focus: c.diagnosticFocus || "",
        score,
        max: totalMaxPerCriterion(),
        band,
        verse: c.sectionVerse,
        mini: band.miniTeaching
      };
    });

    // Deriva/P (para P‚ÄìŒî)
    const P = crit.find(x=>x.id==="carga")?.score ?? 0;
    const derivaScore = crit.find(x=>x.id==="deriva")?.score ?? 0;
    const D = deltaPctFromDerivaScore(derivaScore);

    const A = crit.find(x=>x.id==="anclaje")?.score ?? 0;
    const N = crit.find(x=>x.id==="nudo")?.score ?? 0;
    const S = crit.find(x=>x.id==="apoyo")?.score ?? 0;

    const k = computeK(A,N,S);
    const Peff = P + P*(D/100)*k;
    const ampPct = (P===0) ? 0 : ((Peff - P)/P)*100;

    const gBand = globalBandByAmplificationPct(ampPct);

    // Salud para radar (0‚Äì100 donde m√°s alto = mejor)
    // Anclaje/Nudo/Apoyo: salud = score
    // Carga/Deriva: salud = 100 - score (porque m√°s carga/deriva = m√°s tensi√≥n)
    const health = {
      anclaje: clamp(A,0,100),
      nudo: clamp(N,0,100),
      apoyo: clamp(S,0,100),
      carga: clamp(100 - P, 0, 100),
      deriva: clamp(100 - derivaScore, 0, 100)
    };

    // Ordenar por ‚Äúpeor salud‚Äù (menor health)
    const healthOrder = [
      {id:"anclaje", label:"Anclaje", h:health.anclaje},
      {id:"nudo", label:"Nudo", h:health.nudo},
      {id:"apoyo", label:"Apoyo", h:health.apoyo},
      {id:"carga", label:"Carga", h:health.carga},
      {id:"deriva", label:"Deriva", h:health.deriva}
    ].sort((a,b)=> a.h - b.h);

    const worst1 = healthOrder[0].id;
    const worst2 = healthOrder[1].id;

    const c1 = crit.find(x=>x.id===worst1);
    const c2 = crit.find(x=>x.id===worst2);

    // Plan 7 d√≠as: d√≠as 1‚Äì3 del peor 1, d√≠as 4‚Äì5 del peor 2, d√≠a 6 y 7 del framework
    const plan = [];
    const p1 = (c1?.mini?.oneWeekPlan || []).slice(0,3);
    const p2 = (c2?.mini?.oneWeekPlan || []).slice(0,2);

    plan.push({day:1, title:`Enfoque: ${c1?.title || "Criterio"}`, items:[p1[0] || "Acci√≥n 1"]});
    plan.push({day:2, title:`Enfoque: ${c1?.title || "Criterio"}`, items:[p1[1] || "Acci√≥n 2"]});
    plan.push({day:3, title:`Enfoque: ${c1?.title || "Criterio"}`, items:[p1[2] || "Acci√≥n 3"]});
    plan.push({day:4, title:`Enfoque: ${c2?.title || "Criterio"}`, items:[p2[0] || "Acci√≥n 4"]});
    plan.push({day:5, title:`Enfoque: ${c2?.title || "Criterio"}`, items:[p2[1] || "Acci√≥n 5"]});

    plan.push({day:6, title:DATA.planFramework.day6Title, items:DATA.planFramework.day6Items});
    plan.push({day:7, title:DATA.planFramework.day7Title, items:DATA.planFramework.day7Items});

    return {
      header,
      criteria: crit,
      P, derivaScore, D, A, N, S,
      k, Peff, ampPct,
      globalBand: gBand,
      health,
      worst: { first: worst1, second: worst2 },
      plan7: plan
    };
  }

  function updateLive(){
    const answered = Object.keys(state).length;
    liveScoreEl.textContent = `Respuestas: ${answered} / ${DATA.criteria.length * 5}`;
  }

  function drawRadar(health){
    const W = radarCanvas.width;
    const H = radarCanvas.height;
    rctx.clearRect(0,0,W,H);

    const cx = W*0.50;
    const cy = H*0.54;
    const R = Math.min(W,H) * 0.35;

    const axes = DATA.porticoAxes;
    const n = axes.length;

    // Fondo
    rctx.fillStyle = "rgba(255,255,255,0.02)";
    rctx.fillRect(0,0,W,H);

    // Grid (5 niveles)
    rctx.strokeStyle = "rgba(255,255,255,0.10)";
    rctx.lineWidth = 1;

    for(let lv=1; lv<=5; lv++){
      const rr = R * (lv/5);
      rctx.beginPath();
      for(let i=0;i<n;i++){
        const a = (Math.PI*2)*(i/n) - Math.PI/2;
        const x = cx + rr*Math.cos(a);
        const y = cy + rr*Math.sin(a);
        if(i===0) rctx.moveTo(x,y); else rctx.lineTo(x,y);
      }
      rctx.closePath();
      rctx.stroke();
    }

    // Ejes + labels
    rctx.fillStyle = "rgba(255,255,255,0.85)";
    rctx.font = "14px system-ui, -apple-system, Segoe UI, Arial";
    rctx.textAlign = "center";
    rctx.textBaseline = "middle";

    for(let i=0;i<n;i++){
      const a = (Math.PI*2)*(i/n) - Math.PI/2;
      const x = cx + R*Math.cos(a);
      const y = cy + R*Math.sin(a);

      rctx.beginPath();
      rctx.moveTo(cx,cy);
      rctx.lineTo(x,y);
      rctx.strokeStyle = "rgba(255,255,255,0.12)";
      rctx.stroke();

      const lx = cx + (R+34)*Math.cos(a);
      const ly = cy + (R+34)*Math.sin(a);
      rctx.fillStyle = "rgba(231,238,252,0.92)";
      rctx.fillText(axes[i].label, lx, ly);
    }

    // Pol√≠gono de salud
    const values = [
      health.anclaje,
      health.nudo,
      health.apoyo,
      health.carga,
      health.deriva
    ].map(v=> clamp(v,0,100));

    rctx.beginPath();
    for(let i=0;i<n;i++){
      const a = (Math.PI*2)*(i/n) - Math.PI/2;
      const rr = R*(values[i]/100);
      const x = cx + rr*Math.cos(a);
      const y = cy + rr*Math.sin(a);
      if(i===0) rctx.moveTo(x,y); else rctx.lineTo(x,y);
    }
    rctx.closePath();
    rctx.fillStyle = "rgba(94,234,212,0.18)";
    rctx.strokeStyle = "rgba(94,234,212,0.85)";
    rctx.lineWidth = 2;
    rctx.fill();
    rctx.stroke();

    // Puntos
    for(let i=0;i<n;i++){
      const a = (Math.PI*2)*(i/n) - Math.PI/2;
      const rr = R*(values[i]/100);
      const x = cx + rr*Math.cos(a);
      const y = cy + rr*Math.sin(a);
      rctx.beginPath();
      rctx.arc(x,y,4,0,Math.PI*2);
      rctx.fillStyle = "rgba(94,234,212,0.95)";
      rctx.fill();
    }

    // T√≠tulo peque√±o
    rctx.fillStyle = "rgba(167,180,214,0.95)";
    rctx.font = "12px system-ui, -apple-system, Segoe UI, Arial";
    rctx.fillText("Radar de salud estructural (0‚Äì100)", cx, 24);
  }

  function renderGlobal(payload){
    const P = payload.P;
    const D = payload.D;
    const Pe = payload.Peff;
    const pct = payload.ampPct;
    const band = payload.globalBand;

    kP.textContent = String(Math.round(P));
    kD.textContent = `${D}%`;
    kPe.textContent = Pe.toFixed(1);

    globalBox.innerHTML = `
      <h3><span class="${badgeClassFromLabel(band.label)}">${band.label}</span></h3>
      <div class="muted" style="margin-top:6px;line-height:1.45">${band.summary}</div>
      <div class="mini" style="margin-top:10px">
        <b>Porci√≥n b√≠blica</b>
        <div style="margin-top:6px">${band.verse.quote}<br><span class="muted">(${band.verse.reference})</span></div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:13px">
        Amplificaci√≥n: ${pct.toFixed(1)}% ¬∑ k=${payload.k.toFixed(2)} ¬∑ Anclaje=${payload.A} ¬∑ Nudo=${payload.N} ¬∑ Apoyo=${payload.S}
      </div>
    `;
  }

  function renderTeachings(payload){
    resultsCard.style.display = "block";
    teachingsEl.innerHTML = "";

    payload.criteria.forEach(c=>{
      const b = c.band;
      const mt = c.mini;
      const card = document.createElement("div");
      card.className = "mini";
      card.innerHTML = `
        <h3>${c.title} ‚Äî <span class="${badgeClassFromLabel(b.label)}">${b.label}</span> ¬∑ ${c.score}/100</h3>
        <div class="muted" style="margin-top:6px">${mt.title}</div>
        <div style="margin-top:8px">
          <ul>${mt.text.map(x=>`<li>${x}</li>`).join("")}</ul>
        </div>
        <div class="mini" style="margin-top:10px">
          <b>Verso</b>
          <div style="margin-top:6px">${mt.verse.quote}<br><span class="muted">(${mt.verse.reference})</span></div>
        </div>
      `;
      teachingsEl.appendChild(card);
    });

    // Plan 7 d√≠as
    plan7El.innerHTML = `
      <ul>
        ${payload.plan7.map(d=>`<li><b>D√≠a ${d.day} ‚Äî ${d.title}:</b> ${d.items.join(" ¬∑ ")}</li>`).join("")}
      </ul>
    `;
  }

  function buildTxt(payload){
    const L=[];
    L.push("RADAR DEL P√ìRTICO ‚Äî SIMULADOR DE DERIVA (P‚ÄìŒî espiritual)");
    L.push("");
    L.push(`Paciente: ${payload.header.patient}`);
    L.push(`Auditor: ${payload.header.auditor}`);
    L.push(`Fecha: ${payload.header.date}`);
    L.push("Observaciones:");
    L.push(payload.header.notes || "(sin observaciones)");
    L.push("");
    L.push("DIAGN√ìSTICO GLOBAL (P‚ÄìŒî)");
    L.push(`P=${payload.P} ¬∑ Œî‚âà${payload.D}% ¬∑ k=${payload.k.toFixed(2)} ¬∑ P_eff=${payload.Peff.toFixed(1)} ¬∑ Amplificaci√≥n=${payload.ampPct.toFixed(1)}%`);
    L.push(`Estado: ${payload.globalBand.label}`);
    L.push(payload.globalBand.summary);
    L.push(`${payload.globalBand.verse.quote} (${payload.globalBand.verse.reference})`);
    L.push("");
    L.push("DIAGN√ìSTICO POR CRITERIO");
    payload.criteria.forEach(c=>{
      L.push(`- ${c.title}: ${c.score}/100 ¬∑ ${c.band.label}`);
      L.push(`  Mini-ense√±anza: ${c.mini.title}`);
      L.push(`  Verso: ${c.mini.verse.quote} (${c.mini.verse.reference})`);
    });
    L.push("");
    L.push("PLAN SEMANAL (7 D√çAS)");
    payload.plan7.forEach(d=>{
      L.push(`D√≠a ${d.day} ‚Äî ${d.title}`);
      d.items.forEach(it=> L.push("‚Ä¢ " + it));
      L.push("");
    });
    return L.join("\n");
  }

  function downloadTxt(){
    if(!last) return;
    const txt = buildTxt(last);
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_deriva_radar.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogoDataUrl(){
    try{
      const res = await fetch(LOGO_PATH, {cache:"no-store"});
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeFileName(name){
    return (name||"hogar")
      .toLowerCase()
      .replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  async function downloadPdf(){
    if(!last) return;
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogoDataUrl();

    const radarImg = radarCanvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Radar del P√≥rtico ‚Äî Simulador de Deriva (P‚ÄìŒî espiritual)", M, H-18);
        doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    function sectionTitle(text, y){
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...INK);
      doc.text(text, M, y);
      doc.setDrawColor(230);
      doc.line(M, y+8, W-M, y+8);
      return y + 22;
    }

    // PORTADA
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(22);
    doc.setTextColor(255,255,255);
    doc.text("RADAR DEL P√ìRTICO", M, 52);
    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Simulador de Deriva (P‚ÄìŒî espiritual) ‚Äî Diagn√≥stico por criterios", M, 74);

    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 130, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${last.header.patient}`, M+14, 172);
    doc.text(`Auditor: ${last.header.auditor}`, M+14, 192);
    doc.text(`Fecha: ${last.header.date}`, M+14, 212);

    // Diagn√≥stico global (sin c√≠rculo; pill + texto autoajustado)
    const gb = last.globalBand;
    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 270, W-M*2, 170, 12, 12, "F");

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text("Diagn√≥stico global (P‚ÄìŒî)", M+14, 300);

    // ‚ÄúPill‚Äù de estado
    const pillW = 260, pillH = 26;
    doc.setFillColor(22,33,58);
    doc.roundedRect(M+14, 312, pillW, pillH, 10, 10, "F");
    doc.setTextColor(255,255,255);
    let fs = 11;
    doc.setFont("helvetica","bold");
    doc.setFontSize(fs);
    // auto-fit si es largo
    while(doc.getTextWidth(gb.label) > pillW-16 && fs > 8){
      fs -= 1;
      doc.setFontSize(fs);
    }
    doc.text(gb.label.toUpperCase(), M+14 + pillW/2, 330, {align:"center"});

    doc.setTextColor(...INK);
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`P=${Math.round(last.P)} ¬∑ Œî‚âà${last.D}% ¬∑ k=${last.k.toFixed(2)} ¬∑ P_eff=${last.Peff.toFixed(1)} ¬∑ Amplificaci√≥n=${last.ampPct.toFixed(1)}%`, M+14, 360);

    const sumLines = doc.splitTextToSize(gb.summary, W-M*2-28);
    doc.text(sumLines, M+14, 382);

    doc.setFont("times","italic");
    doc.setFontSize(11);
    const vLines = doc.splitTextToSize(`${gb.verse.quote} (${gb.verse.reference})`, W-M*2-28);
    doc.text(vLines, M+14, 416);

    // P√°gina 2: Radar + Tabla criterios
    doc.addPage();
    addLogo(M, 16, 32, 32);

    let y = sectionTitle("Radar del p√≥rtico (salud estructural)", 64);
    try{
      doc.addImage(radarImg, "PNG", M, y, W - M*2, 260);
    }catch(e){}
    y += 280;

    y = sectionTitle("Resumen por criterio", y);

    const rows = last.criteria.map(c=>[
      c.title,
      `${c.score}/100`,
      c.band.label
    ]);

    doc.autoTable({
      startY: y,
      head: [["Criterio", "Puntaje", "Diagn√≥stico"]],
      body: rows,
      theme:"grid",
      styles:{font:"helvetica",fontSize:10,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245]},
      headStyles:{fillColor:[22,33,58],textColor:[255,255,255],fontStyle:"bold"},
      margin:{left:M,right:M}
    });

    // P√°gina 3+: Mini-ense√±anzas de TODAS las secciones
    doc.addPage();
    addLogo(M, 16, 32, 32);
    y = sectionTitle("Enfoque pastoral por criterio (todas las secciones)", 64);

    last.criteria.forEach((c, idx)=>{
      const mt = c.mini;
      const blockH = 150;

      if(y + blockH > H - 70){
        doc.addPage();
        addLogo(M, 16, 32, 32);
        y = 64;
      }

      doc.setFillColor(255,255,255);
      doc.roundedRect(M, y, W-M*2, blockH, 12, 12, "F");

      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(...INK);
      doc.text(`${c.title} ‚Äî ${c.band.label} ¬∑ ${c.score}/100`, M+14, y+26);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(...INK);
      const t1 = doc.splitTextToSize(mt.title, W-M*2-28);
      doc.text(t1, M+14, y+46);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      const bullets = mt.text.map(x=>"‚Ä¢ "+x).join("\n");
      const t2 = doc.splitTextToSize(bullets, W-M*2-28);
      doc.text(t2, M+14, y+66);

      doc.setFont("times","italic");
      doc.setFontSize(10);
      const t3 = doc.splitTextToSize(`${mt.verse.quote} (${mt.verse.reference})`, W-M*2-28);
      doc.text(t3, M+14, y+122);

      y += blockH + 14;
    });

    // Plan 7 d√≠as
    doc.addPage();
    addLogo(M, 16, 32, 32);
    y = sectionTitle("Plan semanal autom√°tico (7 d√≠as)", 64);

    doc.autoTable({
      startY: y,
      head: [["D√≠a", "Enfoque", "Acciones"]],
      body: last.plan7.map(d=>[
        `D√≠a ${d.day}`,
        d.title,
        d.items.join(" ‚Ä¢ ")
      ]),
      theme:"grid",
      styles:{font:"helvetica",fontSize:10,cellPadding:7,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles:{fillColor:[22,33,58],textColor:[255,255,255],fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:180},2:{cellWidth:W-M*2-70-180}},
      margin:{left:M,right:M}
    });

    // Observaciones
    doc.addPage();
    addLogo(M, 16, 32, 32);
    y = sectionTitle("Observaciones", 64);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, y, W-M*2, 520, 12, 12, "F");
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...INK);

    const notes = last.header.notes || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, y+26);

    footer();

    doc.save(`${safeFileName(last.header.patient)}_radar_portico.pdf`);
  }

  function showResult(){
    last = computePayload();

    // Radar
    drawRadar(last.health);

    // Global
    renderGlobal(last);

    // Teachings + plan
    renderTeachings(last);

    // Enable downloads
    btnTxt.disabled = false;
    btnPdf.disabled = !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  async function init(){
    const res = await fetch(JSON_PATH, {cache:"no-store"});
    if(!res.ok) throw new Error("No se pudo cargar el JSON.");
    DATA = await res.json();

    renderHeader();
    setDefaultDateIfEmpty();
    renderCriteriaForm();
    updateLive();

    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  document.getElementById("btnCalc").addEventListener("click", showResult);
  btnTxt.addEventListener("click", downloadTxt);
  btnPdf.addEventListener("click", downloadPdf);

  init().catch(err=>{
    document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${err.message}<br><span style="color:#a7b4d6">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta que este HTML.</span></div>`;
  });
</script>
</body>
</html>