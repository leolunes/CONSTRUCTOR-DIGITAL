<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas del Hogar ‚Äî Laboratorio</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;margin-right:8px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:560px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    label{font-weight:850;font-size:13px;}
    input, select, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:950;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;}
    .list{margin-top:10px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.4px;}
    .bG{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.35);}
    .bY{background:rgba(245,158,11,.18);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
    .bO{background:rgba(249,115,22,.18);color:#fdba74;border:1px solid rgba(249,115,22,.35);}
    .bR{background:rgba(244,63,94,.18);color:#fda4af;border:1px solid rgba(244,63,94,.35);}
    .small{font-size:13px;color:var(--muted);line-height:1.45;}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;}
    .warnZone{color:#fcd34d}
    .dangerZone{color:#fda4af}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Simulador de Cargas del Hogar</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill" id="pTotal">Magnitud total: 0</span>
      <span class="pill" id="pState">Estado: ‚Äî</span>
      <span class="pill">S√≠smica = flecha horizontal (en el NUDO)</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- IZQ -->
    <div class="card">
      <div class="row">
        <div>
          <b>Laboratorio visual</b>
          <div class="muted" style="font-size:13px;margin-top:4px">
            Simula el ‚Äúmovimiento‚Äù del p√≥rtico seg√∫n cargas NO transferidas vs cargas transferidas al Cimiento (Cristo).
          </div>
        </div>
        <span class="pill" id="liveBand">‚Äî</span>
      </div>

      <div class="svgBox" style="margin-top:10px;">
        <svg id="portico" viewBox="0 0 560 380" width="100%" height="auto">
          <!-- ground -->
          <rect x="0" y="335" width="560" height="45" fill="rgba(255,255,255,.05)"></rect>

          <!-- ===== ESTRUCTURA AGRUPADA PARA SIMULACI√ìN ===== -->
          <g id="frame" style="transform-origin: 150px 312px; transition: transform 650ms cubic-bezier(.2,.9,.2,1);">
            <!-- foundation -->
            <rect id="foundation" x="80" y="290" width="140" height="45" rx="10"
              fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"></rect>
            <text x="150" y="318" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">CIMIENTO</text>

            <!-- column -->
            <rect id="column" x="140" y="90" width="22" height="200" rx="10"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="151" y="78" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">COLUMNA</text>

            <!-- beam -->
            <rect id="beam" x="151" y="90" width="285" height="18" rx="9"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="294" y="78" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">VIGA</text>

            <!-- roller support -->
            <circle id="rollerBase" cx="445" cy="118" r="11"
              fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"></circle>
            <rect id="roller" x="423" y="131" width="44" height="12" rx="5"
              fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="445" y="167" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">APOYO</text>

            <!-- joint marker -->
            <circle id="joint" cx="151" cy="99" r="8"
              fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.20)"></circle>

            <!-- "fisura" visual -->
            <path id="crack" d="M151 99 L146 112 L154 125 L148 140"
                  stroke="rgba(251,113,133,.0)" stroke-width="3" fill="none"
                  style="transition: stroke 650ms ease;"/>
          </g>

          <!-- Drop zones (transparent hit areas) -->
          <rect class="drop" data-zone="beam" x="151" y="70" width="285" height="55" fill="transparent"></rect>
          <rect class="drop" data-zone="column" x="120" y="90" width="70" height="200" fill="transparent"></rect>
          <rect class="drop" data-zone="foundation" x="70" y="270" width="170" height="80" fill="transparent"></rect>
          <rect class="drop" data-zone="roller" x="410" y="90" width="80" height="80" fill="transparent"></rect>
          <rect class="drop" data-zone="joint" x="115" y="70" width="70" height="70" fill="transparent"></rect>

          <!-- Arrow layers per zone -->
          <g id="layer_beam"></g>
          <g id="layer_column"></g>
          <g id="layer_joint"></g>
          <g id="layer_roller"></g>
          <g id="layer_foundation"></g>
        </svg>

        <div class="legend">
          <div class="k"><span class="dot" style="background:#60a5fa"></span>Carga muerta (‚Üì)</div>
          <div class="k"><span class="dot" style="background:#34d399"></span>Carga viva (‚Üì)</div>
          <div class="k"><span class="dot" style="background:#fb7185"></span>Carga s√≠smica (‚Üí en NUDO)</div>
        </div>
      </div>

      <div class="mini" id="diagBox" style="margin-top:12px;"></div>

      <div class="btns">
        <button class="primary" id="btnSimNo">Simular SIN transferencia</button>
        <button class="ghost" id="btnSimYes">Simular CON transferencia</button>
        <button class="ghost" id="btnClear">Vaciar escenario</button>
      </div>
      <div class="hint">La simulaci√≥n es pedag√≥gica: deriva/rotaci√≥n crecen seg√∫n magnitudes NO descargadas al cimiento.</div>
    </div>

    <!-- DER -->
    <div class="card">
      <div class="row">
        <div>
          <b>Crear carga</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            El nombre queda en la lista, pero en el p√≥rtico solo ver√°s flecha + magnitud.
          </div>
        </div>
        <span class="pill">Control</span>
      </div>

      <div class="fieldgrid" style="margin-top:10px;">
        <div style="grid-column:1/-1">
          <label>Nombre de la carga (solo lista)</label>
          <input id="name" placeholder="Ej: presi√≥n financiera / discusiones / falta de altar">
        </div>

        <div>
          <label>Tipo</label>
          <select id="type"></select>
        </div>

        <div>
          <label>Magnitud</label>
          <input id="mag" type="number" min="1" max="10" step="1">
          <div class="hint">S√≠smica usa magnitud como ‚Äúempuje horizontal‚Äù.</div>
        </div>

        <div style="grid-column:1/-1">
          <label>Nota (opcional)</label>
          <textarea id="note" placeholder="¬øQu√© lo detona? ¬øQu√© se repite?"></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnAdd">Crear flecha</button>
        <button class="ghost" id="btnResetForm">Limpiar</button>
      </div>

      <div class="mini">
        <h3>Biblioteca de cargas (arrastra al p√≥rtico)</h3>
        <div class="small" id="libHint">Nota: si es S√çSMICA, al soltarla se ancla al NUDO autom√°ticamente.</div>
        <div id="library" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;"></div>
      </div>

      <div class="mini">
        <h3>Cargas en el escenario</h3>
        <div class="list">
          <table>
            <thead>
              <tr>
                <th>Carga</th>
                <th>Tipo</th>
                <th>Magnitud</th>
                <th>Ubicaci√≥n</th>
                <th>Transferir</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px" id="verseBox"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const JSON_PATH = "simulador.json";
  const STORAGE_KEY = "simulador_cargas_v2";

  let DATA=null;

  const state = {
    library: [],   // {id,name,type,mag,note,createdAt}
    placed: []     // {id, refId, zone}
  };

  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const pTotal = document.getElementById("pTotal");
  const pState = document.getElementById("pState");
  const liveBand = document.getElementById("liveBand");
  const diagBox = document.getElementById("diagBox");
  const verseBox = document.getElementById("verseBox");

  const frameEl = document.getElementById("frame");
  const crackEl = document.getElementById("crack");

  const nameEl = document.getElementById("name");
  const typeEl = document.getElementById("type");
  const magEl  = document.getElementById("mag");
  const noteEl = document.getElementById("note");

  const libraryEl = document.getElementById("library");
  const rowsEl = document.getElementById("rows");

  const zoneLayers = {
    beam: document.getElementById("layer_beam"),
    column: document.getElementById("layer_column"),
    joint: document.getElementById("layer_joint"),
    roller: document.getElementById("layer_roller"),
    foundation: document.getElementById("layer_foundation")
  };

  function uid(){
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2));
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      state.library = Array.isArray(payload.library) ? payload.library : [];
      state.placed  = Array.isArray(payload.placed) ? payload.placed : [];
    }catch(e){}
  }

  function typeInfo(key){
    return DATA.loadTypes.find(x=>x.key===key) || DATA.loadTypes[0];
  }

  function zoneInfo(key){
    return DATA.zones.find(z=>z.key===key);
  }

  function clampMag(v){
    const min = DATA.magnitude.min, max = DATA.magnitude.max;
    v = Number(v);
    if(Number.isNaN(v)) v = DATA.magnitude.default;
    return Math.max(min, Math.min(max, v));
  }

  function setDefaults(){
    magEl.value = String(DATA.magnitude.default);
    typeEl.innerHTML = DATA.loadTypes.map(t=>`<option value="${t.key}">${t.label}</option>`).join("");
  }

  function resetForm(){
    nameEl.value = "";
    noteEl.value = "";
    typeEl.value = DATA.loadTypes[0].key;
    magEl.value = String(DATA.magnitude.default);
  }

  function addToLibrary(){
    const name = (nameEl.value||"").trim();
    if(!name){
      alert("Escribe el nombre de la carga (solo para la lista).");
      return;
    }
    const item = {
      id: uid(),
      name,
      type: typeEl.value,
      mag: clampMag(magEl.value),
      note: (noteEl.value||"").trim(),
      createdAt: new Date().toISOString()
    };
    state.library.unshift(item);
    save();
    resetForm();
    render();
  }

  function removeLibrary(id){
    if(!confirm("¬øEliminar esta carga (y todas sus flechas colocadas)?")) return;
    state.library = state.library.filter(x=>x.id!==id);
    state.placed = state.placed.filter(p=>p.refId!==id);
    save();
    render();
  }

  function placeFromLibrary(refId, zone){
    const lib = state.library.find(x=>x.id===refId);
    if(!lib) return;

    // ‚úÖ Regla: si es S√çSMICA, se ancla al NUDO s√≠ o s√≠
    const finalZone = (lib.type === "sismica") ? "joint" : zone;

    state.placed.unshift({ id: uid(), refId, zone: finalZone });
    save();
    render();
  }

  function removePlaced(placedId){
    state.placed = state.placed.filter(p=>p.id!==placedId);
    save();
    render();
  }

  function transferPlaced(placedId){
    const p = state.placed.find(x=>x.id===placedId);
    if(!p) return;
    const z = zoneInfo(p.zone);
    if(!z || !z.transferTo){
      alert("Ya est√° en el cimiento (Cristo).");
      return;
    }
    p.zone = z.transferTo;
    save();
    render();
  }

  // ===== ARROWS (vertical vs horizontal) =====
  function clearLayers(){
    Object.values(zoneLayers).forEach(g=> g.innerHTML="");
  }

  function arrowVertical(x, y, color, mag){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    const halo = document.createElementNS("http://www.w3.org/2000/svg","circle");
    halo.setAttribute("cx", x);
    halo.setAttribute("cy", y-16);
    halo.setAttribute("r", "18");
    halo.setAttribute("fill", "rgba(0,0,0,.18)");

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x", x);
    text.setAttribute("y", y - 8);
    text.setAttribute("text-anchor","middle");
    text.setAttribute("font-size","12");
    text.setAttribute("font-weight","900");
    text.setAttribute("fill", "rgba(255,255,255,.92)");
    text.textContent = String(mag);

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x);
    line.setAttribute("y1", y - 30);
    line.setAttribute("x2", x);
    line.setAttribute("y2", y - 4);
    line.setAttribute("stroke", color);
    line.setAttribute("stroke-width","4");
    line.setAttribute("stroke-linecap","round");

    const tri = document.createElementNS("http://www.w3.org/2000/svg","polygon");
    tri.setAttribute("points", `${x},${y} ${x-8},${y-12} ${x+8},${y-12}`);
    tri.setAttribute("fill", color);

    g.appendChild(halo);
    g.appendChild(text);
    g.appendChild(line);
    g.appendChild(tri);
    return g;
  }

  function arrowHorizontal(x, y, color, mag){
    // flecha apuntando ‚Üí con magnitud arriba
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    const halo = document.createElementNS("http://www.w3.org/2000/svg","rect");
    halo.setAttribute("x", x-22);
    halo.setAttribute("y", y-22);
    halo.setAttribute("width", "84");
    halo.setAttribute("height", "40");
    halo.setAttribute("rx", "14");
    halo.setAttribute("fill", "rgba(0,0,0,.18)");

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x", x+20);
    text.setAttribute("y", y - 6);
    text.setAttribute("text-anchor","middle");
    text.setAttribute("font-size","12");
    text.setAttribute("font-weight","900");
    text.setAttribute("fill", "rgba(255,255,255,.92)");
    text.textContent = String(mag);

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x);
    line.setAttribute("y1", y);
    line.setAttribute("x2", x+52);
    line.setAttribute("y2", y);
    line.setAttribute("stroke", color);
    line.setAttribute("stroke-width","4");
    line.setAttribute("stroke-linecap","round");

    const tri = document.createElementNS("http://www.w3.org/2000/svg","polygon");
    tri.setAttribute("points", `${x+62},${y} ${x+48},${y-8} ${x+48},${y+8}`);
    tri.setAttribute("fill", color);

    g.appendChild(halo);
    g.appendChild(text);
    g.appendChild(line);
    g.appendChild(tri);
    return g;
  }

  function zoneAnchor(zoneKey){
    // (x,y) base. Para sismica (horizontal) se ve mejor en el nudo.
    if(zoneKey==="beam") return { x: 250, y: 88 };
    if(zoneKey==="column") return { x: 151, y: 160 };
    if(zoneKey==="joint") return { x: 155, y: 108 };
    if(zoneKey==="roller") return { x: 438, y: 120 };
    return { x: 150, y: 300 }; // foundation
  }

  function renderArrows(){
    clearLayers();

    const placedByZone = {};
    DATA.zones.forEach(z=> placedByZone[z.key] = []);
    state.placed.forEach(p=> (placedByZone[p.zone] ??= []).push(p));

    Object.entries(placedByZone).forEach(([zoneKey, arr])=>{
      const layer = zoneLayers[zoneKey];
      if(!layer) return;

      const base = zoneAnchor(zoneKey);
      const dx = 38;
      const maxRow = 6;

      arr.forEach((p, idx)=>{
        const lib = state.library.find(x=>x.id===p.refId);
        if(!lib) return;
        const t = typeInfo(lib.type);
        const mag = clampMag(lib.mag);

        const row = Math.floor(idx / maxRow);
        const colIdx = idx % maxRow;

        const x = base.x + (colIdx - (Math.min(arr.length, maxRow)-1)/2) * dx;
        const y = base.y + row*50;

        // ‚úÖ S√çSMICA = flecha horizontal
        if(lib.type === "sismica"){
          layer.appendChild(arrowHorizontal(x, y, t.color, mag));
        }else{
          layer.appendChild(arrowVertical(x, y, t.color, mag));
        }
      });
    });
  }

  // ===== M√âTRICAS =====
  function totals(){
    let total=0, onFoundation=0, notFoundation=0;
    let hNot=0, vNot=0; // horizontal no transferida / vertical no transferida

    state.placed.forEach(p=>{
      const lib = state.library.find(x=>x.id===p.refId);
      if(!lib) return;
      const m = clampMag(lib.mag);
      total += m;

      if(p.zone === "foundation") onFoundation += m;
      else notFoundation += m;

      if(p.zone !== "foundation"){
        if(lib.type === "sismica") hNot += m;
        else vNot += m;
      }
    });

    return { total, onFoundation, notFoundation, hNot, vNot };
  }

  function stateBand(sum){
    const r = DATA.rules;
    if(sum >= r.criticalThreshold) return { label:"Cr√≠tico", cls:"bR" };
    if(sum >= r.riskThreshold) return { label:"En riesgo", cls:"bO" };
    if(sum > 0) return { label:"En ajuste", cls:"bY" };
    return { label:"Alineado", cls:"bG" };
  }

  function renderDiagnostics(){
    const t = totals();
    const band = stateBand(t.total);

    pTotal.textContent = `Magnitud total: ${t.total}`;
    pState.textContent = `Estado: ${band.label}`;
    liveBand.innerHTML = `<span class="badge ${band.cls}">${band.label}</span>`;

    const byZoneCount = {};
    state.placed.forEach(p=> byZoneCount[p.zone] = (byZoneCount[p.zone]||0) + 1);

    const warnMax = DATA.rules.maxPerZoneBeforeWarn;

    const zoneLines = DATA.zones.map(z=>{
      const c = byZoneCount[z.key] || 0;
      const cls = c >= warnMax ? "dangerZone" : (c >= Math.ceil(warnMax*0.7) ? "warnZone" : "");
      return `<li><b>${z.label}:</b> ${c} flecha(s) ${cls?`<span class="${cls}">(concentraci√≥n)</span>`:""}</li>`;
    }).join("");

    diagBox.innerHTML = `
      <h3>Diagn√≥stico r√°pido</h3>
      <div class="small">
        <b>No transferido al cimiento:</b> ${t.notFoundation} &nbsp;|&nbsp;
        <b>Transferido al cimiento:</b> ${t.onFoundation}
        <br>
        <b>Empuje s√≠smico no transferido (‚Üí):</b> ${t.hNot} &nbsp;|&nbsp;
        <b>Peso vertical no transferido (‚Üì):</b> ${t.vNot}
      </div>
      <ul style="margin:8px 0 0;padding-left:18px;line-height:1.45">${zoneLines}</ul>
    `;

    verseBox.innerHTML = `<b>üìñ</b> ${DATA.verses.transferencia.quote} <span class="muted">(${DATA.verses.transferencia.reference})</span>`;
  }

  // ===== SIMULACI√ìN =====
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function simulate(mode){
    // mode: "no" = sin transferencia, "yes" = con transferencia
    const t = totals();

    if(mode === "yes"){
      // si est√° ‚Äúcon transferencia‚Äù, visualmente mostramos el sistema estable
      frameEl.style.transform = `translate(0px,0px) rotate(0deg)`;
      crackEl.setAttribute("stroke", "rgba(251,113,133,.0)");
      return;
    }

    // "no": deriva por cargas NO transferidas
    // Horizontal no transferida => desplazamiento + rotaci√≥n
    // Vertical no transferida => ‚Äúasentamiento‚Äù + ligera rotaci√≥n (pedag√≥gico)
    const h = t.hNot;
    const v = t.vNot;

    // Escalas pedag√≥gicas (ajustables)
    const driftX = clamp(h * 2.2, 0, 48);     // px
    const driftY = clamp(v * 0.55, 0, 18);    // px (asentamiento)
    const rotDeg = clamp(h * 0.22 + v * 0.05, 0, 8); // grados

    frameEl.style.transform = `translate(${driftX}px,${driftY}px) rotate(${rotDeg}deg)`;

    // fisura: aparece si hay mucho no transferido, especialmente s√≠smico
    const crackAlpha = clamp((t.notFoundation / 30), 0, 1) * clamp((h / 12), 0, 1);
    crackEl.setAttribute("stroke", `rgba(251,113,133,${(0.15 + crackAlpha*0.85).toFixed(3)})`);
  }

  // ===== UI =====
  function renderLibrary(){
    libraryEl.innerHTML = "";
    state.library.forEach(item=>{
      const t = typeInfo(item.type);

      const card = document.createElement("div");
      card.style.cssText = `
        border:1px solid rgba(255,255,255,.14);
        border-radius:14px;padding:10px 12px;cursor:grab;
        background:rgba(255,255,255,.03);min-width:170px;
      `;
      card.setAttribute("draggable","true");
      card.dataset.refId = item.id;
      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <b style="font-size:13px">${escapeHtml(item.name)}</b>
          <span class="tag" style="border-color:${t.color};color:${t.color}">M${item.mag}</span>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">${escapeHtml(t.label)}</div>
        <div style="margin-top:8px">
          <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del-lib="${item.id}">Eliminar</button>
        </div>
      `;
      card.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", item.id);
      });
      libraryEl.appendChild(card);
    });

    libraryEl.querySelectorAll("[data-del-lib]").forEach(btn=>{
      btn.addEventListener("click", ()=> removeLibrary(btn.getAttribute("data-del-lib")));
    });
  }

  function renderRows(){
    rowsEl.innerHTML = "";
    state.placed.forEach(p=>{
      const lib = state.library.find(x=>x.id===p.refId);
      if(!lib) return;
      const t = typeInfo(lib.type);
      const z = zoneInfo(p.zone);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${escapeHtml(lib.name)}</b>
          <div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(lib.note||"")}</div>
          <div style="margin-top:6px">
            <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-remove="${p.id}">Quitar flecha</button>
          </div>
        </td>
        <td><span class="tag" style="border-color:${t.color};color:${t.color}">${escapeHtml(t.label)}</span></td>
        <td><b>${clampMag(lib.mag)}</b></td>
        <td>${escapeHtml(z ? z.label : p.zone)} ${lib.type==="sismica" ? "<div class='muted' style='font-size:12px;margin-top:4px'>(s√≠smica anclada al nudo)</div>" : ""}</td>
        <td>
          <button class="primary" style="padding:8px 10px;border-radius:12px;font-weight:950"
            data-transfer="${p.id}" ${(!z || !z.transferTo) ? "disabled" : ""}>
            Transferir ‚Üí
          </button>
          <div class="muted" style="font-size:12px;margin-top:6px">
            ${z && z.transferTo ? `Destino: <b>${escapeHtml(zoneInfo(z.transferTo)?.label || z.transferTo)}</b>` : "Destino: ‚Äî"}
          </div>
        </td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-remove]").forEach(btn=>{
      btn.addEventListener("click", ()=> removePlaced(btn.getAttribute("data-remove")));
    });
    rowsEl.querySelectorAll("[data-transfer]").forEach(btn=>{
      btn.addEventListener("click", ()=> transferPlaced(btn.getAttribute("data-transfer")));
    });
  }

  function render(){
    renderLibrary();
    renderArrows();
    renderRows();
    renderDiagnostics();
    // por defecto, deja ‚Äúestable‚Äù
    simulate("yes");
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function setupDrops(){
    document.querySelectorAll(".drop").forEach(el=>{
      el.addEventListener("dragover", (e)=>{ e.preventDefault(); });
      el.addEventListener("drop", (e)=>{
        e.preventDefault();
        const refId = e.dataTransfer.getData("text/plain");
        const zone = el.getAttribute("data-zone");
        if(refId && zone) placeFromLibrary(refId, zone);
      });
    });
  }

  function clearScenario(){
    if(!confirm("¬øVaciar el escenario (quitar todas las flechas colocadas)?")) return;
    state.placed = [];
    save();
    render();
  }

  async function init(){
    const res = await fetch(JSON_PATH, {cache:"no-store"});
    if(!res.ok) throw new Error("No se pudo cargar el JSON: " + res.status);
    DATA = await res.json();

    tEl.textContent = DATA.meta.title;
    dEl.textContent = DATA.meta.description;

    setDefaults();
    load();
    setupDrops();
    render();
  }

  document.getElementById("btnAdd").addEventListener("click", addToLibrary);
  document.getElementById("btnResetForm").addEventListener("click", resetForm);
  document.getElementById("btnClear").addEventListener("click", clearScenario);

  document.getElementById("btnSimNo").addEventListener("click", ()=> simulate("no"));
  document.getElementById("btnSimYes").addEventListener("click", ()=> simulate("yes"));

  init().catch(err=>{
    document.body.innerHTML = `<div style="padding:22px;color:#fda4af">
      <b>Error:</b> ${err.message}<br>
      <span style="color:#a7b4d6">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta.</span>
    </div>`;
  });
</script>
</body>
</html>