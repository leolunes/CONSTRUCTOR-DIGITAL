<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas del Hogar</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:560px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, select, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    button[disabled]{opacity:.55;cursor:not-allowed}

    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}

    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    .table{margin-top:10px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .result{display:none;margin-top:12px;border-radius:18px;border:1px solid var(--line);padding:14px;background:rgba(255,255,255,.04);}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.4px;}
    .bG{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.35);}
    .bY{background:rgba(245,158,11,.18);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
    .bO{background:rgba(249,115,22,.18);color:#fdba74;border:1px solid rgba(249,115,22,.35);}
    .bR{background:rgba(244,63,94,.18);color:#fda4af;border:1px solid rgba(244,63,94,.35);}

    .eqGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:520px){.eqGrid{grid-template-columns:1fr 1fr 1fr;}}
    .eqCard{border:1px solid var(--line);border-radius:16px;padding:10px;background:rgba(255,255,255,.03);}
    .eqLabel{color:var(--muted);font-size:12px;}
    .eqValue{font-weight:950;font-size:20px;margin-top:4px;}
    .eqHint{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35;}

    .helpLine{stroke:rgba(94,234,212,.35);stroke-width:3;stroke-linecap:round;stroke-dasharray:8 8;opacity:0;}
    .helpDot{fill:rgba(94,234,212,.55);opacity:0;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="t">Simulador de Cargas del Hogar</h1>
      <p class="sub" id="d"></p>
      <div style="margin-top:10px">
        <span class="pill" id="pGlobal">Global: —</span>
        <span class="pill" id="pUn">No transferido: 0</span>
        <span class="pill" id="pEq">∑Fy / ∑Fx / ∑M</span>
      </div>
      <div id="pdfWarn" class="warn">No se pudo cargar jsPDF. Verifica internet/CDN.</div>
    </div>

    <div class="grid">
      <!-- IZQ: ESCENARIO -->
      <div class="card">
        <div class="row">
          <div>
            <b>Escenario del pórtico</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">
              Flechas = cargas · Magnitud sobre la flecha · Transferencia mueve la flecha (no el nombre).
            </div>
          </div>
          <span class="pill" id="liveMode">Modo: —</span>
        </div>

        <div class="mini">
          <h3>Ecuaciones espirituales (panel pedagógico)</h3>
          <div class="eqGrid">
            <div class="eqCard">
              <div class="eqLabel">∑Fy (vertical no descargado)</div>
              <div class="eqValue" id="eqFy">0</div>
              <div class="eqHint">Muertas + vivas fuera del cimiento.</div>
            </div>
            <div class="eqCard">
              <div class="eqLabel">∑Fx (horizontal no descargado)</div>
              <div class="eqValue" id="eqFx">0</div>
              <div class="eqHint">Sísmicas fuera del cimiento.</div>
            </div>
            <div class="eqCard">
              <div class="eqLabel">∑M (momento)</div>
              <div class="eqValue" id="eqM">0</div>
              <div class="eqHint">Aumenta con sísmica + cargas altas.</div>
            </div>
          </div>
        </div>

        <div class="svgBox" style="margin-top:10px;">
          <svg id="svg" viewBox="0 0 560 380" width="100%" height="auto" aria-label="Simulador pórtico">
            <!-- ground -->
            <rect x="0" y="340" width="560" height="40" fill="rgba(255,255,255,.05)"></rect>

            <!-- crack -->
            <path id="crack" d="" fill="none" stroke="rgba(244,63,94,.9)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0"></path>

            <!-- guide routes -->
            <g id="routes">
              <line id="route_beam_column" class="helpLine" x1="285" y1="105" x2="140" y2="200"></line>
              <line id="route_joint_column" class="helpLine" x1="140" y1="114" x2="140" y2="200"></line>
              <line id="route_roller_beam" class="helpLine" x1="430" y1="132" x2="285" y2="105"></line>
              <line id="route_column_foundation" class="helpLine" x1="140" y1="200" x2="140" y2="300"></line>

              <circle id="dot_beam" class="helpDot" cx="285" cy="105" r="6"></circle>
              <circle id="dot_joint" class="helpDot" cx="140" cy="114" r="6"></circle>
              <circle id="dot_roller" class="helpDot" cx="430" cy="132" r="6"></circle>
              <circle id="dot_column" class="helpDot" cx="140" cy="200" r="6"></circle>
              <circle id="dot_foundation" class="helpDot" cx="140" cy="300" r="6"></circle>
            </g>

            <!-- GROUP that we will transform -->
            <g id="frame">
              <!-- foundation -->
              <rect id="foundation" x="70" y="295" width="140" height="45" rx="10" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"></rect>
              <text x="140" y="323" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">CIMIENTO</text>

              <!-- column -->
              <rect id="column" x="130" y="105" width="20" height="190" rx="8" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
              <text x="140" y="96" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">COLUMNA</text>

              <!-- beam -->
              <rect id="beam" x="140" y="105" width="290" height="18" rx="8" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
              <text x="285" y="92" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">VIGA</text>

              <!-- roller support -->
              <circle id="rollerBase" cx="430" cy="132" r="10" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"></circle>
              <rect x="410" y="142" width="40" height="10" rx="4" fill="rgba(255,255,255,.08)"></rect>
              <text x="430" y="173" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">APOYO MÓVIL</text>

              <!-- nodes -->
              <circle id="N1" cx="140" cy="295" r="10" fill="#64748b"></circle>
              <text x="155" y="299" font-size="12" fill="rgba(255,255,255,.75)">1</text>
              <text x="140" y="283" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">COMUNIÓN</text>

              <circle id="N2" cx="140" cy="114" r="10" fill="#64748b"></circle>
              <text x="155" y="118" font-size="12" fill="rgba(255,255,255,.75)">2</text>
              <text x="140" y="141" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">NUDO</text>

              <circle id="N3" cx="430" cy="132" r="10" fill="#64748b"></circle>
              <text x="445" y="136" font-size="12" fill="rgba(255,255,255,.75)">3</text>
              <text x="430" y="186" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">INTERSECCIÓN</text>
            </g>

            <!-- arrows layer -->
            <g id="arrows"></g>
          </svg>

          <div class="legend" id="typeLegend"></div>
        </div>

        <div class="result" id="resBox"></div>

        <div class="btns">
          <button class="primary" id="btnSimNo">Simular SIN transferencia</button>
          <button class="ghost" id="btnSimYes">Simular CON transferencia</button>
          <button class="primary" id="btnTransferAll">Transferir TODO al cimiento (Cristo)</button>
          <button class="ghost" id="btnClear">Vaciar escenario</button>
        </div>

        <div class="btns">
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF (captura)</button>
        </div>
      </div>

      <!-- DER: FORM + LISTA -->
      <div class="card">
        <div class="row">
          <div>
            <b>Crear carga</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">
              Crea la flecha (tipo + magnitud) y ubícala en una zona.
            </div>
          </div>
          <span class="pill">Laboratorio</span>
        </div>

        <div class="fieldgrid">
          <div>
            <label>Paciente / hogar</label>
            <input id="patient" placeholder="Ej: Hogar Abraham y Sara">
          </div>
          <div>
            <label>Auditor</label>
            <input id="auditor" placeholder="Ej: Consejero / Pastor">
          </div>
          <div>
            <label>Fecha</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, detonantes, etc."></textarea>
          </div>
        </div>

        <div class="mini">
          <h3>Nueva flecha (carga)</h3>

          <div class="fieldgrid">
            <div>
              <label>Tipo</label>
              <select id="type"></select>
            </div>
            <div>
              <label>Magnitud</label>
              <input id="mag" type="number" min="1" step="1" placeholder="Ej: 15">
            </div>

            <div style="grid-column:1/-1">
              <label>Nombre (solo para la lista; NO viaja en la transferencia)</label>
              <input id="name" placeholder="Ej: Presión financiera / Discusión / Falta de altar">
            </div>

            <div style="grid-column:1/-1">
              <label>Zona inicial</label>
              <select id="zone"></select>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnAdd">Crear flecha</button>
            <button class="ghost" id="btnResetForm">Limpiar</button>
          </div>

          <div class="muted" style="font-size:13px;margin-top:8px;">
            Sísmica = flecha horizontal (recomendado en Nudo).
          </div>
        </div>

        <div class="mini">
          <h3>Flechas colocadas</h3>
          <div class="table">
            <table>
              <thead>
                <tr>
                  <th>Flecha</th>
                  <th>Zona</th>
                  <th>Tipo</th>
                  <th>Magnitud</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="muted" style="font-size:13px;margin-top:8px;">
            La guía de transferencia aparece cuando transfieres (línea punteada). “Transferir” mueve flechas por pasos.
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const JSON_PATH = "simulador.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "simulador_cargas_v2";

  let DATA=null;
  let logoDataUrl=null;

  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    placed: [] // {id, name, type, mag, zone, createdAt}
  };

  // UI
  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const pGlobal = document.getElementById("pGlobal");
  const pUn = document.getElementById("pUn");
  const liveMode = document.getElementById("liveMode");
  const rowsEl = document.getElementById("rows");
  const arrowsEl = document.getElementById("arrows");
  const resBox = document.getElementById("resBox");
  const crackEl = document.getElementById("crack");
  const frameEl = document.getElementById("frame");
  const typeLegend = document.getElementById("typeLegend");
  const pdfWarn = document.getElementById("pdfWarn");

  const eqFyEl = document.getElementById("eqFy");
  const eqFxEl = document.getElementById("eqFx");
  const eqMEl  = document.getElementById("eqM");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");

  const typeEl = document.getElementById("type");
  const magEl = document.getElementById("mag");
  const nameEl = document.getElementById("name");
  const zoneEl = document.getElementById("zone");

  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");

  // route elements
  const route = {
    beam_column: document.getElementById("route_beam_column"),
    joint_column: document.getElementById("route_joint_column"),
    roller_beam: document.getElementById("route_roller_beam"),
    column_foundation: document.getElementById("route_column_foundation"),
    dot_beam: document.getElementById("dot_beam"),
    dot_joint: document.getElementById("dot_joint"),
    dot_roller: document.getElementById("dot_roller"),
    dot_column: document.getElementById("dot_column"),
    dot_foundation: document.getElementById("dot_foundation")
  };

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function okPdfLib(){ return !!(window.jspdf && window.jspdf.jsPDF); }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      state.header = payload.header || state.header;
      state.placed = Array.isArray(payload.placed) ? payload.placed : [];
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function uid(){
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2));
  }

  function loadTypeByKey(k){
    return DATA.loadTypes.find(x=>x.key===k) || DATA.loadTypes[0];
  }

  function zoneTitle(zoneKey){
    const z = DATA.sections.find(s=>s.id===zoneKey);
    return z ? z.title : zoneKey;
  }

  function renderLegend(){
    typeLegend.innerHTML = DATA.loadTypes.map(t=>`
      <div class="k">
        <span class="dot" style="background:${t.color}"></span>${escapeHtml(t.label)}
      </div>
    `).join("");
  }

  function setupSelects(){
    typeEl.innerHTML = DATA.loadTypes.map(x=>`<option value="${x.key}">${escapeHtml(x.label)}</option>`).join("");
    zoneEl.innerHTML = DATA.sections.map(s=>`<option value="${s.id}">${escapeHtml(s.title)}</option>`).join("");
  }

  function resetForm(){
    typeEl.value = "viva";
    const t = loadTypeByKey(typeEl.value);
    magEl.value = String(t.defaultMagnitude || 10);
    nameEl.value = "";
    zoneEl.value = "beam";
  }

  // anchor points in SVG
  function zoneAnchor(zoneKey){
    if(zoneKey==="foundation") return {x:140, y:300};
    if(zoneKey==="column") return {x:140, y:200};
    if(zoneKey==="beam") return {x:285, y:105};
    if(zoneKey==="joint") return {x:140, y:114};
    if(zoneKey==="roller") return {x:430, y:132};
    return {x:280,y:180};
  }

  function addArrowEl(p, idxInZone){
    const t = loadTypeByKey(p.type);
    const a = zoneAnchor(p.zone);

    const sw = DATA.render.arrow.strokeWidth || 3;
    const head = DATA.render.arrow.headSize || 9;
    const offset = (idxInZone - 1) * 18;

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("data-id", p.id);

    const mag = Number(p.mag||0);

    if(t.direction === "horizontal"){
      // horizontal arrow (sísmica)
      const y = a.y - 26 + offset;
      const x1 = a.x - 80;
      const x2 = a.x + 80;

      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y);
      line.setAttribute("stroke", t.color);
      line.setAttribute("stroke-width", sw);
      line.setAttribute("stroke-linecap","round");

      const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
      poly.setAttribute("points", `${x2},${y} ${x2-head},${y-head*0.7} ${x2-head},${y+head*0.7}`);
      poly.setAttribute("fill", t.color);

      const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
      txt.setAttribute("x", (x1+x2)/2);
      txt.setAttribute("y", y-10);
      txt.setAttribute("text-anchor","middle");
      txt.setAttribute("font-size","12");
      txt.setAttribute("fill","rgba(255,255,255,.92)");
      txt.textContent = String(mag);

      g.appendChild(line); g.appendChild(poly); g.appendChild(txt);
    } else {
      // vertical arrow
      const x = a.x + offset;
      const yTop = (p.zone==="foundation") ? 250 : (a.y - 65);
      const yBottom = (p.zone==="foundation") ? 290 : (a.y - 15);

      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", x);
      line.setAttribute("y1", yTop);
      line.setAttribute("x2", x);
      line.setAttribute("y2", yBottom);
      line.setAttribute("stroke", t.color);
      line.setAttribute("stroke-width", sw);
      line.setAttribute("stroke-linecap","round");

      const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
      poly.setAttribute("points", `${x},${yBottom+head} ${x-head*0.7},${yBottom} ${x+head*0.7},${yBottom}`);
      poly.setAttribute("fill", t.color);

      const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
      txt.setAttribute("x", x);
      txt.setAttribute("y", yTop-8);
      txt.setAttribute("text-anchor","middle");
      txt.setAttribute("font-size","12");
      txt.setAttribute("fill","rgba(255,255,255,.92)");
      txt.textContent = String(mag);

      g.appendChild(line); g.appendChild(poly); g.appendChild(txt);
    }

    arrowsEl.appendChild(g);
  }

  function renderArrows(){
    arrowsEl.innerHTML = "";
    const groups = {};
    state.placed.forEach(p=>{
      const t = loadTypeByKey(p.type);
      const key = p.zone + "|" + t.direction;
      groups[key] = groups[key] || [];
      groups[key].push(p);
    });
    Object.keys(groups).forEach(k=>{
      groups[k].forEach((p, i)=> addArrowEl(p, i));
    });
  }

  function renderRows(){
    rowsEl.innerHTML = "";
    const sorted = state.placed.slice().sort((a,b)=> (a.zone>b.zone?1:-1));
    sorted.forEach(p=>{
      const t = loadTypeByKey(p.type);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <b>${escapeHtml(p.name || "(sin nombre)")}</b>
          <div style="margin-top:6px"><span class="tag" style="border-color:${t.color};color:${t.color}">● ${escapeHtml(t.key)}</span></div>
        </td>
        <td>${escapeHtml(zoneTitle(p.zone))}</td>
        <td>${escapeHtml(t.label)}</td>
        <td><b>${Number(p.mag||0)}</b></td>
        <td>
          <button class="ghost" style="padding:7px 10px;border-radius:10px;font-weight:900" data-step="${p.id}">Transferir 1 paso</button>
          <button class="ghost" style="padding:7px 10px;border-radius:10px;font-weight:900;margin-top:6px" data-del="${p.id}">Eliminar</button>
        </td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        state.placed = state.placed.filter(x=>x.id!==id);
        save(); render();
      });
    });

    rowsEl.querySelectorAll("[data-step]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-step");
        transferOneStep(id, true);
      });
    });
  }

  // ====== ECUACIONES (∑Fy, ∑Fx, ∑M) ======
  function computeEquations(){
    const fyF = DATA.equations?.fyFactor ?? 1;
    const fxF = DATA.equations?.fxFactor ?? 1;
    const mF  = DATA.equations?.momentFactor ?? 0.55;
    const arms = DATA.equations?.momentArm || {};

    let Fy = 0;
    let Fx = 0;
    let M  = 0;

    state.placed.forEach(p=>{
      if(p.zone==="foundation") return; // descargado
      const t = loadTypeByKey(p.type);
      const mag = Number(p.mag||0);

      if(t.direction==="vertical") Fy += mag * fyF;
      if(t.direction==="horizontal") Fx += mag * fxF;

      const arm = arms[p.zone] ?? 0.8;
      // pedagógico: momento suma vertical+horizontal ponderados por brazo, sísmica pesa más en giro
      const seismicBoost = (t.direction==="horizontal") ? 1.6 : 1.0;
      M += (mag * arm * mF * seismicBoost);
    });

    // redondeos
    Fy = Math.round(Fy);
    Fx = Math.round(Fx);
    M  = Math.round(M);

    return {Fy, Fx, M};
  }

  function updateEqPanel(){
    const eq = computeEquations();
    eqFyEl.textContent = String(eq.Fy);
    eqFxEl.textContent = String(eq.Fx);
    eqMEl.textContent  = String(eq.M);
    return eq;
  }

  // ====== GLOBAL / BANDAS ======
  function totalUntransferred(){
    return state.placed.reduce((acc,p)=> acc + (p.zone==="foundation" ? 0 : Number(p.mag||0)), 0);
  }

  function globalBand(un){
    const b = DATA.globalBands.find(x=> un>=x.min && un<=x.max);
    return b || DATA.globalBands[DATA.globalBands.length-1];
  }

  function badgeForBand(key){
    if(key==="g_alineado") return "bG";
    if(key==="g_ajuste") return "bY";
    if(key==="g_riesgo") return "bO";
    return "bR";
  }

  function paintNodesByLoad(){
    const worst = { N1:0, N2:0, N3:0 };

    state.placed.forEach(p=>{
      if(p.zone==="foundation") return;
      const mag = Number(p.mag||0);
      if(p.zone==="joint") worst.N2 = Math.max(worst.N2, mag);
      if(p.zone==="beam") worst.N2 = Math.max(worst.N2, mag);
      if(p.zone==="column") worst.N1 = Math.max(worst.N1, mag);
      if(p.zone==="roller") worst.N3 = Math.max(worst.N3, mag);
    });

    const colorFor = (m)=>{
      if(m<=0) return "#64748b";
      if(m<20) return DATA.levels[1].color;
      if(m<45) return DATA.levels[2].color;
      return DATA.levels[3].color;
    };

    ["N1","N2","N3"].forEach(n=>{
      const el = document.getElementById(n);
      if(el) el.setAttribute("fill", colorFor(worst[n]));
    });
  }

  function renderGlobal(){
    const un = totalUntransferred();
    const b = globalBand(un);
    pGlobal.textContent = `Global: ${b.label}`;
    pUn.textContent = `No transferido: ${un}`;

    const badge = badgeForBand(b.key);

    resBox.style.display = "block";
    resBox.innerHTML = `
      <div class="row">
        <div>
          <span class="badge ${badge}">${escapeHtml(b.label)}</span>
          <div class="muted" style="margin-top:6px;font-size:13px;">Carga no transferida: <b>${un}</b></div>
          <div class="muted" style="margin-top:4px;font-size:13px;">${escapeHtml(b.summary)}</div>
        </div>
      </div>
      <div style="margin-top:10px;border-left:3px solid rgba(94,234,212,.45);background:rgba(94,234,212,.06);padding:10px 12px;border-radius:12px;">
        <div style="font-style:italic;">${escapeHtml(b.verse.quote)}</div>
        <div class="muted" style="margin-top:6px;">(${escapeHtml(b.verse.reference)})</div>
      </div>
    `;

    btnTxt.disabled = (state.placed.length===0);
    btnPdf.disabled = (state.placed.length===0) || !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  function render(){
    renderLegend();
    renderRows();
    renderArrows();
    paintNodesByLoad();
    updateEqPanel();
    renderGlobal();
    save();
  }

  // ====== TRANSFERENCIA DIDÁCTICA (líneas guía) ======
  function hideAllRoutes(){
    Object.values(route).forEach(el=>{
      if(!el) return;
      el.style.opacity = "0";
    });
  }

  function showRouteForStep(from, to){
    hideAllRoutes();

    // show dots
    const dotMap = {
      beam: route.dot_beam,
      joint: route.dot_joint,
      roller: route.dot_roller,
      column: route.dot_column,
      foundation: route.dot_foundation
    };

    const d1 = dotMap[from];
    const d2 = dotMap[to];
    if(d1) d1.style.opacity = "1";
    if(d2) d2.style.opacity = "1";

    // show corresponding line
    if(from==="beam" && to==="column" && route.beam_column) route.beam_column.style.opacity="1";
    if(from==="joint" && to==="column" && route.joint_column) route.joint_column.style.opacity="1";
    if(from==="roller" && to==="beam" && route.roller_beam) route.roller_beam.style.opacity="1";
    if(from==="column" && to==="foundation" && route.column_foundation) route.column_foundation.style.opacity="1";
  }

  async function blinkRoute(from,to){
    showRouteForStep(from,to);
    await new Promise(r=>setTimeout(r, 520));
    hideAllRoutes();
  }

  // ====== SIMULACIÓN (deformación) ======
  function setStable(){
    frameEl.setAttribute("transform", "translate(0 0) rotate(0 140 300)");
    crackEl.setAttribute("opacity","0");
    crackEl.setAttribute("d","");
  }

  function setUnstable(){
    const eq = computeEquations();

    // deriva horizontal: depende de Fx
    const dx = Math.min(30, eq.Fx * 0.25);

    // rotación/momento: depende de M (sísmica pesa más porque M la incluye con boost)
    const rot = Math.max(-9, Math.min(9, eq.M * 0.03));

    frameEl.setAttribute("transform", `translate(${dx} 0) rotate(${rot} 140 300)`);

    // fisura: depende de M + Fy
    const intensity = (eq.M + eq.Fy*0.35);
    const show = intensity >= 40 ? 1 : (intensity>=22 ? 0.6 : 0);
    crackEl.setAttribute("opacity", String(show));
    if(show>0){
      crackEl.setAttribute("d", "M 110 340 L 130 320 L 120 305 L 150 290 L 140 275");
    } else {
      crackEl.setAttribute("d","");
    }
  }

  function simulate(mode){
    if(mode==="no"){
      liveMode.textContent = "Modo: SIN transferencia (deriva + fisuras)";
      setUnstable();
    }else{
      liveMode.textContent = "Modo: CON transferencia (estable)";
      setStable();
    }
  }

  // ====== CRUD ======
  function addLoad(){
    const type = typeEl.value;
    const t = loadTypeByKey(type);

    let zone = zoneEl.value;
    if(type==="sismica" && !zone) zone = (t.defaultZone || "joint");

    const min = DATA.render.magnitudes.min;
    const max = DATA.render.magnitudes.max;
    const mag = Math.max(min, Math.min(max, Number(magEl.value || t.defaultMagnitude || 10)));
    const name = (nameEl.value || "").trim();

    state.placed.unshift({
      id: uid(),
      name,
      type,
      mag,
      zone,
      createdAt: new Date().toISOString()
    });

    resetForm();
    render();
  }

  function clearScenario(){
    if(!confirm("¿Vaciar escenario completo?")) return;
    state.placed = [];
    hideAllRoutes();
    setStable();
    render();
    simulate("yes");
  }

  async function transferOneStep(id, showGuide){
    const p = state.placed.find(x=>x.id===id);
    if(!p) return;
    if(p.zone==="foundation") return;

    const from = p.zone;
    const to = DATA.transferGraph[p.zone] || null;
    if(!to) return;

    if(showGuide) await blinkRoute(from,to);

    p.zone = to;
    renderArrows();
    paintNodesByLoad();
    updateEqPanel();
    renderGlobal();
    save();
  }

  function lockUI(isLocked){
    ["btnAdd","btnResetForm","btnSimNo","btnSimYes","btnTransferAll","btnClear","btnTxt","btnPdf"]
      .forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.disabled = !!isLocked;
      });
  }

  async function transferAllAnimated(){
    if(state.placed.length===0){
      alert("No hay flechas colocadas.");
      return;
    }

    lockUI(true);
    liveMode.textContent = "Modo: Transferencia (guía + animación)";

    // animación por rondas
    for(let round=0; round<12; round++){
      let moved = 0;

      // mostrar guía por cada tipo de paso presente (didáctico)
      const stepsPresent = new Set();
      state.placed.forEach(p=>{
        if(p.zone==="foundation") return;
        const to = DATA.transferGraph[p.zone];
        if(to) stepsPresent.add(p.zone + "->" + to);
      });

      // reproducir guías principales presentes
      for(const s of stepsPresent){
        const [from,to] = s.split("->");
        await blinkRoute(from,to);
      }

      // mover todos 1 paso
      state.placed.forEach(p=>{
        if(p.zone==="foundation") return;
        const to = DATA.transferGraph[p.zone];
        if(to){
          p.zone = to;
          moved++;
        }
      });

      renderArrows();
      paintNodesByLoad();
      updateEqPanel();
      renderGlobal();
      save();

      if(moved===0) break;
      await new Promise(r=>setTimeout(r, 520));
    }

    hideAllRoutes();
    simulate("yes");
    lockUI(false);
  }

  // ====== TXT/PDF (se mantiene como antes, TXT incluido) ======
  function buildTXT(){
    const L = [];
    L.push((DATA.meta.title||"SIMULADOR").toUpperCase());
    L.push("");
    L.push("DATOS");
    L.push(`Paciente: ${patientEl.value || "(no especificado)"}`);
    L.push(`Auditor: ${auditorEl.value || "(no especificado)"}`);
    L.push(`Fecha: ${dateEl.value || "(no especificada)"}`);
    L.push("Observaciones:");
    L.push(notesEl.value || "(sin observaciones)");
    L.push("");

    const un = totalUntransferred();
    const eq = computeEquations();
    const b = globalBand(un);

    L.push("ECUACIONES");
    L.push(`∑Fy: ${eq.Fy}`);
    L.push(`∑Fx: ${eq.Fx}`);
    L.push(`∑M : ${eq.M}`);
    L.push("");

    L.push("RESULTADO GLOBAL");
    L.push(`No transferido: ${un}`);
    L.push(`Banda: ${b.label}`);
    L.push(b.summary);
    L.push(`${b.verse.quote} (${b.verse.reference})`);
    L.push("");

    L.push("FLECHAS COLOCADAS");
    L.push("--------------------------------------------------");
    state.placed.forEach(p=>{
      const t = loadTypeByKey(p.type);
      L.push(`- ${p.name || "(sin nombre)"} | Tipo: ${t.label} | Magnitud: ${p.mag} | Zona: ${zoneTitle(p.zone)}`);
    });

    return L.join("\n");
  }

  function downloadTXT(){
    const txt = buildTXT();
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_cargas.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function svgToDataUrl(svgEl){
    const clone = svgEl.cloneNode(true);
    clone.setAttribute("xmlns","http://www.w3.org/2000/svg");
    const svgText = new XMLSerializer().serializeToString(clone);
    const blob = new Blob([svgText], {type:"image/svg+xml;charset=utf-8"});
    return URL.createObjectURL(blob);
  }

  async function downloadPDF(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    // portada
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,90,"F");
    addLogo(W-M-54, 18, 54, 54);

    doc.setFont("helvetica","bold");
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("SIMULADOR DE CARGAS DEL HOGAR", M, 52);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(210,230,255);
    doc.text("Captura del escenario + ∑Fy/∑Fx/∑M", M, 74);

    // datos
    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 110, W-M*2, 118, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 135);
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${patientEl.value || "(no especificado)"}`, M+14, 160);
    doc.text(`Auditor: ${auditorEl.value || "(no especificado)"}`, M+14, 180);
    doc.text(`Fecha: ${dateEl.value || "(no especificada)"}`, M+14, 200);

    const un = totalUntransferred();
    const eq = computeEquations();
    const band = globalBand(un);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 240, W-M*2, 110, 12, 12, "F");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text(`Global: ${band.label}`, M+14, 268);
    doc.setFont("helvetica","normal");
    doc.setFontSize(10.5);
    doc.text(doc.splitTextToSize(`No transferido: ${un} · ∑Fy=${eq.Fy} · ∑Fx=${eq.Fx} · ∑M=${eq.M}`, W-M*2-28), M+14, 288);
    doc.text(doc.splitTextToSize(band.summary, W-M*2-28), M+14, 312);

    // captura
    const svg = document.getElementById("svg");
    const url = svgToDataUrl(svg);

    const img = new Image();
    img.crossOrigin = "anonymous";
    await new Promise(resolve=>{
      img.onload = resolve;
      img.onerror = resolve;
      img.src = url;
    });

    const canvas = document.createElement("canvas");
    canvas.width = 1200;
    canvas.height = 800;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    URL.revokeObjectURL(url);

    const png = canvas.toDataURL("image/png");

    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...INK);
    doc.text("Captura del escenario", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const imgW = W - M*2;
    const imgH = (imgW * canvas.height) / canvas.width;
    doc.addImage(png, "PNG", M, 90, imgW, Math.min(imgH, H-140));

    const n = doc.getNumberOfPages();
    for(let i=1;i<=n;i++){
      doc.setPage(i);
      doc.setFont("helvetica","normal");
      doc.setFontSize(9);
      doc.setTextColor(...MUTED);
      doc.text("Simulador de Cargas — Hogar como Sistema Estructural", M, H-18);
      doc.text(`Página ${i} de ${n}`, W-M, H-18, {align:"right"});
    }

    doc.save("simulador_cargas.pdf");
  }

  function resetHeaderSave(){
    save();
    renderGlobal();
  }

  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();

      tEl.textContent = DATA.meta.title || "Simulador de Cargas del Hogar";
      dEl.textContent = DATA.meta.description || "";

      setupSelects();
      setDefaultDateIfEmpty();

      load();
      fillHeaderUI();

      renderLegend();
      resetForm();
      hideAllRoutes();
      setStable();
      render();
      simulate("yes");

      pdfWarn.style.display = okPdfLib() ? "none" : "block";
    }catch(e){
      document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${escapeHtml(e.message)}<br>
        <span style="color:#a7b4d6">Asegúrate de que <b>${JSON_PATH}</b> esté en la misma carpeta.</span></div>`;
    }
  }

  // events
  document.getElementById("btnAdd").addEventListener("click", addLoad);
  document.getElementById("btnResetForm").addEventListener("click", resetForm);
  document.getElementById("btnClear").addEventListener("click", clearScenario);

  document.getElementById("btnSimNo").addEventListener("click", ()=> simulate("no"));
  document.getElementById("btnSimYes").addEventListener("click", ()=> simulate("yes"));
  document.getElementById("btnTransferAll").addEventListener("click", transferAllAnimated);

  document.getElementById("btnTxt").addEventListener("click", downloadTXT);
  document.getElementById("btnPdf").addEventListener("click", downloadPDF);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", resetHeaderSave);
    el.addEventListener("change", resetHeaderSave);
  });

  typeEl.addEventListener("change", ()=>{
    const t = loadTypeByKey(typeEl.value);
    magEl.value = String(t.defaultMagnitude || 10);
    if(typeEl.value==="sismica") zoneEl.value = (t.defaultZone || "joint");
  });

  init();
</script>
</body>
</html>