<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas del Hogar</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;margin-right:8px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    label{font-weight:800;font-size:13px;}
    input, textarea, select{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:92px;resize:vertical;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);cursor:grab;user-select:none;
    }
    .chip:active{cursor:grabbing;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .canvasBox{border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03);padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .danger{color:#fda4af;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Simulador de Cargas del Hogar</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill">Arrastrar y soltar</span>
      <span class="pill">Transferida / No transferida</span>
      <span class="pill" id="pCount">Cargas activas: 0</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- IZQ -->
    <div class="card">
      <div class="row">
        <b>Cabecera</b>
        <span class="pill">LocalStorage</span>
      </div>

      <div class="fieldgrid">
        <div>
          <label>Paciente / hogar</label>
          <input id="patient" placeholder="Ej: Hogar Abraham y Sara">
        </div>
        <div>
          <label>Auditor</label>
          <input id="auditor" placeholder="Ej: Consejero / Pastor">
        </div>
        <div>
          <label>Fecha</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Observaciones</label>
          <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
        </div>
      </div>

      <div class="mini">
        <h3>Biblioteca de cargas (arrástralas al pórtico)</h3>
        <div class="muted" style="font-size:13px;margin-bottom:10px" id="libHint"></div>
        <div id="library" style="display:grid;gap:10px;"></div>
      </div>

      <div class="btns">
        <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
        <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
        <button class="ghost" id="btnClear">Quitar todas</button>
        <button class="ghost" id="btnReset">Borrar todo</button>
      </div>

      <div class="mini">
        <h3>Notas del laboratorio</h3>
        <ul class="muted" id="tips" style="margin:0;padding-left:18px;line-height:1.45;"></ul>
      </div>
    </div>

    <!-- DER -->
    <div class="card">
      <div class="row">
        <div>
          <b>Escenario del pórtico</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">Suelta cargas sobre zonas: Viga / Columna / Nudo / Cimiento / Apoyo.</div>
        </div>
        <span class="pill" id="globalPill">Global: —</span>
      </div>

      <div class="canvasBox" style="margin-top:10px;">
        <canvas id="sim" width="720" height="420" style="width:100%;height:auto;display:block;"></canvas>

        <div class="legend">
          <div class="k"><span class="dot" style="background:var(--g)"></span>Estable</div>
          <div class="k"><span class="dot" style="background:var(--y)"></span>En ajuste</div>
          <div class="k"><span class="dot" style="background:var(--o)"></span>En riesgo</div>
          <div class="k"><span class="dot" style="background:var(--r)"></span>Crítico</div>
        </div>
      </div>

      <div class="mini" id="metrics"></div>

      <div class="mini">
        <h3>Cargas activas</h3>
        <div style="overflow:auto;border:1px solid var(--line);border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th>Carga</th>
                <th>Dir.</th>
                <th>Magnitud</th>
                <th>Destino</th>
                <th>Transferencia</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="muted" style="font-size:13px;margin-top:8px;">
          Tip: “No transferida” aumenta momento/deriva/fisura (concentración de esfuerzo).
        </div>
      </div>

      <div class="mini">
        <h3>Recomendaciones automáticas</h3>
        <div class="muted" id="reco"></div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "simulador.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "simulador_cargas_v1";

  let DATA=null;
  let logoDataUrl=null;

  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    loads: [] // instances: {id,key,label,direction,magnitude,target,transfer,x,y,createdAt}
  };

  // UI
  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const pCount = document.getElementById("pCount");
  const globalPill = document.getElementById("globalPill");
  const pdfWarn = document.getElementById("pdfWarn");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");

  const libraryEl = document.getElementById("library");
  const tipsEl = document.getElementById("tips");
  const libHintEl = document.getElementById("libHint");
  const metricsEl = document.getElementById("metrics");
  const rowsEl = document.getElementById("rows");
  const recoEl = document.getElementById("reco");

  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");

  // Canvas
  const canvas = document.getElementById("sim");
  const ctx = canvas.getContext("2d");

  // Zones (canvas coords)
  const Z = {
    foundation: {id:"foundation", label:"Cimiento", x:120,y:340,w:180,h:50},
    column:     {id:"column", label:"Columna", x:190,y:140,w:26,h:200},
    beam:       {id:"beam", label:"Viga", x:205,y:140,w:310,h:24},
    joint:      {id:"joint", label:"Nudo", x:188,y:136,w:40,h:40},
    roller:     {id:"roller", label:"Apoyo móvil", x:520,y:155,w:60,h:55}
  };

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) &&
      !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const p = JSON.parse(raw);
      if(p.header) state.header = p.header;
      if(Array.isArray(p.loads)) state.loads = p.loads;
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  function uid(){
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2));
  }

  function enumLabel(list, key){
    const it = list.find(x=>x.key===key);
    return it ? it.label : key;
  }

  function dirArrow(dir){
    return dir==="horizontal" ? "→" : "↓";
  }

  function addInstance(loadKey){
    const base = DATA.loadsLibrary.find(x=>x.key===loadKey);
    if(!base) return;
    const inst = {
      id: uid(),
      key: base.key,
      label: base.label,
      direction: base.direction,
      magnitude: Number(base.magnitude||1),
      target: base.defaultTarget || "beam",
      transfer: true,
      x: 60 + Math.random()*80,
      y: 80 + Math.random()*220,
      createdAt: new Date().toISOString()
    };

    snapToTarget(inst, inst.target);
    state.loads.unshift(inst);
    save();
    render();
  }

  function snapToTarget(inst, target){
    const z = Z[target] || Z.beam;
    inst.target = target;
    inst.x = z.x + z.w/2;
    inst.y = z.y + z.h/2;
  }

  function deleteInstance(id){
    if(!confirm("¿Quitar esta carga del escenario?")) return;
    state.loads = state.loads.filter(x=>x.id!==id);
    save();
    render();
  }

  function toggleTransfer(id){
    const l = state.loads.find(x=>x.id===id);
    if(!l) return;
    l.transfer = !l.transfer;
    save();
    render();
  }

  function detectTarget(x,y){
    for(const k of Object.keys(Z)){
      const z = Z[k];
      if(x>=z.x && x<=z.x+z.w && y>=z.y && y<=z.y+z.h) return z.id;
    }
    return null;
  }

  // ===== Physics-ish scoring (simple but pedagogical) =====
  function compute(){
    let V=0, H=0, M=0, drift=0;
    const stress = {foundation:0,column:0,beam:0,joint:0,roller:0};
    let cracks = 0;

    state.loads.forEach(l=>{
      const mag = Number(l.magnitude||0);
      const penalty = l.transfer ? 1.0 : 1.6; // no transfer -> concentrate
      const t = l.target;

      if(l.direction==="vertical"){
        V += mag;
        // moment depends on how far on beam side (simulate lever)
        const lever = (t==="beam"||t==="roller") ? 1.0 : (t==="joint" ? 0.6 : 0.3);
        M += mag * 6 * lever * penalty;

        stress[t] += mag * 6 * penalty;
        if(!l.transfer && (t==="beam"||t==="column")) cracks += 1;
      }else{
        H += mag;
        drift += mag * (t==="joint" ? 1.2 : (t==="beam" ? 1.0 : 0.7)) * penalty;
        M += mag * 10 * (t==="beam" ? 1.0 : 0.7) * penalty;

        stress[t] += mag * 7 * penalty;
        if(!l.transfer) cracks += 1;
        if(t==="roller" && !l.transfer) cracks += 1; // rigidez en apoyo móvil
      }

      // transfer reduces column/foundation stress by design
      if(l.transfer){
        if(t==="beam"||t==="joint") stress.column += mag * 2;
        if(t==="beam"||t==="joint"||t==="column") stress.foundation += mag * 1.5;
        if(t==="roller") stress.roller += mag * 1.2;
      }else{
        // if not transferred, foundation receives less and system drifts more
        drift += mag * 0.8;
      }
    });

    // normalize some indicators
    M = Math.round(M);
    drift = Math.round(drift);
    cracks = Math.min(12, cracks);

    // global band by worst indicator
    const T = DATA.thresholds;
    const riskPoints =
      (V>=T.verticalRisk?2: V>=T.verticalWarn?1:0) +
      (H>=T.horizontalRisk?2: H>=T.horizontalWarn?1:0) +
      (M>=T.momentRisk?2: M>=T.momentWarn?1:0) +
      (drift>=T.driftRisk?2: drift>=T.driftWarn?1:0) +
      (cracks>=6?2: cracks>=3?1:0);

    let global = {key:"low", label:"Estable", color:getCss("--g")};
    if(riskPoints>=7) global = {key:"high", label:"Crítico", color:getCss("--r")};
    else if(riskPoints>=4) global = {key:"mid2", label:"En riesgo", color:getCss("--o")};
    else if(riskPoints>=2) global = {key:"mid1", label:"En ajuste", color:getCss("--y")};

    // stress caps
    Object.keys(stress).forEach(k=> stress[k] = Math.min(100, Math.round(stress[k])));

    return {V,H,M,drift,cracks,stress,global};
  }

  function getCss(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  // ===== Draw =====
  function drawScene(){
    const m = compute();
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background
    ctx.fillStyle = "rgba(255,255,255,.03)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // ground
    ctx.fillStyle = "rgba(255,255,255,.05)";
    ctx.fillRect(0,380,canvas.width,40);

    // helper: zone color by stress
    function stressColor(s){
      if(s>=75) return getCss("--r");
      if(s>=55) return getCss("--o");
      if(s>=35) return getCss("--y");
      return "rgba(255,255,255,.12)";
    }

    // foundation
    fillRoundRect(Z.foundation.x, Z.foundation.y, Z.foundation.w, Z.foundation.h, 10, stressColor(m.stress.foundation));
    label(Z.foundation.x+Z.foundation.w/2, Z.foundation.y+32, "CIMIENTO");

    // column
    fillRoundRect(Z.column.x, Z.column.y, Z.column.w, Z.column.h, 10, stressColor(m.stress.column));
    label(Z.column.x+Z.column.w/2, Z.column.y-12, "COLUMNA (VARÓN)");

    // beam
    fillRoundRect(Z.beam.x, Z.beam.y, Z.beam.w, Z.beam.h, 10, stressColor(m.stress.beam));
    label(Z.beam.x+Z.beam.w/2, Z.beam.y-12, "VIGA (MUJER)");

    // roller
    ctx.fillStyle = stressColor(m.stress.roller);
    ctx.strokeStyle = "rgba(255,255,255,.22)";
    ctx.lineWidth = 2;
    circle(Z.roller.x+30, Z.roller.y+20, 14, true);
    fillRoundRect(Z.roller.x+10, Z.roller.y+38, 40, 10, 6, "rgba(255,255,255,.08)");
    label(Z.roller.x+30, Z.roller.y+70, "APOYO MÓVIL");

    // joint (visual marker)
    ctx.fillStyle = stressColor(m.stress.joint);
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    fillRoundRect(Z.joint.x, Z.joint.y, Z.joint.w, Z.joint.h, 10, ctx.fillStyle);
    label(Z.joint.x+Z.joint.w/2, Z.joint.y+58, "NUDO");

    // nodes circles
    node(Z.foundation.x+70, Z.foundation.y-6, "1");
    node(Z.joint.x+20, Z.joint.y+10, "2");
    node(Z.roller.x+30, Z.roller.y+20, "3");

    // global label
    ctx.font = "bold 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = m.global.color;
    ctx.fillText("GLOBAL: " + m.global.label, 24, 34);

    // metrics quick
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(231,238,252,.85)";
    ctx.fillText(`V=${m.V}  H=${m.H}  M=${m.M}  Deriva=${m.drift}  Fisuras=${m.cracks}`, 24, 58);

    // draw loads instances
    state.loads.forEach(l=>{
      drawLoadToken(l);
    });

    // fisuras indicator
    if(m.cracks>0){
      ctx.fillStyle = "rgba(244,63,94,.12)";
      fillRoundRect(520, 16, 180, 46, 12, ctx.fillStyle);
      ctx.fillStyle = getCss("--r");
      ctx.font = "bold 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("FISURAS DETECTADAS: " + m.cracks, 534, 44);
    }

    function fillRoundRect(x,y,w,h,r,fill){
      ctx.fillStyle = fill;
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    function label(x,y,text){
      ctx.textAlign = "center";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(231,238,252,.75)";
      ctx.fillText(text, x, y);
      ctx.textAlign = "left";
    }

    function circle(cx,cy,r,stroke){
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.closePath();
      ctx.fill();
      if(stroke) ctx.stroke();
    }

    function node(cx,cy,num){
      ctx.fillStyle = "rgba(100,116,139,.85)";
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 2;
      circle(cx,cy,12,true);
      ctx.fillStyle = "rgba(231,238,252,.92)";
      ctx.font = "bold 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillText(num, cx, cy+4);
      ctx.textAlign = "left";
    }
  }

  function drawLoadToken(l){
    const isH = l.direction==="horizontal";
    const base = isH ? "rgba(94,234,212,.20)" : "rgba(255,255,255,.10)";
    const strong = l.transfer ? "rgba(16,185,129,.85)" : "rgba(244,63,94,.85)";

    // token
    ctx.fillStyle = base;
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 1;
    roundToken(l.x, l.y, 120, 34, 12);

    // label
    ctx.font = "bold 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(231,238,252,.95)";
    ctx.fillText(`${dirArrow(l.direction)} ${l.label}`, l.x-52, l.y+4);

    // magnitude + transfer dot
    ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(167,180,214,.95)";
    ctx.fillText(`Mag ${l.magnitude}`, l.x+40, l.y+4);

    ctx.fillStyle = strong;
    ctx.beginPath();
    ctx.arc(l.x+58, l.y-10, 6, 0, Math.PI*2);
    ctx.fill();

    function roundToken(cx,cy,w,h,r){
      const x = cx - w/2, y = cy - h/2;
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }
  }

  // ===== Dragging on canvas =====
  let draggingId=null;
  let dragOffset = {dx:0, dy:0};

  function hitToken(mx,my){
    // tokens are about 120x34
    for(const l of state.loads){
      const x0 = l.x - 60, x1 = l.x + 60;
      const y0 = l.y - 17, y1 = l.y + 17;
      if(mx>=x0 && mx<=x1 && my>=y0 && my<=y1) return l.id;
    }
    return null;
  }

  function pointerPos(evt){
    const rect = canvas.getBoundingClientRect();
    const sx = canvas.width / rect.width;
    const sy = canvas.height / rect.height;
    return {x:(evt.clientX-rect.left)*sx, y:(evt.clientY-rect.top)*sy};
  }

  canvas.addEventListener("pointerdown", (e)=>{
    const p = pointerPos(e);
    const id = hitToken(p.x,p.y);
    if(!id) return;
    const l = state.loads.find(x=>x.id===id);
    draggingId = id;
    dragOffset.dx = p.x - l.x;
    dragOffset.dy = p.y - l.y;
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!draggingId) return;
    const p = pointerPos(e);
    const l = state.loads.find(x=>x.id===draggingId);
    if(!l) return;
    l.x = p.x - dragOffset.dx;
    l.y = p.y - dragOffset.dy;
    drawScene();
  });

  canvas.addEventListener("pointerup", (e)=>{
    if(!draggingId) return;
    const p = pointerPos(e);
    const l = state.loads.find(x=>x.id===draggingId);
    draggingId = null;
    if(!l){ drawScene(); return; }

    const t = detectTarget(p.x,p.y);
    if(t) snapToTarget(l, t);

    save();
    render();
  });

  // ===== Library (drag from list => create instance) =====
  function renderLibrary(){
    libraryEl.innerHTML = "";
    DATA.loadsLibrary.forEach(item=>{
      const div = document.createElement("div");
      div.className = "chip";
      div.draggable = true;
      div.innerHTML = `
        <div style="font-weight:900">${dirArrow(item.direction)} ${item.label}</div>
        <span class="tag">${enumLabel(DATA.enums.direction, item.direction)}</span>
        <span class="tag">Mag ${item.magnitude}</span>
      `;
      div.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", item.key);
      });
      div.title = item.hint || "";
      libraryEl.appendChild(div);
    });

    // drop onto canvas = add instance near cursor, snap to default target
    canvas.addEventListener("dragover", (e)=> e.preventDefault());
    canvas.addEventListener("drop", (e)=>{
      e.preventDefault();
      const key = e.dataTransfer.getData("text/plain");
      if(!key) return;
      addInstance(key);
    });
  }

  function bandForMetric(val, warn, risk){
    if(val>=risk) return {k:"crit", label:"Crítico", color:getCss("--r")};
    if(val>=warn) return {k:"risk", label:"En riesgo", color:getCss("--o")};
    if(val>0) return {k:"adj", label:"En ajuste", color:getCss("--y")};
    return {k:"ok", label:"Estable", color:getCss("--g")};
  }

  function renderMetrics(){
    const m = compute();
    pCount.textContent = `Cargas activas: ${state.loads.length}`;

    const T = DATA.thresholds;
    const bV = bandForMetric(m.V, T.verticalWarn, T.verticalRisk);
    const bH = bandForMetric(m.H, T.horizontalWarn, T.horizontalRisk);
    const bM = bandForMetric(m.M, T.momentWarn, T.momentRisk);
    const bD = bandForMetric(m.drift, T.driftWarn, T.driftRisk);

    globalPill.textContent = `Global: ${m.global.label}`;

    metricsEl.innerHTML = `
      <h3>Indicadores</h3>
      <div class="muted" style="line-height:1.6">
        <b style="color:${bV.color}">Peso vertical:</b> ${m.V} &nbsp;·&nbsp;
        <b style="color:${bH.color}">Fuerza horizontal:</b> ${m.H} &nbsp;·&nbsp;
        <b style="color:${bM.color}">Momento:</b> ${m.M} &nbsp;·&nbsp;
        <b style="color:${bD.color}">Deriva:</b> ${m.drift} &nbsp;·&nbsp;
        <b class="${m.cracks>=6?'danger':''}">Fisuras:</b> ${m.cracks}
      </div>
      <div class="muted" style="margin-top:8px;font-size:13px;">
        Stress (0–100): Cimiento ${m.stress.foundation} · Columna ${m.stress.column} · Viga ${m.stress.beam} · Nudo ${m.stress.joint} · Apoyo ${m.stress.roller}
      </div>
    `;

    // recommendations
    const R = DATA.texts.recommendations;
    const list = (m.global.key==="high") ? R.high : (m.global.key==="mid2"||m.global.key==="mid1") ? R.mid : R.low;
    recoEl.innerHTML = "<ul style='margin:0;padding-left:18px;line-height:1.45'>" + list.map(x=>`<li>${escapeHtml(x)}</li>`).join("") + "</ul>";
  }

  function renderRows(){
    rowsEl.innerHTML = "";
    const has = state.loads.length>0;
    btnTxt.disabled = !has;
    btnPdf.disabled = !has || !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";

    state.loads.forEach(l=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(l.label)}</b><div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(l.key)}</div></td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.direction,l.direction))}</span></td>
        <td><b>${l.magnitude}</b></td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.targets, l.target))}</span></td>
        <td>
          <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-t="${l.id}">
            ${l.transfer ? "Transferida ✅" : "No transferida ⚠️"}
          </button>
        </td>
        <td>
          <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del="${l.id}">Quitar</button>
        </td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=> deleteInstance(b.getAttribute("data-del")));
    });
    rowsEl.querySelectorAll("[data-t]").forEach(b=>{
      b.addEventListener("click", ()=> toggleTransfer(b.getAttribute("data-t")));
    });
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function render(){
    drawScene();
    renderMetrics();
    renderRows();
  }

  function buildTXT(){
    const m = compute();
    const L = [];
    L.push((DATA.meta.title||"SIMULADOR DE CARGAS").toUpperCase());
    L.push("");
    L.push(`Paciente: ${patientEl.value || "(no especificado)"}`);
    L.push(`Auditor: ${auditorEl.value || "(no especificado)"}`);
    L.push(`Fecha: ${dateEl.value || "(no especificada)"}`);
    L.push("");
    L.push("INDICADORES");
    L.push(`Global: ${m.global.label}`);
    L.push(`Peso vertical: ${m.V}`);
    L.push(`Fuerza horizontal: ${m.H}`);
    L.push(`Momento: ${m.M}`);
    L.push(`Deriva: ${m.drift}`);
    L.push(`Fisuras: ${m.cracks}`);
    L.push("");
    L.push("CARGAS ACTIVAS");
    L.push("--------------------------------------------------");
    state.loads.forEach(l=>{
      L.push(`- ${l.label} (${l.key})`);
      L.push(`  Dirección: ${enumLabel(DATA.enums.direction,l.direction)} | Magnitud: ${l.magnitude}`);
      L.push(`  Destino: ${enumLabel(DATA.enums.targets,l.target)} | Transferencia: ${l.transfer ? "Transferida" : "No transferida"}`);
      L.push("");
    });
    L.push("OBSERVACIONES");
    L.push(notesEl.value || "(sin observaciones)");
    return L.join("\n");
  }

  function downloadTxt(){
    const txt = buildTXT();
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_cargas.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeName(name){
    return (name||"simulador")
      .toLowerCase().replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  async function downloadPdf(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const m = compute();
    const scenarioImg = canvas.toDataURL("image/png", 1.0);

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Simulador de Cargas del Hogar — Laboratorio", M, H-18);
        doc.text(`Página ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // portada
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("SIMULADOR DE CARGAS DEL HOGAR", M, 52);
    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Captura del escenario + indicadores + listado", M, 74);

    // datos
    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 120, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${patientEl.value || "(no especificado)"}`, M+14, 172);
    doc.text(`Auditor: ${auditorEl.value || "(no especificado)"}`, M+14, 192);
    doc.text(`Fecha: ${dateEl.value || "(no especificada)"}`, M+14, 212);

    // indicadores
    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 255, W-M*2, 90, 12, 12, "F");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text(`Global: ${m.global.label}`, M+14, 282);
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`V=${m.V}  H=${m.H}  Momento=${m.M}  Deriva=${m.drift}  Fisuras=${m.cracks}`, M+14, 306);

    // escenario (imagen)
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text("Captura del escenario", M, 372);

    const imgW = W - M*2;
    const imgH = imgW * (canvas.height / canvas.width);
    doc.addImage(scenarioImg, "PNG", M, 385, imgW, Math.min(imgH, 320));

    // tabla cargas
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Listado de cargas activas", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.autoTable({
      startY: 90,
      head: [["Carga", "Dir.", "Mag", "Destino", "Transferencia"]],
      body: state.loads.map(l=>[
        l.label,
        enumLabel(DATA.enums.direction, l.direction),
        String(l.magnitude),
        enumLabel(DATA.enums.targets, l.target),
        l.transfer ? "Transferida" : "No transferida"
      ]),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      margin:{left:M, right:M}
    });

    // observaciones
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Observaciones", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 96, W-M*2, 520, 12, 12, "F");
    doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(...INK);
    const notes = notesEl.value || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, 122);

    footer();
    doc.save(`${safeName(patientEl.value||"hogar")}_simulador.pdf`);
  }

  function clearLoads(){
    if(!confirm("¿Quitar todas las cargas del escenario?")) return;
    state.loads = [];
    save();
    render();
  }

  function resetAll(){
    if(!confirm("¿Borrar TODO (cabecera + cargas guardadas)?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.header = {patient:"",auditor:"",date:"",notes:""};
    state.loads = [];
    fillHeaderUI();
    setDefaultDateIfEmpty();
    save();
    render();
  }

  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();

      tEl.textContent = DATA.meta.title || "Simulador de Cargas";
      dEl.textContent = DATA.meta.description || "";
      libHintEl.textContent = "Arrastra una carga hacia el pórtico. Luego puedes moverla y cambiar si está transferida o no.";

      tipsEl.innerHTML = "";
      (DATA.texts.notes||[]).forEach(x=>{
        const li = document.createElement("li");
        li.textContent = x;
        tipsEl.appendChild(li);
      });

      setDefaultDateIfEmpty();
      loadLocal();
      fillHeaderUI();
      if(!dateEl.value) setDefaultDateIfEmpty();

      renderLibrary();
      pdfWarn.style.display = okPdfLib() ? "none" : "block";
      render();

    }catch(e){
      document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${e.message}<br><span style="color:#a7b4d6">Asegúrate de que ${JSON_PATH} esté en la misma carpeta.</span></div>`;
    }
  }

  // events
  document.getElementById("btnTxt").addEventListener("click", downloadTxt);
  document.getElementById("btnPdf").addEventListener("click", downloadPdf);
  document.getElementById("btnClear").addEventListener("click", clearLoads);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });

  init();
</script>
</body>
</html>