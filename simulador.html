<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas del Hogar</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:560px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, select, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}
    .table{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .premium{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px; margin-top:10px;
    }
    .premiumBox{
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px; padding:10px 12px;
      background:rgba(0,0,0,.10);
    }
    .big{font-weight:950; font-size:18px;}
    .bigNum{font-weight:950; font-size:22px; letter-spacing:.3px;}
    .stateBad{color:#fda4af;}
    .stateGood{color:#34d399;}
    .stateWarn{color:#fcd34d;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Simulador de Cargas del Hogar</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill">Laboratorio didáctico (sin servidor)</span>
      <span class="pill" id="pCount">Cargas: 0</span>
      <span class="pill" id="modePill">Modo: —</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- IZQ: DIAGRAMA / SIMULACION -->
    <div class="card">
      <div class="row">
        <div>
          <b>Simulación del pórtico</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            Flechas por carga (color por tipo + magnitud). Sísmica = flecha horizontal en el nudo.
          </div>
        </div>
        <span class="pill" id="liveState">Estado: —</span>
      </div>

      <div class="svgBox" style="margin-top:10px;">
        <svg id="svg" viewBox="0 0 560 390" width="100%" height="auto" aria-label="Pórtico simulable">
          <!-- base -->
          <rect x="0" y="340" width="560" height="50" fill="rgba(255,255,255,.05)"></rect>

          <!-- frame group (we transform this for “deriva”) -->
          <g id="frame">
            <!-- foundation -->
            <rect id="foundation" x="70" y="300" width="150" height="40" rx="10"
              fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"></rect>
            <text x="145" y="325" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">CIMIENTO (CRISTO)</text>

            <!-- column -->
            <rect id="column" x="135" y="90" width="22" height="210" rx="10"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="146" y="80" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">COLUMNA (VARÓN)</text>

            <!-- beam -->
            <rect id="beam" x="146" y="90" width="290" height="18" rx="9"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="290" y="75" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">VIGA (MUJER)</text>

            <!-- roller support -->
            <circle id="rollerBase" cx="436" cy="110" r="11"
              fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"></circle>
            <rect x="412" y="123" width="48" height="10" rx="4" fill="rgba(255,255,255,.08)"></rect>
            <text x="436" y="155" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">INTERSECCIÓN</text>

            <!-- joint node -->
            <circle id="joint" cx="146" cy="99" r="10" fill="#64748b"></circle>
            <text x="162" y="103" font-size="12" fill="rgba(255,255,255,.75)">NUDO</text>

            <!-- crack (fisura) -->
            <path id="crack" d="" stroke="#fb7185" stroke-width="3" fill="none" opacity="0"></path>
          </g>

          <!-- load arrows -->
          <g id="loadLayer"></g>

          <!-- transfer “travel lines” -->
          <g id="travelLayer"></g>
        </svg>

        <div class="legend">
          <div class="k"><span class="dot" style="background:#a78bfa"></span>Muerta</div>
          <div class="k"><span class="dot" style="background:#5eead4"></span>Viva</div>
          <div class="k"><span class="dot" style="background:#fb7185"></span>Sísmica</div>
        </div>

        <!-- PREMIUM SUMMARY (big) -->
        <div class="premium">
          <div class="premiumBox">
            <div class="muted">Estado</div>
            <div class="big" id="premiumState">—</div>
            <div class="muted" style="margin-top:6px;font-size:12px;" id="premiumSub">—</div>
          </div>
          <div class="premiumBox">
            <div class="muted">Equilibrio</div>
            <div class="bigNum">∑Fy: <span id="sumFy">0</span></div>
            <div class="bigNum">∑Fx: <span id="sumFx">0</span></div>
            <div class="bigNum">∑M: <span id="sumM">0</span></div>
          </div>
        </div>
      </div>

      <div class="mini">
        <h3>Reglas rápidas</h3>
        <ul id="rules"></ul>
      </div>

      <div class="btns">
        <button class="ghost" id="btnNoTransfer">Ver SIN transferencia</button>
        <button class="ghost" id="btnWithTransfer">Ver CON transferencia</button>
      </div>

    </div>

    <!-- DER: FORM + LISTADO -->
    <div class="card">
      <div class="row">
        <div>
          <b>Crear cargas</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">Se guarda localmente. Exporta TXT y PDF premium.</div>
        </div>
        <span class="pill">Form</span>
      </div>

      <div class="fieldgrid">
        <div>
          <label>Paciente / hogar</label>
          <input id="patient" placeholder="Ej: Hogar Abraham y Sara">
        </div>
        <div>
          <label>Auditor</label>
          <input id="auditor" placeholder="Ej: Consejero / Pastor">
        </div>
        <div>
          <label>Fecha (editable)</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Observaciones</label>
          <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
        </div>
      </div>

      <div class="mini">
        <h3>Nueva carga</h3>
        <div class="fieldgrid">
          <div style="grid-column:1/-1">
            <label>Nombre (solo para listado / PDF)</label>
            <input id="loadName" placeholder="Ej: Presión financiera / Discusión / Falta de altar">
          </div>

          <div>
            <label>Tipo</label>
            <select id="loadType"></select>
          </div>

          <div>
            <label>Ubicación</label>
            <select id="target"></select>
          </div>

          <div>
            <label>Magnitud (1–100)</label>
            <input id="mag" type="number" min="1" max="100" value="20">
          </div>

          <div style="grid-column:1/-1">
            <label>Detalle</label>
            <textarea id="detail" placeholder="Qué lo detona / qué se repite / qué se siente"></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnAdd">Agregar carga</button>
          <button class="ghost" id="btnClear">Limpiar</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:13px;">
          Nota: en el pórtico NO se transfiere el nombre; se transfiere la flecha con su magnitud.
        </div>
      </div>

      <div class="btns">
        <button class="ghost" id="btnTransfer">Transferir cargas (animación)</button>
        <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
        <button class="ghost" id="btnPdf" disabled>Descargar PDF premium</button>
        <button class="ghost" id="btnReset">Borrar todo</button>
      </div>

      <div class="mini">
        <h3>Listado de cargas</h3>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>Carga</th>
                <th>Tipo</th>
                <th>Ubicación</th>
                <th>Magnitud</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "simulador.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "simulador_cargas_v1";

  let DATA=null;
  let logoDataUrl=null;

  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    loads: [],          // {id,name,type,target,mag,detail,createdAt}
    transferred: false  // global mode for simulation
  };

  // ====== Elements ======
  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const rulesEl = document.getElementById("rules");

  const pCount = document.getElementById("pCount");
  const modePill = document.getElementById("modePill");
  const liveState = document.getElementById("liveState");

  const premiumState = document.getElementById("premiumState");
  const premiumSub = document.getElementById("premiumSub");
  const sumFyEl = document.getElementById("sumFy");
  const sumFxEl = document.getElementById("sumFx");
  const sumMEl = document.getElementById("sumM");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");

  const loadNameEl = document.getElementById("loadName");
  const loadTypeEl = document.getElementById("loadType");
  const targetEl = document.getElementById("target");
  const magEl = document.getElementById("mag");
  const detailEl = document.getElementById("detail");

  const rowsEl = document.getElementById("rows");
  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");
  const pdfWarn = document.getElementById("pdfWarn");

  // SVG elements
  const svgEl = document.getElementById("svg");
  const frameEl = document.getElementById("frame");
  const crackEl = document.getElementById("crack");
  const jointEl = document.getElementById("joint");
  const loadLayer = document.getElementById("loadLayer");
  const travelLayer = document.getElementById("travelLayer");

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) && !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      state.header = payload.header || state.header;
      state.loads = Array.isArray(payload.loads) ? payload.loads : [];
      state.transferred = !!payload.transferred;
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  function enumItem(list, key){
    return list.find(x=>x.key===key) || null;
  }
  function enumLabel(list, key){
    const it = enumItem(list, key);
    return it ? it.label : key;
  }

  function setupEnums(){
    loadTypeEl.innerHTML = DATA.enums.loadType.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
    targetEl.innerHTML = DATA.enums.target.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
  }

  // ====== SIM MATH (Fy / Fx / M) ======
  function sums(){
    // Fy: sum of muerta+viva magnitudes
    // Fx: sum of sismica magnitudes
    // M: a didactic moment proxy = Fx*2 + (Fy if untransferred from beam)*1.2 + (Fy on column if not to foundation)*0.8
    let Fy=0, Fx=0, M=0;

    state.loads.forEach(L=>{
      const mag = Number(L.mag||0);
      if(L.type === "sismica"){
        Fx += mag;
      }else{
        Fy += mag;
      }
      // moment proxy
      if(!state.transferred){
        if(L.type === "sismica") M += mag * 2.0;
        if(L.target === "viga" && L.type !== "sismica") M += mag * 1.2;
        if(L.target === "columna" && L.type !== "sismica") M += mag * 0.8;
      }else{
        // with transfer, residual moment small
        if(L.type === "sismica") M += mag * 0.25;
      }
    });

    Fy = Math.round(Fy);
    Fx = Math.round(Fx);
    M  = Math.round(M);
    return {Fy,Fx,M};
  }

  // ====== SVG DRAWING (arrows with magnitudes) ======
  function clearLayer(g){
    while(g.firstChild) g.removeChild(g.firstChild);
  }

  function svgElNS(tag){
    return document.createElementNS("http://www.w3.org/2000/svg", tag);
  }

  function addArrow({x,y,dir,color,mag,scale=1}){
    // dir: "down" or "right"
    // returns group
    const g = svgElNS("g");
    g.setAttribute("opacity","0.95");

    const w = Math.max(14, Math.min(42, 14 + mag*0.28)) * scale; // arrow visual size by mag
    const h = Math.max(30, Math.min(95, 30 + mag*0.60)) * scale;

    // line + head
    const line = svgElNS("line");
    line.setAttribute("stroke", color);
    line.setAttribute("stroke-width", "4");
    line.setAttribute("stroke-linecap","round");

    const head = svgElNS("polygon");
    head.setAttribute("fill", color);

    // label
    const txt = svgElNS("text");
    txt.setAttribute("fill", "rgba(255,255,255,.88)");
    txt.setAttribute("font-size","12");
    txt.setAttribute("font-weight","900");
    txt.setAttribute("text-anchor","middle");
    txt.textContent = String(mag);

    if(dir === "down"){
      line.setAttribute("x1", x);
      line.setAttribute("y1", y);
      line.setAttribute("x2", x);
      line.setAttribute("y2", y + h);

      const p = `${x},${y+h+10} ${x-9},${y+h-2} ${x+9},${y+h-2}`;
      head.setAttribute("points", p);

      txt.setAttribute("x", x);
      txt.setAttribute("y", y - 8);
    }else{
      line.setAttribute("x1", x);
      line.setAttribute("y1", y);
      line.setAttribute("x2", x + h);
      line.setAttribute("y2", y);

      const p = `${x+h+10},${y} ${x+h-2},${y-9} ${x+h-2},${y+9}`;
      head.setAttribute("points", p);

      txt.setAttribute("x", x + (h/2));
      txt.setAttribute("y", y - 10);
    }

    g.appendChild(line);
    g.appendChild(head);
    g.appendChild(txt);
    loadLayer.appendChild(g);
    return g;
  }

  function layoutLoads(){
    clearLayer(loadLayer);

    // positions:
    // beam top region ~ x: 250..420, y: 35
    // column top region ~ x: 120, y: 35
    // joint for seismic ~ x: 150, y: 130
    const beamXs = [250, 320, 390, 460];
    const colXs  = [110, 140];
    let bI=0, cI=0, nI=0;

    state.loads.forEach(L=>{
      const lt = enumItem(DATA.enums.loadType, L.type);
      const color = lt ? lt.color : "#e5e7eb";
      const mag = Math.max(1, Math.min(100, Number(L.mag||1)));

      if(L.type === "sismica" || L.target === "nudo"){
        // always horizontal at joint
        const x = 160;
        const y = 118 + (nI*22);
        nI++;
        addArrow({x,y,dir:"right",color,mag});
      }else if(L.target === "columna"){
        const x = colXs[cI % colXs.length];
        const y = 34;
        cI++;
        addArrow({x,y,dir:"down",color,mag});
      }else{
        const x = beamXs[bI % beamXs.length];
        const y = 34;
        bI++;
        addArrow({x,y,dir:"down",color,mag});
      }
    });
  }

  // ====== Simulation states: unstable vs stable ======
  function setUnstable(){
    // Deriva & rotation based on sums (didactic)
    const {Fy,Fx,M} = sums();
    const dx = Math.min(55, Fx * 0.35 + M * 0.08);
    const rot = Math.min(12, Fx * 0.05 + M * 0.012);
    frameEl.setAttribute("transform", `translate(${dx},0) rotate(${rot} 146 300)`);

    // crack appears
    crackEl.setAttribute("opacity","1");
    crackEl.setAttribute("d", "M120 300 L140 285 L132 270 L150 252 L142 236 L165 220");

    // joint “stressed” color
    jointEl.setAttribute("fill", "#fb7185");
  }

  function setStable(){
    frameEl.setAttribute("transform", `translate(0,0) rotate(0 146 300)`);
    crackEl.setAttribute("opacity","0");
    crackEl.setAttribute("d", "");
    jointEl.setAttribute("fill", "#10b981");
  }

  function applyMode(){
    if(state.transferred){
      setStable();
      liveState.textContent = "Estado: Estable (transferido)";
      premiumState.textContent = "CON transferencia";
      premiumState.className = "big stateGood";
      premiumSub.textContent = "Cargas descargadas al Cimiento (Cristo). Menos deriva y fisuras.";
      modePill.textContent = "Modo: CON transferencia";
    }else{
      setUnstable();
      liveState.textContent = "Estado: Deriva + fisuras (no transferido)";
      premiumState.textContent = "SIN transferencia";
      premiumState.className = "big stateBad";
      premiumSub.textContent = "Cargas retenidas: aumenta ∑M (rotación), deriva y fisuras.";
      modePill.textContent = "Modo: SIN transferencia";
    }
  }

  function updatePremiumNumbers(){
    const {Fy,Fx,M} = sums();
    sumFyEl.textContent = Fy;
    sumFxEl.textContent = Fx;
    sumMEl.textContent = M;
  }

  // ====== Transfer animation: traveling arrows ======
  function animateTransfer(){
    // Create ghost arrows traveling along the path:
    // viga -> columna -> foundation (vertical+diagonal), nudo(sismo) -> foundation (diagonal)
    clearLayer(travelLayer);

    const duration = 850; // ms per segment
    const now = performance.now();

    function makeGhost(color){
      const g = svgElNS("g");
      g.setAttribute("opacity","0.95");
      const c = svgElNS("circle");
      c.setAttribute("r","8");
      c.setAttribute("fill", color);
      g.appendChild(c);
      travelLayer.appendChild(g);
      return {g,c};
    }

    const ghosts = state.loads.map(L=>{
      const lt = enumItem(DATA.enums.loadType, L.type);
      return { L, color: (lt?lt.color:"#e5e7eb"), ghost: makeGhost(lt?lt.color:"#e5e7eb") };
    });

    // Paths (start->mid->end)
    function pathsFor(L){
      // end at foundation center
      const end = {x:145, y:320};

      if(L.type==="sismica" || L.target==="nudo"){
        // from joint area
        const start = {x:170, y:120};
        const mid = {x:145, y:170};
        return [start, mid, end];
      }
      if(L.target==="columna"){
        const start = {x:125, y:60};
        const mid = {x:145, y:180};
        return [start, mid, end];
      }
      // viga
      const start = {x:320, y:60};
      const mid = {x:170, y:110};
      return [start, mid, end];
    }

    function lerp(a,b,t){ return a + (b-a)*t; }

    function tick(ts){
      const t = ts - now;
      const segT = t / duration; // 0..?
      ghosts.forEach(({L,color,ghost})=>{
        const pts = pathsFor(L);
        const seg = Math.min(1.999, Math.max(0, segT)); // up to second segment
        const idx = seg < 1 ? 0 : 1;
        const local = seg < 1 ? seg : (seg-1);
        const A = pts[idx];
        const B = pts[idx+1];
        const x = lerp(A.x, B.x, local);
        const y = lerp(A.y, B.y, local);
        ghost.g.setAttribute("transform", `translate(${x} ${y})`);
      });

      if(t < duration*2){
        requestAnimationFrame(tick);
      }else{
        // end: set transferred and rerender
        state.transferred = true;
        save();
        render();
        // fade travel layer
        travelLayer.setAttribute("opacity","0.0");
        setTimeout(()=>{ travelLayer.setAttribute("opacity","1"); clearLayer(travelLayer); }, 180);
      }
    }

    // show guide lines
    travelLayer.setAttribute("opacity","1");
    const guide = svgElNS("path");
    guide.setAttribute("stroke","rgba(255,255,255,.25)");
    guide.setAttribute("stroke-width","2");
    guide.setAttribute("fill","none");
    guide.setAttribute("stroke-dasharray","6 6");
    guide.setAttribute("d","M320 60 L170 110 L145 320 M125 60 L145 180 L145 320 M170 120 L145 170 L145 320");
    travelLayer.appendChild(guide);

    requestAnimationFrame(tick);
  }

  // ====== CRUD loads ======
  function clearForm(){
    loadNameEl.value = "";
    detailEl.value = "";
    loadTypeEl.value = "viva";
    targetEl.value = "viga";
    magEl.value = "20";
  }

  function addLoad(){
    const name = (loadNameEl.value||"").trim() || "Carga";
    const type = loadTypeEl.value;
    let target = targetEl.value;
    const mag = Math.max(1, Math.min(100, Number(magEl.value||1)));

    // enforce: sismica must be at nudo, and drawn horizontal
    if(type === "sismica") target = "nudo";

    const L = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
      name,
      type,
      target,
      mag,
      detail: (detailEl.value||"").trim(),
      createdAt: new Date().toISOString()
    };

    state.loads.unshift(L);
    // whenever loads change, keep current transfer mode (do not auto-transfer)
    save();
    clearForm();
    render();
  }

  function deleteLoad(id){
    if(!confirm("¿Eliminar esta carga?")) return;
    state.loads = state.loads.filter(x=>x.id !== id);
    save();
    render();
  }

  function renderRows(){
    rowsEl.innerHTML = "";
    state.loads.forEach(L=>{
      const tr = document.createElement("tr");
      const lt = enumItem(DATA.enums.loadType, L.type);
      const color = lt ? lt.color : "#e5e7eb";
      tr.innerHTML = `
        <td><b>${escapeHtml(L.name)}</b><div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(L.detail||"")}</div></td>
        <td><span class="tag" style="border-color:${color};color:${color}">${escapeHtml(enumLabel(DATA.enums.loadType, L.type))}</span></td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.target, L.target))}</span></td>
        <td><b>${L.mag}</b></td>
        <td><button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del="${L.id}">Eliminar</button></td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteLoad(btn.getAttribute("data-del")));
    });
  }

  function renderRules(){
    rulesEl.innerHTML = "";
    (DATA.texts.rules || []).forEach(r=>{
      const li = document.createElement("li");
      li.textContent = r;
      rulesEl.appendChild(li);
    });
  }

  function render(){
    pCount.textContent = `Cargas: ${state.loads.length}`;
    btnTxt.disabled = state.loads.length === 0;
    btnPdf.disabled = state.loads.length === 0 || !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";

    layoutLoads();
    updatePremiumNumbers();
    applyMode();
    renderRows();
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  // ====== TXT export ======
  function buildTXT(){
    const L=[];
    L.push((DATA.meta.title||"SIMULADOR").toUpperCase());
    L.push("");
    L.push("DATOS");
    L.push(`Paciente: ${patientEl.value || "(no especificado)"}`);
    L.push(`Auditor: ${auditorEl.value || "(no especificado)"}`);
    L.push(`Fecha: ${dateEl.value || "(no especificada)"}`);
    L.push("Observaciones:");
    L.push(notesEl.value || "(sin observaciones)");
    L.push("");

    const S = sums();
    L.push("RESUMEN PREMIUM");
    L.push(`Estado: ${state.transferred ? "CON transferencia" : "SIN transferencia"}`);
    L.push(`∑Fy: ${S.Fy} | ∑Fx: ${S.Fx} | ∑M: ${S.M}`);
    L.push("");

    L.push("CARGAS");
    L.push("--------------------------------------------------");
    state.loads.forEach(x=>{
      L.push(`- ${x.name}`);
      L.push(`  Tipo: ${enumLabel(DATA.enums.loadType,x.type)} | Ubicación: ${enumLabel(DATA.enums.target,x.target)} | Magnitud: ${x.mag}`);
      if(x.detail) L.push(`  Detalle: ${x.detail}`);
      L.push("");
    });

    L.push("VERSO FUNDAMENTO");
    L.push(`${DATA.verses.foundation.quote} (${DATA.verses.foundation.reference})`);
    L.push("");

    L.push("PLAN DE TRANSFERENCIA (pasos)");
    (DATA.planTemplates.transferSteps||[]).forEach(s=> L.push("• "+s));
    L.push("");

    L.push("PLAN 7 DÍAS");
    (DATA.planTemplates.plan7||[]).forEach(d=>{
      L.push(`Día ${d.day}: ${d.title}`);
      (d.items||[]).forEach(it=> L.push("• "+it));
      L.push("");
    });

    return L.join("\n");
  }

  function downloadTXT(){
    const txt = buildTXT();
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_cargas.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ====== PDF helpers ======
  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeName(name){
    return (name||"simulador")
      .toLowerCase().replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  function waitFrame(){
    return new Promise(r => requestAnimationFrame(() => r()));
  }

  // Convert SVG to PNG (dataURL)
  async function svgToPngData(svg, w, h){
    const xml = new XMLSerializer().serializeToString(svg);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const imgSrc = "data:image/svg+xml;base64," + svg64;

    const img = new Image();
    img.crossOrigin = "anonymous";
    await new Promise((resolve,reject)=>{
      img.onload = ()=> resolve();
      img.onerror = ()=> reject(new Error("No se pudo renderizar el SVG a imagen."));
      img.src = imgSrc;
    });

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");

    // fondo sólido para PDF
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,0,w,h);

    ctx.drawImage(img, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  // capture before/after + return snapshot and premium numbers
  async function captureScenarioMode(mode){
    const prevTransferred = state.transferred;
    state.transferred = (mode === "yes");
    render();
    await waitFrame();

    const snap = await svgToPngData(svgEl, 1500, 1050);
    const S = sums();

    // restore
    state.transferred = prevTransferred;
    render();
    await waitFrame();
    return { snap, S };
  }

  // Draw the premium header box in PDF
  function drawPremiumBox(doc, x, y, w, h, modeLabel, S){
    doc.setFillColor(255,255,255);
    doc.roundedRect(x, y, w, h, 10, 10, "F");
    doc.setTextColor(22,33,58);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Resumen premium", x+12, y+20);

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    const isYes = modeLabel.toLowerCase().includes("con");
    doc.setTextColor(isYes ? 16 : 244, isYes ? 185 : 63, isYes ? 129 : 94);
    doc.text(modeLabel, x+12, y+42);

    doc.setTextColor(22,33,58);
    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    doc.text(`∑Fy: ${S.Fy}`, x+12, y+68);
    doc.text(`∑Fx: ${S.Fx}`, x+12, y+92);
    doc.text(`∑M: ${S.M}`, x+12, y+116);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(90,102,130);
    doc.text(DATA.texts.premiumLegend || "", x+12, y+h-12);
  }

  // Build didactic images inside hidden SVGs and convert to PNG
  async function buildDidacticBeamDeflectionPNG(){
    const s = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
        <rect width="100%" height="100%" fill="#0b1220"/>
        <text x="60" y="80" font-family="Arial" font-size="42" fill="#e7eefc" font-weight="800">Deflexión de la Viga (sin transferir a la columna)</text>
        <text x="60" y="125" font-family="Arial" font-size="22" fill="#a7b4d6">La carga se queda en la viga → curvatura y fatiga</text>

        <!-- supports -->
        <circle cx="180" cy="470" r="18" fill="#64748b"/>
        <circle cx="1020" cy="470" r="18" fill="#64748b"/>

        <!-- beam (deflected) -->
        <path d="M180 420 C 420 520, 780 520, 1020 420" stroke="#5eead4" stroke-width="18" fill="none" stroke-linecap="round"/>

        <!-- loads -->
        <line x1="430" y1="210" x2="430" y2="360" stroke="#a78bfa" stroke-width="8"/>
        <polygon points="430,380 412,352 448,352" fill="#a78bfa"/>
        <line x1="610" y1="210" x2="610" y2="360" stroke="#5eead4" stroke-width="8"/>
        <polygon points="610,380 592,352 628,352" fill="#5eead4"/>
        <text x="520" y="190" font-family="Arial" font-size="24" fill="#e7eefc" font-weight="700">Cargas (↓)</text>

        <!-- note -->
        <rect x="60" y="540" width="1080" height="110" rx="16" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.14)"/>
        <text x="90" y="585" font-family="Arial" font-size="22" fill="#e7eefc" font-weight="700">Lectura:</text>
        <text x="190" y="585" font-family="Arial" font-size="20" fill="#a7b4d6">cuando la viga no transfiere, el sistema entra en “agotamiento” y aparece fisura.</text>
      </svg>
    `;
    const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(s);
    const img = new Image();
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });

    const c = document.createElement("canvas");
    c.width = 1200; c.height = 700;
    const ctx = c.getContext("2d");
    ctx.drawImage(img,0,0);
    return c.toDataURL("image/png");
  }

  async function buildDidacticColumnBucklingPNG(){
    const s = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
        <rect width="100%" height="100%" fill="#0b1220"/>
        <text x="60" y="80" font-family="Arial" font-size="42" fill="#e7eefc" font-weight="800">Pandeo de la Columna (sin transferir al cimiento)</text>
        <text x="60" y="125" font-family="Arial" font-size="22" fill="#a7b4d6">La carga no descarga al fundamento → inclinación y momento</text>

        <!-- foundation -->
        <rect x="420" y="560" width="360" height="70" rx="18" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.14)"/>
        <text x="600" y="604" text-anchor="middle" font-family="Arial" font-size="22" fill="#e7eefc" font-weight="800">CIMIENTO</text>

        <!-- buckled column -->
        <path d="M600 520 C 560 420, 660 320, 600 220" stroke="#fb7185" stroke-width="22" fill="none" stroke-linecap="round"/>

        <!-- top load -->
        <line x1="600" y1="120" x2="600" y2="190" stroke="#a78bfa" stroke-width="10"/>
        <polygon points="600,210 578,182 622,182" fill="#a78bfa"/>
        <text x="640" y="150" font-family="Arial" font-size="22" fill="#e7eefc" font-weight="700">Peso sin descarga</text>

        <!-- horizontal push -->
        <line x1="300" y1="320" x2="460" y2="320" stroke="#fb7185" stroke-width="10"/>
        <polygon points="480,320 452,298 452,342" fill="#fb7185"/>
        <text x="260" y="310" font-family="Arial" font-size="22" fill="#a7b4d6">Empuje (→)</text>

        <rect x="60" y="540" width="1080" height="110" rx="16" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.14)"/>
        <text x="90" y="585" font-family="Arial" font-size="22" fill="#e7eefc" font-weight="700">Lectura:</text>
        <text x="190" y="585" font-family="Arial" font-size="20" fill="#a7b4d6">cuando la columna no transfiere al cimiento, pierde verticalidad y crece el momento.</text>
      </svg>
    `;
    const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(s);
    const img = new Image();
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });

    const c = document.createElement("canvas");
    c.width = 1200; c.height = 700;
    const ctx = c.getContext("2d");
    ctx.drawImage(img,0,0);
    return c.toDataURL("image/png");
  }

  async function downloadPDF(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Simulador de Cargas del Hogar — Transferencia al Cimiento", M, H-18);
        doc.text(`Página ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // ===== PORTADA =====
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("SIMULADOR DE CARGAS DEL HOGAR", M, 50);

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Antes vs Después + Equilibrio (∑Fy, ∑Fx, ∑M) + Plan de Transferencia", M, 72);

    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 120, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${patientEl.value || "(no especificado)"}`, M+14, 172);
    doc.text(`Auditor: ${auditorEl.value || "(no especificado)"}`, M+14, 192);
    doc.text(`Fecha: ${dateEl.value || "(no especificada)"}`, M+14, 212);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 260, W-M*2, 140, 12, 12, "F");
    doc.setFont("helvetica","bold");
    doc.setTextColor(...INK);
    doc.text("Verso fundamento", M+14, 288);
    doc.setFont("times","italic");
    doc.setFontSize(11);
    doc.setTextColor(20,60,70);
    doc.text(doc.splitTextToSize(DATA.verses.foundation.quote, W-M*2-28), M+14, 310);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(70,90,110);
    doc.text(`(${DATA.verses.foundation.reference})`, M+14, 384);

    // ===== PAGE 2: ANTES =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...INK);
    doc.text("ANTES — Sin transferencia (deriva + fisuras)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const before = await captureScenarioMode("no");
    drawPremiumBox(doc, M, 90, W-M*2, 135, "SIN transferencia", before.S);

    const imgW = W - M*2;
    const imgH = (imgW * 1050) / 1500;
    doc.addImage(before.snap, "PNG", M, 240, imgW, Math.min(imgH, H-300));

    // ===== PAGE 3: DESPUÉS =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...INK);
    doc.text("DESPUÉS — Con transferencia al Cimiento (Cristo)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const after = await captureScenarioMode("yes");
    drawPremiumBox(doc, M, 90, W-M*2, 135, "CON transferencia", after.S);

    doc.addImage(after.snap, "PNG", M, 240, imgW, Math.min(imgH, H-300));

    // ===== PAGE 4: Imagen Deflexión + lectura =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text(DATA.readings.beamDeflection.title, M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const defPng = await buildDidacticBeamDeflectionPNG();
    doc.addImage(defPng, "PNG", M, 92, imgW, (imgW*700)/1200);

    let y = 92 + (imgW*700)/1200 + 14;
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Lectura espiritual", M, y); y += 14;

    doc.setFont("helvetica","normal"); doc.setFontSize(10.5); doc.setTextColor(...INK);
    const beamSp = (DATA.readings.beamDeflection.spiritual||[]).join(" • ");
    doc.text(doc.splitTextToSize(beamSp, W-M*2), M, y);

    // ===== PAGE 5: Imagen Pandeo + lectura =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text(DATA.readings.columnBuckling.title, M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const buckPng = await buildDidacticColumnBucklingPNG();
    doc.addImage(buckPng, "PNG", M, 92, imgW, (imgW*700)/1200);

    y = 92 + (imgW*700)/1200 + 14;
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Lectura espiritual", M, y); y += 14;

    doc.setFont("helvetica","normal"); doc.setFontSize(10.5); doc.setTextColor(...INK);
    const colSp = (DATA.readings.columnBuckling.spiritual||[]).join(" • ");
    doc.text(doc.splitTextToSize(colSp, W-M*2), M, y);

    // ===== PAGE 6: Plan de transferencia + cargas =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Plan de transferencia de cargas", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(...INK);
    doc.text(doc.splitTextToSize(`${DATA.verses.transfer.quote} (${DATA.verses.transfer.reference})`, W-M*2), M, 96);

    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Pasos (prácticos)", M, 126);

    doc.setFont("helvetica","normal"); doc.setFontSize(10.5);
    const steps = (DATA.planTemplates.transferSteps||[]).map(x=>"• "+x).join("\n");
    doc.text(steps, M, 146);

    // Tabla de cargas
    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Cargas registradas", M, 260);

    doc.autoTable({
      startY: 270,
      head: [["Carga", "Tipo", "Ubicación", "Magnitud"]],
      body: state.loads.map(L=>[
        L.name,
        enumLabel(DATA.enums.loadType, L.type),
        enumLabel(DATA.enums.target, L.target),
        String(L.mag)
      ]),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      margin:{left:M, right:M}
    });

    // ===== PAGE 7: Plan 7 días + Observaciones =====
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Plan semanal automático (7 días)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const planRows = (DATA.planTemplates.plan7||[]).map(d=>[
      `Día ${d.day}`,
      d.title,
      (d.items||[]).join(" • ")
    ]);

    doc.autoTable({
      startY: 92,
      head: [["Día", "Enfoque", "Acciones"]],
      body: planRows,
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:170},2:{cellWidth:W-M*2-70-170}},
      margin:{left:M, right:M}
    });

    // Observaciones
    const lastY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 520;
    const boxY = Math.min(lastY + 18, 560);
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Observaciones", M, boxY);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, boxY+10, W-M*2, 140, 12, 12, "F");
    doc.setFont("helvetica","normal"); doc.setFontSize(10.5);
    doc.text(doc.splitTextToSize(notesEl.value || "(sin observaciones)", W-M*2-28), M+14, boxY+34);

    footer();

    const name = safeName(patientEl.value || "hogar");
    doc.save(`${name}_simulador_cargas.pdf`);
  }

  // ====== Reset ======
  function resetAll(){
    if(!confirm("¿Borrar TODO el simulador?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.header = { patient:"", auditor:"", date:"", notes:"" };
    state.loads = [];
    state.transferred = false;
    fillHeaderUI();
    setDefaultDateIfEmpty();
    clearForm();
    save();
    render();
  }

  // ====== Init ======
  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();

      tEl.textContent = DATA.meta.title || "Simulador";
      dEl.textContent = DATA.meta.description || "";
      renderRules();
      setupEnums();

      load();
      fillHeaderUI();
      setDefaultDateIfEmpty();
      clearForm();
      render();

      pdfWarn.style.display = okPdfLib() ? "none" : "block";
    }catch(e){
      document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${e.message}<br><span style="color:#a7b4d6">Asegúrate de que ${JSON_PATH} esté en la misma carpeta.</span></div>`;
    }
  }

  // ====== Events ======
  document.getElementById("btnAdd").addEventListener("click", addLoad);
  document.getElementById("btnClear").addEventListener("click", clearForm);
  document.getElementById("btnTransfer").addEventListener("click", ()=>{
    if(state.loads.length===0) return alert("Primero agrega cargas.");
    animateTransfer();
  });

  document.getElementById("btnNoTransfer").addEventListener("click", ()=>{
    state.transferred = false;
    save(); render();
  });

  document.getElementById("btnWithTransfer").addEventListener("click", ()=>{
    state.transferred = true;
    save(); render();
  });

  document.getElementById("btnTxt").addEventListener("click", downloadTXT);
  document.getElementById("btnPdf").addEventListener("click", downloadPDF);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });

  // enforce: if type becomes sismica, force target to nudo
  loadTypeEl.addEventListener("change", ()=>{
    if(loadTypeEl.value==="sismica") targetEl.value = "nudo";
  });

  init();
</script>
</body>
</html>