<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas ‚Äî Laboratorio</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
      --g:#10b981; --y:#f59e0b; --o:#f97316; --r:#f43f5e;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1150px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:520px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .sec{border-top:1px solid var(--line);padding-top:10px;margin-top:10px;}
    .sec:first-child{border-top:none;padding-top:0;margin-top:0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .opts{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .opt{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:8px 10px;cursor:pointer;user-select:none;}
    .opt input{width:auto}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .result{display:none;margin-top:12px;border-radius:18px;border:1px solid var(--line);padding:14px;background:rgba(255,255,255,.04);}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.4px;}
    .bG{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.35);}
    .bY{background:rgba(245,158,11,.18);color:#fcd34d;border:1px solid rgba(245,158,11,.35);}
    .bO{background:rgba(249,115,22,.18);color:#fdba74;border:1px solid rgba(249,115,22,.35);}
    .bR{background:rgba(244,63,94,.18);color:#fda4af;border:1px solid rgba(244,63,94,.35);}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .toggleRow{margin-top:10px;display:flex;gap:10px;align-items:center;}
    .toggleRow input{transform:scale(1.1)}
    .chip{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px 12px;
      background:rgba(255,255,255,.04);cursor:grab;user-select:none;
    }
    .chip:active{cursor:grabbing;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="t">Simulador de Cargas ‚Äî Laboratorio</h1>
      <p class="sub" id="d"></p>
      <div style="margin-top:10px">
        <span class="pill" id="pMax"></span>
        <span class="pill" id="pHow">Niveles: 0‚Äì3 (Alineado ‚Üí Cr√≠tico)</span>
      </div>
      <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
    </div>

    <div class="grid">
      <!-- IZQ: DIAGRAMA + LIBRER√çA -->
      <div class="card">
        <div class="row">
          <div>
            <b>Laboratorio del p√≥rtico</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">
              Arrastra cargas al p√≥rtico. Click en una carga para alternar Transferida/No transferida.
            </div>
          </div>
          <span class="pill" id="liveGlobal">Global: ‚Äî</span>
        </div>

        <div class="svgBox" style="margin-top:10px;">
          <canvas id="sim" width="520" height="360" style="width:100%;height:auto;display:block;border-radius:14px;"></canvas>

          <div class="legend">
            <div class="k"><span class="dot" style="background:var(--g)"></span>Alineado</div>
            <div class="k"><span class="dot" style="background:var(--y)"></span>En ajuste</div>
            <div class="k"><span class="dot" style="background:var(--o)"></span>En riesgo</div>
            <div class="k"><span class="dot" style="background:var(--r)"></span>Cr√≠tico</div>
          </div>
        </div>

        <div class="sec">
          <div class="row">
            <b>Biblioteca de cargas</b>
            <span class="pill" id="pLoads">Cargas: 0</span>
          </div>
          <div class="muted" style="font-size:13px;margin-top:6px;">
            Arrastra un chip al canvas (drop). Luego puedes moverlo dentro del canvas.
          </div>
          <div id="library" style="display:grid;gap:10px;margin-top:10px;"></div>
        </div>

        <div class="result" id="resBox"></div>
      </div>

      <!-- DER: FORMULARIO (igual que Radar) -->
      <div class="card">
        <div class="row">
          <div>
            <b>Datos de auditor√≠a</b>
            <div class="muted" style="font-size:13px;margin-top:4px;">Se incluyen en el informe. No se env√≠a a servidor.</div>
          </div>
          <span class="pill">Cabecera</span>
        </div>

        <div class="fieldgrid" style="margin-top:10px;">
          <div>
            <label>Nombre del paciente</label>
            <input id="patient" placeholder="Ej: Juan y Mar√≠a P√©rez">
          </div>
          <div>
            <label>Nombre del auditor</label>
            <input id="auditor" placeholder="Ej: Consejero / Pastor">
          </div>
          <div>
            <label>Fecha (editable)</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones libres</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
          </div>
        </div>

        <div class="toggleRow">
          <input id="details" type="checkbox" checked>
          <div class="muted" style="font-size:13px;">Incluir detalle por secci√≥n y listado de cargas en el PDF</div>
        </div>

        <div class="sec" id="secForm"></div>

        <div class="sec">
          <b>Listado de cargas activas</b>
          <div class="muted" style="font-size:13px;margin-top:6px;">Click en ‚ÄúTransferida‚Äù para alternar estado.</div>
          <div style="margin-top:10px;overflow:auto;border:1px solid var(--line);border-radius:14px;">
            <table>
              <thead>
                <tr>
                  <th>Carga</th>
                  <th>Dir</th>
                  <th>Mag</th>
                  <th>Destino</th>
                  <th>Transferencia</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnResult">Ver resultado</button>
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
          <button class="ghost" id="btnClear">Quitar cargas</button>
          <button class="ghost" id="btnReset">Reiniciar</button>
          <span class="muted" id="live">Puntaje: 0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "simulador.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "simulador_portico_v1";

  let DATA=null;
  let logoDataUrl=null;

  const scores = {}; // sectionId -> levelValue(0..3)
  let last=null;

  // Local state for loads (saved)
  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    loads: [] // {id,key,label,direction,magnitude,target,transfer,x,y,createdAt}
  };

  // UI
  const secForm = document.getElementById("secForm");
  const resBox = document.getElementById("resBox");
  const pdfWarn = document.getElementById("pdfWarn");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");
  const detailsEl = document.getElementById("details");

  const liveEl = document.getElementById("live");
  const liveGlobal = document.getElementById("liveGlobal");
  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");

  const libraryEl = document.getElementById("library");
  const rowsEl = document.getElementById("rows");
  const pLoads = document.getElementById("pLoads");

  // Canvas
  const canvas = document.getElementById("sim");
  const ctx = canvas.getContext("2d");

  // Targets (match radar elements)
  const TARGETS = [
    { key:"foundation", label:"Cimiento" },
    { key:"column", label:"Columna" },
    { key:"joint", label:"Nudo" },
    { key:"beam", label:"Viga" },
    { key:"roller", label:"Apoyo m√≥vil" },
    { key:"loads", label:"Zona de cargas" }
  ];

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) &&
      !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function levelByValue(v){
    return DATA.levels.find(x=>Number(x.value)===Number(v)) || DATA.levels[0];
  }

  function totalScore(){
    return DATA.sections.reduce((acc,s)=> acc + (scores[s.id] ?? 0), 0);
  }

  function globalBand(sum){
    const b = DATA.globalBands.find(x => sum>=x.min && sum<=x.max);
    return b || DATA.globalBands[0];
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function uid(){
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const p = JSON.parse(raw);
      if(p.header) state.header = p.header;
      if(Array.isArray(p.loads)) state.loads = p.loads;
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  // ===== Rendering sections (igual Radar) =====
  function renderForm(){
    secForm.innerHTML = `<div class="muted" style="font-size:13px;margin-bottom:10px;">
      Selecciona el nivel por secci√≥n (0‚Äì3). Este puntaje genera el diagn√≥stico global del escenario.
    </div>`;

    DATA.sections.forEach(sec=>{
      scores[sec.id] = 0;

      const div = document.createElement("div");
      div.className = "sec";
      div.innerHTML = `
        <div class="row">
          <div>
            <div style="font-weight:900">${escapeHtml(sec.title)}</div>
            <div class="muted" style="font-size:13px;margin-top:4px">${escapeHtml(sec.diagnosticFocus || "")}</div>
          </div>
          <span class="pill" id="pill_${sec.id}">Alineado</span>
        </div>
        <div class="opts" role="radiogroup" aria-label="${escapeHtml(sec.title)}">
          ${DATA.levels.map(l=>`
            <label class="opt">
              <input type="radio" name="${sec.id}" value="${l.value}" ${l.value===0?"checked":""}>
              <span>${escapeHtml(l.label)} (${l.value})</span>
            </label>
          `).join("")}
        </div>
        <div class="muted" style="font-size:13px;margin-top:10px;">
          <b>üìñ</b> ${escapeHtml(sec.verse.quote)} <span class="muted">(${escapeHtml(sec.verse.reference)})</span>
        </div>
      `;

      div.querySelectorAll(`input[name="${sec.id}"]`).forEach(inp=>{
        inp.addEventListener("change", (e)=>{
          scores[sec.id] = Number(e.target.value);
          const lev = levelByValue(scores[sec.id]);
          const pill = document.getElementById(`pill_${sec.id}`);
          if(pill) pill.textContent = lev.label;
          updateLive();
          draw();
        });
      });

      secForm.appendChild(div);
    });

    updateLive();
  }

  function updateLive(){
    const sum = totalScore();
    liveEl.textContent = `Puntaje: ${sum}`;
    const g = globalBand(sum);
    liveGlobal.textContent = `Global: ${g.label}`;
    document.getElementById("pMax").textContent = `Total m√°x: ${DATA.sections.length * 3}`;
  }

  // ===== Canvas: p√≥rtico + cargas =====
  const Z = {
    foundation: {x:75,y:280,w:120,h:40},
    column: {x:125,y:95,w:20,h:185},
    beam: {x:135,y:95,w:250,h:18},
    joint: {x:125,y:95,w:28,h:28},
    roller: {x:385,y:113,w:20,h:20},
    loads: {x:200,y:40,w:140,h:60}
  };

  function sectionLevelForElement(elementKey){
    // si varias secciones apuntan al mismo element, gana el peor
    let worst = 0;
    DATA.sections.forEach(s=>{
      if(s.element===elementKey){
        worst = Math.max(worst, scores[s.id] ?? 0);
      }
    });
    return worst;
  }

  function loadTargetAt(x,y){
    const keys = ["foundation","column","joint","beam","roller","loads"];
    for(const k of keys){
      const z = Z[k];
      if(x>=z.x && x<=z.x+z.w && y>=z.y && y<=z.y+z.h) return k;
    }
    return null;
  }

  function snapToTarget(l, t){
    const z = Z[t] || Z.beam;
    l.target = t;
    l.x = z.x + z.w/2;
    l.y = z.y + z.h/2;
  }

  function addInstance(loadKey){
    const base = (DATA.loadsLibrary||[]).find(x=>x.key===loadKey);
    if(!base) return;
    const inst = {
      id: uid(),
      key: base.key,
      label: base.label,
      direction: base.direction,
      magnitude: Number(base.magnitude||1),
      target: base.defaultTarget || "beam",
      transfer: true,
      x: 120,
      y: 160,
      createdAt: new Date().toISOString()
    };
    snapToTarget(inst, inst.target);
    state.loads.unshift(inst);
    save();
    renderRows();
    draw();
  }

  function toggleTransfer(id){
    const l = state.loads.find(x=>x.id===id);
    if(!l) return;
    l.transfer = !l.transfer;
    save();
    renderRows();
    draw();
  }

  function deleteLoad(id){
    if(!confirm("¬øQuitar esta carga?")) return;
    state.loads = state.loads.filter(x=>x.id!==id);
    save();
    renderRows();
    draw();
  }

  // Drag in canvas
  let draggingId=null;
  let dragOffset={dx:0,dy:0};

  function hitToken(mx,my){
    // tokens ~ 120x30
    for(const l of state.loads){
      const x0=l.x-60, x1=l.x+60;
      const y0=l.y-15, y1=l.y+15;
      if(mx>=x0 && mx<=x1 && my>=y0 && my<=y1) return l.id;
    }
    return null;
  }

  function pointerPos(evt){
    const rect = canvas.getBoundingClientRect();
    const sx = canvas.width / rect.width;
    const sy = canvas.height / rect.height;
    return {x:(evt.clientX-rect.left)*sx, y:(evt.clientY-rect.top)*sy};
  }

  canvas.addEventListener("pointerdown", (e)=>{
    const p = pointerPos(e);
    const id = hitToken(p.x,p.y);
    if(!id) return;
    const l = state.loads.find(x=>x.id===id);
    draggingId = id;
    dragOffset.dx = p.x - l.x;
    dragOffset.dy = p.y - l.y;
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!draggingId) return;
    const p = pointerPos(e);
    const l = state.loads.find(x=>x.id===draggingId);
    if(!l) return;
    l.x = p.x - dragOffset.dx;
    l.y = p.y - dragOffset.dy;
    draw();
  });

  canvas.addEventListener("pointerup", (e)=>{
    if(!draggingId) return;
    const p = pointerPos(e);
    const l = state.loads.find(x=>x.id===draggingId);
    draggingId = null;
    if(!l){ draw(); return; }
    const t = loadTargetAt(p.x,p.y);
    if(t) snapToTarget(l,t);
    save();
    renderRows();
    draw();
  });

  // Click token to toggle transfer
  canvas.addEventListener("click", (e)=>{
    const p = pointerPos(e);
    const id = hitToken(p.x,p.y);
    if(!id) return;
    toggleTransfer(id);
  });

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background
    ctx.fillStyle = "rgba(255,255,255,.03)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // ground
    ctx.fillStyle = "rgba(255,255,255,.05)";
    ctx.fillRect(0,320,520,40);

    // levels colors for elements (from section scores)
    function colForElement(key){
      const v = sectionLevelForElement(key);
      return levelByValue(v).color;
    }

    // foundation
    rectR(Z.foundation.x,Z.foundation.y,Z.foundation.w,Z.foundation.h,8,colForElement("foundation"));
    txt(Z.foundation.x+Z.foundation.w/2, Z.foundation.y+26, "CIMIENTO");

    // column
    rectR(Z.column.x,Z.column.y,Z.column.w,Z.column.h,8,colForElement("column"));
    txt(Z.column.x+Z.column.w/2, Z.column.y-10, "COLUMNA");

    // beam
    rectR(Z.beam.x,Z.beam.y,Z.beam.w,Z.beam.h,8,colForElement("beam"));
    txt(Z.beam.x+Z.beam.w/2, Z.beam.y-10, "VIGA");

    // roller
    ctx.fillStyle = colForElement("roller");
    ctx.strokeStyle = "rgba(255,255,255,.22)";
    ctx.lineWidth = 2;
    circle(395,123,10,true);
    ctx.fillStyle = "rgba(255,255,255,.08)";
    rectR(375,133,40,10,4,"rgba(255,255,255,.08)");
    txt(395,162,"APOYO");

    // nodes (color by section)
    node(135,280, "1", levelByValue(scores["comunion"] ?? 0).color);
    node(135,104, "2", levelByValue(scores["congregacion"] ?? 0).color);
    node(395,123, "3", levelByValue(scores["interseccion"] ?? 0).color);

    // loads zone label
    ctx.fillStyle = "rgba(255,255,255,.06)";
    rectR(Z.loads.x, Z.loads.y, Z.loads.w, Z.loads.h, 10, "rgba(255,255,255,.05)");
    txt(Z.loads.x+Z.loads.w/2, Z.loads.y+22, "DROP ZONA");
    ctx.fillStyle = "rgba(231,238,252,.70)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.fillText("CARGAS", Z.loads.x+Z.loads.w/2, Z.loads.y+44);

    // draw load tokens
    state.loads.forEach(l=>{
      drawToken(l);
    });

    function rectR(x,y,w,h,r,fill){
      ctx.fillStyle = fill;
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }

    function circle(cx,cy,r,stroke){
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.closePath(); ctx.fill();
      if(stroke) ctx.stroke();
    }

    function txt(x,y,t){
      ctx.fillStyle = "rgba(231,238,252,.75)";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillText(t,x,y);
      ctx.textAlign = "left";
    }

    function node(cx,cy,num,color){
      ctx.fillStyle = color || "#64748b";
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 2;
      circle(cx,cy,10,true);
      ctx.fillStyle = "rgba(231,238,252,.85)";
      ctx.font = "bold 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.fillText(num,cx,cy+4);
      ctx.textAlign = "left";
    }

    function drawToken(l){
      const w=130, h=32;
      const x=l.x-w/2, y=l.y-h/2;
      const base = l.direction==="horizontal" ? "rgba(94,234,212,.14)" : "rgba(255,255,255,.10)";
      rectR(x,y,w,h,12,base);

      // transfer dot
      ctx.fillStyle = l.transfer ? "rgba(16,185,129,.9)" : "rgba(244,63,94,.9)";
      ctx.beginPath(); ctx.arc(x+w-12, y+10, 6, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = "rgba(231,238,252,.92)";
      ctx.font = "bold 11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "left";
      ctx.fillText((l.direction==="horizontal"?"‚Üí ":"‚Üì ")+l.label, x+10, y+20);

      ctx.fillStyle = "rgba(167,180,214,.92)";
      ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Mag "+l.magnitude, x+10, y+30);
    }
  }

  // ===== Library UI =====
  function renderLibrary(){
    libraryEl.innerHTML = "";
    (DATA.loadsLibrary||[]).forEach(item=>{
      const div = document.createElement("div");
      div.className = "chip";
      div.draggable = true;
      div.title = item.hint || "";
      div.innerHTML = `
        <div style="font-weight:900">${escapeHtml(item.label)}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <span class="tag">${escapeHtml(item.direction)}</span>
          <span class="tag">Mag ${Number(item.magnitude||1)}</span>
        </div>
      `;
      div.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", item.key);
      });
      libraryEl.appendChild(div);
    });

    canvas.addEventListener("dragover", (e)=> e.preventDefault());
    canvas.addEventListener("drop", (e)=>{
      e.preventDefault();
      const key = e.dataTransfer.getData("text/plain");
      if(!key) return;

      addInstance(key);
    });
  }

  // ===== Loads table =====
  function renderRows(){
    pLoads.textContent = `Cargas: ${state.loads.length}`;
    rowsEl.innerHTML = "";
    state.loads.forEach(l=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(l.label)}</b><div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(l.key)}</div></td>
        <td><span class="tag">${escapeHtml(l.direction)}</span></td>
        <td><b>${l.magnitude}</b></td>
        <td><span class="tag">${escapeHtml(l.target)}</span></td>
        <td>
          <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-t="${l.id}">
            ${l.transfer ? "Transferida ‚úÖ" : "No transferida ‚ö†Ô∏è"}
          </button>
        </td>
        <td>
          <button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del="${l.id}">Quitar</button>
        </td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-t]").forEach(b=>{
      b.addEventListener("click", ()=> toggleTransfer(b.getAttribute("data-t")));
    });
    rowsEl.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=> deleteLoad(b.getAttribute("data-del")));
    });
  }

  // ===== Result payload (igual Radar, pero incluye loads + captura) =====
  function buildPayload(){
    const header = {
      patient: patientEl.value.trim() || "(no especificado)",
      auditor: auditorEl.value.trim() || "(no especificado)",
      date: dateEl.value || "(no especificada)",
      notes: notesEl.value.trim() || ""
    };

    const sum = totalScore();
    const g = globalBand(sum);

    const sections = DATA.sections.map(sec=>{
      const v = scores[sec.id] ?? 0;
      const level = levelByValue(v);
      return {
        id: sec.id,
        title: sec.title,
        levelValue: v,
        levelKey: level.key,
        levelLabel: level.label,
        color: level.color,
        verse: sec.verse,
        focus: sec.diagnosticFocus || "",
        miniTeaching: sec.miniTeaching || [],
        actions: sec.actions || []
      };
    });

    sections.sort((a,b)=> b.levelValue - a.levelValue);

    const scenarioPng = canvas.toDataURL("image/png", 1.0);

    return {
      meta: DATA.meta,
      header,
      global: { sum, band: g },
      sections,
      loads: state.loads.slice(),
      includeDetails: detailsEl.checked,
      scenarioPng
    };
  }

  function showResult(){
    last = buildPayload();
    const b = last.global.band;

    const badge =
      b.key==="g_alineado" ? "bG" :
      b.key==="g_ajuste" ? "bY" :
      b.key==="g_riesgo" ? "bO" : "bR";

    resBox.style.display = "block";
    resBox.innerHTML = `
      <div class="row">
        <div>
          <span class="badge ${badge}">${escapeHtml(b.label)}</span>
          <div class="muted" style="margin-top:6px;font-size:13px;">Puntaje global: <b>${last.global.sum}</b> / ${DATA.sections.length*3}</div>
          <div class="muted" style="margin-top:4px;font-size:13px;">${escapeHtml(b.summary)}</div>
        </div>
        <div class="pill">Cargas: ${last.loads.length}</div>
      </div>
      <div style="margin-top:10px;border-left:3px solid rgba(94,234,212,.45);background:rgba(94,234,212,.06);padding:10px 12px;border-radius:12px;">
        <div style="font-style:italic;">${escapeHtml(b.verse.quote)}</div>
        <div class="muted" style="margin-top:6px;">(${escapeHtml(b.verse.reference)})</div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:13px;">
        Tip: si una carga est√° <b>no transferida</b>, su concentraci√≥n se representa con el punto rojo en el token.
      </div>
    `;

    btnTxt.disabled = false;
    btnPdf.disabled = !okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  function downloadTXT(){
    if(!last) return;
    const L = [];
    L.push(last.meta.title.toUpperCase());
    L.push("");
    L.push("DATOS");
    L.push(`Paciente: ${last.header.patient}`);
    L.push(`Auditor: ${last.header.auditor}`);
    L.push(`Fecha: ${last.header.date}`);
    L.push("Observaciones:");
    L.push(last.header.notes || "(sin observaciones)");
    L.push("");
    L.push("RESULTADO GLOBAL");
    L.push(`Puntaje: ${last.global.sum}/${DATA.sections.length*3}`);
    L.push(`Diagn√≥stico: ${last.global.band.label}`);
    L.push(last.global.band.summary);
    L.push(`${last.global.band.verse.quote} (${last.global.band.verse.reference})`);
    L.push("");

    L.push("ENFOQUE POR SECCIONES");
    L.push("--------------------------------------------------");
    last.sections.slice().reverse().forEach(s=>{
      L.push(`${s.title} ‚Äî ${s.levelLabel} (${s.levelValue})`);
      L.push(`Enfoque: ${s.focus}`);
      L.push(`Biblia: ${s.verse.quote} (${s.verse.reference})`);
      if(last.includeDetails){
        if(s.miniTeaching?.length){
          L.push("Mini-ense√±anza:");
          s.miniTeaching.forEach(x=> L.push("‚Ä¢ "+x));
        }
        if(s.actions?.length){
          L.push("Acciones sugeridas:");
          s.actions.forEach(x=> L.push("‚Ä¢ "+x));
        }
      }
      L.push("");
    });

    L.push("CARGAS ACTIVAS (SIMULACI√ìN)");
    L.push("--------------------------------------------------");
    last.loads.forEach(l=>{
      L.push(`- ${l.label} (${l.key})`);
      L.push(`  Direcci√≥n: ${l.direction} | Magnitud: ${l.magnitude}`);
      L.push(`  Destino: ${l.target} | Transferencia: ${l.transfer ? "Transferida" : "No transferida"}`);
      L.push("");
    });

    const blob = new Blob([L.join("\n")], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_portico.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function levelColor(label){
    const s = (label||"").toLowerCase();
    if(s.includes("aline")) return [16,185,129];
    if(s.includes("ajus")) return [245,158,11];
    if(s.includes("ries")) return [249,115,22];
    return [244,63,94];
  }

  function safeName(name){
    return (name||"simulador_portico")
      .toLowerCase()
      .replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  async function downloadPDF(){
    if(!last) return;
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"letter" });
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const COLORS = { ink:[22,33,58], muted:[90,102,130] };

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function header(){
      addLogo(M, 16, 34, 34);
      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(...COLORS.ink);
      doc.text("Simulador de Cargas ‚Äî Laboratorio", W/2, 36, {align:"center"});
      doc.setDrawColor(230);
      doc.line(M, 52, W-M, 52);
      return 74;
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...COLORS.muted);
        doc.text("Constructores del Reino ‚Äî Simulaci√≥n del Hogar", M, H-18);
        doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // PORTADA
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W - M - 56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("SIMULADOR DE CARGAS DEL HOGAR", M, 52);

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Captura del escenario + diagn√≥stico por secciones + cargas", M, 74);

    // datos
    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 120, 12, 12, "F");
    doc.setTextColor(...COLORS.ink);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos de auditor√≠a", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${last.header.patient}`, M+14, 172);
    doc.text(`Auditor: ${last.header.auditor}`, M+14, 192);
    doc.text(`Fecha: ${last.header.date}`, M+14, 212);

    // global
    const band = last.global.band;
    const c = levelColor(band.label);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 255, W-M*2, 160, 12, 12, "F");

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...COLORS.ink);
    doc.text(`Diagn√≥stico global: ${band.label}`, M+14, 286);
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Puntaje: ${last.global.sum}/${DATA.sections.length*3}`, M+14, 308);

    doc.setFillColor(...c);
    doc.roundedRect(M+14, 322, 220, 24, 12, 12, "F");
    doc.setTextColor(255,255,255);
    doc.setFont("helvetica","bold");
    doc.setFontSize(10);
    doc.text(band.label.toUpperCase(), M+14 + 110, 339, {align:"center"});

    doc.setTextColor(...COLORS.ink);
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(doc.splitTextToSize(band.summary, W-M*2-28), M+14, 366);

    // Captura escenario
    doc.addPage();
    let y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Captura del escenario (canvas)", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 16;

    const imgW = W - M*2;
    const imgH = imgW * (canvas.height / canvas.width);
    doc.addImage(last.scenarioPng, "PNG", M, y, imgW, Math.min(imgH, 420));

    // Tabla secciones
    doc.addPage();
    y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Diagn√≥stico por secciones", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 12;

    const rows = last.sections.slice().reverse().map(s=>[
      s.title,
      s.levelLabel,
      String(s.levelValue),
      `${s.verse.quote} (${s.verse.reference})`
    ]);

    doc.autoTable({
      startY: y,
      head: [["Secci√≥n", "Diagn√≥stico", "Nivel", "Porci√≥n b√≠blica"]],
      body: rows,
      theme: "grid",
      styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      didParseCell: function(data){
        if(data.section==="body" && data.column.index===1){
          const v = data.cell.raw || "";
          const cc = levelColor(v);
          data.cell.styles.fillColor = cc;
          data.cell.styles.textColor = [255,255,255];
          data.cell.styles.fontStyle = "bold";
        }
      },
      margin: {left:M, right:M}
    });

    // Detalle + cargas
    doc.addPage();
    y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Cargas activas (simulaci√≥n)", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 12;

    doc.autoTable({
      startY: y,
      head: [["Carga", "Dir", "Mag", "Destino", "Transferencia"]],
      body: last.loads.map(l=>[
        l.label,
        l.direction,
        String(l.magnitude),
        l.target,
        l.transfer ? "Transferida" : "No transferida"
      ]),
      theme: "grid",
      styles: {font:"helvetica",fontSize:9.5,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      margin: {left:M, right:M}
    });

    if(last.includeDetails){
      doc.addPage();
      y = header();
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...COLORS.ink);
      doc.text("Gu√≠a pastoral por secciones (detalle)", M, y);
      y += 12;
      doc.setDrawColor(230);
      doc.line(M, y, W-M, y);
      y += 12;

      const pRows = last.sections.slice().reverse().map(s=>[
        s.title,
        s.levelLabel,
        (s.miniTeaching && s.miniTeaching.length) ? ("‚Ä¢ " + s.miniTeaching.join(" ‚Ä¢ ")) : "(sin gu√≠a)",
        (s.actions && s.actions.length) ? ("‚Ä¢ " + s.actions.join(" ‚Ä¢ ")) : "(sin acciones)"
      ]);

      doc.autoTable({
        startY: y,
        head: [["Secci√≥n", "Diagn√≥stico", "Mini-ense√±anza", "Acciones sugeridas"]],
        body: pRows,
        theme: "grid",
        styles: {font:"helvetica",fontSize:9,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
        headStyles: {fillColor: [22,33,58], textColor:[255,255,255], fontStyle:"bold"},
        didParseCell: function(data){
          if(data.section==="body" && data.column.index===1){
            const v = data.cell.raw || "";
            const cc = levelColor(v);
            data.cell.styles.fillColor = cc;
            data.cell.styles.textColor = [255,255,255];
            data.cell.styles.fontStyle = "bold";
          }
        },
        margin: {left:M, right:M}
      });
    }

    // Observaciones
    doc.addPage();
    y = header();
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(...COLORS.ink);
    doc.text("Observaciones del auditor", M, y);
    y += 12;
    doc.setDrawColor(230);
    doc.line(M, y, W-M, y);
    y += 14;

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, y, W-M*2, 420, 12, 12, "F");
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...COLORS.ink);
    const notes = last.header.notes || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, y+26);

    footer();

    const name = safeName(last.header.patient || "simulador_portico");
    doc.save(`${name}_simulador_portico.pdf`);
  }

  function resetAll(){
    DATA.sections.forEach(s=> scores[s.id]=0);
    document.querySelectorAll('input[type="radio"]').forEach(i=>{
      if(i.value==="0") i.checked=true;
      else i.checked=false;
    });
    document.querySelectorAll('[id^="pill_"]').forEach(p=> p.textContent="Alineado");

    state.loads = [];
    save();

    updateLive();
    renderRows();
    draw();

    resBox.style.display="none";
    resBox.innerHTML="";
    btnTxt.disabled=true;
    btnPdf.disabled=true;
    last=null;
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function clearLoads(){
    if(!confirm("¬øQuitar todas las cargas del escenario?")) return;
    state.loads = [];
    save();
    renderRows();
    draw();
  }

  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();

      document.getElementById("t").textContent = DATA.meta.title || "Simulador de Cargas";
      document.getElementById("d").textContent = DATA.meta.description || "";

      setDefaultDateIfEmpty();
      loadLocal();
      fillHeaderUI();

      renderForm();
      renderLibrary();
      renderRows();
      draw();

      btnPdf.disabled = !okPdfLib();
      pdfWarn.style.display = okPdfLib() ? "none" : "block";
    }catch(e){
      secForm.innerHTML = `<div style="color:#fda4af"><b>Error:</b> ${e.message}</div>
      <div class="muted" style="margin-top:6px">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta.</div>`;
    }
  }

  // events
  document.getElementById("btnResult").addEventListener("click", showResult);
  document.getElementById("btnTxt").addEventListener("click", downloadTXT);
  document.getElementById("btnPdf").addEventListener("click", downloadPDF);
  document.getElementById("btnClear").addEventListener("click", clearLoads);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });

  init();
</script>
</body>
</html>