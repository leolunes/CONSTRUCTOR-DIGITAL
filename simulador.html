<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de Cargas del Hogar</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#5eead4;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:560px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:750;font-size:13px;}
    input, select, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:88px;resize:vertical;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:900;cursor:pointer;}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .muted{color:var(--muted);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}
    .table{margin-top:12px;border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);vertical-align:top;}
    th{font-size:12px;text-align:left;color:var(--muted);background:rgba(255,255,255,.03);}
    td{font-size:13px;}
    .tag{display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);}
    .svgBox{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:18px;padding:10px;}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .k{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block;margin-right:6px;}
    .premium{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    .premiumBox{border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:10px 12px;background:rgba(0,0,0,.10);}
    .big{font-weight:950;font-size:18px;}
    .bigNum{font-weight:950;font-size:22px;letter-spacing:.3px;}
    .stateBad{color:#fda4af;}
    .stateGood{color:#34d399;}
    .stateWarn{color:#fcd34d;}

    .rangeRow{display:flex;gap:10px;align-items:center;}
    .rangeRow input[type="range"]{padding:0;height:34px}
    .rangeBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .rangeDot{width:10px;height:10px;border-radius:999px;display:inline-block;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">Simulador de Cargas del Hogar</h1>
    <p class="sub" id="d"></p>
    <div style="margin-top:10px">
      <span class="pill">Laboratorio didáctico (sin servidor)</span>
      <span class="pill" id="pCount">Cargas: 0</span>
      <span class="pill" id="modePill">Modo: —</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- IZQ -->
    <div class="card">
      <div class="row">
        <div>
          <b>Simulación del pórtico</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            Flechas por carga (color por tipo + magnitud por rangos). Sísmica = flecha horizontal en el nudo.
          </div>
        </div>
        <span class="pill" id="liveState">Estado: —</span>
      </div>

      <div class="svgBox" style="margin-top:10px;">
        <svg id="svg" viewBox="0 0 560 390" width="100%" height="auto" aria-label="Pórtico simulable">
          <rect x="0" y="340" width="560" height="50" fill="rgba(255,255,255,.05)"></rect>

          <g id="frame">
            <rect id="foundation" x="70" y="300" width="150" height="40" rx="10"
              fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)"></rect>
            <text x="145" y="325" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">CIMIENTO (CRISTO)</text>

            <rect id="column" x="135" y="90" width="22" height="210" rx="10"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="146" y="80" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">COLUMNA (VARÓN)</text>

            <rect id="beam" x="146" y="90" width="290" height="18" rx="9"
              fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.20)"></rect>
            <text x="290" y="75" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">VIGA (MUJER)</text>

            <circle id="rollerBase" cx="436" cy="110" r="11"
              fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"></circle>
            <rect x="412" y="123" width="48" height="10" rx="4" fill="rgba(255,255,255,.08)"></rect>
            <text x="436" y="155" text-anchor="middle" font-size="12" fill="rgba(255,255,255,.75)">INTERSECCIÓN</text>

            <circle id="joint" cx="146" cy="99" r="10" fill="#64748b"></circle>
            <text x="162" y="103" font-size="12" fill="rgba(255,255,255,.75)">NUDO</text>

            <path id="crack" d="" stroke="#fb7185" stroke-width="3" fill="none" opacity="0"></path>
          </g>

          <g id="loadLayer"></g>
          <g id="travelLayer"></g>
        </svg>

        <div class="legend" id="rangeLegend"></div>

        <div class="premium">
          <div class="premiumBox">
            <div class="muted">Estado</div>
            <div class="big" id="premiumState">—</div>
            <div class="muted" style="margin-top:6px;font-size:12px;" id="premiumSub">—</div>
          </div>
          <div class="premiumBox">
            <div class="muted">Equilibrio</div>
            <div class="bigNum">∑Fy: <span id="sumFy">0</span></div>
            <div class="bigNum">∑Fx: <span id="sumFx">0</span></div>
            <div class="bigNum">∑M: <span id="sumM">0</span></div>
          </div>
        </div>
      </div>

      <div class="mini">
        <h3>Reglas rápidas</h3>
        <ul id="rules"></ul>
      </div>

      <div class="btns">
        <button class="ghost" id="btnNoTransfer">Ver SIN transferencia</button>
        <button class="ghost" id="btnWithTransfer">Ver CON transferencia</button>
      </div>
    </div>

    <!-- DER -->
    <div class="card">
      <div class="row">
        <div>
          <b>Crear cargas</b>
          <div class="muted" style="font-size:13px;margin-top:4px;">Se guarda localmente. Exporta TXT y PDF premium.</div>
        </div>
        <span class="pill">Form</span>
      </div>

      <div class="fieldgrid">
        <div>
          <label>Paciente / hogar</label>
          <input id="patient" placeholder="Ej: Hogar Abraham y Sara">
        </div>
        <div>
          <label>Auditor</label>
          <input id="auditor" placeholder="Ej: Consejero / Pastor">
        </div>
        <div>
          <label>Fecha (editable)</label>
          <input id="date" type="date">
        </div>
        <div>
          <label>Observaciones</label>
          <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
        </div>
      </div>

      <div class="mini">
        <h3>Nueva carga</h3>
        <div class="fieldgrid">
          <div style="grid-column:1/-1">
            <label>Nombre (solo para listado / PDFs)</label>
            <input id="loadName" placeholder="Ej: Presión financiera / Discusión / Falta de altar">
          </div>

          <div>
            <label>Tipo</label>
            <select id="loadType"></select>
          </div>

          <div>
            <label>Ubicación</label>
            <select id="target"></select>
          </div>

          <div style="grid-column:1/-1">
            <label>Magnitud (por rangos)</label>
            <div class="rangeRow">
              <input id="mag" type="range" min="10" max="100" step="10" value="20" style="flex:1">
              <span class="rangeBadge" id="magBadge">
                <span class="rangeDot" id="magDot"></span>
                <span id="magTxt">—</span>
              </span>
            </div>
            <div class="muted" style="font-size:12px;margin-top:6px;" id="magHelp"></div>
          </div>

          <div style="grid-column:1/-1">
            <label>Detalle</label>
            <textarea id="detail" placeholder="Qué lo detona / qué se repite / qué se siente"></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnAdd">Agregar carga</button>
          <button class="ghost" id="btnClear">Limpiar</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:13px;">
          Nota: en el pórtico NO se transfiere el nombre; se transfiere la flecha con su magnitud y rango.
        </div>
      </div>

      <div class="btns">
        <button class="ghost" id="btnTransfer">Transferir cargas (animación)</button>
        <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
        <button class="ghost" id="btnPdf" disabled>Descargar PDF premium</button>
        <button class="ghost" id="btnTeachPdf" disabled>PDF Enseñanza (Libro)</button>
        <button class="ghost" id="btnReset">Borrar todo</button>
      </div>

      <div class="mini">
        <h3>Listado de cargas</h3>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>Carga</th>
                <th>Tipo</th>
                <th>Ubicación</th>
                <th>Magnitud</th>
                <th>Rango</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "simulador.json";
  const LOGO_PATH = "logo.png";
  const STORAGE_KEY = "simulador_cargas_v2";

  let DATA=null;
  let logoDataUrl=null;

  const state = {
    header: { patient:"", auditor:"", date:"", notes:"" },
    loads: [],
    transferred: false
  };

  // ===== Elements =====
  const tEl = document.getElementById("t");
  const dEl = document.getElementById("d");
  const rulesEl = document.getElementById("rules");
  const rangeLegend = document.getElementById("rangeLegend");

  const pCount = document.getElementById("pCount");
  const modePill = document.getElementById("modePill");
  const liveState = document.getElementById("liveState");

  const premiumState = document.getElementById("premiumState");
  const premiumSub = document.getElementById("premiumSub");
  const sumFyEl = document.getElementById("sumFy");
  const sumFxEl = document.getElementById("sumFx");
  const sumMEl = document.getElementById("sumM");

  const patientEl = document.getElementById("patient");
  const auditorEl = document.getElementById("auditor");
  const dateEl = document.getElementById("date");
  const notesEl = document.getElementById("notes");

  const loadNameEl = document.getElementById("loadName");
  const loadTypeEl = document.getElementById("loadType");
  const targetEl = document.getElementById("target");
  const magEl = document.getElementById("mag");
  const magBadge = document.getElementById("magBadge");
  const magDot = document.getElementById("magDot");
  const magTxt = document.getElementById("magTxt");
  const magHelp = document.getElementById("magHelp");
  const detailEl = document.getElementById("detail");

  const rowsEl = document.getElementById("rows");
  const btnTxt = document.getElementById("btnTxt");
  const btnPdf = document.getElementById("btnPdf");
  const btnTeachPdf = document.getElementById("btnTeachPdf");
  const pdfWarn = document.getElementById("pdfWarn");

  // SVG
  const svgEl = document.getElementById("svg");
  const frameEl = document.getElementById("frame");
  const crackEl = document.getElementById("crack");
  const jointEl = document.getElementById("joint");
  const loadLayer = document.getElementById("loadLayer");
  const travelLayer = document.getElementById("travelLayer");

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) &&
           !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function save(){
    state.header.patient = patientEl.value || "";
    state.header.auditor = auditorEl.value || "";
    state.header.date = dateEl.value || "";
    state.header.notes = notesEl.value || "";
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      state.header = payload.header || state.header;
      state.loads = Array.isArray(payload.loads) ? payload.loads : [];
      state.transferred = !!payload.transferred;
    }catch(e){}
  }

  function fillHeaderUI(){
    patientEl.value = state.header.patient || "";
    auditorEl.value = state.header.auditor || "";
    dateEl.value = state.header.date || "";
    notesEl.value = state.header.notes || "";
  }

  function enumItem(list, key){
    return list.find(x=>x.key===key) || null;
  }
  function enumLabel(list, key){
    const it = enumItem(list, key);
    return it ? it.label : key;
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  // ===== RANGOS =====
  function bandForMag(mag){
    const m = Number(mag||0);
    const b = (DATA.magnitude && Array.isArray(DATA.magnitude.bands))
      ? DATA.magnitude.bands.find(x => m >= x.min && m <= x.max)
      : null;
    // fallback seguro
    return b || { key:"media", label:"Media (ajuste)", badgeColor:"#f59e0b", summary:"" };
  }

  function applyMagUI(){
    const m = Number(magEl.value || (DATA.magnitude?.default||20));
    const b = bandForMag(m);
    magDot.style.background = b.badgeColor;
    magTxt.textContent = `${m} · ${b.label}`;
    magHelp.textContent = b.summary || "";
  }

  function clampToStep(val){
    const min = Number(DATA.magnitude?.min ?? 10);
    const max = Number(DATA.magnitude?.max ?? 100);
    const step = Number(DATA.magnitude?.step ?? 10);
    let v = Math.max(min, Math.min(max, Number(val||min)));
    // snap
    const snapped = Math.round((v - min)/step) * step + min;
    v = Math.max(min, Math.min(max, snapped));
    return v;
  }

  // ===== Enums UI =====
  function setupEnums(){
    loadTypeEl.innerHTML = DATA.enums.loadType.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
    targetEl.innerHTML = DATA.enums.target.map(x=>`<option value="${x.key}">${x.label}</option>`).join("");
  }

  function setupMagnitude(){
    const min = Number(DATA.magnitude?.min ?? 10);
    const max = Number(DATA.magnitude?.max ?? 100);
    const step = Number(DATA.magnitude?.step ?? 10);
    const def = Number(DATA.magnitude?.default ?? 20);

    magEl.min = String(min);
    magEl.max = String(max);
    magEl.step = String(step);
    magEl.value = String(clampToStep(def));
    applyMagUI();

    // legend ranges
    rangeLegend.innerHTML = "";
    (DATA.magnitude?.bands || []).forEach(b=>{
      const div = document.createElement("div");
      div.className = "k";
      div.innerHTML = `<span class="dot" style="background:${b.badgeColor}"></span>${escapeHtml(b.label)} (${b.min}-${b.max})`;
      rangeLegend.appendChild(div);
    });
  }

  // ===== SIM MATH (didáctico) =====
  function sums(){
    let Fy=0, Fx=0, M=0;

    state.loads.forEach(L=>{
      const mag = Number(L.mag||0);
      if(L.type === "sismica") Fx += mag;
      else Fy += mag;

      const b = bandForMag(mag);
      const w = (b.key==="baja")?1 : (b.key==="media")?1.15 : (b.key==="alta")?1.35 : 1.65;

      if(!state.transferred){
        if(L.type === "sismica") M += mag * 2.0 * w;
        if(L.target === "viga" && L.type !== "sismica") M += mag * 1.2 * w;
        if(L.target === "columna" && L.type !== "sismica") M += mag * 0.8 * w;
      }else{
        if(L.type === "sismica") M += mag * 0.25 * w;
      }
    });

    return {Fy:Math.round(Fy), Fx:Math.round(Fx), M:Math.round(M)};
  }

  // ===== SVG helpers =====
  function svgElNS(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }
  function clearLayer(g){ while(g.firstChild) g.removeChild(g.firstChild); }

  function addArrow({x,y,dir,color,mag,band}){
    const g = svgElNS("g");
    g.setAttribute("opacity","0.95");

    const w = Math.max(14, Math.min(42, 14 + mag*0.28));
    const h = Math.max(30, Math.min(95, 30 + mag*0.60));

    const line = svgElNS("line");
    line.setAttribute("stroke", color);
    line.setAttribute("stroke-width", String(4 + (band.key==="critica"?2:band.key==="alta"?1:0)));
    line.setAttribute("stroke-linecap","round");

    const head = svgElNS("polygon");
    head.setAttribute("fill", color);

    // MAG text
    const txt = svgElNS("text");
    txt.setAttribute("fill", "rgba(255,255,255,.92)");
    txt.setAttribute("font-size","12");
    txt.setAttribute("font-weight","950");
    txt.setAttribute("text-anchor","middle");
    txt.textContent = String(mag);

    // RANGE badge next to mag (colored)
    const badge = svgElNS("rect");
    badge.setAttribute("rx","8");
    badge.setAttribute("ry","8");
    badge.setAttribute("fill", band.badgeColor);
    badge.setAttribute("opacity","0.95");

    const badgeTxt = svgElNS("text");
    badgeTxt.setAttribute("fill", "#071018");
    badgeTxt.setAttribute("font-size","10");
    badgeTxt.setAttribute("font-weight","950");
    badgeTxt.setAttribute("text-anchor","middle");
    badgeTxt.textContent =
      band.key === "baja" ? "B" :
      band.key === "media" ? "M" :
      band.key === "alta" ? "A" : "C";

    if(dir === "down"){
      line.setAttribute("x1", x);
      line.setAttribute("y1", y);
      line.setAttribute("x2", x);
      line.setAttribute("y2", y + h);

      head.setAttribute("points", `${x},${y+h+10} ${x-9},${y+h-2} ${x+9},${y+h-2}`);

      txt.setAttribute("x", x);
      txt.setAttribute("y", y - 8);

      // badge to the right of mag
      const bw = 20, bh = 16;
      badge.setAttribute("x", String(x + 12));
      badge.setAttribute("y", String(y - 22));
      badge.setAttribute("width", String(bw));
      badge.setAttribute("height", String(bh));
      badgeTxt.setAttribute("x", String(x + 12 + bw/2));
      badgeTxt.setAttribute("y", String(y - 10));
    }else{
      line.setAttribute("x1", x);
      line.setAttribute("y1", y);
      line.setAttribute("x2", x + h);
      line.setAttribute("y2", y);

      head.setAttribute("points", `${x+h+10},${y} ${x+h-2},${y-9} ${x+h-2},${y+9}`);

      txt.setAttribute("x", x + (h/2));
      txt.setAttribute("y", y - 10);

      // badge above and slightly right
      const bw = 20, bh = 16;
      badge.setAttribute("x", String(x + (h/2) + 14));
      badge.setAttribute("y", String(y - 26));
      badge.setAttribute("width", String(bw));
      badge.setAttribute("height", String(bh));
      badgeTxt.setAttribute("x", String(x + (h/2) + 14 + bw/2));
      badgeTxt.setAttribute("y", String(y - 14));
    }

    g.appendChild(line);
    g.appendChild(head);
    g.appendChild(txt);
    g.appendChild(badge);
    g.appendChild(badgeTxt);

    loadLayer.appendChild(g);
    return g;
  }

  function layoutLoads(){
    clearLayer(loadLayer);

    const beamXs = [250, 320, 390, 460];
    const colXs  = [110, 140];
    let bI=0, cI=0, nI=0;

    state.loads.forEach(L=>{
      const lt = enumItem(DATA.enums.loadType, L.type);
      const color = lt ? lt.color : "#e5e7eb";
      const mag = clampToStep(L.mag);
      const band = bandForMag(mag);

      // sísmica siempre horizontal en nudo
      if(L.type === "sismica" || L.target === "nudo"){
        const x = 160;
        const y = 118 + (nI*22);
        nI++;
        addArrow({x,y,dir:"right",color,mag,band});
      }else if(L.target === "columna"){
        const x = colXs[cI % colXs.length];
        const y = 34;
        cI++;
        addArrow({x,y,dir:"down",color,mag,band});
      }else{
        const x = beamXs[bI % beamXs.length];
        const y = 34;
        bI++;
        addArrow({x,y,dir:"down",color,mag,band});
      }
    });
  }

  // ===== Simulation states =====
  function setUnstable(){
    const {Fx,M} = sums();
    const dx = Math.min(58, Fx * 0.35 + M * 0.08);
    const rot = Math.min(14, Fx * 0.05 + M * 0.012);
    frameEl.setAttribute("transform", `translate(${dx},0) rotate(${rot} 146 300)`);

    crackEl.setAttribute("opacity","1");
    crackEl.setAttribute("d", "M120 300 L140 285 L132 270 L150 252 L142 236 L165 220");
    jointEl.setAttribute("fill", "#fb7185");
  }

  function setStable(){
    frameEl.setAttribute("transform", `translate(0,0) rotate(0 146 300)`);
    crackEl.setAttribute("opacity","0");
    crackEl.setAttribute("d", "");
    jointEl.setAttribute("fill", "#10b981");
  }

  function applyMode(){
    if(state.transferred){
      setStable();
      liveState.textContent = "Estado: Estable (transferido)";
      premiumState.textContent = "CON transferencia";
      premiumState.className = "big stateGood";
      premiumSub.textContent = "Cargas descargadas al Cimiento (Cristo). Menos deriva y fisuras.";
      modePill.textContent = "Modo: CON transferencia";
    }else{
      setUnstable();
      liveState.textContent = "Estado: Deriva + fisuras (no transferido)";
      premiumState.textContent = "SIN transferencia";
      premiumState.className = "big stateBad";
      premiumSub.textContent = "Cargas retenidas: aumenta ∑M (rotación), deriva y fisuras.";
      modePill.textContent = "Modo: SIN transferencia";
    }
  }

  function updatePremiumNumbers(){
    const {Fy,Fx,M} = sums();
    sumFyEl.textContent = Fy;
    sumFxEl.textContent = Fx;
    sumMEl.textContent = M;
  }

  // ===== Transfer animation =====
  function animateTransfer(){
    clearLayer(travelLayer);

    const duration = 850;
    const now = performance.now();

    function makeGhost(color){
      const g = svgElNS("g");
      g.setAttribute("opacity","0.95");
      const c = svgElNS("circle");
      c.setAttribute("r","8");
      c.setAttribute("fill", color);
      g.appendChild(c);
      travelLayer.appendChild(g);
      return {g,c};
    }

    const ghosts = state.loads.map(L=>{
      const lt = enumItem(DATA.enums.loadType, L.type);
      return { L, color: (lt?lt.color:"#e5e7eb"), ghost: makeGhost(lt?lt.color:"#e5e7eb") };
    });

    function pathsFor(L){
      const end = {x:145, y:320};

      if(L.type==="sismica" || L.target==="nudo"){
        const start = {x:170, y:120};
        const mid = {x:145, y:170};
        return [start, mid, end];
      }
      if(L.target==="columna"){
        const start = {x:125, y:60};
        const mid = {x:145, y:180};
        return [start, mid, end];
      }
      const start = {x:320, y:60};
      const mid = {x:170, y:110};
      return [start, mid, end];
    }

    function lerp(a,b,t){ return a + (b-a)*t; }

    function tick(ts){
      const t = ts - now;
      const segT = t / duration;
      ghosts.forEach(({L,ghost})=>{
        const pts = pathsFor(L);
        const seg = Math.min(1.999, Math.max(0, segT));
        const idx = seg < 1 ? 0 : 1;
        const local = seg < 1 ? seg : (seg-1);
        const A = pts[idx], B = pts[idx+1];
        const x = lerp(A.x, B.x, local);
        const y = lerp(A.y, B.y, local);
        ghost.g.setAttribute("transform", `translate(${x} ${y})`);
      });

      if(t < duration*2){
        requestAnimationFrame(tick);
      }else{
        state.transferred = true;
        save();
        render();
        travelLayer.setAttribute("opacity","0.0");
        setTimeout(()=>{ travelLayer.setAttribute("opacity","1"); clearLayer(travelLayer); }, 180);
      }
    }

    const guide = svgElNS("path");
    guide.setAttribute("stroke","rgba(255,255,255,.25)");
    guide.setAttribute("stroke-width","2");
    guide.setAttribute("fill","none");
    guide.setAttribute("stroke-dasharray","6 6");
    guide.setAttribute("d","M320 60 L170 110 L145 320 M125 60 L145 180 L145 320 M170 120 L145 170 L145 320");
    travelLayer.appendChild(guide);

    requestAnimationFrame(tick);
  }

  // ===== CRUD loads =====
  function clearForm(){
    loadNameEl.value = "";
    detailEl.value = "";
    loadTypeEl.value = "viva";
    targetEl.value = "viga";
    magEl.value = String(clampToStep(DATA.magnitude?.default ?? 20));
    applyMagUI();
  }

  function addLoad(){
    const name = (loadNameEl.value||"").trim() || "Carga";
    const type = loadTypeEl.value;
    let target = targetEl.value;

    let mag = clampToStep(magEl.value);

    // enforce: sismica -> nudo
    if(type === "sismica") target = "nudo";

    const L = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
      name,
      type,
      target,
      mag,
      bandKey: bandForMag(mag).key,
      detail: (detailEl.value||"").trim(),
      createdAt: new Date().toISOString()
    };

    state.loads.unshift(L);
    save();
    clearForm();
    render();
  }

  function deleteLoad(id){
    if(!confirm("¿Eliminar esta carga?")) return;
    state.loads = state.loads.filter(x=>x.id !== id);
    save();
    render();
  }

  function renderRows(){
    rowsEl.innerHTML = "";
    state.loads.forEach(L=>{
      const lt = enumItem(DATA.enums.loadType, L.type);
      const tColor = lt ? lt.color : "#e5e7eb";
      const band = bandForMag(L.mag);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(L.name)}</b><div class="muted" style="font-size:12px;margin-top:4px">${escapeHtml(L.detail||"")}</div></td>
        <td><span class="tag" style="border-color:${tColor};color:${tColor}">${escapeHtml(enumLabel(DATA.enums.loadType, L.type))}</span></td>
        <td><span class="tag">${escapeHtml(enumLabel(DATA.enums.target, L.target))}</span></td>
        <td><b>${escapeHtml(String(clampToStep(L.mag)))}</b></td>
        <td><span class="tag" style="border-color:${band.badgeColor};color:${band.badgeColor}">${escapeHtml(band.label)}</span></td>
        <td><button class="ghost" style="padding:6px 10px;border-radius:10px;font-weight:900" data-del="${L.id}">Eliminar</button></td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteLoad(btn.getAttribute("data-del")));
    });
  }

  function renderRules(){
    rulesEl.innerHTML = "";
    (DATA.texts.rules || []).forEach(r=>{
      const li = document.createElement("li");
      li.textContent = r;
      rulesEl.appendChild(li);
    });
  }

  function render(){
    pCount.textContent = `Cargas: ${state.loads.length}`;
    btnTxt.disabled = state.loads.length === 0;
    const pdfOk = okPdfLib();
    btnPdf.disabled = state.loads.length === 0 || !pdfOk;
    btnTeachPdf.disabled = !pdfOk;
    pdfWarn.style.display = pdfOk ? "none" : "block";

    // ensure mags snapped
    state.loads.forEach(L=>{
      L.mag = clampToStep(L.mag);
      L.bandKey = bandForMag(L.mag).key;
    });

    layoutLoads();
    updatePremiumNumbers();
    applyMode();
    renderRows();
  }

  // ===== TXT export =====
  function buildTXT(){
    const out=[];
    out.push((DATA.meta.title||"SIMULADOR").toUpperCase());
    out.push("");
    out.push("DATOS");
    out.push(`Paciente: ${patientEl.value || "(no especificado)"}`);
    out.push(`Auditor: ${auditorEl.value || "(no especificado)"}`);
    out.push(`Fecha: ${dateEl.value || "(no especificada)"}`);
    out.push("Observaciones:");
    out.push(notesEl.value || "(sin observaciones)");
    out.push("");

    const S = sums();
    out.push("RESUMEN PREMIUM");
    out.push(`Estado: ${state.transferred ? "CON transferencia" : "SIN transferencia"}`);
    out.push(`∑Fy: ${S.Fy} | ∑Fx: ${S.Fx} | ∑M: ${S.M}`);
    out.push("");

    out.push("CARGAS");
    out.push("--------------------------------------------------");
    state.loads.forEach(x=>{
      const band = bandForMag(x.mag);
      out.push(`- ${x.name}`);
      out.push(`  Tipo: ${enumLabel(DATA.enums.loadType,x.type)} | Ubicación: ${enumLabel(DATA.enums.target,x.target)} | Magnitud: ${x.mag} | Rango: ${band.label}`);
      if(x.detail) out.push(`  Detalle: ${x.detail}`);
      out.push("");
    });

    out.push("VERSO FUNDAMENTO");
    out.push(`${DATA.verses.foundation.quote} (${DATA.verses.foundation.reference})`);
    out.push("");
    out.push("PLAN DE TRANSFERENCIA (pasos)");
    (DATA.planTemplates.transferSteps||[]).forEach(s=> out.push("• "+s));
    out.push("");
    return out.join("\n");
  }

  function downloadTXT(){
    const txt = buildTXT();
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simulador_cargas.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ===== PDF helpers =====
  async function loadLogo(){
    try{
      const res = await fetch(LOGO_PATH, { cache:"no-store" });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeName(name){
    return (name||"simulador")
      .toLowerCase().replace(/\s+/g,"_")
      .replace(/[^a-z0-9_\-]/g,"")
      .slice(0,60);
  }

  function waitFrame(){
    return new Promise(r => requestAnimationFrame(() => r()));
  }

  async function svgToPngData(svg, w, h){
    const xml = new XMLSerializer().serializeToString(svg);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const imgSrc = "data:image/svg+xml;base64," + svg64;

    const img = new Image();
    img.crossOrigin = "anonymous";
    await new Promise((resolve,reject)=>{
      img.onload = ()=> resolve();
      img.onerror = ()=> reject(new Error("No se pudo renderizar el SVG a imagen."));
      img.src = imgSrc;
    });

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  async function captureScenarioMode(mode){
    const prev = state.transferred;
    state.transferred = (mode === "yes");
    render();
    await waitFrame();
    const snap = await svgToPngData(svgEl, 1500, 1050);
    const S = sums();
    state.transferred = prev;
    render();
    await waitFrame();
    return { snap, S };
  }

  function drawPremiumBox(doc, x, y, w, h, modeLabel, S){
    doc.setFillColor(255,255,255);
    doc.roundedRect(x, y, w, h, 10, 10, "F");
    doc.setTextColor(22,33,58);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Resumen premium", x+12, y+20);

    const isYes = modeLabel.toLowerCase().includes("con");
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.setTextColor(isYes ? 16 : 244, isYes ? 185 : 63, isYes ? 129 : 94);
    doc.text(modeLabel, x+12, y+42);

    doc.setTextColor(22,33,58);
    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    doc.text(`∑Fy: ${S.Fy}`, x+12, y+68);
    doc.text(`∑Fx: ${S.Fx}`, x+12, y+92);
    doc.text(`∑M: ${S.M}`, x+12, y+116);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(90,102,130);
    doc.text(DATA.texts.premiumLegend || "", x+12, y+h-12);
  }

  async function downloadPDFPremium(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Simulador de Cargas del Hogar — Transferencia al Cimiento", M, H-18);
        doc.text(`Página ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    // PORTADA
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56, 18, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("SIMULADOR DE CARGAS DEL HOGAR", M, 50);

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Antes vs Después + Equilibrio (∑Fy, ∑Fx, ∑M) + Rangos + Plan", M, 72);

    doc.setFillColor(245,247,255);
    doc.roundedRect(M, 120, W-M*2, 120, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${patientEl.value || "(no especificado)"}`, M+14, 172);
    doc.text(`Auditor: ${auditorEl.value || "(no especificado)"}`, M+14, 192);
    doc.text(`Fecha: ${dateEl.value || "(no especificada)"}`, M+14, 212);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 260, W-M*2, 140, 12, 12, "F");
    doc.setFont("helvetica","bold");
    doc.setTextColor(...INK);
    doc.text("Verso fundamento", M+14, 288);
    doc.setFont("times","italic");
    doc.setFontSize(11);
    doc.setTextColor(20,60,70);
    doc.text(doc.splitTextToSize(DATA.verses.foundation.quote, W-M*2-28), M+14, 310);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(70,90,110);
    doc.text(`(${DATA.verses.foundation.reference})`, M+14, 384);

    // PAGE 2: ANTES
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("ANTES — Sin transferencia (deriva + fisuras)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const before = await captureScenarioMode("no");
    drawPremiumBox(doc, M, 90, W-M*2, 135, "SIN transferencia", before.S);

    const imgW = W - M*2;
    const imgH = (imgW * 1050) / 1500;
    doc.addImage(before.snap, "PNG", M, 240, imgW, Math.min(imgH, H-300));

    // PAGE 3: DESPUÉS
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("DESPUÉS — Con transferencia al Cimiento (Cristo)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const after = await captureScenarioMode("yes");
    drawPremiumBox(doc, M, 90, W-M*2, 135, "CON transferencia", after.S);
    doc.addImage(after.snap, "PNG", M, 240, imgW, Math.min(imgH, H-300));

    // PAGE 4: tabla de cargas + rangos
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Cargas registradas (con rangos)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    doc.autoTable({
      startY: 92,
      head: [["Carga", "Tipo", "Ubicación", "Magnitud", "Rango"]],
      body: state.loads.map(L=>{
        const band = bandForMag(L.mag);
        return [
          L.name,
          enumLabel(DATA.enums.loadType, L.type),
          enumLabel(DATA.enums.target, L.target),
          String(L.mag),
          band.label
        ];
      }),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      margin:{left:M, right:M}
    });

    // PAGE 5: plan 7 días
    doc.addPage();
    addLogo(M, 16, 32, 32);
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(...INK);
    doc.text("Plan semanal automático (7 días)", M, 64);
    doc.setDrawColor(230); doc.line(M, 74, W-M, 74);

    const planRows = (DATA.planTemplates.plan7||[]).map(d=>[
      `Día ${d.day}`,
      d.title,
      (d.items||[]).join(" • ")
    ]);

    doc.autoTable({
      startY: 92,
      head: [["Día", "Enfoque", "Acciones"]],
      body: planRows,
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:170},2:{cellWidth:W-M*2-70-170}},
      margin:{left:M, right:M}
    });

    footer();
    const name = safeName(patientEl.value || "hogar");
    doc.save(`${name}_simulador_premium.pdf`);
  }

  async function downloadTeachingPDF(){
    if(!okPdfLib()){
      pdfWarn.style.display="block";
      return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogo();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK = [22,33,58];
    const MUTED = [90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }

    function header(title){
      addLogo(M, 16, 32, 32);
      doc.setFont("helvetica","bold");
      doc.setFontSize(13);
      doc.setTextColor(...INK);
      doc.text(title, W/2, 36, {align:"center"});
      doc.setDrawColor(230);
      doc.line(M, 52, W-M, 52);
      return 74;
    }

    function footer(){
      const n = doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Enseñanza — Simulador de Cargas del Hogar (Enfoque del Libro)", M, H-18);
        doc.text(`Página ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }

    const T = DATA.teachingPdf;

    // PORTADA
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,110,"F");
    addLogo(W-M-56, 26, 56, 56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    doc.setTextColor(255,255,255);
    doc.text(T.title, M, 56);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11.5);
    doc.setTextColor(210,230,255);
    doc.text(doc.splitTextToSize(T.subtitle, W-M*2), M, 84);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M, 140, W-M*2, 170, 12, 12, "F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Marco (como el libro)", M+14, 166);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    const frameText = (T.frame||[]).map(x=>"• "+x).join("\n");
    doc.text(frameText, M+14, 190);

    doc.setFillColor(240,253,250);
    doc.roundedRect(M, 330, W-M*2, 70, 12, 12, "F");
    doc.setFont("times","italic");
    doc.setFontSize(11);
    doc.setTextColor(20,60,70);
    doc.text(doc.splitTextToSize(`${DATA.verses.burdens.quote}`, W-M*2-28), M+14, 356);
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(70,90,110);
    doc.text(`(${DATA.verses.burdens.reference})`, M+14, 392);

    // Página: ideas clave
    doc.addPage();
    let y = header("Ideas clave (estructura espiritual)");
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Lectura estructural", M, y); y += 18;

    doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(...INK);
    const ideas = (T.keyIdeas||[]).map(x=>"• "+x).join("\n");
    doc.text(ideas, M, y); y += 110;

    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Rangos de magnitud (cómo interpretarlos)", M, y); y += 14;

    doc.setFont("helvetica","normal"); doc.setFontSize(10.5);
    const bandLines = (DATA.magnitude.bands||[]).map(b=>`• ${b.label} (${b.min}-${b.max}): ${b.summary}`).join("\n");
    doc.text(doc.splitTextToSize(bandLines, W-M*2), M, y);

    // Página: flujo de uso
    doc.addPage();
    y = header("Cómo usar la app en taller / consejería");
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Paso a paso", M, y); y += 18;
    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    const how = (T.howToUse||[]).map(x=>"• "+x).join("\n");
    doc.text(doc.splitTextToSize(how, W-M*2), M, y); y += 180;

    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Flujo sugerido (80 min)", M, y); y += 10;

    doc.autoTable({
      startY: y + 8,
      head: [["Min", "Bloque", "Qué hacer"]],
      body: (T.workshopFlow||[]).map(b=>[b.min, b.title, (b.items||[]).join(" • ")]),
      theme:"grid",
      styles:{font:"helvetica", fontSize:9.5, cellPadding:6, textColor:[20,30,50], lineColor:[230,234,245], valign:"top"},
      headStyles:{fillColor:[22,33,58], textColor:[255,255,255], fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:160},2:{cellWidth:W-M*2-70-160}},
      margin:{left:M, right:M}
    });

    // Página: preguntas + cierre
    doc.addPage();
    y = header("Preguntas guía + cierre");
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Preguntas (para activar transferencia)", M, y); y += 18;

    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    const qs = (T.questions||[]).map(x=>"• "+x).join("\n");
    doc.text(doc.splitTextToSize(qs, W-M*2), M, y); y += 150;

    doc.setFillColor(245,247,255);
    doc.roundedRect(M, y, W-M*2, 120, 12, 12, "F");
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(...INK);
    doc.text("Cierre", M+14, y+22);

    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    const closing = (T.closing||[]).map(x=>"• "+x).join("\n");
    doc.text(doc.splitTextToSize(closing, W-M*2-28), M+14, y+46);

    footer();
    const name = safeName(patientEl.value || "hogar");
    doc.save(`${name}_ensenanza_simulador.pdf`);
  }

  // ===== Init helpers =====
  function renderRules(){
    rulesEl.innerHTML = "";
    (DATA.texts.rules || []).forEach(r=>{
      const li = document.createElement("li");
      li.textContent = r;
      rulesEl.appendChild(li);
    });
  }

  function resetAll(){
    if(!confirm("¿Borrar TODO el simulador?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.header = { patient:"", auditor:"", date:"", notes:"" };
    state.loads = [];
    state.transferred = false;
    fillHeaderUI();
    setDefaultDateIfEmpty();
    clearForm();
    save();
    render();
  }

  async function init(){
    try{
      const res = await fetch(JSON_PATH, {cache:"no-store"});
      if(!res.ok) throw new Error("No se pudo cargar el JSON: "+res.status);
      DATA = await res.json();

      tEl.textContent = DATA.meta.title || "Simulador";
      dEl.textContent = DATA.meta.description || "";

      setupEnums();
      setupMagnitude();
      renderRules();

      load();
      fillHeaderUI();
      setDefaultDateIfEmpty();
      clearForm();

      pdfWarn.style.display = okPdfLib() ? "none" : "block";
      render();
    }catch(e){
      document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${e.message}<br><span style="color:#a7b4d6">Asegúrate de que ${JSON_PATH} esté en la misma carpeta.</span></div>`;
    }
  }

  // ===== Events =====
  document.getElementById("btnAdd").addEventListener("click", addLoad);
  document.getElementById("btnClear").addEventListener("click", clearForm);

  document.getElementById("btnTransfer").addEventListener("click", ()=>{
    if(state.loads.length===0) return alert("Primero agrega cargas.");
    animateTransfer();
  });

  document.getElementById("btnNoTransfer").addEventListener("click", ()=>{
    state.transferred = false;
    save(); render();
  });

  document.getElementById("btnWithTransfer").addEventListener("click", ()=>{
    state.transferred = true;
    save(); render();
  });

  document.getElementById("btnTxt").addEventListener("click", downloadTXT);
  document.getElementById("btnPdf").addEventListener("click", downloadPDFPremium);
  document.getElementById("btnTeachPdf").addEventListener("click", downloadTeachingPDF);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  [patientEl,auditorEl,dateEl,notesEl].forEach(el=>{
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });

  magEl.addEventListener("input", ()=>{
    // snap to step while sliding
    magEl.value = String(clampToStep(magEl.value));
    applyMagUI();
  });

  loadTypeEl.addEventListener("change", ()=>{
    if(loadTypeEl.value==="sismica") targetEl.value = "nudo";
  });

  init();
</script>
</body>
</html>