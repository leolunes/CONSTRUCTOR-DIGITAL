<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La columna: el var√≥n como eje estructural ‚Äî Test</title>

  <!-- jsPDF + autoTable (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e8eefc;
      --muted:#aab7d6;
      --line:#22304e;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --bad:#fb7185;
      --good:#34d399;
      --orange:#fb923c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.22), transparent 60%),
                  radial-gradient(1200px 700px at 85% 0%, rgba(167,243,208,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 60px}
    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:18px 18px;border:1px solid var(--line);background:rgba(17,26,46,.72);
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(8px);
      position:sticky;top:0;z-index:30;
    }
    .titleBlock{display:flex;gap:14px;align-items:center;min-width:280px}
    .logo{
      width:44px;height:44px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);padding:6px;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12.5px;margin-top:2px}
    .live{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(15,23,42,.7);
      font-size:12.5px;
    }
    .pill b{font-family:var(--mono);font-size:12.5px}
    .pill .dot{width:9px;height:9px;border-radius:999px;background:var(--accent)}
    .pill.good .dot{background:var(--good)}
    .pill.warn .dot{background:var(--warn)}
    .pill.risk .dot{background:var(--orange)}
    .pill.bad .dot{background:var(--bad)}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;margin-top:16px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(17,26,46,.75);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:700px){.fields{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="text"], input[type="date"], textarea{
      width:100%;
      background:rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:10px 12px;border-radius:14px;
      background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.12));
      color:var(--text);
      border:1px solid rgba(125,211,252,.35);
      font-weight:600;
    }
    button.secondary{background:rgba(15,23,42,.7);border:1px solid rgba(255,255,255,.14);font-weight:600;}
    button.danger{background:linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.12));border:1px solid rgba(251,113,133,.38);}
    button:disabled{opacity:.5;cursor:not-allowed}
    .smallNote{color:var(--muted);font-size:12px;margin-top:8px}
    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12.5px;margin-left:auto;}
    .toggle input{transform: translateY(1px)}
    .section{
      margin-top:16px;border:1px solid var(--line);border-radius:var(--radius);
      overflow:hidden;background:rgba(17,26,46,.62);box-shadow:var(--shadow);
    }
    .sectionHead{
      padding:14px 14px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background:rgba(15,23,42,.65);border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sectionHead h3{margin:0;font-size:14px}
    .sectionHead .metaLine{color:var(--muted);font-size:12.5px;margin-top:4px}
    .sectionBody{padding:10px 14px 14px}
    .q{padding:12px 0;border-bottom:1px dashed rgba(255,255,255,.12);}
    .q:last-child{border-bottom:0}
    .q .qText{font-size:13.5px;margin-bottom:8px}
    .scaleRow{display:flex;flex-wrap:wrap;gap:8px;}
    .opt{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;background:rgba(15,23,42,.55);
      font-size:12.5px;color:var(--text);user-select:none;
    }
    .opt input{margin:0}
    .opt:hover{border-color: rgba(125,211,252,.35)}
    .results{
      margin-top:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.62);border-radius:var(--radius);overflow:hidden;
    }
    .resultsHead{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:14px;border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(17,26,46,.75);
    }
    .resultsHead h2{margin:0;font-size:15px}
    .resBody{padding:14px}
    .bandBox{
      padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.35);
    }
    .bandTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 10px;
      border:1px solid rgba(255,255,255,.14);background:rgba(15,23,42,.65);
      font-size:12.5px;font-weight:700;
    }
    .tag.good{border-color: rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
    .tag.warn{border-color: rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
    .tag.risk{border-color: rgba(251,146,60,.38);background:rgba(251,146,60,.12)}
    .tag.bad{border-color: rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .verse{
      margin-top:10px;color:var(--muted);font-size:12.5px;border-left:3px solid rgba(125,211,252,.35);
      padding-left:10px;
    }
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12.5px;}
    th,td{ text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); vertical-align:top; }
    th{color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}
    .plan{margin-top:14px;display:grid;grid-template-columns:1fr;gap:10px;}
    .day{padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(11,18,32,.30);}
    .day b{font-family:var(--mono);font-size:12.5px}
    .err{
      margin-top:14px;padding:12px;border-radius:16px;border:1px solid rgba(251,113,133,.38);
      background:rgba(251,113,133,.10);color:var(--text);
    }
    .footerNote{margin-top:18px;color:var(--muted);font-size:12px}

    /* P√≥rtico */
    .porticoWrap{margin-top:12px;display:grid;grid-template-columns: 1fr;gap:10px;}
    .porticoTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;}
    .porticoSvgBox{
      border:1px solid rgba(255,255,255,.12);background:rgba(11,18,32,.30);
      border-radius:16px;padding:10px;overflow:auto;
    }
    .legendRow{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12.5px;}
    .lg{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background:rgba(15,23,42,.55);
    }

    /* Loader strip */
    .strip{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.30);margin-top:10px;
      color:var(--muted);font-size:12.5px;
    }
    .strip strong{color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleBlock">
        <img class="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <div>
          <h1>[La columna: el var√≥n como eje estructural]</h1>
          <div class="sub">Auditor√≠a diagn√≥stica basada en el cap√≠tulo 5: ‚ÄúLa columna‚Äù</div>
        </div>
      </div>
      <div class="live">
        <div id="liveScorePill" class="pill"><span class="dot"></span><span>Puntaje:</span> <b id="liveScore">0</b><span class="muted">/</span><b id="liveMax">0</b></div>
        <div id="livePercentPill" class="pill"><span class="dot"></span><span>Progreso:</span> <b id="liveAnswered">0</b><span class="muted">/</span><b id="liveTotalQ">0</b></div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Datos del informe</h2>
        <div class="fields">
          <div>
            <label for="patientName">Nombre del paciente</label>
            <input id="patientName" type="text" placeholder="Ej: Juan P√©rez" />
          </div>
          <div>
            <label for="auditorName">Nombre del auditor</label>
            <input id="auditorName" type="text" placeholder="Ej: Pastor / Mentor / Auditor" />
          </div>
          <div>
            <label for="dateField">Fecha</label>
            <input id="dateField" type="date" />
          </div>
          <div>
            <label for="includeDetails">Detalle por pregunta (para TXT/PDF)</label>
            <div class="toggle" style="margin-left:0">
              <input id="includeDetails" type="checkbox" />
              <span>Incluir detalles</span>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label for="notes">Observaciones libres</label>
          <textarea id="notes" placeholder="Notas del auditor, contexto, acuerdos, etc."></textarea>
        </div>

        <div class="controls">
          <button id="btnResults" disabled>Ver resultado</button>
          <button id="btnTxt" class="secondary" disabled>Descargar TXT</button>
          <button id="btnPdf" class="secondary" disabled>Descargar PDF bonito</button>
          <button id="btnPng" class="secondary" disabled>Descargar Imagen (PNG)</button>
          <button id="btnReset" class="danger" disabled>Reiniciar</button>
          <div class="toggle">
            <input id="autoScroll" type="checkbox" checked />
            <span>Auto-bajar a resultados</span>
          </div>
        </div>

        <div class="strip">
          <strong>JSON:</strong> <span id="jsonStatus">cargando‚Ä¶</span>
          <span class="muted">¬∑</span>
          <span>Si est√°s en <span class="muted">file://</span>, usa ‚ÄúCargar JSON manual‚Äù.</span>
          <input id="jsonFile" type="file" accept="application/json" style="display:none" />
          <button id="btnLoadJson" class="secondary" type="button">Cargar JSON manual</button>
        </div>

        <div class="smallNote">Escala 0‚Äì5 (radio buttons). No se permiten n√∫meros escritos manualmente.</div>
        <div id="loadError" class="err" style="display:none"></div>
      </div>

      <div class="card">
        <h2>Gu√≠a r√°pida de lectura</h2>
        <div class="bandBox">
          <div class="muted" style="font-size:12.5px">
            Este test detecta <b>transferencia de cargas</b>, <b>verticalidad</b>, <b>inclinaciones</b> (ego/evasi√≥n),
            <b>empotramiento en Cristo</b> y <b>efecto sist√©mico</b>.
            <br><br>
            Incluye <b>Diagrama del p√≥rtico</b> (Comuni√≥n, Congregaci√≥n, Intersecci√≥n) para visualizar el estado estructural del hogar.
          </div>
        </div>
        <div class="footerNote">
          Archivos requeridos: <span class="muted">ensenanza05.json</span>, <span class="muted">ensenanza05.html</span> y <span class="muted">logo.png</span> en la misma carpeta.
        </div>
      </div>
    </div>

    <div id="testRoot"></div>

    <div id="resultsRoot" class="results" style="display:none">
      <div class="resultsHead">
        <h2>Resultados</h2>
        <div class="pill"><span class="dot"></span><span>Total:</span> <b id="resTotal">0</b><span class="muted">/</span><b id="resMax">0</b> <span class="muted">¬∑</span> <b id="resPct">0%</b></div>
      </div>
      <div class="resBody">
        <div id="globalBox" class="bandBox"></div>

        <!-- Diagrama del p√≥rtico -->
        <div style="margin-top:12px">
          <h2 style="margin:0 0 10px;font-size:14px">Diagrama del p√≥rtico</h2>
          <div class="bandBox">
            <div class="porticoTop">
              <div class="muted" style="font-size:12.5px">
                Visual estructural calculado desde el test (Comuni√≥n, Congregaci√≥n, Intersecci√≥n).
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <div id="pillComunion" class="pill"><span class="dot"></span><span>Comuni√≥n:</span> <b id="pctComunion">0%</b></div>
                <div id="pillCongregacion" class="pill"><span class="dot"></span><span>Congregaci√≥n:</span> <b id="pctCongregacion">0%</b></div>
                <div id="pillInterseccion" class="pill"><span class="dot"></span><span>Intersecci√≥n:</span> <b id="pctInterseccion">0%</b></div>
              </div>
            </div>

            <div class="porticoWrap">
              <div class="porticoSvgBox">
                <div id="porticoSvgMount"></div>
              </div>

              <div class="legendRow">
                <span class="lg">üü¢ Alineado</span>
                <span class="lg">üü° En ajuste</span>
                <span class="lg">üü† En riesgo</span>
                <span class="lg">üî¥ Cr√≠tico</span>
              </div>

              <div class="smallNote">El bot√≥n ‚ÄúDescargar Imagen (PNG)‚Äù exporta exactamente este diagrama (860√ó420) con t√≠tulo y fecha.</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h2 style="margin:0 0 10px;font-size:14px">Resultados por secci√≥n</h2>
          <div style="overflow:auto">
            <table id="sectionTable">
              <thead>
                <tr>
                  <th>Secci√≥n</th>
                  <th>Diagn√≥stico</th>
                  <th>Puntaje</th>
                  <th>%</th>
                  <th>Enfoque</th>
                  <th>Verso</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:14px">
          <h2 style="margin:0 0 10px;font-size:14px">Enfoque pastoral por secciones</h2>
          <div id="pastoralBlocks"></div>
        </div>

        <div style="margin-top:14px">
          <h2 style="margin:0 0 10px;font-size:14px">Plan semanal autom√°tico (7 d√≠as)</h2>
          <div class="muted" style="font-size:12.5px;margin-bottom:8px">
            Basado en las secciones con mayor tensi√≥n (menor %). Se prioriza restauraci√≥n con pasos peque√±os y sostenibles.
          </div>
          <div id="weeklyPlan" class="plan"></div>
        </div>

        <div class="footerNote">Tip: descarga el PDF para una lectura ordenada con portada, tablas, diagrama, plan y enfoque pastoral.</div>
      </div>
    </div>

  </div>

<script>
(() => {
  const JSON_PATH = './ensenanza05.json';
  const TITLE = '[La columna: el var√≥n como eje estructural]';

  const GLOBAL_THRESHOLDS = [
    { min: 0.85, band: 'Alineado' },
    { min: 0.65, band: 'Ajuste' },
    { min: 0.40, band: 'Riesgo' },
    { min: 0.00, band: 'Cr√≠tico' }
  ];
  const SECTION_THRESHOLDS = [
    { min: 0.75, band: 'Alineado' },
    { min: 0.50, band: 'Ajuste' },
    { min: 0.00, band: 'Riesgo' }
  ];

  const PORTICO_BANDS = [
    { min: 75, label: 'Alineado', key: 'good', emoji:'üü¢' },
    { min: 55, label: 'En ajuste', key: 'warn', emoji:'üü°' },
    { min: 35, label: 'En riesgo', key: 'risk', emoji:'üü†' },
    { min: 0,  label: 'Cr√≠tico',  key: 'bad',  emoji:'üî¥' }
  ];

  const el = (id) => document.getElementById(id);

  const state = {
    data: null,
    answers: new Map(),
    totalQuestions: 0,
    maxPerQuestion: 5,
    maxTotal: 0,
    lastPorticoPNG: null
  };

  function enableUI(enabled){
    const ids = ['btnResults','btnTxt','btnPdf','btnPng','btnReset'];
    ids.forEach(id => { const b = el(id); if (b) b.disabled = !enabled; });
  }

  function showError(msg){
    const box = el('loadError');
    box.style.display = '';
    box.textContent = msg;
  }
  function clearError(){
    const box = el('loadError');
    box.style.display = 'none';
    box.textContent = '';
  }

  // Defaults
  try {
    const today = new Date();
    const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
    el('dateField').value = iso;
  } catch {}

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function fmtPct(p){ return `${Math.round(p*100)}%`; }
  function safeText(s){ return (s ?? '').toString(); }

  // DOM-safe id (sin romper q.id real)
  function domSafeId(str){
    // Base64url-ish simple (no dependencias)
    const s = safeText(str);
    let out = '';
    for (let i=0;i<s.length;i++){
      const c = s.charCodeAt(i);
      out += (c>=48&&c<=57)||(c>=65&&c<=90)||(c>=97&&c<=122) ? s[i] : '_';
    }
    return out || 'id';
  }

  function getScaleOptions(){
    const opts = state.data?.scale?.options || [];
    const nums = opts.map(o => Number(o.value)).filter(v => Number.isFinite(v));
    const max = nums.length ? Math.max(...nums) : 5;
    state.maxPerQuestion = max;
    return opts;
  }

  function computeTotals(){
    let total = 0;
    let answered = 0;
    for (const [, val] of state.answers.entries()){
      if (Number.isFinite(val)){
        total += val;
        answered += 1;
      }
    }
    return { total, answered };
  }

  function pickBand(pct, thresholds, kind){
    const p = clamp(pct, 0, 1);
    const chosen = thresholds.find(t => p >= t.min) || thresholds[thresholds.length - 1];
    const label = chosen.band;

    if (!state.data?.rubrics) return { label, summary:'', verse:{quote:'',reference:''} };

    if (kind === 'global'){
      const bandObj = (state.data.rubrics.globalBands || []).find(b => b.label === label);
      return bandObj || (state.data.rubrics.globalBands || [])[0] || { label, summary:'', verse:{quote:'',reference:''} };
    } else {
      const bandObj = (state.data.rubrics.sectionBands || []).find(b => b.label === label);
      return bandObj || (state.data.rubrics.sectionBands || [])[0] || { label, summary:'', verse:{quote:'',reference:''} };
    }
  }

  function computeBySection(){
    const sections = state.data.sections || [];
    const by = [];
    for (const s of sections){
      let score = 0;
      let answered = 0;
      const qCount = (s.questions || []).length;
      for (const q of (s.questions || [])){
        const v = state.answers.get(q.id);
        if (Number.isFinite(v)){
          score += v;
          answered += 1;
        }
      }
      const max = qCount * state.maxPerQuestion;
      const pct = max > 0 ? (score / max) : 0;
      const band = pickBand(pct, SECTION_THRESHOLDS, 'section');
      by.push({ section: s, score, max, pct, answered, qCount, band });
    }
    by.sort((a,b) => a.pct - b.pct);
    return by;
  }

  function bandClass(label){
    const l = (label || '').toLowerCase();
    if (l.includes('aline')) return 'good';
    if (l.includes('ajust')) return 'warn';
    if (l.includes('riesg')) return 'risk';
    if (l.includes('cr√≠t') || l.includes('crit')) return 'bad';
    return '';
  }

  function porticoBandFromPct100(p){
    const v = clamp(Math.round(p), 0, 100);
    const chosen = PORTICO_BANDS.find(b => v >= b.min) || PORTICO_BANDS[PORTICO_BANDS.length - 1];
    return chosen;
  }

  function colorForPorticoKey(key){
    if (key === 'good') return '#34d399';
    if (key === 'warn') return '#fbbf24';
    if (key === 'risk') return '#fb923c';
    return '#fb7185';
  }

  function setJsonStatus(ok, msg){
    const st = el('jsonStatus');
    st.textContent = msg;
    st.style.color = ok ? 'var(--good)' : 'var(--bad)';
  }

  function renderTest(){
    const root = el('testRoot');
    root.innerHTML = '';

    const data = state.data;
    const scale = getScaleOptions();
    const sections = data.sections || [];

    let totalQ = 0;
    for (const s of sections) totalQ += (s.questions || []).length;
    state.totalQuestions = totalQ;
    state.maxTotal = totalQ * state.maxPerQuestion;

    el('liveMax').textContent = state.maxTotal;
    el('liveTotalQ').textContent = totalQ;

    for (const s of sections){
      const sec = document.createElement('div');
      sec.className = 'section';
      sec.dataset.sectionId = s.id;

      const head = document.createElement('div');
      head.className = 'sectionHead';

      const left = document.createElement('div');
      const h = document.createElement('h3');
      h.textContent = s.title;

      const meta = document.createElement('div');
      meta.className = 'metaLine';
      meta.textContent = `${safeText(s.subtitle)} ¬∑ Enfoque: ${safeText(s.diagnosticFocus)}`;

      left.appendChild(h);
      left.appendChild(meta);

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '10px';
      right.style.alignItems = 'center';
      right.style.flexWrap = 'wrap';
      right.innerHTML = `
        <div class="pill"><span class="dot"></span><span>Secci√≥n:</span> <b id="secScore_${domSafeId(s.id)}">0</b><span class="muted">/</span><b id="secMax_${domSafeId(s.id)}">0</b></div>
      `;

      head.appendChild(left);
      head.appendChild(right);

      const body = document.createElement('div');
      body.className = 'sectionBody';

      for (const q of (s.questions || [])){
        const qWrap = document.createElement('div');
        qWrap.className = 'q';

        const qText = document.createElement('div');
        qText.className = 'qText';
        qText.textContent = q.text;

        const row = document.createElement('div');
        row.className = 'scaleRow';

        const qDom = domSafeId(q.id);

        for (const opt of scale){
          const id = `${qDom}_v${opt.value}`;
          const lab = document.createElement('label');
          lab.className = 'opt';
          lab.setAttribute('for', id);

          const inp = document.createElement('input');
          inp.type = 'radio';
          inp.name = qDom;               // name DOM-safe
          inp.id = id;
          inp.value = String(opt.value);
          inp.dataset.qid = q.id;        // qid real
          inp.addEventListener('change', () => {
            state.answers.set(q.id, Number(inp.value));
            state.lastPorticoPNG = null;
            updateLive();
          });

          const span = document.createElement('span');
          span.textContent = `${opt.label}`;

          lab.appendChild(inp);
          lab.appendChild(span);
          row.appendChild(lab);
        }

        qWrap.appendChild(qText);
        qWrap.appendChild(row);
        body.appendChild(qWrap);
      }

      sec.appendChild(head);
      sec.appendChild(body);
      root.appendChild(sec);

      const secMax = (s.questions || []).length * state.maxPerQuestion;
      const maxEl = el(`secMax_${domSafeId(s.id)}`);
      if (maxEl) maxEl.textContent = secMax;
    }

    updateLive();
  }

  function computePorticoAxes(){
    const by = computeBySection();
    const axisAgg = {
      comunion: { score:0, max:0 },
      congregacion: { score:0, max:0 },
      interseccion: { score:0, max:0 }
    };

    for (const it of by){
      const axis = it.section.porticoAxis || 'comunion';
      if (!axisAgg[axis]) continue;
      axisAgg[axis].score += it.score;
      axisAgg[axis].max += it.max;
    }

    const toPct100 = (obj) => obj.max > 0 ? (obj.score / obj.max) * 100 : 0;

    const comunionPct = toPct100(axisAgg.comunion);
    const congregacionPct = toPct100(axisAgg.congregacion);
    const interseccionPct = toPct100(axisAgg.interseccion);

    return {
      comunion: { pct: comunionPct, band: porticoBandFromPct100(comunionPct) },
      congregacion: { pct: congregacionPct, band: porticoBandFromPct100(congregacionPct) },
      interseccion: { pct: interseccionPct, band: porticoBandFromPct100(interseccionPct) }
    };
  }

  function updatePorticoUI(){
    const axes = computePorticoAxes();

    const setPill = (pillId, pctId, axis) => {
      const pill = el(pillId);
      const pctEl = el(pctId);
      if (!pill || !pctEl) return;
      pctEl.textContent = `${Math.round(axes[axis].pct)}%`;
      pill.classList.remove('good','warn','risk','bad');
      pill.classList.add(axes[axis].band.key);
    };

    setPill('pillComunion', 'pctComunion', 'comunion');
    setPill('pillCongregacion', 'pctCongregacion', 'congregacion');
    setPill('pillInterseccion', 'pctInterseccion', 'interseccion');

    renderPorticoSVG();
  }

  function updateLive(){
    const { total, answered } = computeTotals();

    el('liveScore').textContent = total;
    el('liveAnswered').textContent = answered;

    const pct = state.maxTotal ? total / state.maxTotal : 0;
    const pill = el('liveScorePill');
    pill.classList.remove('good','warn','risk','bad');
    const label = pickBand(pct, GLOBAL_THRESHOLDS, 'global').label || '';
    const cls = bandClass(label);
    if (cls) pill.classList.add(cls);

    const pill2 = el('livePercentPill');
    pill2.classList.remove('good','warn','risk','bad');
    if (answered === state.totalQuestions && state.totalQuestions > 0) pill2.classList.add('good');
    else if (answered > 0) pill2.classList.add('warn');

    const bySection = computeBySection().reduce((acc, it) => { acc[it.section.id] = it; return acc; }, {});
    for (const s of (state.data.sections || [])){
      const it = bySection[s.id];
      const scoreEl = el(`secScore_${domSafeId(s.id)}`);
      if (scoreEl) scoreEl.textContent = it ? it.score : 0;
    }

    if (el('resultsRoot').style.display !== 'none'){
      updatePorticoUI();
    }
  }

  function buildGlobalBox(globalBand, pct){
    const cls = bandClass(globalBand.label);
    const tagClass = cls ? `tag ${cls}` : 'tag';
    const verse = globalBand.verse || { quote:'', reference:'' };

    return `
      <div class="bandTop">
        <span class="${tagClass}">Diagn√≥stico global: ${safeText(globalBand.label)}</span>
        <span class="pill"><span class="dot"></span><span>Porcentaje:</span> <b>${fmtPct(pct)}</b></span>
      </div>
      <div style="margin-top:10px;color:var(--text);font-size:13px">${safeText(globalBand.summary)}</div>
      <div class="verse">üìñ ‚Äú${safeText(verse.quote)}‚Äù <span class="muted">(${safeText(verse.reference)})</span></div>
    `;
  }

  function getMiniTeachingForSection(sectionId){
    const list = state.data?.pastoralManual?.sections || [];
    return list.find(x => x.id === sectionId)?.miniTeaching || null;
  }

  function buildWeeklyPlanFromSections(bySectionSortedLow){
    const priority = bySectionSortedLow.slice(0, 3);
    const pools = priority.map(it => {
      const mini = getMiniTeachingForSection(it.section.id);
      return { title: it.section.title, actions: (mini?.oneWeekPlan || []).slice() };
    }).filter(p => p.actions.length);

    const days = [];
    for (let i=0;i<7;i++){
      const picks = [];
      for (let j=0;j<pools.length;j++){
        const pool = pools[(i + j) % pools.length];
        const act = pool.actions[i % pool.actions.length];
        if (act) picks.push({ sec: pool.title, act });
        if (picks.length >= 2) break;
      }
      if (!picks.length){
        picks.push({ sec: 'Alineaci√≥n general', act: 'Ora: ‚ÄúSe√±or, alinea mi vida contigo; ens√©√±ame a recibir y transferir correctamente el peso.‚Äù' });
      }
      days.push(picks);
    }
    return days;
  }

  // -------------------------
  // DIAGRAMA DEL P√ìRTICO (SVG) ‚Äî GEOMETR√çA FIJA (NO MODIFICAR)
  // -------------------------
  function buildPorticoSVGMarkup(){
    const axes = computePorticoAxes();
    const patient = safeText(el('patientName').value).trim();
    const date = safeText(el('dateField').value).trim();

    const comm = axes.comunion;
    const cong = axes.congregacion;
    const inter = axes.interseccion;

    const cComm = colorForPorticoKey(comm.band.key);
    const cCong = colorForPorticoKey(cong.band.key);
    const cInter = colorForPorticoKey(inter.band.key);

    const labelBand = (a) => `${a.band.emoji} ${a.band.label} (${Math.round(a.pct)}%)`;

    const W = 860, H = 420;

    const foundation = { x:110, y:320, w:220, h:48, rx:14 };
    const col = { x:220, y1:310, y2:130 };
    const beam = { x1:220, y:130, x2:660 };

    const nCom = { x:220, y:310, r:14 };
    const nCong = { x:220, y:130, r:14 };
    const nInter = { x:660, y:130, r:14 };

    const titleLine = `Diagrama del p√≥rtico ‚Äî ${patient ? patient : 'Paciente'} ‚Äî ${date || 'Fecha'}`;

    return `
<svg id="porticoSvg" xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <rect x="0" y="0" width="${W}" height="${H}" rx="22" fill="#0b1220"/>
  <rect x="18" y="18" width="${W-36}" height="${H-36}" rx="18" fill="#0f172a" stroke="rgba(255,255,255,0.10)"/>

  <text x="${W/2}" y="70" fill="rgba(232,238,252,0.90)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="18" font-weight="700" text-anchor="middle">
    CARGAS (vivas + muertas)
  </text>
  <text x="${W/2}" y="94" fill="rgba(170,183,214,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" text-anchor="middle">
    (decorativo) ‚Üí‚Üí hacia la viga
  </text>

  <path d="M 520 110 C 560 125, 600 135, 640 130" fill="none" stroke="rgba(125,211,252,0.30)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 535 122 C 570 136, 605 144, 650 138" fill="none" stroke="rgba(167,243,208,0.22)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>

  <rect x="${foundation.x}" y="${foundation.y}" width="${foundation.w}" height="${foundation.h}" rx="${foundation.rx}"
        fill="none" stroke="${cComm}" stroke-width="22" stroke-linejoin="round"/>
  <text x="${foundation.x + foundation.w/2}" y="${foundation.y + foundation.h/2 + 5}"
        fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700" text-anchor="middle">
    CIMIENTO
  </text>

  <path d="M ${col.x} ${col.y1} L ${col.x} ${col.y2}" fill="none" stroke="${cCong}" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
  <text x="155" y="220" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700"
        text-anchor="middle" transform="rotate(-90 155 220)">
    COLUMNA (VAR√ìN)
  </text>

  <path d="M ${beam.x1} ${beam.y} L ${beam.x2} ${beam.y}" fill="none" stroke="${cInter}" stroke-width="22" stroke-linecap="round" stroke-linejoin="round"/>
  <text x="${(beam.x1+beam.x2)/2}" y="${beam.y - 26}"
        fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700" text-anchor="middle">
    VIGA (MUJER)
  </text>

  <circle cx="${nCom.x}" cy="${nCom.y}" r="${nCom.r}" fill="#0b1220" stroke="${cComm}" stroke-width="10"/>
  <circle cx="${nCong.x}" cy="${nCong.y}" r="${nCong.r}" fill="#0b1220" stroke="${cCong}" stroke-width="10"/>
  <circle cx="${nInter.x}" cy="${nInter.y}" r="${nInter.r}" fill="#0b1220" stroke="${cInter}" stroke-width="10"/>

  <text x="${nCom.x}" y="${nCom.y + 40}" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700" text-anchor="middle">
    COMUNI√ìN
  </text>
  <text x="${nCong.x + 18}" y="${nCong.y - 22}" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700" text-anchor="start">
    CONGREGACI√ìN
  </text>
  <text x="${nInter.x}" y="${nInter.y - 22}" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="700" text-anchor="middle">
    INTERSECCI√ìN / APOYO M√ìVIL
  </text>

  <g>
    <rect x="520" y="230" width="300" height="120" rx="16" fill="rgba(11,18,32,0.65)" stroke="rgba(255,255,255,0.10)"/>
    <text x="540" y="262" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13" font-weight="800">
      ESTADO POR EJES
    </text>

    <circle cx="548" cy="286" r="6" fill="${cComm}"/>
    <text x="562" y="290" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13">
      COMUNI√ìN: ${labelBand(comm)}
    </text>

    <circle cx="548" cy="312" r="6" fill="${cCong}"/>
    <text x="562" y="316" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13">
      CONGREGACI√ìN: ${labelBand(cong)}
    </text>

    <circle cx="548" cy="338" r="6" fill="${cInter}"/>
    <text x="562" y="342" fill="rgba(232,238,252,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="13">
      INTERSECCI√ìN: ${labelBand(inter)}
    </text>
  </g>

  <text x="${W/2}" y="${H-26}" fill="rgba(170,183,214,0.95)" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="12" text-anchor="middle">
    ${titleLine}
  </text>
</svg>`;
  }

  function renderPorticoSVG(){
    const mount = el('porticoSvgMount');
    if (!mount) return;
    mount.innerHTML = buildPorticoSVGMarkup();
  }

  function svgToPngDataURL(svgEl, width=860, height=420){
    return new Promise((resolve, reject) => {
      try{
        const serializer = new XMLSerializer();
        const svgStr = serializer.serializeToString(svgEl);
        const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const img = new Image();
        img.onload = () => {
          try{
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#0b1220';
            ctx.fillRect(0,0,width,height);
            ctx.drawImage(img, 0, 0, width, height);
            URL.revokeObjectURL(url);
            resolve(canvas.toDataURL('image/png'));
          } catch(e){
            URL.revokeObjectURL(url);
            reject(e);
          }
        };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      } catch(e){ reject(e); }
    });
  }

  async function exportPorticoPNGDataURL(){
    if (state.lastPorticoPNG) return state.lastPorticoPNG;
    const svg = document.getElementById('porticoSvg');
    if (!svg) throw new Error('No se encontr√≥ el SVG del p√≥rtico.');
    const dataUrl = await svgToPngDataURL(svg, 860, 420);
    state.lastPorticoPNG = dataUrl;
    return dataUrl;
  }

  function downloadDataURL(dataURL, filename){
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // -------------------------
  // RESULTS RENDER
  // -------------------------
  function renderResults(){
    const { total } = computeTotals();
    const max = state.maxTotal || 1;
    const pct = total / max;

    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');

    el('resTotal').textContent = total;
    el('resMax').textContent = max;
    el('resPct').textContent = fmtPct(pct);

    el('globalBox').innerHTML = buildGlobalBox(globalBand, pct);

    updatePorticoUI();

    const tbody = el('sectionTable').querySelector('tbody');
    tbody.innerHTML = '';

    const bySectionRaw = computeBySection();
    const bySectionOriginalOrder = (state.data.sections || []).map(s => bySectionRaw.find(x => x.section.id === s.id)).filter(Boolean);

    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const secVerse = s.sectionVerse || { quote:'', reference:'' };
      const diag = it.band?.label || '‚Äî';
      const diagSummary = it.band?.summary || '';
      const diagCell = `<b>${safeText(diag)}</b><div class="muted" style="margin-top:4px">${safeText(diagSummary)}</div>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${safeText(s.title)}</b><div class="muted" style="margin-top:4px">${safeText(s.subtitle)}</div></td>
        <td>${diagCell}</td>
        <td><span style="font-family:var(--mono)">${it.score}</span> / <span class="muted">${it.max}</span></td>
        <td><b>${fmtPct(it.pct)}</b></td>
        <td class="muted">${safeText(s.diagnosticFocus)}</td>
        <td class="muted">‚Äú${safeText(secVerse.quote)}‚Äù (${safeText(secVerse.reference)})</td>
      `;
      tbody.appendChild(tr);
    }

    const pastoralRoot = el('pastoralBlocks');
    pastoralRoot.innerHTML = '';
    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const mini = getMiniTeachingForSection(s.id);
      const cls = bandClass(it.band?.label || '');
      const tagClass = cls ? `tag ${cls}` : 'tag';

      const block = document.createElement('div');
      block.className = 'bandBox';
      block.style.marginBottom = '10px';

      if (!mini){
        block.innerHTML = `
          <div class="bandTop">
            <span class="${tagClass}">${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')}</span>
            <span class="pill"><span class="dot"></span><span>${fmtPct(it.pct)}</span></span>
          </div>
          <div class="muted" style="margin-top:10px">No se encontr√≥ mini-ense√±anza para esta secci√≥n.</div>
        `;
      } else {
        const bullets = (mini.text || []).map(x => `<li>${safeText(x)}</li>`).join('');
        const v = mini.verse || { quote:'', reference:'' };
        block.innerHTML = `
          <div class="bandTop">
            <span class="${tagClass}">${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')}</span>
            <span class="pill"><span class="dot"></span><span>Puntaje:</span> <b>${it.score}</b><span class="muted">/</span><b>${it.max}</b> <span class="muted">¬∑</span> <b>${fmtPct(it.pct)}</b></span>
          </div>
          <div style="margin-top:10px"><b>${safeText(mini.title)}</b></div>
          <ul style="margin:8px 0 0 18px;color:var(--text);font-size:13px">${bullets}</ul>
          <div class="verse">üìñ ‚Äú${safeText(v.quote)}‚Äù <span class="muted">(${safeText(v.reference)})</span></div>
        `;
      }
      pastoralRoot.appendChild(block);
    }

    const week = buildWeeklyPlanFromSections(bySectionRaw);
    const planRoot = el('weeklyPlan');
    planRoot.innerHTML = '';
    for (let i=0;i<7;i++){
      const dayBox = document.createElement('div');
      dayBox.className = 'day';
      const items = (week[i] || []).map(p => `<div style="margin-top:6px"><span class="muted">(${safeText(p.sec)})</span> ${safeText(p.act)}</div>`).join('');
      dayBox.innerHTML = `<b>D√≠a ${i+1}</b>${items}`;
      planRoot.appendChild(dayBox);
    }

    el('resultsRoot').style.display = '';
    if (el('autoScroll').checked){
      el('resultsRoot').scrollIntoView({ behavior:'smooth', block:'start' });
    }
  }

  // -------------------------
  // TXT EXPORT
  // -------------------------
  function buildTXTReport(){
    const patient = safeText(el('patientName').value).trim() || '‚Äî';
    const auditor = safeText(el('auditorName').value).trim() || '‚Äî';
    const date = safeText(el('dateField').value).trim() || '‚Äî';
    const notes = safeText(el('notes').value).trim() || '‚Äî';

    const { total, answered } = computeTotals();
    const max = state.maxTotal || 1;
    const pct = total / max;
    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');
    const gv = globalBand.verse || { quote:'', reference:'' };

    const axes = computePorticoAxes();

    const lines = [];
    lines.push(TITLE);
    lines.push('='.repeat(70));
    lines.push(`Paciente: ${patient}`);
    lines.push(`Auditor:  ${auditor}`);
    lines.push(`Fecha:    ${date}`);
    lines.push('');
    lines.push(`Diagn√≥stico global: ${safeText(globalBand.label)} (${fmtPct(pct)})`);
    lines.push(`Verso global: ‚Äú${safeText(gv.quote)}‚Äù (${safeText(gv.reference)})`);
    lines.push('');
    lines.push('DIAGRAMA DEL P√ìRTICO (EJES)');
    lines.push(`- Comuni√≥n:      ${Math.round(axes.comunion.pct)}% (${axes.comunion.band.label})`);
    lines.push(`- Congregaci√≥n:  ${Math.round(axes.congregacion.pct)}% (${axes.congregacion.band.label})`);
    lines.push(`- Intersecci√≥n:  ${Math.round(axes.interseccion.pct)}% (${axes.interseccion.band.label})`);
    lines.push('');
    lines.push('RESULTADOS POR SECCI√ìN');
    lines.push('-'.repeat(70));

    const bySectionRaw = computeBySection();
    const bySectionOriginalOrder = (state.data.sections || []).map(s => bySectionRaw.find(x => x.section.id === s.id)).filter(Boolean);

    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const sv = s.sectionVerse || { quote:'', reference:'' };
      lines.push(`‚Ä¢ ${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')} ‚Äî ${it.score}/${it.max} (${fmtPct(it.pct)})`);
      lines.push(`  Enfoque: ${safeText(s.diagnosticFocus)}`);
      lines.push(`  Verso: ‚Äú${safeText(sv.quote)}‚Äù (${safeText(sv.reference)})`);
      const mini = getMiniTeachingForSection(s.id);
      if (mini){
        lines.push(`  Mini-ense√±anza: ${safeText(mini.title
)}`);
        for (const b of (mini.text || [])) lines.push(`   - ${safeText(b)}`);
      }
      lines.push('');
    }

    lines.push('PLAN SEMANAL (7 D√çAS)');
    lines.push('-'.repeat(70));
    const week = buildWeeklyPlanFromSections(bySectionRaw);
    for (let i=0;i<7;i++){
      lines.push(`D√≠a ${i+1}:`);
      for (const p of (week[i] || [])){
        lines.push(`  - (${safeText(p.sec)}) ${safeText(p.act)}`);
      }
    }

    lines.push('');
    lines.push('OBSERVACIONES');
    lines.push('-'.repeat(70));
    lines.push(notes);
    lines.push('');

    const includeDetails = el('includeDetails').checked;
    if (includeDetails){
      lines.push('DETALLE DE RESPUESTAS');
      lines.push('-'.repeat(70));
      for (const s of (state.data.sections || [])){
        lines.push(`SECCI√ìN: ${safeText(s.title)}`);
        for (const q of (s.questions || [])){
          const v = state.answers.get(q.id);
          lines.push(` - ${safeText(q.text)} => ${Number.isFinite(v) ? v : '‚Äî'}`);
        }
        lines.push('');
      }
    } else {
      lines.push(`Detalle de respuestas: no incluido (respuestas contestadas: ${answered}/${state.totalQuestions}).`);
    }

    return lines.join('\n');
  }

  function downloadTextFile(text, filename){
    const blob = new Blob([text], { type:'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------------
  // PDF EXPORT (jsPDF + autoTable)
  // -------------------------
  async function buildAndDownloadPDF(){
    clearError();
    const { jsPDF } = (window.jspdf || {});
    if (!jsPDF) throw new Error('jsPDF no est√° disponible. Verifica conexi√≥n CDN.');
    if (!jsPDF.API || !jsPDF.API.autoTable) {
      // jspdf-autotable inyecta autoTable en la API
      // Aun as√≠, algunas cargas tard√≠as pueden fallar
    }

    const patient = safeText(el('patientName').value).trim() || '‚Äî';
    const auditor = safeText(el('auditorName').value).trim() || '‚Äî';
    const date = safeText(el('dateField').value).trim() || '‚Äî';
    const notes = safeText(el('notes').value).trim() || '‚Äî';

    const { total } = computeTotals();
    const max = state.maxTotal || 1;
    const pct = total / max;
    const globalBand = pickBand(pct, GLOBAL_THRESHOLDS, 'global');
    const gv = globalBand.verse || { quote:'', reference:'' };

    // Portico PNG
    renderPorticoSVG(); // ensure exists
    const porticoPng = await exportPorticoPNGDataURL();

    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    // Helpers
    const margin = 44;
    const line = (y) => { doc.setDrawColor(255,255,255,40); doc.line(margin, y, pageW-margin, y); };

    // Load logo (optional)
    async function loadLogoDataURL(){
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          try{
            const c = document.createElement('canvas');
            c.width = img.naturalWidth; c.height = img.naturalHeight;
            const ctx = c.getContext('2d');
            ctx.drawImage(img,0,0);
            resolve(c.toDataURL('image/png'));
          } catch { resolve(null); }
        };
        img.onerror = () => resolve(null);
        img.src = 'logo.png';
      });
    }
    const logoData = await loadLogoDataURL();

    // -------------
    // COVER
    // -------------
    doc.setFillColor(11,18,32);
    doc.rect(0,0,pageW,pageH,'F');

    // Title
    doc.setTextColor(232,238,252);
    doc.setFont('helvetica','bold');
    doc.setFontSize(18);
    doc.text(TITLE.replace(/[\[\]]/g,''), margin, 72, { maxWidth: pageW - margin*2 });

    doc.setFont('helvetica','normal');
    doc.setFontSize(11);
    doc.setTextColor(170,183,214);
    doc.text('Auditor√≠a diagn√≥stica estructural del hogar ‚Äî Cap√≠tulo 5: ‚ÄúLa columna‚Äù', margin, 96);

    // Logo
    if (logoData){
      try{
        doc.addImage(logoData, 'PNG', pageW - margin - 54, 54, 54, 54);
      } catch {}
    }

    // Patient/Auditor/Date box
    doc.setDrawColor(255,255,255,30);
    doc.setFillColor(15,23,42);
    doc.roundedRect(margin, 120, pageW - margin*2, 74, 12, 12, 'FD');
    doc.setFont('helvetica','bold');
    doc.setFontSize(11);
    doc.setTextColor(232,238,252);
    doc.text(`Paciente: ${patient}`, margin+14, 146);
    doc.text(`Auditor: ${auditor}`, margin+14, 166);
    doc.text(`Fecha: ${date}`, margin+14, 186);

    // Global pill (auto-fit)
    const pillText = `Diagn√≥stico global: ${safeText(globalBand.label)} ¬∑ ${Math.round(pct*100)}%`;
    doc.setFont('helvetica','bold');
    doc.setFontSize(11);
    const pillW = Math.min(pageW - margin*2, Math.max(240, doc.getTextWidth(pillText) + 26));
    doc.setFillColor(11,18,32);
    doc.setDrawColor(255,255,255,45);
    doc.roundedRect(margin, 210, pillW, 28, 999, 999, 'FD');
    doc.setTextColor(232,238,252);
    doc.text(pillText, margin+13, 229);

    // Global verse
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.setTextColor(170,183,214);
    doc.text(`üìñ ‚Äú${safeText(gv.quote)}‚Äù (${safeText(gv.reference)})`, margin, 256, { maxWidth: pageW - margin*2 });

    // Portico image centered
    const imgW = Math.min(pageW - margin*2, 460);
    const imgH = imgW * (420/860);
    const imgX = (pageW - imgW)/2;
    const imgY = 286;
    try{
      doc.addImage(porticoPng, 'PNG', imgX, imgY, imgW, imgH);
    } catch {}

    // -------------
    // INTERNAL PAGES HEADER helper
    // -------------
    function headerSmall(){
      doc.setFillColor(11,18,32);
      doc.rect(0,0,pageW,54,'F');
      doc.setTextColor(232,238,252);
      doc.setFont('helvetica','bold');
      doc.setFontSize(11);
      doc.text(TITLE.replace(/[\[\]]/g,''), margin, 34, { maxWidth: pageW - margin*2 - 60 });

      if (logoData){
        try{ doc.addImage(logoData, 'PNG', pageW - margin - 24, 16, 24, 24); } catch {}
      }
      doc.setDrawColor(255,255,255,25);
      doc.line(margin, 54, pageW-margin, 54);
    }

    // -------------
    // PAGE 2: TABLE
    // -------------
    doc.addPage();
    headerSmall();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Tabla de resultados por secci√≥n', margin, 84);

    const bySectionRaw = computeBySection();
    const bySectionOriginalOrder = (state.data.sections || []).map(s => bySectionRaw.find(x => x.section.id === s.id)).filter(Boolean);

    const tableBody = bySectionOriginalOrder.map(it => {
      const s = it.section;
      return [
        safeText(s.title),
        `${safeText(it.band?.label || '')}`,
        `${it.score}/${it.max}`,
        `${Math.round(it.pct*100)}%`,
        safeText(s.diagnosticFocus)
      ];
    });

    doc.autoTable({
      startY: 98,
      head: [['Secci√≥n','Diagn√≥stico','Puntaje','%','Enfoque']],
      body: tableBody,
      styles: { font:'helvetica', fontSize: 9, textColor: [232,238,252], cellPadding: 6 },
      headStyles: { fillColor: [15,23,42], textColor: [170,183,214] },
      bodyStyles: { fillColor: [11,18,32] },
      alternateRowStyles: { fillColor: [15,23,42] },
      margin: { left: margin, right: margin },
      tableLineColor: [255,255,255],
      tableLineWidth: 0.1
    });

    // -------------
    // PAGE 3+: PASTORAL MANUAL (all)
    // -------------
    doc.addPage();
    headerSmall();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Enfoque pastoral por secciones', margin, 84);

    let y = 102;
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);

    for (const it of bySectionOriginalOrder){
      const s = it.section;
      const mini = getMiniTeachingForSection(s.id);
      const sv = (mini?.verse || s.sectionVerse || { quote:'', reference:'' });

      // section box
      const boxH = 78;
      if (y + boxH > pageH - margin){
        doc.addPage();
        headerSmall();
        y = 78;
      }

      doc.setFillColor(15,23,42);
      doc.setDrawColor(255,255,255,30);
      doc.roundedRect(margin, y, pageW - margin*2, boxH, 10, 10, 'FD');

      doc.setTextColor(232,238,252);
      doc.setFont('helvetica','bold');
      doc.setFontSize(11);
      doc.text(`${safeText(s.title)} ‚Äî ${safeText(it.band?.label || '')} (${Math.round(it.pct*100)}%)`, margin+12, y+20, { maxWidth: pageW - margin*2 - 24 });

      doc.setFont('helvetica','normal');
      doc.setFontSize(9.5);
      doc.setTextColor(170,183,214);
      doc.text(`Enfoque: ${safeText(s.diagnosticFocus)}`, margin+12, y+36, { maxWidth: pageW - margin*2 - 24 });

      const teachingTitle = mini?.title ? safeText(mini.title) : 'Mini-ense√±anza';
      doc.setTextColor(232,238,252);
      doc.text(`${teachingTitle}`, margin+12, y+52, { maxWidth: pageW - margin*2 - 24 });

      doc.setTextColor(170,183,214);
      doc.text(`üìñ ‚Äú${safeText(sv.quote)}‚Äù (${safeText(sv.reference)})`, margin+12, y+68, { maxWidth: pageW - margin*2 - 24 });

      y += boxH + 10;
    }

    // -------------
    // PLAN SEMANAL
    // -------------
    doc.addPage();
    headerSmall();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Plan semanal autom√°tico (7 d√≠as)', margin, 84);

    const week = buildWeeklyPlanFromSections(bySectionRaw);
    let py = 104;
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);

    for (let i=0;i<7;i++){
      const dayTitle = `D√≠a ${i+1}`;
      const items = (week[i] || []).map(p => `‚Ä¢ (${safeText(p.sec)}) ${safeText(p.act)}`);
      const block = [dayTitle, ...items].join('\n');

      const needed = doc.getTextDimensions(block, { maxWidth: pageW - margin*2 - 20 }).h + 16;
      if (py + needed > pageH - margin){
        doc.addPage();
        headerSmall();
        py = 78;
      }

      doc.setFillColor(15,23,42);
      doc.setDrawColor(255,255,255,30);
      doc.roundedRect(margin, py, pageW - margin*2, needed, 10, 10, 'FD');

      doc.setFont('helvetica','bold');
      doc.setTextColor(232,238,252);
      doc.text(dayTitle, margin+12, py+18);

      doc.setFont('helvetica','normal');
      doc.setTextColor(170,183,214);
      doc.text(items.join('\n'), margin+12, py+34, { maxWidth: pageW - margin*2 - 24 });

      py += needed + 10;
    }

    // -------------
    // OBSERVACIONES + (opcional) DETALLES
    // -------------
    doc.addPage();
    headerSmall();
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(232,238,252);
    doc.text('Observaciones', margin, 84);

    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.setTextColor(170,183,214);
    doc.text(notes, margin, 104, { maxWidth: pageW - margin*2 });

    if (el('includeDetails').checked){
      doc.addPage();
      headerSmall();
      doc.setFont('helvetica','bold');
      doc.setFontSize(14);
      doc.setTextColor(232,238,252);
      doc.text('Detalle por pregunta', margin, 84);

      const detailRows = [];
      for (const s of (state.data.sections || [])){
        detailRows.push([{ content: safeText(s.title), colSpan: 3, styles: { fillColor:[15,23,42], textColor:[232,238,252], fontStyle:'bold' } }, '', '']);
        for (const q of (s.questions || [])){
          const v = state.answers.get(q.id);
          detailRows.push([safeText(q.text), Number.isFinite(v) ? String(v) : '‚Äî', `${state.maxPerQuestion}`]);
        }
      }

      doc.autoTable({
        startY: 98,
        head: [['Pregunta','Respuesta','Max']],
        body: detailRows,
        styles: { font:'helvetica', fontSize: 9, textColor: [232,238,252], cellPadding: 6 },
        headStyles: { fillColor: [15,23,42], textColor: [170,183,214] },
        bodyStyles: { fillColor: [11,18,32] },
        alternateRowStyles: { fillColor: [15,23,42] },
        margin: { left: margin, right: margin },
        tableLineColor: [255,255,255],
        tableLineWidth: 0.1
      });
    }

    // Save
    const fname = `informe_${patient.replace(/\s+/g,'_')}_${date}.pdf`.replace(/[^\w\-\.]/g,'_');
    doc.save(fname);
  }

  // -------------------------
  // PNG EXPORT
  // -------------------------
  async function downloadPorticoPNG(){
    clearError();
    renderPorticoSVG();
    const patient = safeText(el('patientName').value).trim() || 'paciente';
    const date = safeText(el('dateField').value).trim() || 'fecha';
    const dataUrl = await exportPorticoPNGDataURL();
    const fname = `portico_${patient.replace(/\s+/g,'_')}_${date}.png`.replace(/[^\w\-\.]/g,'_');
    downloadDataURL(dataUrl, fname);
  }

  // -------------------------
  // EVENTS
  // -------------------------
  function resetAll(){
    state.answers.clear();
    state.lastPorticoPNG = null;

    // uncheck radios
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);

    el('resultsRoot').style.display = 'none';
    el('liveScore').textContent = '0';
    el('liveAnswered').textContent = '0';
    updateLive();
    clearError();
  }

  function wireEvents(){
    el('btnResults').addEventListener('click', () => {
      try{ renderResults(); } catch(e){ showError(e?.message || String(e)); }
    });

    el('btnTxt').addEventListener('click', () => {
      try{
        const patient = safeText(el('patientName').value).trim() || 'paciente';
        const date = safeText(el('dateField').value).trim() || 'fecha';
        const txt = buildTXTReport();
        const fname = `informe_${patient.replace(/\s+/g,'_')}_${date}.txt`.replace(/[^\w\-\.]/g,'_');
        downloadTextFile(txt, fname);
      } catch(e){ showError(e?.message || String(e)); }
    });

    el('btnPdf').addEventListener('click', async () => {
      try{ await buildAndDownloadPDF(); }
      catch(e){ showError(e?.message || String(e)); }
    });

    el('btnPng').addEventListener('click', async () => {
      try{ await downloadPorticoPNG(); }
      catch(e){ showError(e?.message || String(e)); }
    });

    el('btnReset').addEventListener('click', () => resetAll());

    // If patient/date changes, invalidate cached png + refresh if results open
    ['patientName','dateField'].forEach(id => {
      el(id).addEventListener('input', () => {
        state.lastPorticoPNG = null;
        if (el('resultsRoot').style.display !== 'none'){
          updatePorticoUI();
        }
      });
    });

    // Manual JSON load
    el('btnLoadJson').addEventListener('click', () => el('jsonFile').click());
    el('jsonFile').addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      try{
        clearError();
        const text = await file.text();
        const json = JSON.parse(text);
        initFromJSON(json, true);
      } catch(e){
        setJsonStatus(false, 'error al cargar');
        showError('No se pudo leer el JSON. Verifica el archivo.');
      } finally {
        ev.target.value = '';
      }
    });
  }

  // -------------------------
  // INIT (fetch JSON with fallback)
  // -------------------------
  function validateJSONShape(json){
    if (!json || typeof json !== 'object') return 'JSON inv√°lido.';
    if (!json.meta?.title) return 'Falta meta.title.';
    if (!Array.isArray(json.scale?.options) || !json.scale.options.length) return 'Falta scale.options.';
    if (!Array.isArray(json.sections) || !json.sections.length) return 'Falta sections.';
    if (!json.rubrics?.globalBands || !json.rubrics?.sectionBands) return 'Falta rubrics.';
    if (!json.pastoralManual?.sections) return 'Falta pastoralManual.sections.';
    return null;
  }

  function initFromJSON(json, fromManual=false){
    const err = validateJSONShape(json);
    if (err) throw new Error(err);

    state.data = json;

    // reset answers
    state.answers.clear();
    state.lastPorticoPNG = null;

    // render
    renderTest();
    enableUI(true);
    setJsonStatus(true, fromManual ? 'cargado (manual)' : 'cargado');
    clearError();
  }

  async function loadJSON(){
    enableUI(false);
    clearError();
    try{
      const res = await fetch(JSON_PATH, { cache:'no-store' });
      if (!res.ok) throw new Error('No se pudo cargar el JSON por fetch.');
      const json = await res.json();
      initFromJSON(json, false);
    } catch(e){
      // En file:// fetch suele fallar: dejamos opci√≥n manual
      setJsonStatus(false, 'no disponible por fetch');
      showError('No se pudo cargar el JSON autom√°ticamente. Pulsa ‚ÄúCargar JSON manual‚Äù y selecciona ensenanza05.json.');
    }
  }

  // Start
  wireEvents();
  loadJSON();

})();
</script>
</body>
</html>



