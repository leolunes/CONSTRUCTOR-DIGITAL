<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detector de Fisuras ‚Äî Auditor√≠a del Hogar</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e7eefc; --muted:#a7b4d6;
      --accent:#5eead4; --line:rgba(255,255,255,.10);
      --danger:#fb7185;
      --g:rgba(16,185,129,.16); --y:rgba(245,158,11,.14);
      --o:rgba(249,115,22,.14); --r:rgba(244,63,94,.14);
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:22px;}
    .hero{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(135deg, rgba(94,234,212,.10), rgba(99,102,241,.08));}
    h1{margin:0 0 6px;font-size:26px;}
    .sub{margin:0;color:var(--muted);line-height:1.4}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);font-size:12px;margin-right:8px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:980px){.grid{grid-template-columns:520px 1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;}
    .fieldgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:740px){.fieldgrid{grid-template-columns:1fr 1fr;}}
    label{font-weight:900;font-size:13px;}
    input, textarea{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,.04);color:var(--text);
      border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    .muted{color:var(--muted);}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;}
    button{border:0;border-radius:14px;padding:11px 14px;font-weight:950;cursor:pointer;}
    .primary{background:var(--accent);color:#071018;}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);}
    .warn{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#fcd34d;}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:950;font-size:12px;border:1px solid rgba(255,255,255,.14);}
    .bG{background:var(--g);color:#6ee7b7;border-color:rgba(16,185,129,.30);}
    .bY{background:var(--y);color:#fcd34d;border-color:rgba(245,158,11,.30);}
    .bO{background:var(--o);color:#fdba74;border-color:rgba(249,115,22,.30);}
    .bR{background:var(--r);color:#fda4af;border-color:rgba(244,63,94,.30);}
    .mini{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);}
    .mini h3{margin:0 0 8px;font-size:14px;}
    .q{padding:12px 0;border-top:1px solid var(--line);}
    .q:first-of-type{border-top:none;}
    .opts{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;}
    .opt{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);cursor:pointer;user-select:none;}
    .resultBox{display:none;}
    ul{margin:8px 0 0;padding-left:18px;line-height:1.45;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 id="t">‚Äî</h1>
    <p class="sub" id="d">‚Äî</p>
    <div style="margin-top:10px">
      <span class="pill" id="pillMax">‚Äî</span>
      <span class="pill" id="pillVerse">‚Äî</span>
    </div>
    <div id="pdfWarn" class="warn">No se pudo cargar jsPDF/AutoTable. Verifica internet/CDN.</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <b>Datos de auditor√≠a</b>
        <div class="fieldgrid">
          <div>
            <label>Nombre del paciente</label>
            <input id="patient" placeholder="Ej: Juan y Mar√≠a P√©rez">
          </div>
          <div>
            <label>Nombre del auditor</label>
            <input id="auditor" placeholder="Ej: Consejero / Pastor">
          </div>
          <div>
            <label>Fecha (editable)</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Observaciones libres</label>
            <textarea id="notes" placeholder="Contexto, acuerdos, motivo, etc."></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnCalc">Ver resultado</button>
          <button class="ghost" id="btnTxt" disabled>Descargar TXT</button>
          <button class="ghost" id="btnPdf" disabled>Descargar PDF bonito</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <b>Diagn√≥stico global</b>
        <div class="mini" id="globalBox"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div id="form"></div>

      <div class="card resultBox" id="resultsCard" style="margin-top:14px">
        <b>Enfoque pastoral por fisura (autom√°tico)</b>
        <div id="teachings"></div>

        <div class="mini" style="margin-top:12px">
          <h3>Plan semanal autom√°tico (7 d√≠as)</h3>
          <div id="plan7"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  const JSON_PATH = "detector-fisuras.json";
  const LOGO_PATH = "logo.png";

  let DATA=null;
  let logoDataUrl=null;
  const state = {};
  let last=null;

  const pdfWarn = document.getElementById("pdfWarn");

  const tEl=document.getElementById("t");
  const dEl=document.getElementById("d");
  const pillMax=document.getElementById("pillMax");
  const pillVerse=document.getElementById("pillVerse");

  const patientEl=document.getElementById("patient");
  const auditorEl=document.getElementById("auditor");
  const dateEl=document.getElementById("date");
  const notesEl=document.getElementById("notes");

  const formEl=document.getElementById("form");
  const globalBox=document.getElementById("globalBox");

  const resultsCard=document.getElementById("resultsCard");
  const teachingsEl=document.getElementById("teachings");
  const plan7El=document.getElementById("plan7");

  const btnTxt=document.getElementById("btnTxt");
  const btnPdf=document.getElementById("btnPdf");

  function okPdfLib(){
    return !!(window.jspdf && window.jspdf.jsPDF) &&
           !!(window.jspdfAutoTable || (window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable));
  }

  function setDefaultDateIfEmpty(){
    if(dateEl.value) return;
    const d = new Date();
    dateEl.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function safeText(x){ return (x===null || x===undefined) ? "" : String(x); }

  function badgeClassFromBandKey(key){
    if(key==="b_verde") return "badge bG";
    if(key==="b_amarillo") return "badge bY";
    if(key==="b_naranja") return "badge bO";
    return "badge bR";
  }

  // score 0‚Äì100 = salud; riesgo = 100-score
  function bandForScore(score){
    const risk = 100 - score;
    if(risk <= 30) return DATA.bands.find(b=>b.key==="b_verde");
    if(risk <= 60) return DATA.bands.find(b=>b.key==="b_amarillo");
    if(risk <= 85) return DATA.bands.find(b=>b.key==="b_naranja");
    return DATA.bands.find(b=>b.key==="b_rojo");
  }

  function teachingFor(section, bandKey){
    const map = { b_verde:"verde", b_amarillo:"amarillo", b_naranja:"naranja", b_rojo:"rojo" };
    const k = map[bandKey] || "amarillo";
    return section.teachings[k];
  }

  function sectionScore(sec){
    return sec.questions.reduce((acc,q)=> acc + (state[q.id] ?? 0), 0);
  }

  function renderHeader(){
    tEl.textContent = safeText(DATA.meta.title) || "Detector de Fisuras";
    dEl.textContent = safeText(DATA.meta.description) || "";
    pillMax.textContent = `M√°x por fisura: 100`;
    const v=DATA.verses.base;
    pillVerse.textContent = `üìñ ${v.quote} (${v.reference})`;
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  function renderForm(){
    formEl.innerHTML = "";
    DATA.sections.forEach(sec=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div>
            <b>${safeText(sec.title)}</b>
            ${sec.subtitle ? `<div class="muted" style="margin-top:4px;font-size:13px">${safeText(sec.subtitle)}</div>` : ""}
            ${sec.diagnosticFocus ? `<div class="muted" style="margin-top:4px;font-size:13px"><b>Enfoque:</b> ${safeText(sec.diagnosticFocus)}</div>` : ""}
          </div>
          <span class="pill">0‚Äì100</span>
        </div>
        <div class="mini">
          <div class="muted" style="font-size:13px"><b>Porci√≥n b√≠blica</b></div>
          <div style="margin-top:6px">${safeText(sec.sectionVerse.quote)}<br><span class="muted">(${safeText(sec.sectionVerse.reference)})</span></div>
        </div>
      `;

      sec.questions.forEach((q, idx)=>{
        const qDiv=document.createElement("div");
        qDiv.className="q";

        const opts = DATA.scale.options.map(opt=>`
          <label class="opt">
            <input type="radio" name="${q.id}" value="${opt.value}">
            <span>${opt.label}</span>
          </label>
        `).join("");

        qDiv.innerHTML = `
          <label>${idx+1}. ${safeText(q.text)}</label>
          <div class="opts" role="radiogroup" aria-label="${safeText(q.text)}">${opts}</div>
        `;

        qDiv.querySelectorAll(`input[name="${q.id}"]`).forEach(inp=>{
          inp.addEventListener("change",(e)=>{
            state[q.id] = Number(e.target.value);
          });
        });

        card.appendChild(qDiv);
      });

      formEl.appendChild(card);
    });
  }

  function computePayload(){
    const header = {
      patient: patientEl.value.trim() || "(no especificado)",
      auditor: auditorEl.value.trim() || "(no especificado)",
      date: dateEl.value || "(no especificada)",
      notes: notesEl.value.trim() || ""
    };

    const sections = DATA.sections.map(sec=>{
      const score = sectionScore(sec); // 0‚Äì100 salud
      const band = bandForScore(score);
      const teaching = teachingFor(sec, band.key);
      const risk = 100 - score;
      return {
        id: sec.id,
        title: sec.title,
        score,
        risk,
        band,
        teaching,
        verse: sec.sectionVerse
      };
    });

    const avgRisk = sections.reduce((a,s)=>a+s.risk,0) / sections.length;
    let gBand;
    if(avgRisk <= 30) gBand = DATA.bands.find(b=>b.key==="b_verde");
    else if(avgRisk <= 60) gBand = DATA.bands.find(b=>b.key==="b_amarillo");
    else if(avgRisk <= 85) gBand = DATA.bands.find(b=>b.key==="b_naranja");
    else gBand = DATA.bands.find(b=>b.key==="b_rojo");

    const sorted = [...sections].sort((a,b)=> b.risk - a.risk);
    const topA = sorted[0];
    const topB = sorted[1] || sorted[0];

    // Acciones reales (d√≠a 1‚Äì5) ‚Äî ya definidas (sin placeholders)
    const defaultActions = {
      day1: "Orar juntos 10‚Äì15 minutos pidiendo luz, sin discutir el problema (solo rendici√≥n).",
      day2: "Identificar 1 fisura concreta y hacer 1 acuerdo corto: ‚Äú¬øQu√© haremos distinto esta semana?‚Äù",
      day3: "Practicar conversaci√≥n breve con reglas: tono suave, no interrumpir, cerrar con 1 acuerdo.",
      day4: "Restaurar honra: cada uno reconoce 1 virtud/esfuerzo del otro (sin sarcasmo).",
      day5: "Transferir 1 carga al fundamento: oraci√≥n final + decisi√≥n pr√°ctica (agenda/rol/l√≠mite)."
    };

    const plan = [];
    plan.push({day:1, title:`Enfoque: ${topA.title}`, items:[defaultActions.day1]});
    plan.push({day:2, title:`Enfoque: ${topA.title}`, items:[defaultActions.day2]});
    plan.push({day:3, title:`Enfoque: ${topA.title}`, items:[defaultActions.day3]});
    plan.push({day:4, title:`Enfoque: ${topB.title}`, items:[defaultActions.day4]});
    plan.push({day:5, title:`Enfoque: ${topB.title}`, items:[defaultActions.day5]});
    plan.push({day:6, title:DATA.planFramework.day6Title, items:DATA.planFramework.day6Items});
    plan.push({day:7, title:DATA.planFramework.day7Title, items:DATA.planFramework.day7Items});

    return { header, sections, avgRisk, globalBand: gBand, plan7: plan, topA, topB };
  }

  function renderGlobal(payload){
    const b = payload.globalBand;
    globalBox.innerHTML = `
      <h3><span class="${badgeClassFromBandKey(b.key)}">${b.label}</span></h3>
      <div class="muted" style="margin-top:6px;line-height:1.45">${b.summary}</div>
      <div class="mini" style="margin-top:10px">
        <b>Porci√≥n b√≠blica</b>
        <div style="margin-top:6px">${b.verse.quote}<br><span class="muted">(${b.verse.reference})</span></div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:13px">
        Riesgo promedio estimado: <b>${payload.avgRisk.toFixed(1)}%</b> (0% = sano, 100% = cr√≠tico)
      </div>
    `;
  }

  function renderTeachings(payload){
    resultsCard.style.display = "block";
    teachingsEl.innerHTML = "";

    payload.sections.forEach(s=>{
      const card=document.createElement("div");
      card.className="mini";
      card.innerHTML = `
        <h3>${s.title} ‚Äî <span class="${badgeClassFromBandKey(s.band.key)}">${s.band.label}</span> ¬∑ Salud ${s.score}/100 ¬∑ Riesgo ${s.risk}/100</h3>
        <div class="muted" style="margin-top:6px">${s.teaching.title}</div>
        <ul>${s.teaching.text.map(x=>`<li>${x}</li>`).join("")}</ul>
        <div class="mini">
          <b>Verso</b>
          <div style="margin-top:6px">${s.teaching.verse.quote}<br><span class="muted">(${s.teaching.verse.reference})</span></div>
        </div>
      `;
      teachingsEl.appendChild(card);
    });

    plan7El.innerHTML = `
      <ul>
        ${payload.plan7.map(d=>`<li><b>D√≠a ${d.day} ‚Äî ${d.title}:</b> ${d.items.join(" ¬∑ ")}</li>`).join("")}
      </ul>
    `;
  }

  function buildTxt(payload){
    const L=[];
    L.push("DETECTOR DE FISURAS ‚Äî AUDITOR√çA DEL HOGAR");
    L.push("");
    L.push(`Paciente: ${payload.header.patient}`);
    L.push(`Auditor: ${payload.header.auditor}`);
    L.push(`Fecha: ${payload.header.date}`);
    L.push("Observaciones:");
    L.push(payload.header.notes || "(sin observaciones)");
    L.push("");
    L.push("DIAGN√ìSTICO GLOBAL");
    L.push(`${payload.globalBand.label}`);
    L.push(payload.globalBand.summary);
    L.push(`${payload.globalBand.verse.quote} (${payload.globalBand.verse.reference})`);
    L.push(`Riesgo promedio: ${payload.avgRisk.toFixed(1)}%`);
    L.push("");
    L.push("DIAGN√ìSTICO POR FISURAS");
    payload.sections.forEach(s=>{
      L.push(`- ${s.title}`);
      L.push(`  Salud: ${s.score}/100 ¬∑ Riesgo: ${s.risk}/100 ¬∑ Estado: ${s.band.label}`);
      L.push(`  Mini-ense√±anza: ${s.teaching.title}`);
      L.push(`  Verso: ${s.teaching.verse.quote} (${s.teaching.verse.reference})`);
    });
    L.push("");
    L.push("PLAN SEMANAL (7 D√çAS)");
    payload.plan7.forEach(d=>{
      L.push(`D√≠a ${d.day} ‚Äî ${d.title}`);
      d.items.forEach(it=> L.push("‚Ä¢ " + it));
      L.push("");
    });
    return L.join("\n");
  }

  function downloadTxt(){
    if(!last) return;
    const blob=new Blob([buildTxt(last)],{type:"text/plain;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="detector_fisuras.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadLogoDataUrl(){
    try{
      const res = await fetch(LOGO_PATH, {cache:"no-store"});
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(resolve=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=()=>resolve(null);
        fr.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function safeFileName(name){
    return (name||"hogar").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"").slice(0,60);
  }

  async function downloadPdf(){
    if(!last) return;
    if(!(window.jspdf && window.jspdf.jsPDF)){
      pdfWarn.style.display="block"; return;
    }
    if(logoDataUrl===null) logoDataUrl = await loadLogoDataUrl();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"letter"});
    const W = doc.internal.pageSize.getWidth();
    const H = doc.internal.pageSize.getHeight();
    const M = 44;

    const INK=[22,33,58];
    const MUTED=[90,102,130];

    function addLogo(x,y,w,h){
      if(!logoDataUrl) return;
      try{ doc.addImage(logoDataUrl,"PNG",x,y,w,h); }catch(e){}
    }
    function footer(){
      const n=doc.getNumberOfPages();
      for(let i=1;i<=n;i++){
        doc.setPage(i);
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(...MUTED);
        doc.text("Detector de Fisuras ‚Äî Auditor√≠a del Hogar", M, H-18);
        doc.text(`P√°gina ${i} de ${n}`, W-M, H-18, {align:"right"});
      }
    }
    function sectionTitle(text,y){
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);
      doc.setTextColor(...INK);
      doc.text(text,M,y);
      doc.setDrawColor(230);
      doc.line(M,y+8,W-M,y+8);
      return y+22;
    }

    // PORTADA
    doc.setFillColor(22,33,58);
    doc.rect(0,0,W,96,"F");
    addLogo(W-M-56,18,56,56);

    doc.setFont("helvetica","bold");
    doc.setFontSize(22);
    doc.setTextColor(255,255,255);
    doc.text("DETECTOR DE FISURAS", M, 52);

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);
    doc.setTextColor(210,230,255);
    doc.text("Auditor√≠a del Hogar ‚Äî diagn√≥stico por secciones", M, 74);

    doc.setFillColor(245,247,255);
    doc.roundedRect(M,120,W-M*2,130,12,12,"F");
    doc.setTextColor(...INK);
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Datos", M+14, 145);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`Paciente: ${last.header.patient}`, M+14, 172);
    doc.text(`Auditor: ${last.header.auditor}`, M+14, 192);
    doc.text(`Fecha: ${last.header.date}`, M+14, 212);

    // GLOBAL
    const gb=last.globalBand;
    doc.setFillColor(255,255,255);
    doc.roundedRect(M,270,W-M*2,170,12,12,"F");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(...INK);
    doc.text("Diagn√≥stico global", M+14, 300);

    // Pill global (AUTO-FIT)
    const pillW = 260, pillH = 24;
    doc.setFillColor(22,33,58);
    doc.roundedRect(M+14,312,pillW,pillH,10,10,"F");

    doc.setFont("helvetica","bold");
    doc.setTextColor(255,255,255);
    let fs = 10;
    doc.setFontSize(fs);
    while (doc.getTextWidth(gb.label.toUpperCase()) > pillW - 20 && fs > 7) {
      fs -= 0.5;
      doc.setFontSize(fs);
    }
    doc.text(gb.label.toUpperCase(), M+14+pillW/2, 328, {align:"center", baseline:"middle"});

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...INK);
    doc.text(`Riesgo promedio estimado: ${last.avgRisk.toFixed(1)}%`, M+14, 362);

    const sumLines = doc.splitTextToSize(gb.summary, W - M*2 - 40);
    doc.text(sumLines, M+14, 380, {maxWidth: W - M*2 - 40});

    doc.setFont("times","italic");
    doc.setFontSize(11);
    const vLines=doc.splitTextToSize(`${gb.verse.quote} (${gb.verse.reference})`, W-M*2-40);
    doc.text(vLines, M+14, 430);

    // TABLA RESUMEN
    doc.addPage();
    addLogo(M,16,32,32);
    let y=sectionTitle("Resumen por fisuras",64);

    const rows=last.sections.map(s=>[
      s.title,
      `${s.score}/100`,
      `${s.risk}/100`,
      s.band.label
    ]);

    doc.autoTable({
      startY:y,
      head:[["Fisura", "Salud", "Riesgo", "Diagn√≥stico"]],
      body:rows,
      theme:"grid",
      styles:{font:"helvetica",fontSize:10,cellPadding:6,textColor:[20,30,50],lineColor:[230,234,245]},
      headStyles:{fillColor:[22,33,58],textColor:[255,255,255],fontStyle:"bold"},
      margin:{left:M,right:M}
    });

    // ENFOQUE PASTORAL (TODAS) ‚Äî texto din√°mico
    doc.addPage();
    addLogo(M,16,32,32);
    y=sectionTitle("Enfoque pastoral por fisura (todas)",64);

    last.sections.forEach(s=>{
      const width = W - M*2 - 28;

      const headerLine = `${s.title} ‚Äî ${s.band.label} ¬∑ Salud ${s.score}/100`;
      const bulletsStr = s.teaching.text.map(x => "‚Ä¢ " + x).join("\n");
      const verseStr = `${s.teaching.verse.quote} (${s.teaching.verse.reference})`;

      const headerLines = doc.splitTextToSize(headerLine, width);
      const titleLines  = doc.splitTextToSize(s.teaching.title, width);
      const bulletLines = doc.splitTextToSize(bulletsStr, width);
      const verseLines  = doc.splitTextToSize(verseStr, width);

      const dynamicH = Math.max(140, 34 + (headerLines.length+titleLines.length+bulletLines.length+verseLines.length)*12 + 20);

      if(y + dynamicH > H - 70){
        doc.addPage();
        addLogo(M,16,32,32);
        y = 64;
      }

      doc.setFillColor(255,255,255);
      doc.roundedRect(M, y, W - M*2, dynamicH, 12, 12, "F");

      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.setTextColor(...INK);
      doc.text(headerLines, M+14, y+24);

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(...INK);
      doc.text(titleLines, M+14, y+24 + (headerLines.length*12) + 10);

      const afterTitleY = y+24 + (headerLines.length*12) + 10 + (titleLines.length*12) + 10;
      doc.text(bulletLines, M+14, afterTitleY);

      doc.setFont("times","italic");
      doc.setFontSize(10);
      doc.text(verseLines, M+14, afterTitleY + (bulletLines.length*12) + 12);

      y += dynamicH + 14;
    });

    // PLAN SEMANAL
    doc.addPage();
    addLogo(M,16,32,32);
    y=sectionTitle("Plan semanal autom√°tico (7 d√≠as)",64);

    doc.autoTable({
      startY:y,
      head:[["D√≠a","Enfoque","Acciones"]],
      body:last.plan7.map(d=>[ `D√≠a ${d.day}`, d.title, d.items.join(" ‚Ä¢ ") ]),
      theme:"grid",
      styles:{font:"helvetica",fontSize:10,cellPadding:7,textColor:[20,30,50],lineColor:[230,234,245],valign:"top"},
      headStyles:{fillColor:[22,33,58],textColor:[255,255,255],fontStyle:"bold"},
      columnStyles:{0:{cellWidth:70},1:{cellWidth:190},2:{cellWidth:W-M*2-70-190}},
      margin:{left:M,right:M}
    });

    // OBSERVACIONES
    doc.addPage();
    addLogo(M,16,32,32);
    y=sectionTitle("Observaciones",64);

    doc.setFillColor(255,255,255);
    doc.roundedRect(M,y,W-M*2,520,12,12,"F");
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(...INK);
    const notes = last.header.notes || "(sin observaciones)";
    doc.text(doc.splitTextToSize(notes, W-M*2-28), M+14, y+26);

    footer();
    doc.save(`${safeFileName(last.header.patient)}_detector_fisuras.pdf`);
  }

  function showResult(){
    last = computePayload();
    renderGlobal(last);
    renderTeachings(last);

    btnTxt.disabled=false;
    btnPdf.disabled=!okPdfLib();
    pdfWarn.style.display = okPdfLib() ? "none" : "block";
  }

  async function init(){
    const res=await fetch(JSON_PATH,{cache:"no-store"});
    if(!res.ok) throw new Error("No se pudo cargar el JSON.");
    DATA=await res.json();

    renderHeader();
    setDefaultDateIfEmpty();
    renderForm();
  }

  document.getElementById("btnCalc").addEventListener("click", showResult);
  btnTxt.addEventListener("click", downloadTxt);
  btnPdf.addEventListener("click", downloadPdf);

  init().catch(err=>{
    document.body.innerHTML = `<div style="padding:22px;color:#fda4af"><b>Error:</b> ${err.message}<br><span style="color:#a7b4d6">Aseg√∫rate de que <b>${JSON_PATH}</b> est√© en la misma carpeta.</span></div>`;
  });
</script>
</body>
</html>